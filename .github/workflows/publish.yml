name: Publish to npm

on:
  push:
    tags:
      - 'v*'           # Triggers on version tags like v0.2.5
      - 'core@*'       # Triggers on core-specific tags like core@0.2.5
      - 'ui@*'         # Triggers on ui-specific tags like ui@0.1.0
  workflow_dispatch:
    inputs:
      package:
        description: 'Package to publish'
        required: true
        default: 'both'
        type: choice
        options:
          - both
          - core
          - ui
      bump:
        description: 'Version bump type'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major

permissions:
  contents: write

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Use Node.js 20.x
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build packages
        run: npm run build

      - name: Run tests
        run: npm run test:ci

  publish-core:
    runs-on: ubuntu-latest
    needs: test
    if: |
      needs.test.result == 'success' &&
      (startsWith(github.ref, 'refs/tags/v') ||
       startsWith(github.ref, 'refs/tags/core@') ||
       (github.event_name == 'workflow_dispatch' && (inputs.package == 'both' || inputs.package == 'core')))

    steps:
      - uses: actions/checkout@v4

      - name: Use Node.js 20.x
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'npm'
          registry-url: 'https://registry.npmjs.org'

      - name: Install dependencies
        run: npm ci

      - name: Build packages
        run: npm run build

      - name: Bump version
        if: github.event_name == 'workflow_dispatch'
        run: |
          cd packages/core
          npm version ${{ inputs.bump }} --no-git-tag-version
          echo "NEW_VERSION=$(node -p "require('./package.json').version")" >> $GITHUB_ENV

      - name: Publish @moxijs/core
        run: npm publish --workspace=@moxijs/core
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Commit version bump and create tag
        if: github.event_name == 'workflow_dispatch'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add packages/core/package.json
          git commit -m "chore(core): bump version to ${{ env.NEW_VERSION }}" || echo "No changes to commit"
          git tag "core@${{ env.NEW_VERSION }}"
          git push origin HEAD:${{ github.ref_name }}
          git push origin "core@${{ env.NEW_VERSION }}"

  publish-ui:
    runs-on: ubuntu-latest
    needs: [test, publish-core]
    # Run after test, wait for publish-core if it ran
    if: |
      always() &&
      needs.test.result == 'success' &&
      (needs.publish-core.result == 'success' || needs.publish-core.result == 'skipped') &&
      (startsWith(github.ref, 'refs/tags/v') ||
       startsWith(github.ref, 'refs/tags/ui@') ||
       (github.event_name == 'workflow_dispatch' && (inputs.package == 'both' || inputs.package == 'ui')))

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Pull latest changes
        if: github.event_name == 'workflow_dispatch' && inputs.package == 'both'
        run: git pull origin ${{ github.ref_name }}

      - name: Use Node.js 20.x
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'npm'
          registry-url: 'https://registry.npmjs.org'

      - name: Install dependencies
        run: npm ci

      - name: Build packages
        run: npm run build

      - name: Bump version
        if: github.event_name == 'workflow_dispatch'
        run: |
          cd packages/ui
          npm version ${{ inputs.bump }} --no-git-tag-version
          echo "NEW_VERSION=$(node -p "require('./package.json').version")" >> $GITHUB_ENV

      - name: Publish @moxijs/ui
        run: npm publish --workspace=@moxijs/ui
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Commit version bump and create tag
        if: github.event_name == 'workflow_dispatch'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add packages/ui/package.json
          git commit -m "chore(ui): bump version to ${{ env.NEW_VERSION }}" || echo "No changes to commit"
          git tag "ui@${{ env.NEW_VERSION }}"
          git push origin HEAD:${{ github.ref_name }}
          git push origin "ui@${{ env.NEW_VERSION }}"
