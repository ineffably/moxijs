# MoxiJS

> A game framework built on PIXI.js with Entity-Component-System architecture, physics integration, and UI components.

## Package: @moxijs/core

All imports from `@moxijs/core` unless noted.

---

## Quick Start

```ts
import { setupMoxi, asEntity, Logic } from '@moxijs/core';

// Initialize engine
const { scene, engine } = await setupMoxi({
  hostElement: document.getElementById('game'),
  backgroundColor: 0x1a1a2e,
});

// Create entity with logic
const player = asEntity(new PIXI.Sprite(texture));
player.moxiEntity.addLogic(new PlayerLogic());
scene.addChild(player);

engine.start();
```

---

## Core Engine

### setupMoxi
Main initialization function.
```ts
const { scene, engine, camera, physicsWorld, loadAssets } = await setupMoxi({
  hostElement: HTMLElement,
  backgroundColor?: number,
  physics?: boolean | PhysicsWorldOptions,
  showLoadingScene?: boolean,
});
```

### Engine
Game loop manager.
```ts
engine.start();
engine.stop();
engine.loadStage(newScene);
```

### Scene
Root container for game objects. Extends PIXI.Container.
```ts
scene.addChild(entity);
scene.init();
scene.update(deltaTime);
```

---

## Entity System

### asEntity
Wrap any PIXI.Container as an entity with logic support.
```ts
const entity = asEntity(new PIXI.Sprite(texture));
entity.moxiEntity.addLogic(new MyLogic());
entity.moxiEntity.getLogic<MyLogic>('MyLogic');
```

### Logic
Base class for entity behavior. Extend to create custom logic.
```ts
class MyLogic extends Logic<PIXI.Sprite> {
  name = 'MyLogic';

  init(entity, renderer) {
    // Called once when scene initializes
  }

  update(entity, deltaTime) {
    // Called every frame while active
    entity.rotation += 0.01 * deltaTime;
  }
}
```

### StateMachine
Finite state machine for entity states.
```ts
const fsm = new StateMachine();
fsm.addState(new IdleState());
fsm.addState(new WalkState());
fsm.setState('idle');
fsm.addEventListener('stateChange', (e) => console.log(e.detail));
```

### StateLogic
Base class for FSM states.
```ts
class IdleState extends StateLogic {
  name = 'idle';
  onEnter() { /* play idle animation */ }
  onExit() { /* cleanup */ }
  update(entity, deltaTime) { /* state logic */ }
}
```

---

## Camera

### Camera
Viewport with smooth following and zoom.
```ts
const camera = new Camera(scene, renderer);
camera.desiredPosition = { x: 100, y: 100 };
camera.desiredScale = { x: 2, y: 2 };
camera.speed = 0.1; // 0-1 interpolation speed
```

### CameraLogic
Follow a target entity.
```ts
const cameraLogic = camera.moxiEntity.getLogic<CameraLogic>('CameraLogic');
cameraLogic.target = player;
cameraLogic.speed = 0.05;
```

---

## Physics (Planck.js)

### PhysicsWorld
Physics simulation manager.
```ts
const physicsWorld = new PhysicsWorld({
  gravity: { x: 0, y: 10 },
  pixelsPerMeter: 30,
});

// Create body
const body = physicsWorld.createBody({
  type: 'dynamic', // 'static' | 'dynamic' | 'kinematic'
  position: { x: 100, y: 100 },
  shape: { type: 'box', width: 32, height: 32 },
  tags: ['player'],
});

// Collision detection
physicsWorld.onCollision('player', 'enemy', (event) => {
  console.log('Hit!', event.bodyA, event.bodyB);
});

// Debug visualization
physicsWorld.enableDebugRenderer(scene);
```

### PhysicsBodyLogic
Attach physics to entity.
```ts
const entity = asEntity(sprite);
entity.moxiEntity.addLogic(new PhysicsBodyLogic(physicsWorld, {
  type: 'dynamic',
  shape: { type: 'circle', radius: 16 },
}));
```

---

## UI System

**Package: @moxijs/ui**

All UI components are now in the separate `@moxijs/ui` package.

```ts
import { 
  FlexContainer, FlexDirection, UIButton, UILabel, 
  UITextInput, UITextArea, UISelect, UIScrollContainer,
  UITabs, UIPanel, UICheckbox, UIRadioGroup, CardPanel,
  FontType, UIFontConfig
} from '@moxijs/ui';
```

**Font Standardization:** All text-based UI components (`UILabel`, `UIButton`, `UITextInput`, `UITextArea`, `UISelect`, `UITabs`) support standardized font configuration:
- `fontFamily?: string` - Font family name
- `fontType?: FontType` - Rendering method: `'canvas'` (default), `'msdf'`, or `'bitmap'`

Font properties inherit from parent components, allowing you to set fonts once at the container level.

### UILabel
Text display with layout. Supports font inheritance.
```ts
const label = new UILabel({
  text: 'Score: 0',
  fontSize: 24,
  fontFamily: 'PixelOperator8',  // Font family name
  fontType: 'msdf',               // 'canvas' | 'msdf' | 'bitmap'
  color: 0xffffff,
  align: 'center',
  wordWrap: true,
  wordWrapWidth: 200,
});
label.setText('Score: 100');
label.setColor(0xff0000);
```

### UIButton
Interactive button with font support.
```ts
const button = new UIButton({
  label: 'Start Game',
  width: 120,
  height: 40,
  backgroundColor: 0x4444ff,
  textColor: 0xffffff,
  fontFamily: 'PixelOperator8',  // Optional: inherits from parent
  fontType: 'msdf',               // Optional: inherits from parent
  onClick: () => startGame(),
});
```

### FlexContainer
Flexbox-style layout.
```ts
const container = new FlexContainer({
  direction: FlexDirection.Column,
  justify: FlexJustify.Center,
  align: FlexAlign.Center,
  gap: 10,
  padding: EdgeInsets.all(20),
});
container.addChild(label);
container.addChild(button);
```

### UIPanel
Nine-slice panel background.
```ts
const panel = new UIPanel({
  width: 300,
  height: 200,
  nineSliceConfig: { texture, leftWidth, rightWidth, topHeight, bottomHeight },
});
```

### UITabs
Tab navigation.
```ts
const tabs = new UITabs({
  tabs: [
    { label: 'Tab 1', content: panel1 },
    { label: 'Tab 2', content: panel2 },
  ],
  onChange: (index) => console.log('Tab:', index),
});
```

### UITextInput / UITextArea
Text input fields with font support.
```ts
const input = new UITextInput({
  placeholder: 'Enter name...',
  fontFamily: 'PixelOperator8',  // Optional: inherits from parent
  fontType: 'canvas',             // Optional: inherits from parent
  onChange: (value) => console.log(value),
  onSubmit: (value) => saveName(value),
});
```

### UISelect
Dropdown selection.
```ts
const select = new UISelect({
  options: [
    { label: 'Easy', value: 1 },
    { label: 'Hard', value: 2 },
  ],
  onChange: (option) => setDifficulty(option.value),
});
```

### UIScrollContainer
Scrollable content.
```ts
const scroll = new UIScrollContainer({ width: 200, height: 300 });
scroll.addChild(longContent);
```

### UICheckbox / UIRadioGroup
Form controls.
```ts
const checkbox = new UICheckbox({ checked: true, onChange: (checked) => {} });
const radioGroup = new UIRadioGroup({
  options: [{ label: 'Option 1', value: 1 }, { label: 'Option 2', value: 2 }],
  onChange: (option) => {}
});
```

### CardPanel
Flexible card component with title/body/footer sections.
```ts
const card = new CardPanel({
  title: 'Settings',
  width: 300,
  height: 200,
});
```

---

## Pixel Grid System

### PixelGrid
Pixel-perfect measurements.
```ts
const grid = new PixelGrid({ scale: 2, unit: 8 });
const width = grid.px(10);  // 10 units = 160px at 2x scale
const units = grid.units(160); // 160px = 10 units
```

### UIScaleMode
UI scaling strategies.
```ts
const layer = new UILayer({
  scaleMode: UIScaleMode.LockRatio, // None | ScaleUI | LockRatio
  targetWidth: 1280,
  targetHeight: 720,
});
```

---

## Parallax Backgrounds

### ParallaxBackground
Container for parallax layers.
```ts
const parallax = new ParallaxBackground({ camera });
parallax.autoscroll = { x: -0.5, y: 0 }; // Auto-scroll speed
```

### ParallaxLayer
Individual parallax layer.
```ts
const layer = new ParallaxLayer({
  scrollScale: { x: 0.5, y: 0.5 }, // Half speed = farther away
  scrollOffset: { x: 0, y: 0 },
  mirroring: true,
});
layer.addChild(backgroundSprite);
parallax.addLayer(layer);
```

---

## Texture & Animation

### asTextureFrames
Split texture into frames.
```ts
const frames = asTextureFrames(PIXI, spritesheet, {
  frameWidth: 32,
  frameHeight: 32,
  columns: 8,
  rows: 4,
});
const animatedSprite = new PIXI.AnimatedSprite(frames);
```

### TextureFrameSequences
Manage animation sequences.
```ts
const sequences = new TextureFrameSequences(frames);
sequences.addSequence('walk', [0, 1, 2, 3], 0.15);
sequences.addSequence('jump', [4, 5, 6], 0.1);
const walkFrames = sequences.getFrameSequence('walk');
```

---

## PIXI Helpers

### asSprite / asText / asGraphics / asContainer
Create configured PIXI objects.
```ts
const sprite = asSprite(texture, {
  x: 100, y: 100,
  anchor: { x: 0.5, y: 0.5 },
  scale: { x: 2, y: 2 },
  rotation: Math.PI / 4,
  tint: 0xff0000,
  alpha: 0.8,
});
```

### asTextDPR
Canvas 2D Device Pixel Ratio text rendering for crisp, pixel-perfect text.
```ts
const text = asTextDPR('Hello World', {
  fontSize: 24,
  fontFamily: 'Arial',
  color: 0xffffff,
  dpr: 2, // Default: 2 for 2× supersampling
});
```

### asMSDFText
Multi-channel Signed Distance Field text for crisp rendering at any scale. Requires .fnt font files.
```ts
// Load MSDF font first (PixiJS v8 requires .fnt extension)
await Assets.load({
  alias: 'PixelOperator8-MSDF',
  src: 'assets/fonts/msdf/PixelOperator8.fnt'
});

// Create MSDF text
const text = asMSDFText({
  text: 'Hello World',
  style: {
    fontFamily: 'PixelOperator8',
    fontSize: 32,
    fill: 0xffffff
  }
});

// MSDF stays crisp when scaled
text.scale.set(4); // No blur!
```

Generate MSDF fonts:
```bash
npm run generate-msdf-font -- fonts/MyFont.ttf ./assets/msdf MyFont
# Creates: MyFont.fnt (JSON with .fnt extension) and MyFont-MSDF.png
```

---

## Events

### EventEmitter
Type-safe pub/sub.
```ts
interface GameEvents {
  'score': (points: number) => void;
  'gameOver': () => void;
}
const events = new EventEmitter<GameEvents>();
events.on('score', (points) => updateScore(points));
events.emit('score', 100);
```

### ClientEvents
Singleton input manager.
```ts
const input = ClientEvents.getInstance();
if (input.isKeyDown('ArrowLeft')) moveLeft();
const mousePos = input.movePosition;
const wheelDelta = input.wheelDelta;
```

---

## Utilities

### ActionManager
Manage event listener lifecycle.
```ts
const actions = new ActionManager();
actions.add(window, 'resize', handleResize);
actions.removeAll(); // Cleanup all listeners
```

### LoadingScene
Customizable loading screen with animations.
```ts
const loadingScene = new LoadingScene({
  backgroundColor: 0x1a1a2e,
  animation: new FallingSquaresAnimation({ count: 20 }),
  onComplete: () => console.log('Loaded!'),
});
scene.addChild(loadingScene);
loadingScene.start();
```

### FallingSquaresAnimation
Animated loading indicator with falling squares.
```ts
const animation = new FallingSquaresAnimation({
  count: 30,
  speed: 2,
  colors: [0xff6b6b, 0x4ecdc4, 0x45b7d1],
});
```

### Utils
Common helpers.
```ts
import { utils } from '@moxijs/core';
utils.lerp(0, 100, 0.5);        // 50
utils.getRandomInt(1, 10);      // Random 1-10
utils.rad2deg(Math.PI);         // 180
utils.deg2rad(90);              // PI/2
utils.metersToPixels(1);        // 30 (default PPM)
```

### createTileGrid
Generate tile grids.
```ts
const grid = createTileGrid(
  { width: 10, height: 10, cellWidth: 32, cellHeight: 32 },
  tileTextures,
  (pos) => pos.index % tileTextures.length // Texture selector
);
```

---

## Package: @moxijs/mini-gui

Debug GUI panels inspired by dat.gui/lil-gui.

```ts
import { GUI } from '@moxijs/mini-gui';

const gui = new GUI({ title: 'Settings', x: 10, y: 10 });

// Auto-detects control type from value
gui.add(object, 'speed', 0, 100);        // NumberControl (slider)
gui.add(object, 'enabled');               // BooleanControl (checkbox)
gui.add(object, 'name');                  // StringControl (text input)
gui.add(object, 'mode', ['easy', 'hard']); // OptionControl (dropdown)

// Folders
const folder = gui.addFolder('Position');
folder.add(object, 'x', 0, 500);
folder.add(object, 'y', 0, 500);

// Callbacks
gui.add(object, 'volume', 0, 1)
  .onChange((v) => console.log('Changing:', v))
  .onFinishChange((v) => saveVolume(v));

// Add to scene
scene.addChild(gui.container);
```

---

## Common Patterns

### Game Entity with Multiple Behaviors
```ts
const enemy = asEntity(new PIXI.AnimatedSprite(frames));
enemy.moxiEntity.addLogic(new PhysicsBodyLogic(world, { type: 'dynamic' }));
enemy.moxiEntity.addLogic(new AILogic());
enemy.moxiEntity.addLogic(new HealthLogic(100));
scene.addChild(enemy);
```

### Responsive UI Layer
```ts
import { UILayer, UIScaleMode, FlexContainer, FlexDirection, UILabel } from '@moxijs/ui';

const ui = new UILayer({ scaleMode: UIScaleMode.LockRatio });
const hud = new FlexContainer({ direction: FlexDirection.Row, gap: 20 });
hud.addChild(new UILabel({ text: 'HP: 100' }));
hud.addChild(new UILabel({ text: 'Score: 0' }));
ui.addChild(hud.container);
scene.addChild(ui);
```

### Physics Platformer Setup
```ts
const { scene, physicsWorld } = await setupMoxi({
  hostElement: container,
  physics: { gravity: { x: 0, y: 20 } },
});

// Ground
physicsWorld.createBody({
  type: 'static',
  position: { x: 400, y: 550 },
  shape: { type: 'box', width: 800, height: 100 },
  tags: ['ground'],
});

// Player
const player = asEntity(playerSprite);
player.moxiEntity.addLogic(new PhysicsBodyLogic(physicsWorld, {
  type: 'dynamic',
  shape: { type: 'box', width: 32, height: 48 },
  tags: ['player'],
}));
player.moxiEntity.addLogic(new PlatformerControlLogic());
```

### MSDF Font UI with Inheritance
```ts
// Load MSDF font once
await Assets.load({ alias: 'UI-Font', src: 'fonts/PixelOperator8.fnt' });

// Set font at container level - all children inherit
const uiContainer = new FlexContainer({
  direction: FlexDirection.Column,
  gap: 10,
  fontFamily: 'PixelOperator8',
  fontType: 'msdf'  // Children inherit crisp MSDF rendering
});

// All these inherit the MSDF font automatically
uiContainer.addChild(new UILabel({ text: 'Title', fontSize: 24 }));
uiContainer.addChild(new UIButton({ label: 'Start', onClick: start }));
uiContainer.addChild(new UITextInput({ placeholder: 'Name' }));
```

### Game HUD with Dynamic Text
```ts
// Create HUD with MSDF fonts for crisp scaling
const hud = new FlexContainer({
  direction: FlexDirection.Row,
  justify: FlexJustify.SpaceBetween,
  fontFamily: 'PixelOperator8',
  fontType: 'msdf',
  padding: EdgeInsets.all(20)
});

const scoreLabel = new UILabel({ text: 'Score: 0', fontSize: 16 });
const livesLabel = new UILabel({ text: 'Lives: 3', fontSize: 16 });

hud.addChild(scoreLabel);
hud.addChild(livesLabel);

// Update dynamically
engine.ticker.add(() => {
  scoreLabel.setText(`Score: ${game.score}`);
  livesLabel.setText(`Lives: ${game.lives}`);
});
```

### Form with Validation
```ts
const form = new FlexContainer({
  direction: FlexDirection.Column,
  gap: 15,
  padding: EdgeInsets.all(20),
  fontFamily: 'Arial',
  fontType: 'canvas'
});

const nameInput = new UITextInput({
  placeholder: 'Username',
  width: 200,
  onChange: (value) => validateUsername(value)
});

const emailInput = new UITextInput({
  placeholder: 'Email',
  width: 200,
  onChange: (value) => validateEmail(value)
});

const submitButton = new UIButton({
  label: 'Register',
  width: 200,
  onClick: () => submitForm({ name: nameInput.value, email: emailInput.value })
});

form.addChild(nameInput);
form.addChild(emailInput);
form.addChild(submitButton);
```

### Tabs with Different Content
```ts
const tabs = new UITabs({
  items: [
    { key: 'inventory', label: 'Inventory', content: inventoryPanel },
    { key: 'stats', label: 'Stats', content: statsPanel },
    { key: 'settings', label: 'Settings', content: settingsPanel }
  ],
  defaultActiveKey: 'inventory',
  width: 800,
  height: 600,
  fontFamily: 'PixelOperator8',
  fontType: 'msdf',
  onChange: (key) => console.log('Active tab:', key)
});
```

### Scrollable Content Panel
```ts
const scrollPanel = new UIScrollContainer({
  width: 300,
  height: 400,
  scrollDirection: 'vertical',
  backgroundColor: 0x2d2d44
});

// Add many items
for (let i = 0; i < 50; i++) {
  const item = new UILabel({
    text: `Item ${i}`,
    fontSize: 14,
    padding: EdgeInsets.symmetric(10, 15)
  });
  scrollPanel.addChild(item);
}
```

### Theming System
```ts
import { ThemeManager, Theme } from '@moxijs/ui';

const darkTheme: Theme = {
  colors: {
    primary: 0x4a90e2,
    secondary: 0x50c878,
    background: 0x1e1e1e,
    surface: 0x2d2d44,
    text: 0xffffff
  },
  fonts: {
    primary: { family: 'PixelOperator8', type: 'msdf' },
    secondary: { family: 'Arial', type: 'canvas' }
  }
};

ThemeManager.getInstance().setTheme('dark', darkTheme);
ThemeManager.getInstance().setActiveTheme('dark');

// Components automatically use theme
const button = new UIButton({
  label: 'Themed Button',
  useTheme: true  // Applies theme colors
});
```

---

## File Structure

```
@moxijs/core
├── main/          # Engine, Scene, Entity, Logic, Camera
└── library/       # Physics, Parallax, State Machine, Utilities, Loading Scene

@moxijs/ui
├── base/          # UIComponent, BoxModel, EdgeInsets, UIFocusManager
├── components/    # UIButton, UILabel, UITextInput, etc.
├── layout/        # FlexContainer
├── services/      # LayoutEngine, FormStateManager, ThemeApplier
└── theming/        # ThemeManager, ThemeResolver

@moxijs/mini-gui
├── gui.ts         # Main GUI class
├── gui-grid.ts    # Grid constants, colors
└── controls/      # NumberControl, BooleanControl, etc.
```
