/*! For license information please see bundle.js.LICENSE.txt */
(()=>{var t={767:t=>{!function(){function e(t,e){document.addEventListener?t.addEventListener("scroll",e,!1):t.attachEvent("scroll",e)}function i(t){this.g=document.createElement("div"),this.g.setAttribute("aria-hidden","true"),this.g.appendChild(document.createTextNode(t)),this.h=document.createElement("span"),this.i=document.createElement("span"),this.m=document.createElement("span"),this.j=document.createElement("span"),this.l=-1,this.h.style.cssText="max-width:none;display:inline-block;position:absolute;height:100%;width:100%;overflow:scroll;font-size:16px;",this.i.style.cssText="max-width:none;display:inline-block;position:absolute;height:100%;width:100%;overflow:scroll;font-size:16px;",this.j.style.cssText="max-width:none;display:inline-block;position:absolute;height:100%;width:100%;overflow:scroll;font-size:16px;",this.m.style.cssText="display:inline-block;width:200%;height:200%;font-size:16px;max-width:none;",this.h.appendChild(this.m),this.i.appendChild(this.j),this.g.appendChild(this.h),this.g.appendChild(this.i)}function s(t,e){t.g.style.cssText="max-width:none;min-width:20px;min-height:20px;display:inline-block;overflow:hidden;position:absolute;width:auto;margin:0;padding:0;top:-999px;white-space:nowrap;font-synthesis:none;font:"+e+";"}function o(t){var e=t.g.offsetWidth,i=e+100;return t.j.style.width=i+"px",t.i.scrollLeft=i,t.h.scrollLeft=t.h.scrollWidth+100,t.l!==e&&(t.l=e,!0)}function n(t,i){function s(){var t=n;o(t)&&null!==t.g.parentNode&&i(t.l)}var n=t;e(t.h,s),e(t.i,s),o(t)}function r(t,e,i){e=e||{},i=i||window,this.family=t,this.style=e.style||"normal",this.weight=e.weight||"normal",this.stretch=e.stretch||"normal",this.context=i}var a=null,h=null,c=null,l=null;function m(t){return null===l&&(l=!!t.document.fonts),l}function u(t,e){var i=t.style,s=t.weight;if(null===c){var o=document.createElement("div");try{o.style.font="condensed 100px sans-serif"}catch(t){}c=""!==o.style.font}return[i,s,c?t.stretch:"","100px",e].join(" ")}r.prototype.load=function(t,e){var o=this,r=t||"BESbswy",c=0,l=e||3e3,_=(new Date).getTime();return new Promise(function(t,e){if(m(o.context)&&!function(t){return null===h&&(m(t)&&/Apple/.test(window.navigator.vendor)?(t=/AppleWebKit\/([0-9]+)(?:\.([0-9]+))(?:\.([0-9]+))/.exec(window.navigator.userAgent),h=!!t&&603>parseInt(t[1],10)):h=!1),h}(o.context)){var d=new Promise(function(t,e){!function i(){(new Date).getTime()-_>=l?e(Error(l+"ms timeout exceeded")):o.context.document.fonts.load(u(o,'"'+o.family+'"'),r).then(function(e){1<=e.length?t():setTimeout(i,25)},e)}()}),p=new Promise(function(t,e){c=setTimeout(function(){e(Error(l+"ms timeout exceeded"))},l)});Promise.race([p,d]).then(function(){clearTimeout(c),t(o)},e)}else!function(t){document.body?t():document.addEventListener?document.addEventListener("DOMContentLoaded",function e(){document.removeEventListener("DOMContentLoaded",e),t()}):document.attachEvent("onreadystatechange",function e(){"interactive"!=document.readyState&&"complete"!=document.readyState||(document.detachEvent("onreadystatechange",e),t())})}(function(){function h(){var e;(e=-1!=y&&-1!=f||-1!=y&&-1!=g||-1!=f&&-1!=g)&&((e=y!=f&&y!=g&&f!=g)||(null===a&&(e=/AppleWebKit\/([0-9]+)(?:\.([0-9]+))/.exec(window.navigator.userAgent),a=!!e&&(536>parseInt(e[1],10)||536===parseInt(e[1],10)&&11>=parseInt(e[2],10))),e=a&&(y==v&&f==v&&g==v||y==x&&f==x&&g==x||y==b&&f==b&&g==b)),e=!e),e&&(null!==A.parentNode&&A.parentNode.removeChild(A),clearTimeout(c),t(o))}var m=new i(r),d=new i(r),p=new i(r),y=-1,f=-1,g=-1,v=-1,x=-1,b=-1,A=document.createElement("div");A.dir="ltr",s(m,u(o,"sans-serif")),s(d,u(o,"serif")),s(p,u(o,"monospace")),A.appendChild(m.g),A.appendChild(d.g),A.appendChild(p.g),o.context.document.body.appendChild(A),v=m.g.offsetWidth,x=d.g.offsetWidth,b=p.g.offsetWidth,function t(){if((new Date).getTime()-_>=l)null!==A.parentNode&&A.parentNode.removeChild(A),e(Error(l+"ms timeout exceeded"));else{var i=o.context.document.hidden;!0!==i&&void 0!==i||(y=m.g.offsetWidth,f=d.g.offsetWidth,g=p.g.offsetWidth,h()),c=setTimeout(t,50)}}(),n(m,function(t){y=t,h()}),s(m,u(o,'"'+o.family+'",sans-serif')),n(d,function(t){f=t,h()}),s(d,u(o,'"'+o.family+'",serif')),n(p,function(t){g=t,h()}),s(p,u(o,'"'+o.family+'",monospace'))})})},t.exports=r}()}},e={};function i(s){var o=e[s];if(void 0!==o)return o.exports;var n=e[s]={exports:{}};return t[s](n,n.exports,i),n.exports}i.n=t=>{var e=t&&t.__esModule?()=>t.default:()=>t;return i.d(e,{a:e}),e},i.d=(t,e)=>{for(var s in e)i.o(e,s)&&!i.o(t,s)&&Object.defineProperty(t,s,{enumerable:!0,get:e[s]})},i.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),i.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},(()=>{"use strict";var t={};i.r(t),i.d(t,{ONE_POINT:()=>r,ZERO_POINT:()=>n,createPoint:()=>o,deg2rad:()=>g,fetchXml:()=>y,getRandomInt:()=>m,lc:()=>h,lerp:()=>_,metersToPixels:()=>d,padRight:()=>c,pixelsToMeters:()=>p,pr:()=>l,rad2deg:()=>f,roundTo:()=>u,uc:()=>a});const e=window.PIXI;var s=i.n(e);const o=(t=0,i=0)=>new e.Point(t,i),n=()=>new e.Point(0,0),r=()=>new e.Point(1,1),a=(t="")=>t.toUpperCase(),h=(t="")=>t.toLowerCase(),c=(t="",e=0,i=" ")=>{let s=t+"";for(;s.length<e;)s+=i;return s},l=c,m=(t,e)=>Math.floor(Math.random()*(e+1-t))+t,u=(t,e)=>Math.round(e*Math.pow(10,t))/Math.pow(10,t),_=(t,e,i)=>(1-i)*t+i*e;function d(t){return 20*t}function p(t){return.05*t}const y=async t=>await(await fetch(t)).text(),f=t=>t*(180/Math.PI),g=t=>t*(Math.PI/180);class v{constructor(t,e){this.fitToWindow=!1,this.onResize=()=>{const{renderer:t,htmlRoot:e}=this,i=t.canvas,s=e.clientWidth,o=e.clientHeight,n=t.width,r=t.height,a=Math.min(s/n,o/r);i.style.width=`${Math.floor(n*a)}px`,i.style.height=`${Math.floor(r*a)}px`},this.htmlRoot=t,this.renderer=e,t.appendChild(this.renderer.canvas),window.addEventListener("resize",()=>this.onResize()),this.onResize()}render(t){this.renderer.render(t)}}function x(t){return null!=t&&"object"==typeof t&&"moxiEntity"in t}v.getRenderer=async t=>await s().autoDetectRenderer(t),v.create=async(t,e)=>new v(t,await v.getRenderer(e));class b extends s().Container{constructor(t){super(),this.renderer=t}init(){this.children.forEach(t=>{x(t)&&t.moxiEntity.init(this.renderer)})}update(t){this.children.forEach(e=>{x(e)&&e.moxiEntity.update(t)})}draw(t){this.renderer.render(this)}}class A{constructor(t=null){this.gameLoop=t=>{if(this.root){const{deltaTime:e,deltaMS:i}=t;if(this.physicsWorld){const t=i/1e3;this.physicsWorld.step(t)}this.root.update(e),this.root.draw(e)}},this.root=t;const e=s().Ticker.shared;e.autoStart=!1,e.add(this.gameLoop),this.ticker=e,this.loggerFrequencyMs=500,this.nextLogTime=0,this.logger=t=>null}start(){return this.ticker.start(),this}stop(){return this.ticker.stop(),this}addPhysicsWorld(t){return this.physicsWorld=t,this}loadStage(t){return this.root=t,this}}class w{constructor(){this.listeners={}}on(t,e){(this.listeners[t]||(this.listeners[t]=[])).push(e)}off(t,e){const i=this.listeners[t];i&&(this.listeners[t]=i.filter(t=>t!==e))}emit(t,...e){(this.listeners[t]||[]).forEach(t=>t(...e))}once(t,e){this.on(t,(...i)=>{e(...i),this.off(t,e)})}static getInstance(){return w.instance||(w.instance=new w),w.instance}}w.instance=null;class B{static getInstance(t={}){return B.instance||(B.instance=new B(t)),B.instance}constructor({initWheelOffset:t=new e.Point,onAnyEvent:i=t=>{}}={}){if(B.instance)return B.instance;this.wheelOffsets=t,this.keydown={},this.movePosition=new e.Point;const s=t=>{i(t)};document.addEventListener("wheel",t=>{const i=this.wheelOffsets||new e.Point,o=i.x+t.deltaX,n=i.y+t.deltaY;this.wheelOffsets=new e.Point(o,n),s({eventType:"wheel",event:t})}),document.addEventListener("mousemove",t=>{this.lastMovePosition=this.movePosition,this.movePosition=new e.Point(t.clientX,t.clientY),this.moveDelta=new e.Point(this.movePosition.x-this.lastMovePosition.x,this.movePosition.y-this.lastMovePosition.y),s({eventType:"mousemove",event:t})}),document.addEventListener("mousedown",t=>{this.mouseDownEvent=t,this.lastMouseDown=t,this.mouseUpEvent=null,s({eventType:"mousedown",event:t})}),document.addEventListener("mouseup",t=>{this.mouseUpEvent=t,this.lastMouseUp=t,this.mouseDownEvent=null,s({eventType:"mouseup",event:t})}),document.addEventListener("keydown",t=>{const{key:e}=t;this.keyDownEvent=t,this.keyUpEvent=null,this.keydown[e]=t,s({eventType:"keydown",event:t})}),document.addEventListener("keyup",t=>{const{key:e}=t;this.keyUpEvent=t,this.keyDownEvent=null,delete this.keydown[e],s({eventType:"keyup",event:t})}),B.instance=this}isKeyDown(t){return Boolean(this.keydown[t])}isKeyUp(t){return!this.keydown[t]}}B.instance=null;class C{constructor(){this.PIXIAssets=s().Assets,this.textures=[],this.isLoading=!1,this.events=new w,this.loadAssets=async t=>{const{PIXIAssets:e}=this,i=[];this.isLoading=!0,this.events.emit("loading:start");try{for(let s=0;s<t.length;s++){const{src:o,alias:n}=t[s];try{if(n){if(!e.cache.has(n)){const t=await e.load({alias:n,src:o});this.textures.push(t)}}else{const t=await e.load(o);this.textures.push(t)}}catch(t){console.error(`Failed to load asset: ${o}`,t),i.push(o)}}return i.length>0&&console.warn(`${i.length} asset(s) failed to load:`,i),this}finally{this.isLoading=!1,this.events.emit("loading:end")}}}on(t,e){this.events.on(t,e)}off(t,e){this.events.off(t,e)}}class S{constructor(){this.active=!0}init(t,e,...i){}update(t,e){}}class M{constructor(t,e={}){this.logic={},this.logic=e,this.entity=t}update(t){if(this.entity)for(const e in this.logic){const i=this.logic[e];i&&i.active&&i.update&&i.update(this.entity,t)}}init(t,...e){if(this.entity)for(const i in this.logic){const s=this.logic[i];s&&s.init&&s.init(this.entity,t,...e)}}addLogic(t){const e=t.name||t.constructor.name;this.logic[e]=t}getLogic(t){return this.logic[t]}}class P extends S{constructor(){super(...arguments),this.name="CameraLogic",this.speed=.1,this.target=null}init(t,e){this.entity=t,this.renderer=e}update(t,e){const{speed:i}=this,s=Math.min(e*i,1),o=Math.abs(t.scale.x-t.desiredScale.x)>.01||Math.abs(t.scale.y-t.desiredScale.y)>.01;if(t.desiredScale!==t.scale&&(t.scale.x=_(t.scale.x,t.desiredScale.x,s),t.scale.y=_(t.scale.y,t.desiredScale.y,s)),this.target){const e=this.renderer.width/2,i=this.renderer.height/2,s=-this.target.position.x*t.scale.x+e,o=-this.target.position.y*t.scale.y+i;t.desiredPosition.set(-s,-o)}t.desiredPosition!==t.position&&(o?t.position.copyFrom(t.desiredPosition):(t.position.x=_(t.position.x,t.desiredPosition.x,s),t.position.y=_(t.position.y,t.desiredPosition.y,s))),t.scene.scale.set(t.scale.x,t.scale.y),t.scene.position.set(-t.position.x,-t.position.y)}}class V extends s().Container{constructor(t,i,s={}){super(),this.speed=.1,this.desiredScale=new e.Point(1,1),this.desiredPosition=new e.Point(0,0),this.scene=t,this.renderer=i;const o=new P;o.init(this,i),this.moxiEntity=new M(this,s),this.moxiEntity.addLogic(o),this.scene.addChild(this)}}var I=function(t,e){return(I=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i])})(t,e)};function z(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function i(){this.constructor=t}I(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)}var T=function(){return T=Object.assign||function(t){for(var e,i=1,s=arguments.length;i<s;i++)for(var o in e=arguments[i])Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o]);return t},T.apply(this,arguments)},L=function(t,e){null==t&&(t={});var i=T({},t);for(var s in e)e.hasOwnProperty(s)&&void 0===t[s]&&(i[s]=e[s]);if("function"==typeof Object.getOwnPropertySymbols)for(var o=Object.getOwnPropertySymbols(e),n=0;n<o.length;n++){var r=o[n];e.propertyIsEnumerable(r)&&void 0===t[r]&&(i[r]=e[r])}return i},F=Math.random,k=1e-9,q=Number.isFinite;function N(t,e,i){return void 0===e?(i=1,e=0):void 0===i&&(i=e,e=0),i>e?(t=(t-e)%(i-e))+(t<0?i:e):(t=(t-i)%(e-i))+(t<=0?e:i)}function j(t,e,i){return t<e?e:t>i?i:t}var R=Object.create(Math);R.EPSILON=k,R.isFinite=q,R.nextPowerOfTwo=function(t){return t|=t>>1,t|=t>>2,t|=t>>4,t|=t>>8,1+(t|=t>>16)},R.isPowerOfTwo=function(t){return t>0&&!(t&t-1)},R.mod=N,R.clamp=j,R.random=function(t,e){return void 0===t?(e=1,t=0):void 0===e&&(e=t,t=0),t===e?t:F()*(e-t)+t};var E=Math.abs,O=Math.sqrt,D=Math.max,H=Math.min,Y=function(){function t(e,i){if(!(this instanceof t))return new t(e,i);void 0===e?(this.x=0,this.y=0):"object"==typeof e?(this.x=e.x,this.y=e.y):(this.x=e,this.y=i)}return t.prototype._serialize=function(){return{x:this.x,y:this.y}},t._deserialize=function(e){var i=Object.create(t.prototype);return i.x=e.x,i.y=e.y,i},t.zero=function(){var e=Object.create(t.prototype);return e.x=0,e.y=0,e},t.neo=function(e,i){var s=Object.create(t.prototype);return s.x=e,s.y=i,s},t.clone=function(e){return t.neo(e.x,e.y)},t.prototype.toString=function(){return JSON.stringify(this)},t.isValid=function(t){return null!=t&&Number.isFinite(t.x)&&Number.isFinite(t.y)},t.assert=function(t){},t.prototype.clone=function(){return t.clone(this)},t.prototype.setZero=function(){return this.x=0,this.y=0,this},t.prototype.set=function(t,e){return"object"==typeof t?(this.x=t.x,this.y=t.y):(this.x=t,this.y=e),this},t.prototype.setNum=function(t,e){return this.x=t,this.y=e,this},t.prototype.setVec2=function(t){return this.x=t.x,this.y=t.y,this},t.prototype.wSet=function(t,e,i,s){return void 0!==i||void 0!==s?this.setCombine(t,e,i,s):this.setMul(t,e)},t.prototype.setCombine=function(t,e,i,s){var o=t*e.x+i*s.x,n=t*e.y+i*s.y;return this.x=o,this.y=n,this},t.prototype.setMul=function(t,e){var i=t*e.x,s=t*e.y;return this.x=i,this.y=s,this},t.prototype.add=function(t){return this.x+=t.x,this.y+=t.y,this},t.prototype.wAdd=function(t,e,i,s){return void 0!==i||void 0!==s?this.addCombine(t,e,i,s):this.addMul(t,e)},t.prototype.addCombine=function(t,e,i,s){var o=t*e.x+i*s.x,n=t*e.y+i*s.y;return this.x+=o,this.y+=n,this},t.prototype.addMul=function(t,e){var i=t*e.x,s=t*e.y;return this.x+=i,this.y+=s,this},t.prototype.wSub=function(t,e,i,s){return void 0!==i||void 0!==s?this.subCombine(t,e,i,s):this.subMul(t,e)},t.prototype.subCombine=function(t,e,i,s){var o=t*e.x+i*s.x,n=t*e.y+i*s.y;return this.x-=o,this.y-=n,this},t.prototype.subMul=function(t,e){var i=t*e.x,s=t*e.y;return this.x-=i,this.y-=s,this},t.prototype.sub=function(t){return this.x-=t.x,this.y-=t.y,this},t.prototype.mul=function(t){return this.x*=t,this.y*=t,this},t.prototype.length=function(){return t.lengthOf(this)},t.prototype.lengthSquared=function(){return t.lengthSquared(this)},t.prototype.normalize=function(){var t=this.length();if(t<k)return 0;var e=1/t;return this.x*=e,this.y*=e,t},t.normalize=function(e){var i=t.lengthOf(e);if(i<k)return t.zero();var s=1/i;return t.neo(e.x*s,e.y*s)},t.lengthOf=function(t){return O(t.x*t.x+t.y*t.y)},t.lengthSquared=function(t){return t.x*t.x+t.y*t.y},t.distance=function(t,e){var i=t.x-e.x,s=t.y-e.y;return O(i*i+s*s)},t.distanceSquared=function(t,e){var i=t.x-e.x,s=t.y-e.y;return i*i+s*s},t.areEqual=function(t,e){return t===e||"object"==typeof e&&null!==e&&t.x===e.x&&t.y===e.y},t.skew=function(e){return t.neo(-e.y,e.x)},t.dot=function(t,e){return t.x*e.x+t.y*e.y},t.cross=function(e,i){return"number"==typeof i?t.neo(i*e.y,-i*e.x):"number"==typeof e?t.neo(-e*i.y,e*i.x):e.x*i.y-e.y*i.x},t.crossVec2Vec2=function(t,e){return t.x*e.y-t.y*e.x},t.crossVec2Num=function(e,i){return t.neo(i*e.y,-i*e.x)},t.crossNumVec2=function(e,i){return t.neo(-e*i.y,e*i.x)},t.addCross=function(e,i,s){return"number"==typeof s?t.neo(s*i.y+e.x,-s*i.x+e.y):"number"==typeof i?t.neo(-i*s.y+e.x,i*s.x+e.y):void 0},t.addCrossVec2Num=function(e,i,s){return t.neo(s*i.y+e.x,-s*i.x+e.y)},t.addCrossNumVec2=function(e,i,s){return t.neo(-i*s.y+e.x,i*s.x+e.y)},t.add=function(e,i){return t.neo(e.x+i.x,e.y+i.y)},t.wAdd=function(e,i,s,o){return void 0!==s||void 0!==o?t.combine(e,i,s,o):t.mulNumVec2(e,i)},t.combine=function(e,i,s,o){return t.zero().setCombine(e,i,s,o)},t.sub=function(e,i){return t.neo(e.x-i.x,e.y-i.y)},t.mul=function(e,i){return"object"==typeof e?t.neo(e.x*i,e.y*i):"object"==typeof i?t.neo(e*i.x,e*i.y):void 0},t.mulVec2Num=function(e,i){return t.neo(e.x*i,e.y*i)},t.mulNumVec2=function(e,i){return t.neo(e*i.x,e*i.y)},t.prototype.neg=function(){return this.x=-this.x,this.y=-this.y,this},t.neg=function(e){return t.neo(-e.x,-e.y)},t.abs=function(e){return t.neo(E(e.x),E(e.y))},t.mid=function(e,i){return t.neo(.5*(e.x+i.x),.5*(e.y+i.y))},t.upper=function(e,i){return t.neo(D(e.x,i.x),D(e.y,i.y))},t.lower=function(e,i){return t.neo(H(e.x,i.x),H(e.y,i.y))},t.prototype.clamp=function(t){var e=this.x*this.x+this.y*this.y;if(e>t*t){var i=t/O(e);this.x*=i,this.y*=i}return this},t.clamp=function(e,i){var s=t.neo(e.x,e.y);return s.clamp(i),s},t.clampVec2=function(t,e,i){return{x:j(t.x,null==e?void 0:e.x,null==i?void 0:i.x),y:j(t.y,null==e?void 0:e.y,null==i?void 0:i.y)}},t.scaleFn=function(e,i){return function(s){return t.neo(s.x*e,s.y*i)}},t.translateFn=function(e,i){return function(s){return t.neo(s.x+e,s.y+i)}},t}(),W=Math.max,U=Math.min,X=function(){function t(e,i){if(!(this instanceof t))return new t(e,i);this.lowerBound=Y.zero(),this.upperBound=Y.zero(),"object"==typeof e&&this.lowerBound.setVec2(e),"object"==typeof i?this.upperBound.setVec2(i):"object"==typeof e&&this.upperBound.setVec2(e)}return t.prototype.isValid=function(){return t.isValid(this)},t.isValid=function(t){return null!=t&&Y.isValid(t.lowerBound)&&Y.isValid(t.upperBound)&&Y.sub(t.upperBound,t.lowerBound).lengthSquared()>=0},t.assert=function(t){},t.prototype.getCenter=function(){return Y.neo(.5*(this.lowerBound.x+this.upperBound.x),.5*(this.lowerBound.y+this.upperBound.y))},t.prototype.getExtents=function(){return Y.neo(.5*(this.upperBound.x-this.lowerBound.x),.5*(this.upperBound.y-this.lowerBound.y))},t.prototype.getPerimeter=function(){return 2*(this.upperBound.x-this.lowerBound.x+this.upperBound.y-this.lowerBound.y)},t.prototype.combine=function(t,e){e=e||this;var i=t.lowerBound,s=t.upperBound,o=e.lowerBound,n=e.upperBound,r=U(i.x,o.x),a=U(i.y,o.y),h=W(n.x,s.x),c=W(n.y,s.y);this.lowerBound.setNum(r,a),this.upperBound.setNum(h,c)},t.prototype.combinePoints=function(t,e){this.lowerBound.setNum(U(t.x,e.x),U(t.y,e.y)),this.upperBound.setNum(W(t.x,e.x),W(t.y,e.y))},t.prototype.set=function(t){this.lowerBound.setNum(t.lowerBound.x,t.lowerBound.y),this.upperBound.setNum(t.upperBound.x,t.upperBound.y)},t.prototype.contains=function(t){var e=!0;return(e=(e=(e=e&&this.lowerBound.x<=t.lowerBound.x)&&this.lowerBound.y<=t.lowerBound.y)&&t.upperBound.x<=this.upperBound.x)&&t.upperBound.y<=this.upperBound.y},t.prototype.extend=function(e){return t.extend(this,e),this},t.extend=function(t,e){return t.lowerBound.x-=e,t.lowerBound.y-=e,t.upperBound.x+=e,t.upperBound.y+=e,t},t.testOverlap=function(t,e){var i=e.lowerBound.x-t.upperBound.x,s=t.lowerBound.x-e.upperBound.x,o=e.lowerBound.y-t.upperBound.y,n=t.lowerBound.y-e.upperBound.y;return!(i>0||o>0||s>0||n>0)},t.areEqual=function(t,e){return Y.areEqual(t.lowerBound,e.lowerBound)&&Y.areEqual(t.upperBound,e.upperBound)},t.diff=function(t,e){var i=W(0,U(t.upperBound.x,e.upperBound.x)-W(e.lowerBound.x,t.lowerBound.x)),s=W(0,U(t.upperBound.y,e.upperBound.y)-W(e.lowerBound.y,t.lowerBound.y));return(t.upperBound.x-t.lowerBound.x)*(t.upperBound.y-t.lowerBound.y)+(e.upperBound.x-e.lowerBound.x)*(e.upperBound.y-e.lowerBound.y)-i*s},t.prototype.rayCast=function(t,e){var i,s,o=-1/0,n=1/0,r=e.p1,a=Y.sub(e.p2,e.p1),h=Y.abs(a),c=Y.zero();if(h.x<k){if(r.x<this.lowerBound.x||this.upperBound.x<r.x)return!1}else{var l=1/a.x,m=-1;if((i=(this.lowerBound.x-r.x)*l)>(s=(this.upperBound.x-r.x)*l)){var u=i;i=s,s=u,m=1}if(i>o&&(c.setZero(),c.x=m,o=i),o>(n=U(n,s)))return!1}if(h.y<k){if(r.y<this.lowerBound.y||this.upperBound.y<r.y)return!1}else if(l=1/a.y,m=-1,(i=(this.lowerBound.y-r.y)*l)>(s=(this.upperBound.y-r.y)*l)&&(u=i,i=s,s=u,m=1),i>o&&(c.setZero(),c.y=m,o=i),o>(n=U(n,s)))return!1;return!(o<0||e.maxFraction<o||(t.fraction=o,t.normal=c,0))},t.prototype.toString=function(){return JSON.stringify(this)},t.combinePoints=function(t,e,i){return t.lowerBound.x=U(e.x,i.x),t.lowerBound.y=U(e.y,i.y),t.upperBound.x=W(e.x,i.x),t.upperBound.y=W(e.y,i.y),t},t.combinedPerimeter=function(t,e){var i=U(t.lowerBound.x,e.lowerBound.x),s=U(t.lowerBound.y,e.lowerBound.y);return 2*(W(t.upperBound.x,e.upperBound.x)-i+W(t.upperBound.y,e.upperBound.y)-s)},t}(),J=Math.PI,$=function(){function t(){}return Object.defineProperty(t,"polygonRadius",{get:function(){return 2*t.linearSlop},enumerable:!1,configurable:!0}),t.lengthUnitsPerMeter=1,t.maxManifoldPoints=2,t.maxPolygonVertices=12,t.aabbExtension=.1,t.aabbMultiplier=2,t.linearSlop=.005,t.angularSlop=2/180*J,t.maxSubSteps=8,t.maxTOIContacts=32,t.maxTOIIterations=20,t.maxDistanceIterations=20,t.velocityThreshold=1,t.maxLinearCorrection=.2,t.maxAngularCorrection=8/180*J,t.maxTranslation=2,t.maxRotation=.5*J,t.baumgarte=.2,t.toiBaugarte=.75,t.timeToSleep=.5,t.linearSleepTolerance=.01,t.angularSleepTolerance=2/180*J,t}(),G=function(){function t(){}return Object.defineProperty(t,"maxManifoldPoints",{get:function(){return $.maxManifoldPoints},enumerable:!1,configurable:!0}),Object.defineProperty(t,"maxPolygonVertices",{get:function(){return $.maxPolygonVertices},enumerable:!1,configurable:!0}),Object.defineProperty(t,"aabbExtension",{get:function(){return $.aabbExtension*$.lengthUnitsPerMeter},enumerable:!1,configurable:!0}),Object.defineProperty(t,"aabbMultiplier",{get:function(){return $.aabbMultiplier},enumerable:!1,configurable:!0}),Object.defineProperty(t,"linearSlop",{get:function(){return $.linearSlop*$.lengthUnitsPerMeter},enumerable:!1,configurable:!0}),Object.defineProperty(t,"linearSlopSquared",{get:function(){return $.linearSlop*$.lengthUnitsPerMeter*$.linearSlop*$.lengthUnitsPerMeter},enumerable:!1,configurable:!0}),Object.defineProperty(t,"angularSlop",{get:function(){return $.angularSlop},enumerable:!1,configurable:!0}),Object.defineProperty(t,"polygonRadius",{get:function(){return 2*$.linearSlop},enumerable:!1,configurable:!0}),Object.defineProperty(t,"maxSubSteps",{get:function(){return $.maxSubSteps},enumerable:!1,configurable:!0}),Object.defineProperty(t,"maxTOIContacts",{get:function(){return $.maxTOIContacts},enumerable:!1,configurable:!0}),Object.defineProperty(t,"maxTOIIterations",{get:function(){return $.maxTOIIterations},enumerable:!1,configurable:!0}),Object.defineProperty(t,"maxDistanceIterations",{get:function(){return $.maxDistanceIterations},enumerable:!1,configurable:!0}),Object.defineProperty(t,"velocityThreshold",{get:function(){return $.velocityThreshold*$.lengthUnitsPerMeter},enumerable:!1,configurable:!0}),Object.defineProperty(t,"maxLinearCorrection",{get:function(){return $.maxLinearCorrection*$.lengthUnitsPerMeter},enumerable:!1,configurable:!0}),Object.defineProperty(t,"maxAngularCorrection",{get:function(){return $.maxAngularCorrection},enumerable:!1,configurable:!0}),Object.defineProperty(t,"maxTranslation",{get:function(){return $.maxTranslation*$.lengthUnitsPerMeter},enumerable:!1,configurable:!0}),Object.defineProperty(t,"maxTranslationSquared",{get:function(){return $.maxTranslation*$.lengthUnitsPerMeter*$.maxTranslation*$.lengthUnitsPerMeter},enumerable:!1,configurable:!0}),Object.defineProperty(t,"maxRotation",{get:function(){return $.maxRotation},enumerable:!1,configurable:!0}),Object.defineProperty(t,"maxRotationSquared",{get:function(){return $.maxRotation*$.maxRotation},enumerable:!1,configurable:!0}),Object.defineProperty(t,"baumgarte",{get:function(){return $.baumgarte},enumerable:!1,configurable:!0}),Object.defineProperty(t,"toiBaugarte",{get:function(){return $.toiBaugarte},enumerable:!1,configurable:!0}),Object.defineProperty(t,"timeToSleep",{get:function(){return $.timeToSleep},enumerable:!1,configurable:!0}),Object.defineProperty(t,"linearSleepTolerance",{get:function(){return $.linearSleepTolerance*$.lengthUnitsPerMeter},enumerable:!1,configurable:!0}),Object.defineProperty(t,"linearSleepToleranceSqr",{get:function(){return $.linearSleepTolerance*$.lengthUnitsPerMeter*$.linearSleepTolerance*$.lengthUnitsPerMeter},enumerable:!1,configurable:!0}),Object.defineProperty(t,"angularSleepTolerance",{get:function(){return $.angularSleepTolerance},enumerable:!1,configurable:!0}),Object.defineProperty(t,"angularSleepToleranceSqr",{get:function(){return $.angularSleepTolerance*$.angularSleepTolerance},enumerable:!1,configurable:!0}),t}(),K=function(){function t(t){this._list=[],this._max=1/0,this._hasCreateFn=!1,this._createCount=0,this._hasAllocateFn=!1,this._allocateCount=0,this._hasReleaseFn=!1,this._releaseCount=0,this._hasDisposeFn=!1,this._disposeCount=0,this._list=[],this._max=t.max||this._max,this._createFn=t.create,this._hasCreateFn="function"==typeof this._createFn,this._allocateFn=t.allocate,this._hasAllocateFn="function"==typeof this._allocateFn,this._releaseFn=t.release,this._hasReleaseFn="function"==typeof this._releaseFn,this._disposeFn=t.dispose,this._hasDisposeFn="function"==typeof this._disposeFn}return t.prototype.max=function(t){return"number"==typeof t?(this._max=t,this):this._max},t.prototype.size=function(){return this._list.length},t.prototype.allocate=function(){var t;return this._list.length>0?t=this._list.shift():(this._createCount++,t=this._hasCreateFn?this._createFn():{}),this._allocateCount++,this._hasAllocateFn&&this._allocateFn(t),t},t.prototype.release=function(t){this._list.length<this._max?(this._releaseCount++,this._hasReleaseFn&&this._releaseFn(t),this._list.push(t)):(this._disposeCount++,this._hasDisposeFn&&(t=this._disposeFn(t)))},t.prototype.toString=function(){return" +"+this._createCount+" >"+this._allocateCount+" <"+this._releaseCount+" -"+this._disposeCount+" ="+this._list.length+"/"+this._max},t}(),Z=Math.abs,Q=Math.max,tt=function(){function t(t){this.aabb=new X,this.userData=null,this.parent=null,this.child1=null,this.child2=null,this.height=-1,this.id=t}return t.prototype.toString=function(){return this.id+": "+this.userData},t.prototype.isLeaf=function(){return null==this.child1},t}(),et=new K({create:function(){return new tt},release:function(t){t.userData=null,t.parent=null,t.child1=null,t.child2=null,t.height=-1,t.id=void 0}}),it=function(){function t(){this.inputPool=new K({create:function(){return{}},release:function(t){}}),this.stackPool=new K({create:function(){return[]},release:function(t){t.length=0}}),this.iteratorPool=new K({create:function(){return new st},release:function(t){t.close()}}),this.m_root=null,this.m_nodes={},this.m_lastProxyId=0}return t.prototype.getUserData=function(t){return this.m_nodes[t].userData},t.prototype.getFatAABB=function(t){return this.m_nodes[t].aabb},t.prototype.allocateNode=function(){var t=et.allocate();return t.id=++this.m_lastProxyId,this.m_nodes[t.id]=t,t},t.prototype.freeNode=function(t){delete this.m_nodes[t.id],et.release(t)},t.prototype.createProxy=function(t,e){var i=this.allocateNode();return i.aabb.set(t),X.extend(i.aabb,G.aabbExtension),i.userData=e,i.height=0,this.insertLeaf(i),i.id},t.prototype.destroyProxy=function(t){var e=this.m_nodes[t];this.removeLeaf(e),this.freeNode(e)},t.prototype.moveProxy=function(t,e,i){var s=this.m_nodes[t];return!s.aabb.contains(e)&&(this.removeLeaf(s),s.aabb.set(e),e=s.aabb,X.extend(e,G.aabbExtension),i.x<0?e.lowerBound.x+=i.x*G.aabbMultiplier:e.upperBound.x+=i.x*G.aabbMultiplier,i.y<0?e.lowerBound.y+=i.y*G.aabbMultiplier:e.upperBound.y+=i.y*G.aabbMultiplier,this.insertLeaf(s),!0)},t.prototype.insertLeaf=function(t){if(null==this.m_root)return this.m_root=t,void(this.m_root.parent=null);for(var e=t.aabb,i=this.m_root;!i.isLeaf();){var s=i.child1,o=i.child2,n=i.aabb.getPerimeter(),r=X.combinedPerimeter(i.aabb,e),a=2*r,h=2*(r-n),c=X.combinedPerimeter(e,s.aabb)+h;s.isLeaf()||(c-=s.aabb.getPerimeter());var l=X.combinedPerimeter(e,o.aabb)+h;if(o.isLeaf()||(l-=o.aabb.getPerimeter()),a<c&&a<l)break;i=c<l?s:o}var m=i,u=m.parent,_=this.allocateNode();for(_.parent=u,_.userData=null,_.aabb.combine(e,m.aabb),_.height=m.height+1,null!=u?(u.child1===m?u.child1=_:u.child2=_,_.child1=m,_.child2=t,m.parent=_,t.parent=_):(_.child1=m,_.child2=t,m.parent=_,t.parent=_,this.m_root=_),i=t.parent;null!=i;)s=(i=this.balance(i)).child1,o=i.child2,i.height=1+Q(s.height,o.height),i.aabb.combine(s.aabb,o.aabb),i=i.parent},t.prototype.removeLeaf=function(t){if(t!==this.m_root){var e,i=t.parent,s=i.parent;if(e=i.child1===t?i.child2:i.child1,null!=s){s.child1===i?s.child1=e:s.child2=e,e.parent=s,this.freeNode(i);for(var o=s;null!=o;){var n=(o=this.balance(o)).child1,r=o.child2;o.aabb.combine(n.aabb,r.aabb),o.height=1+Q(n.height,r.height),o=o.parent}}else this.m_root=e,e.parent=null,this.freeNode(i)}else this.m_root=null},t.prototype.balance=function(t){var e=t;if(e.isLeaf()||e.height<2)return t;var i=e.child1,s=e.child2,o=s.height-i.height;if(o>1){var n=s.child1,r=s.child2;return s.child1=e,s.parent=e.parent,e.parent=s,null!=s.parent?s.parent.child1===t?s.parent.child1=s:s.parent.child2=s:this.m_root=s,n.height>r.height?(s.child2=n,e.child2=r,r.parent=e,e.aabb.combine(i.aabb,r.aabb),s.aabb.combine(e.aabb,n.aabb),e.height=1+Q(i.height,r.height),s.height=1+Q(e.height,n.height)):(s.child2=r,e.child2=n,n.parent=e,e.aabb.combine(i.aabb,n.aabb),s.aabb.combine(e.aabb,r.aabb),e.height=1+Q(i.height,n.height),s.height=1+Q(e.height,r.height)),s}if(o<-1){var a=i.child1,h=i.child2;return i.child1=e,i.parent=e.parent,e.parent=i,null!=i.parent?i.parent.child1===e?i.parent.child1=i:i.parent.child2=i:this.m_root=i,a.height>h.height?(i.child2=a,e.child1=h,h.parent=e,e.aabb.combine(s.aabb,h.aabb),i.aabb.combine(e.aabb,a.aabb),e.height=1+Q(s.height,h.height),i.height=1+Q(e.height,a.height)):(i.child2=h,e.child1=a,a.parent=e,e.aabb.combine(s.aabb,a.aabb),i.aabb.combine(e.aabb,h.aabb),e.height=1+Q(s.height,a.height),i.height=1+Q(e.height,h.height)),i}return e},t.prototype.getHeight=function(){return null==this.m_root?0:this.m_root.height},t.prototype.getAreaRatio=function(){if(null==this.m_root)return 0;for(var t,e=this.m_root.aabb.getPerimeter(),i=0,s=this.iteratorPool.allocate().preorder(this.m_root);t=s.next();)t.height<0||(i+=t.aabb.getPerimeter());return this.iteratorPool.release(s),i/e},t.prototype.computeHeight=function(t){var e;if((e=void 0!==t?this.m_nodes[t]:this.m_root).isLeaf())return 0;var i=this.computeHeight(e.child1.id),s=this.computeHeight(e.child2.id);return 1+Q(i,s)},t.prototype.validateStructure=function(t){if(null!=t){this.m_root;var e=t.child1,i=t.child2;t.isLeaf()||(this.validateStructure(e),this.validateStructure(i))}},t.prototype.validateMetrics=function(t){if(null!=t){var e=t.child1,i=t.child2;t.isLeaf()||(this.validateMetrics(e),this.validateMetrics(i))}},t.prototype.validate=function(){},t.prototype.getMaxBalance=function(){for(var t,e=0,i=this.iteratorPool.allocate().preorder(this.m_root);t=i.next();)if(!(t.height<=1)){var s=Z(t.child2.height-t.child1.height);e=Q(e,s)}return this.iteratorPool.release(i),e},t.prototype.rebuildBottomUp=function(){for(var t,e=[],i=0,s=this.iteratorPool.allocate().preorder(this.m_root);t=s.next();)t.height<0||(t.isLeaf()?(t.parent=null,e[i]=t,++i):this.freeNode(t));for(this.iteratorPool.release(s);i>1;){for(var o=1/0,n=-1,r=-1,a=0;a<i;++a)for(var h=e[a].aabb,c=a+1;c<i;++c){var l=e[c].aabb,m=X.combinedPerimeter(h,l);m<o&&(n=a,r=c,o=m)}var u=e[n],_=e[r],d=this.allocateNode();d.child1=u,d.child2=_,d.height=1+Q(u.height,_.height),d.aabb.combine(u.aabb,_.aabb),d.parent=null,u.parent=d,_.parent=d,e[r]=e[i-1],e[n]=d,--i}this.m_root=e[0]},t.prototype.shiftOrigin=function(t){for(var e,i=this.iteratorPool.allocate().preorder(this.m_root);e=i.next();){var s=e.aabb;s.lowerBound.x-=t.x,s.lowerBound.y-=t.y,s.upperBound.x-=t.x,s.upperBound.y-=t.y}this.iteratorPool.release(i)},t.prototype.query=function(t,e){var i=this.stackPool.allocate();for(i.push(this.m_root);i.length>0;){var s=i.pop();if(null!=s&&X.testOverlap(s.aabb,t))if(s.isLeaf()){if(!1===e(s.id))return}else i.push(s.child1),i.push(s.child2)}this.stackPool.release(i)},t.prototype.rayCast=function(t,e){var i=t.p1,s=t.p2,o=Y.sub(s,i);o.normalize();var n=Y.crossNumVec2(1,o),r=Y.abs(n),a=t.maxFraction,h=new X,c=Y.combine(1-a,i,a,s);h.combinePoints(i,c);var l=this.stackPool.allocate(),m=this.inputPool.allocate();for(l.push(this.m_root);l.length>0;){var u=l.pop();if(null!=u&&!1!==X.testOverlap(u.aabb,h)){var _=u.aabb.getCenter(),d=u.aabb.getExtents();if(!(Z(Y.dot(n,Y.sub(i,_)))-Y.dot(r,d)>0))if(u.isLeaf()){m.p1=Y.clone(t.p1),m.p2=Y.clone(t.p2),m.maxFraction=a;var p=e(m,u.id);if(0===p)break;p>0&&(a=p,c=Y.combine(1-a,i,a,s),h.combinePoints(i,c))}else l.push(u.child1),l.push(u.child2)}}this.stackPool.release(l),this.inputPool.release(m)},t}(),st=function(){function t(){this.parents=[],this.states=[]}return t.prototype.preorder=function(t){return this.parents.length=0,this.parents.push(t),this.states.length=0,this.states.push(0),this},t.prototype.next=function(){for(;this.parents.length>0;){var t=this.parents.length-1,e=this.parents[t];if(0===this.states[t])return this.states[t]=1,e;if(1===this.states[t]&&(this.states[t]=2,e.child1))return this.parents.push(e.child1),this.states.push(1),e.child1;if(2===this.states[t]&&(this.states[t]=3,e.child2))return this.parents.push(e.child2),this.states.push(1),e.child2;this.parents.pop(),this.states.pop()}},t.prototype.close=function(){this.parents.length=0},t}(),ot=Math.max,nt=Math.min,rt=function(){function t(){var t=this;this.m_tree=new it,this.m_moveBuffer=[],this.query=function(e,i){t.m_tree.query(e,i)},this.queryCallback=function(e){if(e===t.m_queryProxyId)return!0;var i=nt(e,t.m_queryProxyId),s=ot(e,t.m_queryProxyId),o=t.m_tree.getUserData(i),n=t.m_tree.getUserData(s);return t.m_callback(o,n),!0}}return t.prototype.getUserData=function(t){return this.m_tree.getUserData(t)},t.prototype.testOverlap=function(t,e){var i=this.m_tree.getFatAABB(t),s=this.m_tree.getFatAABB(e);return X.testOverlap(i,s)},t.prototype.getFatAABB=function(t){return this.m_tree.getFatAABB(t)},t.prototype.getProxyCount=function(){return this.m_moveBuffer.length},t.prototype.getTreeHeight=function(){return this.m_tree.getHeight()},t.prototype.getTreeBalance=function(){return this.m_tree.getMaxBalance()},t.prototype.getTreeQuality=function(){return this.m_tree.getAreaRatio()},t.prototype.rayCast=function(t,e){this.m_tree.rayCast(t,e)},t.prototype.shiftOrigin=function(t){this.m_tree.shiftOrigin(t)},t.prototype.createProxy=function(t,e){var i=this.m_tree.createProxy(t,e);return this.bufferMove(i),i},t.prototype.destroyProxy=function(t){this.unbufferMove(t),this.m_tree.destroyProxy(t)},t.prototype.moveProxy=function(t,e,i){this.m_tree.moveProxy(t,e,i)&&this.bufferMove(t)},t.prototype.touchProxy=function(t){this.bufferMove(t)},t.prototype.bufferMove=function(t){this.m_moveBuffer.push(t)},t.prototype.unbufferMove=function(t){for(var e=0;e<this.m_moveBuffer.length;++e)this.m_moveBuffer[e]===t&&(this.m_moveBuffer[e]=null)},t.prototype.updatePairs=function(t){for(this.m_callback=t;this.m_moveBuffer.length>0;)if(this.m_queryProxyId=this.m_moveBuffer.pop(),null!==this.m_queryProxyId){var e=this.m_tree.getFatAABB(this.m_queryProxyId);this.m_tree.query(e,this.queryCallback)}},t}(),at=Math.sin,ht=Math.cos,ct=Math.sqrt;function lt(t,e){return{x:t,y:e}}function mt(t,e,i){return t.x=e,t.y=i,t}function ut(t,e){return t.x=e.x,t.y=e.y,t}function _t(t){return t.x=0,t.y=0,t}function dt(t){return t.x=-t.x,t.y=-t.y,t}function pt(t,e){return t.x+=e.x,t.y+=e.y,t}function yt(t,e){return t.x-=e.x,t.y-=e.y,t}function ft(t,e,i){return t.x=e.x-i.x,t.y=e.y-i.y,t}function gt(t,e){return t.x*=e,t.y*=e,t}function vt(t,e,i){return t.x=e*i.x,t.y=e*i.y,t}function xt(t,e,i){return t.x+=e*i.x,t.y+=e*i.y,t}function bt(t,e,i){return t.x-=e*i.x,t.y-=e*i.y,t}function At(t,e,i,s,o){return t.x=e*i.x+s*o.x,t.y=e*i.y+s*o.y,t}function wt(t,e,i,s,o,n,r){return t.x=e*i.x+s*o.x+n*r.x,t.y=e*i.y+s*o.y+n*r.y,t}function Bt(t){var e=ct(t.x*t.x+t.y*t.y);if(e>0){var i=1/e;t.x*=i,t.y*=i}return t}function Ct(t,e,i){var s=i*e.y,o=-i*e.x;return t.x=s,t.y=o,t}function St(t,e,i){var s=-e*i.y,o=e*i.x;return t.x=s,t.y=o,t}function Mt(t,e){return t.x*e.y-t.y*e.x}function Pt(t,e){return t.x*e.x+t.y*e.y}function Vt(t){return t.x*t.x+t.y*t.y}function It(t,e){var i=t.x-e.x,s=t.y-e.y;return ct(i*i+s*s)}function zt(t,e){var i=t.x-e.x,s=t.y-e.y;return i*i+s*s}function Tt(t,e,i){return t.x=e.c*i.x-e.s*i.y,t.y=e.s*i.x+e.c*i.y,t}function Lt(t,e,i){var s=e.c*i.x+e.s*i.y,o=-e.s*i.x+e.c*i.y;return t.x=s,t.y=o,t}function Ft(t,e,i){return{p:lt(t,e),q:(s=i,{s:at(s),c:ht(s)})};var s}function kt(t,e){return t.p.x=e.p.x,t.p.y=e.p.y,t.q.s=e.q.s,t.q.c=e.q.c,t}function qt(t,e,i){var s=e.q.c*i.x-e.q.s*i.y+e.p.x,o=e.q.s*i.x+e.q.c*i.y+e.p.y;return t.x=s,t.y=o,t}function Nt(t,e,i){var s=i.x-e.p.x,o=i.y-e.p.y,n=e.q.c*s+e.q.s*o,r=-e.q.s*s+e.q.c*o;return t.x=n,t.y=r,t}function jt(t,e,i,s){var o=e.q.c*s.x-e.q.s*s.y+e.p.x,n=e.q.s*s.x+e.q.c*s.y+e.p.y,r=o-i.p.x,a=n-i.p.y,h=i.q.c*r+i.q.s*a,c=-i.q.s*r+i.q.c*a;return t.x=h,t.y=c,t}function Rt(t,e,i){var s=e.q.c*i.q.c+e.q.s*i.q.s,o=e.q.c*i.q.s-e.q.s*i.q.c,n=e.q.c*(i.p.x-e.p.x)+e.q.s*(i.p.y-e.p.y),r=-e.q.s*(i.p.x-e.p.x)+e.q.c*(i.p.y-e.p.y);return t.q.c=s,t.q.s=o,t.p.x=n,t.p.y=r,t}var Et=Math.sin,Ot=Math.cos,Dt=Math.atan2,Ht=function(){function t(e){if(!(this instanceof t))return new t(e);"number"==typeof e?this.setAngle(e):"object"==typeof e?this.setRot(e):this.setIdentity()}return t.neo=function(e){var i=Object.create(t.prototype);return i.setAngle(e),i},t.clone=function(e){var i=Object.create(t.prototype);return i.s=e.s,i.c=e.c,i},t.identity=function(){var e=Object.create(t.prototype);return e.s=0,e.c=1,e},t.isValid=function(t){return null!=t&&Number.isFinite(t.s)&&Number.isFinite(t.c)},t.assert=function(t){},t.prototype.setIdentity=function(){this.s=0,this.c=1},t.prototype.set=function(t){"object"==typeof t?(this.s=t.s,this.c=t.c):(this.s=Et(t),this.c=Ot(t))},t.prototype.setRot=function(t){this.s=t.s,this.c=t.c},t.prototype.setAngle=function(t){this.s=Et(t),this.c=Ot(t)},t.prototype.getAngle=function(){return Dt(this.s,this.c)},t.prototype.getXAxis=function(){return Y.neo(this.c,this.s)},t.prototype.getYAxis=function(){return Y.neo(-this.s,this.c)},t.mul=function(e,i){if("c"in i&&"s"in i){var s=t.identity();return s.s=e.s*i.c+e.c*i.s,s.c=e.c*i.c-e.s*i.s,s}if("x"in i&&"y"in i)return Y.neo(e.c*i.x-e.s*i.y,e.s*i.x+e.c*i.y)},t.mulRot=function(e,i){var s=t.identity();return s.s=e.s*i.c+e.c*i.s,s.c=e.c*i.c-e.s*i.s,s},t.mulVec2=function(t,e){return Y.neo(t.c*e.x-t.s*e.y,t.s*e.x+t.c*e.y)},t.mulSub=function(t,e,i){var s=t.c*(e.x-i.x)-t.s*(e.y-i.y),o=t.s*(e.x-i.x)+t.c*(e.y-i.y);return Y.neo(s,o)},t.mulT=function(e,i){if("c"in i&&"s"in i){var s=t.identity();return s.s=e.c*i.s-e.s*i.c,s.c=e.c*i.c+e.s*i.s,s}if("x"in i&&"y"in i)return Y.neo(e.c*i.x+e.s*i.y,-e.s*i.x+e.c*i.y)},t.mulTRot=function(e,i){var s=t.identity();return s.s=e.c*i.s-e.s*i.c,s.c=e.c*i.c+e.s*i.s,s},t.mulTVec2=function(t,e){return Y.neo(t.c*e.x+t.s*e.y,-t.s*e.x+t.c*e.y)},t}(),Yt=Math.atan2,Wt=Math.PI,Ut=lt(0,0),Xt=function(){function t(){this.localCenter=Y.zero(),this.c=Y.zero(),this.a=0,this.alpha0=0,this.c0=Y.zero(),this.a0=0}return t.prototype.recycle=function(){_t(this.localCenter),_t(this.c),this.a=0,this.alpha0=0,_t(this.c0),this.a0=0},t.prototype.setTransform=function(t){qt(Ut,t,this.localCenter),ut(this.c,Ut),ut(this.c0,Ut),this.a=this.a0=Yt(t.q.s,t.q.c)},t.prototype.setLocalCenter=function(t,e){ut(this.localCenter,t),qt(Ut,e,this.localCenter),ut(this.c,Ut),ut(this.c0,Ut)},t.prototype.getTransform=function(t,e){var i,s;void 0===e&&(e=0),i=t.q,s=(1-e)*this.a0+e*this.a,i.c=ht(s),i.s=at(s),At(t.p,1-e,this.c0,e,this.c),yt(t.p,Tt(Ut,t.q,this.localCenter))},t.prototype.advance=function(t){var e=(t-this.alpha0)/(1-this.alpha0);At(this.c0,e,this.c,1-e,this.c0),this.a0=e*this.a+(1-e)*this.a0,this.alpha0=t},t.prototype.forward=function(){this.a0=this.a,ut(this.c0,this.c)},t.prototype.normalize=function(){var t=N(this.a0,-Wt,+Wt);this.a-=this.a0-t,this.a0=t},t.prototype.set=function(t){ut(this.localCenter,t.localCenter),ut(this.c,t.c),this.a=t.a,this.alpha0=t.alpha0,ut(this.c0,t.c0),this.a0=t.a0},t}(),Jt=function(){function t(e,i){if(!(this instanceof t))return new t(e,i);this.p=Y.zero(),this.q=Ht.identity(),void 0!==e&&this.p.setVec2(e),void 0!==i&&this.q.setAngle(i)}return t.clone=function(e){var i=Object.create(t.prototype);return i.p=Y.clone(e.p),i.q=Ht.clone(e.q),i},t.neo=function(e,i){var s=Object.create(t.prototype);return s.p=Y.clone(e),s.q=Ht.clone(i),s},t.identity=function(){var e=Object.create(t.prototype);return e.p=Y.zero(),e.q=Ht.identity(),e},t.prototype.setIdentity=function(){this.p.setZero(),this.q.setIdentity()},t.prototype.set=function(t,e){void 0===e?(this.p.set(t.p),this.q.set(t.q)):(this.p.set(t),this.q.set(e))},t.prototype.setNum=function(t,e){this.p.setVec2(t),this.q.setAngle(e)},t.prototype.setTransform=function(t){this.p.setVec2(t.p),this.q.setRot(t.q)},t.isValid=function(t){return null!=t&&Y.isValid(t.p)&&Ht.isValid(t.q)},t.assert=function(t){},t.mul=function(e,i){if(Array.isArray(i)){for(var s=[],o=0;o<i.length;o++)s[o]=t.mul(e,i[o]);return s}return"x"in i&&"y"in i?t.mulVec2(e,i):"p"in i&&"q"in i?t.mulXf(e,i):void 0},t.mulAll=function(e,i){for(var s=[],o=0;o<i.length;o++)s[o]=t.mul(e,i[o]);return s},t.mulFn=function(e){return function(i){return t.mul(e,i)}},t.mulVec2=function(t,e){var i=t.q.c*e.x-t.q.s*e.y+t.p.x,s=t.q.s*e.x+t.q.c*e.y+t.p.y;return Y.neo(i,s)},t.mulXf=function(e,i){var s=t.identity();return s.q=Ht.mulRot(e.q,i.q),s.p=Y.add(Ht.mulVec2(e.q,i.p),e.p),s},t.mulT=function(e,i){return"x"in i&&"y"in i?t.mulTVec2(e,i):"p"in i&&"q"in i?t.mulTXf(e,i):void 0},t.mulTVec2=function(t,e){var i=e.x-t.p.x,s=e.y-t.p.y,o=t.q.c*i+t.q.s*s,n=-t.q.s*i+t.q.c*s;return Y.neo(o,n)},t.mulTXf=function(e,i){var s=t.identity();return s.q.setRot(Ht.mulTRot(e.q,i.q)),s.p.setVec2(Ht.mulTVec2(e.q,Y.sub(i.p,e.p))),s},t}(),$t=function(){return function(){this.v=Y.zero(),this.w=0}}(),Gt=Math.sin,Kt=Math.cos,Zt=function(){function t(){this.c=Y.zero(),this.a=0}return t.prototype.getTransform=function(t,e){return t.q.c=Kt(this.a),t.q.s=Gt(this.a),t.p.x=this.c.x-(t.q.c*e.x-t.q.s*e.y),t.p.y=this.c.y-(t.q.s*e.x+t.q.c*e.y),t},t}();function Qt(t,e,i,s){return t.q.c=Kt(s),t.q.s=Gt(s),t.p.x=i.x-(t.q.c*e.x-t.q.s*e.y),t.p.y=i.y-(t.q.s*e.x+t.q.c*e.y),t}var te=function(){function t(){this.style={},this.appData={}}return t.isValid=function(t){return null!=t&&"string"==typeof t.m_type&&"number"==typeof t.m_radius},t}(),ee=new X,ie=new X,se=lt(0,0),oe={userData:null,friction:.2,restitution:0,density:0,isSensor:!1,filterGroupIndex:0,filterCategoryBits:1,filterMaskBits:65535},ne=function(){return function(t,e){this.aabb=new X,this.fixture=t,this.childIndex=e}}(),re=function(){function t(t,e,i){this.style={},this.appData={},e.shape?(i=e,e=e.shape):"number"==typeof i&&(i={density:i}),i=L(i,oe),this.m_body=t,this.m_friction=i.friction,this.m_restitution=i.restitution,this.m_density=i.density,this.m_isSensor=i.isSensor,this.m_filterGroupIndex=i.filterGroupIndex,this.m_filterCategoryBits=i.filterCategoryBits,this.m_filterMaskBits=i.filterMaskBits,this.m_shape=e,this.m_next=null,this.m_proxies=[],this.m_proxyCount=0;for(var s=this.m_shape.getChildCount(),o=0;o<s;++o)this.m_proxies[o]=new ne(this,o);this.m_userData=i.userData,"object"==typeof i.style&&null!==i.style&&(this.style=i.style)}return t.prototype._reset=function(){var t=this.getBody(),e=t.m_world.m_broadPhase;this.destroyProxies(e),this.m_shape._reset&&this.m_shape._reset();for(var i=this.m_shape.getChildCount(),s=0;s<i;++s)this.m_proxies[s]=new ne(this,s);this.createProxies(e,t.m_xf),t.resetMassData()},t.prototype._serialize=function(){return{friction:this.m_friction,restitution:this.m_restitution,density:this.m_density,isSensor:this.m_isSensor,filterGroupIndex:this.m_filterGroupIndex,filterCategoryBits:this.m_filterCategoryBits,filterMaskBits:this.m_filterMaskBits,shape:this.m_shape}},t._deserialize=function(e,i,s){var o=s(te,e.shape);return o&&new t(i,o,e)},t.prototype.getType=function(){return this.m_shape.m_type},t.prototype.getShape=function(){return this.m_shape},t.prototype.isSensor=function(){return this.m_isSensor},t.prototype.setSensor=function(t){t!=this.m_isSensor&&(this.m_body.setAwake(!0),this.m_isSensor=t)},t.prototype.getUserData=function(){return this.m_userData},t.prototype.setUserData=function(t){this.m_userData=t},t.prototype.getBody=function(){return this.m_body},t.prototype.getNext=function(){return this.m_next},t.prototype.getDensity=function(){return this.m_density},t.prototype.setDensity=function(t){this.m_density=t},t.prototype.getFriction=function(){return this.m_friction},t.prototype.setFriction=function(t){this.m_friction=t},t.prototype.getRestitution=function(){return this.m_restitution},t.prototype.setRestitution=function(t){this.m_restitution=t},t.prototype.testPoint=function(t){return this.m_shape.testPoint(this.m_body.getTransform(),t)},t.prototype.rayCast=function(t,e,i){return this.m_shape.rayCast(t,e,this.m_body.getTransform(),i)},t.prototype.getMassData=function(t){this.m_shape.computeMass(t,this.m_density)},t.prototype.getAABB=function(t){return this.m_proxies[t].aabb},t.prototype.createProxies=function(t,e){this.m_proxyCount=this.m_shape.getChildCount();for(var i=0;i<this.m_proxyCount;++i){var s=this.m_proxies[i];this.m_shape.computeAABB(s.aabb,e,i),s.proxyId=t.createProxy(s.aabb,s)}},t.prototype.destroyProxies=function(t){for(var e=0;e<this.m_proxyCount;++e){var i=this.m_proxies[e];t.destroyProxy(i.proxyId),i.proxyId=null}this.m_proxyCount=0},t.prototype.synchronize=function(t,e,i){for(var s=0;s<this.m_proxyCount;++s){var o=this.m_proxies[s];this.m_shape.computeAABB(ee,e,o.childIndex),this.m_shape.computeAABB(ie,i,o.childIndex),o.aabb.combine(ee,ie),ft(se,i.p,e.p),t.moveProxy(o.proxyId,o.aabb,se)}},t.prototype.setFilterData=function(t){this.m_filterGroupIndex=t.groupIndex,this.m_filterCategoryBits=t.categoryBits,this.m_filterMaskBits=t.maskBits,this.refilter()},t.prototype.getFilterGroupIndex=function(){return this.m_filterGroupIndex},t.prototype.setFilterGroupIndex=function(t){this.m_filterGroupIndex=t,this.refilter()},t.prototype.getFilterCategoryBits=function(){return this.m_filterCategoryBits},t.prototype.setFilterCategoryBits=function(t){this.m_filterCategoryBits=t,this.refilter()},t.prototype.getFilterMaskBits=function(){return this.m_filterMaskBits},t.prototype.setFilterMaskBits=function(t){this.m_filterMaskBits=t,this.refilter()},t.prototype.refilter=function(){if(null!=this.m_body){for(var t=this.m_body.getContactList();t;){var e=t.contact,i=e.getFixtureA(),s=e.getFixtureB();i!=this&&s!=this||e.flagForFiltering(),t=t.next}var o=this.m_body.getWorld();if(null!=o)for(var n=o.m_broadPhase,r=0;r<this.m_proxyCount;++r)n.touchProxy(this.m_proxies[r].proxyId)}},t.prototype.shouldCollide=function(t){if(t.m_filterGroupIndex===this.m_filterGroupIndex&&0!==t.m_filterGroupIndex)return t.m_filterGroupIndex>0;var e=0!==(t.m_filterMaskBits&this.m_filterCategoryBits),i=0!==(t.m_filterCategoryBits&this.m_filterMaskBits);return e&&i},t}(),ae="static",he="kinematic",ce="dynamic",le=lt(0,0),me=lt(0,0),ue=lt(0,0),_e=lt(0,0),de=Ft(0,0,0),pe={type:ae,position:Y.zero(),angle:0,linearVelocity:Y.zero(),angularVelocity:0,linearDamping:0,angularDamping:0,fixedRotation:!1,bullet:!1,gravityScale:1,allowSleep:!0,awake:!0,active:!0,userData:null},ye=function(){function t(t,e){this.style={},this.appData={},e=L(e,pe),this.m_world=t,this.m_awakeFlag=e.awake,this.m_autoSleepFlag=e.allowSleep,this.m_bulletFlag=e.bullet,this.m_fixedRotationFlag=e.fixedRotation,this.m_activeFlag=e.active,this.m_islandFlag=!1,this.m_toiFlag=!1,this.m_userData=e.userData,this.m_type=e.type,this.m_type==ce?(this.m_mass=1,this.m_invMass=1):(this.m_mass=0,this.m_invMass=0),this.m_I=0,this.m_invI=0,this.m_xf=Jt.identity(),this.m_xf.p.setVec2(e.position),this.m_xf.q.setAngle(e.angle),this.m_sweep=new Xt,this.m_sweep.setTransform(this.m_xf),this.c_velocity=new $t,this.c_position=new Zt,this.m_force=Y.zero(),this.m_torque=0,this.m_linearVelocity=Y.clone(e.linearVelocity),this.m_angularVelocity=e.angularVelocity,this.m_linearDamping=e.linearDamping,this.m_angularDamping=e.angularDamping,this.m_gravityScale=e.gravityScale,this.m_sleepTime=0,this.m_jointList=null,this.m_contactList=null,this.m_fixtureList=null,this.m_prev=null,this.m_next=null,this.m_destroyed=!1,"object"==typeof e.style&&null!==e.style&&(this.style=e.style)}return t.prototype._serialize=function(){for(var t=[],e=this.m_fixtureList;e;e=e.m_next)t.push(e);return{type:this.m_type,bullet:this.m_bulletFlag,position:this.m_xf.p,angle:this.m_xf.q.getAngle(),linearVelocity:this.m_linearVelocity,angularVelocity:this.m_angularVelocity,fixtures:t}},t._deserialize=function(e,i,s){var o=new t(i,e);if(e.fixtures)for(var n=e.fixtures.length-1;n>=0;n--){var r=s(re,e.fixtures[n],o);o._addFixture(r)}return o},t.prototype.isWorldLocked=function(){return!(!this.m_world||!this.m_world.isLocked())},t.prototype.getWorld=function(){return this.m_world},t.prototype.getNext=function(){return this.m_next},t.prototype.setUserData=function(t){this.m_userData=t},t.prototype.getUserData=function(){return this.m_userData},t.prototype.getFixtureList=function(){return this.m_fixtureList},t.prototype.getJointList=function(){return this.m_jointList},t.prototype.getContactList=function(){return this.m_contactList},t.prototype.isStatic=function(){return this.m_type==ae},t.prototype.isDynamic=function(){return this.m_type==ce},t.prototype.isKinematic=function(){return this.m_type==he},t.prototype.setStatic=function(){return this.setType(ae),this},t.prototype.setDynamic=function(){return this.setType(ce),this},t.prototype.setKinematic=function(){return this.setType(he),this},t.prototype.getType=function(){return this.m_type},t.prototype.setType=function(t){if(1!=this.isWorldLocked()&&this.m_type!=t){this.m_type=t,this.resetMassData(),this.m_type==ae&&(this.m_linearVelocity.setZero(),this.m_angularVelocity=0,this.m_sweep.forward(),this.synchronizeFixtures()),this.setAwake(!0),this.m_force.setZero(),this.m_torque=0;for(var e=this.m_contactList;e;){var i=e;e=e.next,this.m_world.destroyContact(i.contact)}this.m_contactList=null;for(var s=this.m_world.m_broadPhase,o=this.m_fixtureList;o;o=o.m_next)for(var n=0;n<o.m_proxyCount;++n)s.touchProxy(o.m_proxies[n].proxyId)}},t.prototype.isBullet=function(){return this.m_bulletFlag},t.prototype.setBullet=function(t){this.m_bulletFlag=!!t},t.prototype.isSleepingAllowed=function(){return this.m_autoSleepFlag},t.prototype.setSleepingAllowed=function(t){this.m_autoSleepFlag=!!t,0==this.m_autoSleepFlag&&this.setAwake(!0)},t.prototype.isAwake=function(){return this.m_awakeFlag},t.prototype.setAwake=function(t){t?(this.m_awakeFlag=!0,this.m_sleepTime=0):(this.m_awakeFlag=!1,this.m_sleepTime=0,this.m_linearVelocity.setZero(),this.m_angularVelocity=0,this.m_force.setZero(),this.m_torque=0)},t.prototype.isActive=function(){return this.m_activeFlag},t.prototype.setActive=function(t){if(t!=this.m_activeFlag)if(this.m_activeFlag=!!t,this.m_activeFlag){for(var e=this.m_world.m_broadPhase,i=this.m_fixtureList;i;i=i.m_next)i.createProxies(e,this.m_xf);this.m_world.m_newFixture=!0}else{for(e=this.m_world.m_broadPhase,i=this.m_fixtureList;i;i=i.m_next)i.destroyProxies(e);for(var s=this.m_contactList;s;){var o=s;s=s.next,this.m_world.destroyContact(o.contact)}this.m_contactList=null}},t.prototype.isFixedRotation=function(){return this.m_fixedRotationFlag},t.prototype.setFixedRotation=function(t){this.m_fixedRotationFlag!=t&&(this.m_fixedRotationFlag=!!t,this.m_angularVelocity=0,this.resetMassData())},t.prototype.getTransform=function(){return this.m_xf},t.prototype.setTransform=function(t,e){if(1!=this.isWorldLocked()){"number"==typeof e?this.m_xf.setNum(t,e):this.m_xf.setTransform(t),this.m_sweep.setTransform(this.m_xf);for(var i=this.m_world.m_broadPhase,s=this.m_fixtureList;s;s=s.m_next)s.synchronize(i,this.m_xf,this.m_xf);this.setAwake(!0)}},t.prototype.synchronizeTransform=function(){this.m_sweep.getTransform(this.m_xf,1)},t.prototype.synchronizeFixtures=function(){this.m_sweep.getTransform(de,0);for(var t=this.m_world.m_broadPhase,e=this.m_fixtureList;e;e=e.m_next)e.synchronize(t,de,this.m_xf)},t.prototype.advance=function(t){this.m_sweep.advance(t),ut(this.m_sweep.c,this.m_sweep.c0),this.m_sweep.a=this.m_sweep.a0,this.m_sweep.getTransform(this.m_xf,1)},t.prototype.getPosition=function(){return this.m_xf.p},t.prototype.setPosition=function(t){this.setTransform(t,this.m_sweep.a)},t.prototype.getAngle=function(){return this.m_sweep.a},t.prototype.setAngle=function(t){this.setTransform(this.m_xf.p,t)},t.prototype.getWorldCenter=function(){return this.m_sweep.c},t.prototype.getLocalCenter=function(){return this.m_sweep.localCenter},t.prototype.getLinearVelocity=function(){return this.m_linearVelocity},t.prototype.getLinearVelocityFromWorldPoint=function(t){var e=Y.sub(t,this.m_sweep.c);return Y.add(this.m_linearVelocity,Y.crossNumVec2(this.m_angularVelocity,e))},t.prototype.getLinearVelocityFromLocalPoint=function(t){return this.getLinearVelocityFromWorldPoint(this.getWorldPoint(t))},t.prototype.setLinearVelocity=function(t){this.m_type!=ae&&(Y.dot(t,t)>0&&this.setAwake(!0),this.m_linearVelocity.setVec2(t))},t.prototype.getAngularVelocity=function(){return this.m_angularVelocity},t.prototype.setAngularVelocity=function(t){this.m_type!=ae&&(t*t>0&&this.setAwake(!0),this.m_angularVelocity=t)},t.prototype.getLinearDamping=function(){return this.m_linearDamping},t.prototype.setLinearDamping=function(t){this.m_linearDamping=t},t.prototype.getAngularDamping=function(){return this.m_angularDamping},t.prototype.setAngularDamping=function(t){this.m_angularDamping=t},t.prototype.getGravityScale=function(){return this.m_gravityScale},t.prototype.setGravityScale=function(t){this.m_gravityScale=t},t.prototype.getMass=function(){return this.m_mass},t.prototype.getInertia=function(){return this.m_I+this.m_mass*Y.dot(this.m_sweep.localCenter,this.m_sweep.localCenter)},t.prototype.getMassData=function(t){t.mass=this.m_mass,t.I=this.getInertia(),ut(t.center,this.m_sweep.localCenter)},t.prototype.resetMassData=function(){if(this.m_mass=0,this.m_invMass=0,this.m_I=0,this.m_invI=0,_t(this.m_sweep.localCenter),this.isStatic()||this.isKinematic())return ut(this.m_sweep.c0,this.m_xf.p),ut(this.m_sweep.c,this.m_xf.p),void(this.m_sweep.a0=this.m_sweep.a);_t(me);for(var t=this.m_fixtureList;t;t=t.m_next)if(0!=t.m_density){var e={mass:0,center:lt(0,0),I:0};t.getMassData(e),this.m_mass+=e.mass,xt(me,e.mass,e.center),this.m_I+=e.I}this.m_mass>0?(this.m_invMass=1/this.m_mass,vt(me,this.m_invMass,me)):(this.m_mass=1,this.m_invMass=1),this.m_I>0&&0==this.m_fixedRotationFlag?(this.m_I-=this.m_mass*Pt(me,me),this.m_invI=1/this.m_I):(this.m_I=0,this.m_invI=0),ut(le,this.m_sweep.c),this.m_sweep.setLocalCenter(me,this.m_xf),ft(ue,this.m_sweep.c,le),St(_e,this.m_angularVelocity,ue),pt(this.m_linearVelocity,_e)},t.prototype.setMassData=function(t){1!=this.isWorldLocked()&&this.m_type==ce&&(this.m_invMass=0,this.m_I=0,this.m_invI=0,this.m_mass=t.mass,this.m_mass<=0&&(this.m_mass=1),this.m_invMass=1/this.m_mass,t.I>0&&0==this.m_fixedRotationFlag&&(this.m_I=t.I-this.m_mass*Pt(t.center,t.center),this.m_invI=1/this.m_I),ut(le,this.m_sweep.c),this.m_sweep.setLocalCenter(t.center,this.m_xf),ft(ue,this.m_sweep.c,le),St(_e,this.m_angularVelocity,ue),pt(this.m_linearVelocity,_e))},t.prototype.applyForce=function(t,e,i){void 0===i&&(i=!0),this.m_type==ce&&(i&&0==this.m_awakeFlag&&this.setAwake(!0),this.m_awakeFlag&&(this.m_force.add(t),this.m_torque+=Y.crossVec2Vec2(Y.sub(e,this.m_sweep.c),t)))},t.prototype.applyForceToCenter=function(t,e){void 0===e&&(e=!0),this.m_type==ce&&(e&&0==this.m_awakeFlag&&this.setAwake(!0),this.m_awakeFlag&&this.m_force.add(t))},t.prototype.applyTorque=function(t,e){void 0===e&&(e=!0),this.m_type==ce&&(e&&0==this.m_awakeFlag&&this.setAwake(!0),this.m_awakeFlag&&(this.m_torque+=t))},t.prototype.applyLinearImpulse=function(t,e,i){void 0===i&&(i=!0),this.m_type==ce&&(i&&0==this.m_awakeFlag&&this.setAwake(!0),this.m_awakeFlag&&(this.m_linearVelocity.addMul(this.m_invMass,t),this.m_angularVelocity+=this.m_invI*Y.crossVec2Vec2(Y.sub(e,this.m_sweep.c),t)))},t.prototype.applyAngularImpulse=function(t,e){void 0===e&&(e=!0),this.m_type==ce&&(e&&0==this.m_awakeFlag&&this.setAwake(!0),this.m_awakeFlag&&(this.m_angularVelocity+=this.m_invI*t))},t.prototype.shouldCollide=function(t){if(this.m_type!=ce&&t.m_type!=ce)return!1;for(var e=this.m_jointList;e;e=e.next)if(e.other==t&&0==e.joint.m_collideConnected)return!1;return!0},t.prototype._addFixture=function(t){if(1==this.isWorldLocked())return null;if(this.m_activeFlag){var e=this.m_world.m_broadPhase;t.createProxies(e,this.m_xf)}return t.m_next=this.m_fixtureList,this.m_fixtureList=t,t.m_density>0&&this.resetMassData(),this.m_world.m_newFixture=!0,t},t.prototype.createFixture=function(t,e){if(1==this.isWorldLocked())return null;var i=new re(this,t,e);return this._addFixture(i),i},t.prototype.destroyFixture=function(t){if(1!=this.isWorldLocked()){if(this.m_fixtureList===t)this.m_fixtureList=t.m_next;else for(var e=this.m_fixtureList;null!=e;){if(e.m_next===t){e.m_next=t.m_next;break}e=e.m_next}for(var i=this.m_contactList;i;){var s=i.contact;i=i.next;var o=s.getFixtureA(),n=s.getFixtureB();t!=o&&t!=n||this.m_world.destroyContact(s)}if(this.m_activeFlag){var r=this.m_world.m_broadPhase;t.destroyProxies(r)}t.m_body=null,t.m_next=null,this.m_world.publish("remove-fixture",t),this.resetMassData()}},t.prototype.getWorldPoint=function(t){return Jt.mulVec2(this.m_xf,t)},t.prototype.getWorldVector=function(t){return Ht.mulVec2(this.m_xf.q,t)},t.prototype.getLocalPoint=function(t){return Jt.mulTVec2(this.m_xf,t)},t.prototype.getLocalVector=function(t){return Ht.mulTVec2(this.m_xf.q,t)},t.STATIC="static",t.KINEMATIC="kinematic",t.DYNAMIC="dynamic",t}(),fe=function(){return function(){this.other=null,this.joint=null,this.prev=null,this.next=null}}(),ge=function(){function t(t,e,i){this.m_type="unknown-joint",this.m_prev=null,this.m_next=null,this.m_edgeA=new fe,this.m_edgeB=new fe,this.m_islandFlag=!1,this.style={},this.appData={},e="bodyA"in t?t.bodyA:e,i="bodyB"in t?t.bodyB:i,this.m_bodyA=e,this.m_bodyB=i,this.m_collideConnected=!!t.collideConnected,this.m_userData=t.userData,"object"==typeof t.style&&null!==t.style&&(this.style=t.style)}return t.prototype.isActive=function(){return this.m_bodyA.isActive()&&this.m_bodyB.isActive()},t.prototype.getType=function(){return this.m_type},t.prototype.getBodyA=function(){return this.m_bodyA},t.prototype.getBodyB=function(){return this.m_bodyB},t.prototype.getNext=function(){return this.m_next},t.prototype.getUserData=function(){return this.m_userData},t.prototype.setUserData=function(t){this.m_userData=t},t.prototype.getCollideConnected=function(){return this.m_collideConnected},t.prototype.shiftOrigin=function(t){},t.prototype._resetAnchors=function(t){return this._reset(t)},t}(),ve={gjkCalls:0,gjkIters:0,gjkMaxIters:0,toiTime:0,toiMaxTime:0,toiCalls:0,toiIters:0,toiMaxIters:0,toiRootIters:0,toiMaxRootIters:0,toString:function(t){t="string"==typeof t?t:"\n";var e="";for(var i in this)"function"!=typeof this[i]&&"object"!=typeof this[i]&&(e+=i+": "+this[i]+t);return e}};var xe=Math.max,be=lt(0,0),Ae=lt(0,0),we=lt(0,0),Be=lt(0,0),Ce=lt(0,0),Se=lt(0,0),Me=lt(0,0);ve.gjkCalls=0,ve.gjkIters=0,ve.gjkMaxIters=0;var Pe=function(){function t(){this.proxyA=new Te,this.proxyB=new Te,this.transformA=Jt.identity(),this.transformB=Jt.identity(),this.useRadii=!1}return t.prototype.recycle=function(){this.proxyA.recycle(),this.proxyB.recycle(),this.transformA.setIdentity(),this.transformB.setIdentity(),this.useRadii=!1},t}(),Ve=function(){function t(){this.pointA=lt(0,0),this.pointB=lt(0,0),this.distance=0,this.iterations=0}return t.prototype.recycle=function(){_t(this.pointA),_t(this.pointB),this.distance=0,this.iterations=0},t}(),Ie=function(){function t(){this.metric=0,this.indexA=[],this.indexB=[],this.count=0}return t.prototype.recycle=function(){this.metric=0,this.indexA.length=0,this.indexB.length=0,this.count=0},t}(),ze=function(t,e,i){++ve.gjkCalls;var s=i.proxyA,o=i.proxyB,n=i.transformA,r=i.transformB;qe.recycle(),qe.readCache(e,s,n,o,r);for(var a=qe.m_v,h=G.maxDistanceIterations,c=[],l=[],m=0,u=0;u<h;){m=qe.m_count;for(var _=0;_<m;++_)c[_]=a[_].indexA,l[_]=a[_].indexB;if(qe.solve(),3===qe.m_count)break;var d=qe.getSearchDirection();if(Vt(d)<1e-18)break;var p=a[qe.m_count];p.indexA=s.getSupport(Lt(be,n.q,vt(be,-1,d))),qt(p.wA,n,s.getVertex(p.indexA)),p.indexB=o.getSupport(Lt(be,r.q,d)),qt(p.wB,r,o.getVertex(p.indexB)),ft(p.w,p.wB,p.wA),++u,++ve.gjkIters;var y=!1;for(_=0;_<m;++_)if(p.indexA===c[_]&&p.indexB===l[_]){y=!0;break}if(y)break;++qe.m_count}if(ve.gjkMaxIters=xe(ve.gjkMaxIters,u),qe.getWitnessPoints(t.pointA,t.pointB),t.distance=It(t.pointA,t.pointB),t.iterations=u,qe.writeCache(e),i.useRadii){var f=s.m_radius,g=o.m_radius;if(t.distance>f+g&&t.distance>k)t.distance-=f+g,ft(Ae,t.pointB,t.pointA),Bt(Ae),xt(t.pointA,f,Ae),bt(t.pointB,g,Ae);else{var v=ft(be,t.pointA,t.pointB);ut(t.pointA,v),ut(t.pointB,v),t.distance=0}}},Te=function(){function t(){this.m_vertices=[],this.m_count=0,this.m_radius=0}return t.prototype.recycle=function(){this.m_vertices.length=0,this.m_count=0,this.m_radius=0},t.prototype.getVertexCount=function(){return this.m_count},t.prototype.getVertex=function(t){return this.m_vertices[t]},t.prototype.getSupport=function(t){for(var e=-1,i=-1/0,s=0;s<this.m_count;++s){var o=Pt(this.m_vertices[s],t);o>i&&(e=s,i=o)}return e},t.prototype.getSupportVertex=function(t){return this.m_vertices[this.getSupport(t)]},t.prototype.set=function(t,e){t.computeDistanceProxy(this,e)},t.prototype.setVertices=function(t,e,i){this.m_vertices=t,this.m_count=e,this.m_radius=i},t}(),Le=function(){function t(){this.wA=lt(0,0),this.indexA=0,this.wB=lt(0,0),this.indexB=0,this.w=lt(0,0),this.a=0}return t.prototype.recycle=function(){this.indexA=0,this.indexB=0,_t(this.wA),_t(this.wB),_t(this.w),this.a=0},t.prototype.set=function(t){this.indexA=t.indexA,this.indexB=t.indexB,ut(this.wA,t.wA),ut(this.wB,t.wB),ut(this.w,t.w),this.a=t.a},t}(),Fe=lt(0,0),ke=lt(0,0),qe=new(function(){function t(){this.m_v1=new Le,this.m_v2=new Le,this.m_v3=new Le,this.m_v=[this.m_v1,this.m_v2,this.m_v3]}return t.prototype.recycle=function(){this.m_v1.recycle(),this.m_v2.recycle(),this.m_v3.recycle(),this.m_count=0},t.prototype.toString=function(){return 3===this.m_count?["+"+this.m_count,this.m_v1.a,this.m_v1.wA.x,this.m_v1.wA.y,this.m_v1.wB.x,this.m_v1.wB.y,this.m_v2.a,this.m_v2.wA.x,this.m_v2.wA.y,this.m_v2.wB.x,this.m_v2.wB.y,this.m_v3.a,this.m_v3.wA.x,this.m_v3.wA.y,this.m_v3.wB.x,this.m_v3.wB.y].toString():2===this.m_count?["+"+this.m_count,this.m_v1.a,this.m_v1.wA.x,this.m_v1.wA.y,this.m_v1.wB.x,this.m_v1.wB.y,this.m_v2.a,this.m_v2.wA.x,this.m_v2.wA.y,this.m_v2.wB.x,this.m_v2.wB.y].toString():1===this.m_count?["+"+this.m_count,this.m_v1.a,this.m_v1.wA.x,this.m_v1.wA.y,this.m_v1.wB.x,this.m_v1.wB.y].toString():"+"+this.m_count},t.prototype.readCache=function(t,e,i,s,o){this.m_count=t.count;for(var n=0;n<this.m_count;++n){(l=this.m_v[n]).indexA=t.indexA[n],l.indexB=t.indexB[n];var r=e.getVertex(l.indexA),a=s.getVertex(l.indexB);qt(l.wA,i,r),qt(l.wB,o,a),ft(l.w,l.wB,l.wA),l.a=0}if(this.m_count>1){var h=t.metric,c=this.getMetric();(c<.5*h||2*h<c||c<k)&&(this.m_count=0)}var l;0===this.m_count&&((l=this.m_v[0]).indexA=0,l.indexB=0,r=e.getVertex(0),a=s.getVertex(0),qt(l.wA,i,r),qt(l.wB,o,a),ft(l.w,l.wB,l.wA),l.a=1,this.m_count=1)},t.prototype.writeCache=function(t){t.metric=this.getMetric(),t.count=this.m_count;for(var e=0;e<this.m_count;++e)t.indexA[e]=this.m_v[e].indexA,t.indexB[e]=this.m_v[e].indexB},t.prototype.getSearchDirection=function(){var t=this.m_v1,e=this.m_v2;switch(this.m_count){case 1:return mt(Fe,-t.w.x,-t.w.y);case 2:return ft(we,e.w,t.w),-Mt(we,t.w)>0?mt(Fe,-we.y,we.x):mt(Fe,we.y,-we.x);default:return _t(Fe)}},t.prototype.getClosestPoint=function(){var t=this.m_v1,e=this.m_v2;switch(this.m_count){case 0:case 3:default:return _t(ke);case 1:return ut(ke,t.w);case 2:return At(ke,t.a,t.w,e.a,e.w)}},t.prototype.getWitnessPoints=function(t,e){var i=this.m_v1,s=this.m_v2,o=this.m_v3;switch(this.m_count){case 0:break;case 1:ut(t,i.wA),ut(e,i.wB);break;case 2:At(t,i.a,i.wA,s.a,s.wA),At(e,i.a,i.wB,s.a,s.wB);break;case 3:wt(t,i.a,i.wA,s.a,s.wA,o.a,o.wA),ut(e,t)}},t.prototype.getMetric=function(){switch(this.m_count){case 0:case 1:default:return 0;case 2:return It(this.m_v1.w,this.m_v2.w);case 3:return Mt(ft(Se,this.m_v2.w,this.m_v1.w),ft(Me,this.m_v3.w,this.m_v1.w))}},t.prototype.solve=function(){switch(this.m_count){case 1:break;case 2:this.solve2();break;case 3:this.solve3()}},t.prototype.solve2=function(){var t=this.m_v1.w,e=this.m_v2.w;ft(we,e,t);var i=-Pt(t,we);if(i<=0)return this.m_v1.a=1,void(this.m_count=1);var s=Pt(e,we);if(s<=0)return this.m_v2.a=1,this.m_count=1,void this.m_v1.set(this.m_v2);var o=1/(s+i);this.m_v1.a=s*o,this.m_v2.a=i*o,this.m_count=2},t.prototype.solve3=function(){var t=this.m_v1.w,e=this.m_v2.w,i=this.m_v3.w;ft(we,e,t);var s=Pt(t,we),o=Pt(e,we),n=-s;ft(Be,i,t);var r=Pt(t,Be),a=Pt(i,Be),h=-r;ft(Ce,i,e);var c=Pt(e,Ce),l=Pt(i,Ce),m=-c,u=Mt(we,Be),_=u*Mt(e,i),d=u*Mt(i,t),p=u*Mt(t,e);if(n<=0&&h<=0)return this.m_v1.a=1,void(this.m_count=1);if(o>0&&n>0&&p<=0){var y=1/(o+n);return this.m_v1.a=o*y,this.m_v2.a=n*y,void(this.m_count=2)}if(a>0&&h>0&&d<=0){var f=1/(a+h);return this.m_v1.a=a*f,this.m_v3.a=h*f,this.m_count=2,void this.m_v2.set(this.m_v3)}if(o<=0&&m<=0)return this.m_v2.a=1,this.m_count=1,void this.m_v1.set(this.m_v2);if(a<=0&&l<=0)return this.m_v3.a=1,this.m_count=1,void this.m_v1.set(this.m_v3);if(l>0&&m>0&&_<=0){var g=1/(l+m);return this.m_v2.a=l*g,this.m_v3.a=m*g,this.m_count=2,void this.m_v1.set(this.m_v3)}var v=1/(_+d+p);this.m_v1.a=_*v,this.m_v2.a=d*v,this.m_v3.a=p*v,this.m_count=3},t}()),Ne=new Pe,je=new Ie,Re=new Ve,Ee=function(t,e,i,s,o,n){return Ne.recycle(),Ne.proxyA.set(t,e),Ne.proxyB.set(i,s),kt(Ne.transformA,o),kt(Ne.transformB,n),Ne.useRadii=!0,Re.recycle(),je.recycle(),ze(Re,je,Ne),Re.distance<1e-8};ze.testOverlap=Ee,ze.Input=Pe,ze.Output=Ve,ze.Proxy=Te,ze.Cache=Ie;!function(){function t(){this.proxyA=new Te,this.proxyB=new Te,this.transformA=Jt.identity(),this.transformB=Jt.identity(),this.translationB=Y.zero()}t.prototype.recycle=function(){this.proxyA.recycle(),this.proxyB.recycle(),this.transformA.setIdentity(),this.transformB.setIdentity(),_t(this.translationB)}}();var Oe,De,He=Math.abs,Ye=Math.max,We=function(){function t(){this.proxyA=new Te,this.proxyB=new Te,this.sweepA=new Xt,this.sweepB=new Xt}return t.prototype.recycle=function(){this.proxyA.recycle(),this.proxyB.recycle(),this.sweepA.recycle(),this.sweepB.recycle(),this.tMax=-1},t}();(De=Oe||(Oe={}))[De.e_unset=-1]="e_unset",De[De.e_unknown=0]="e_unknown",De[De.e_failed=1]="e_failed",De[De.e_overlapped=2]="e_overlapped",De[De.e_touching=3]="e_touching",De[De.e_separated=4]="e_separated";var Ue=function(){function t(){this.state=Oe.e_unset,this.t=-1}return t.prototype.recycle=function(){this.state=Oe.e_unset,this.t=-1},t}();ve.toiTime=0,ve.toiMaxTime=0,ve.toiCalls=0,ve.toiIters=0,ve.toiMaxIters=0,ve.toiRootIters=0,ve.toiMaxRootIters=0;var Xe,Je,$e=new Pe,Ge=new Ve,Ke=new Ie,Ze=Ft(0,0,0),Qe=Ft(0,0,0),ti=lt(0,0),ei=lt(0,0),ii=lt(0,0),si=lt(0,0),oi=lt(0,0),ni=lt(0,0),ri=lt(0,0),ai=lt(0,0),hi=function(t,e){var i=Date.now();++ve.toiCalls,t.state=Oe.e_unknown,t.t=e.tMax;var s=e.proxyA,o=e.proxyB,n=e.sweepA,r=e.sweepB;n.normalize(),r.normalize();var a=e.tMax,h=s.m_radius+o.m_radius,c=Ye(G.linearSlop,h-3*G.linearSlop),l=.25*G.linearSlop,m=0,u=G.maxTOIIterations,_=0;for(Ke.recycle(),$e.proxyA.setVertices(s.m_vertices,s.m_count,s.m_radius),$e.proxyB.setVertices(o.m_vertices,o.m_count,o.m_radius),$e.useRadii=!1;;){if(n.getTransform(Ze,m),r.getTransform(Qe,m),kt($e.transformA,Ze),kt($e.transformB,Qe),ze(Ge,Ke,$e),Ge.distance<=0){t.state=Oe.e_overlapped,t.t=0;break}if(Ge.distance<c+l){t.state=Oe.e_touching,t.t=m;break}ci.initialize(Ke,s,n,o,r,m);for(var d=!1,p=a,y=0;;){var f=ci.findMinSeparation(p);if(f>c+l){t.state=Oe.e_separated,t.t=a,d=!0;break}if(f>c-l){m=p;break}var g=ci.evaluate(m);if(g<c-l){t.state=Oe.e_failed,t.t=m,d=!0;break}if(g<=c+l){t.state=Oe.e_touching,t.t=m,d=!0;break}for(var v=0,x=m,b=p;;){var A;A=1&v?x+(c-g)*(b-x)/(f-g):.5*(x+b),++v,++ve.toiRootIters;var w=ci.evaluate(A);if(He(w-c)<l){p=A;break}if(w>c?(x=A,g=w):(b=A,f=w),50===v)break}if(ve.toiMaxRootIters=Ye(ve.toiMaxRootIters,v),++y===G.maxPolygonVertices)break}if(++_,++ve.toiIters,d)break;if(_===u){t.state=Oe.e_failed,t.t=m;break}}ve.toiMaxIters=Ye(ve.toiMaxIters,_);var B=function(t){return Date.now()-t}(i);ve.toiMaxTime=Ye(ve.toiMaxTime,B),ve.toiTime+=B,ci.recycle()};(Je=Xe||(Xe={}))[Je.e_unset=-1]="e_unset",Je[Je.e_points=1]="e_points",Je[Je.e_faceA=2]="e_faceA",Je[Je.e_faceB=3]="e_faceB";var ci=new(function(){function t(){this.m_proxyA=null,this.m_proxyB=null,this.m_sweepA=null,this.m_sweepB=null,this.m_type=Xe.e_unset,this.m_localPoint=lt(0,0),this.m_axis=lt(0,0),this.indexA=-1,this.indexB=-1}return t.prototype.recycle=function(){this.m_proxyA=null,this.m_proxyB=null,this.m_sweepA=null,this.m_sweepB=null,this.m_type=Xe.e_unset,_t(this.m_localPoint),_t(this.m_axis),this.indexA=-1,this.indexB=-1},t.prototype.initialize=function(t,e,i,s,o,n){var r=t.count;if(this.m_proxyA=e,this.m_proxyB=s,this.m_sweepA=i,this.m_sweepB=o,this.m_sweepA.getTransform(Ze,n),this.m_sweepB.getTransform(Qe,n),1===r){this.m_type=Xe.e_points;var a=this.m_proxyA.getVertex(t.indexA[0]),h=this.m_proxyB.getVertex(t.indexB[0]);return qt(ei,Ze,a),qt(ii,Qe,h),ft(this.m_axis,ii,ei),function(t){var e=ct(t.x*t.x+t.y*t.y);if(0!==e){var i=1/e;t.x*=i,t.y*=i}return e}(this.m_axis)}if(t.indexA[0]===t.indexA[1]){this.m_type=Xe.e_faceB;var c=s.getVertex(t.indexB[0]),l=s.getVertex(t.indexB[1]);Ct(this.m_axis,ft(ti,l,c),1),Bt(this.m_axis),Tt(si,Qe.q,this.m_axis),At(this.m_localPoint,.5,c,.5,l),qt(ii,Qe,this.m_localPoint);var m=e.getVertex(t.indexA[0]);return(d=Pt(Jt.mulVec2(Ze,m),si)-Pt(ii,si))<0&&(dt(this.m_axis),d=-d),d}this.m_type=Xe.e_faceA;var u=this.m_proxyA.getVertex(t.indexA[0]),_=this.m_proxyA.getVertex(t.indexA[1]);Ct(this.m_axis,ft(ti,_,u),1),Bt(this.m_axis),Tt(si,Ze.q,this.m_axis),At(this.m_localPoint,.5,u,.5,_),qt(ei,Ze,this.m_localPoint);var d,p=this.m_proxyB.getVertex(t.indexB[0]);return qt(ii,Qe,p),(d=Pt(ii,si)-Pt(ei,si))<0&&(dt(this.m_axis),d=-d),d},t.prototype.compute=function(t,e){switch(this.m_sweepA.getTransform(Ze,e),this.m_sweepB.getTransform(Qe,e),this.m_type){case Xe.e_points:return t&&(Lt(oi,Ze.q,this.m_axis),Lt(ni,Qe.q,vt(ti,-1,this.m_axis)),this.indexA=this.m_proxyA.getSupport(oi),this.indexB=this.m_proxyB.getSupport(ni)),ut(ri,this.m_proxyA.getVertex(this.indexA)),ut(ai,this.m_proxyB.getVertex(this.indexB)),qt(ei,Ze,ri),qt(ii,Qe,ai),Pt(ii,this.m_axis)-Pt(ei,this.m_axis);case Xe.e_faceA:return Tt(si,Ze.q,this.m_axis),qt(ei,Ze,this.m_localPoint),t&&(Lt(ni,Qe.q,vt(ti,-1,si)),this.indexA=-1,this.indexB=this.m_proxyB.getSupport(ni)),ut(ai,this.m_proxyB.getVertex(this.indexB)),qt(ii,Qe,ai),Pt(ii,si)-Pt(ei,si);case Xe.e_faceB:return Tt(si,Qe.q,this.m_axis),qt(ii,Qe,this.m_localPoint),t&&(Lt(oi,Ze.q,vt(ti,-1,si)),this.indexB=-1,this.indexA=this.m_proxyA.getSupport(oi)),ut(ri,this.m_proxyA.getVertex(this.indexA)),qt(ei,Ze,ri),Pt(ei,si)-Pt(ii,si);default:return t&&(this.indexA=-1,this.indexB=-1),0}},t.prototype.findMinSeparation=function(t){return this.compute(!0,t)},t.prototype.evaluate=function(t){return this.compute(!1,t)},t}());hi.Input=We,hi.Output=Ue;var li=Math.abs,mi=Math.sqrt,ui=Math.min,_i=function(){function t(){this.dt=0,this.inv_dt=0,this.velocityIterations=0,this.positionIterations=0,this.warmStarting=!1,this.blockSolve=!0,this.inv_dt0=0,this.dtRatio=1}return t.prototype.reset=function(t){this.dt>0&&(this.inv_dt0=this.inv_dt),this.dt=t,this.inv_dt=0==t?0:1/t,this.dtRatio=t*this.inv_dt0},t}(),di=new _i,pi=lt(0,0),yi=lt(0,0),fi=lt(0,0),gi=new We,vi=new Ue,xi=new Xt,bi=new Xt,Ai=new Xt,wi=function(){function t(t){this.contact=t,this.normals=[],this.tangents=[]}return t.prototype.recycle=function(){this.normals.length=0,this.tangents.length=0},Object.defineProperty(t.prototype,"normalImpulses",{get:function(){var t=this.contact,e=this.normals;e.length=0;for(var i=0;i<t.v_points.length;++i)e.push(t.v_points[i].normalImpulse);return e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"tangentImpulses",{get:function(){var t=this.contact,e=this.tangents;e.length=0;for(var i=0;i<t.v_points.length;++i)e.push(t.v_points[i].tangentImpulse);return e},enumerable:!1,configurable:!0}),t}(),Bi=function(){function t(t){this.m_world=t,this.m_stack=[],this.m_bodies=[],this.m_contacts=[],this.m_joints=[]}return t.prototype.clear=function(){this.m_stack.length=0,this.m_bodies.length=0,this.m_contacts.length=0,this.m_joints.length=0},t.prototype.addBody=function(t){this.m_bodies.push(t)},t.prototype.addContact=function(t){this.m_contacts.push(t)},t.prototype.addJoint=function(t){this.m_joints.push(t)},t.prototype.solveWorld=function(t){for(var e=this.m_world,i=e.m_bodyList;i;i=i.m_next)i.m_islandFlag=!1;for(var s=e.m_contactList;s;s=s.m_next)s.m_islandFlag=!1;for(var o=e.m_jointList;o;o=o.m_next)o.m_islandFlag=!1;for(var n=this.m_stack,r=e.m_bodyList;r;r=r.m_next)if(!r.m_islandFlag&&0!=r.isAwake()&&0!=r.isActive()&&!r.isStatic()){for(this.clear(),n.push(r),r.m_islandFlag=!0;n.length>0;)if(i=n.pop(),this.addBody(i),i.m_awakeFlag=!0,!i.isStatic()){for(var a=i.m_contactList;a;a=a.next){var h=a.contact;if(!h.m_islandFlag&&0!=h.isEnabled()&&0!=h.isTouching()){var c=h.m_fixtureA.m_isSensor,l=h.m_fixtureB.m_isSensor;c||l||(this.addContact(h),h.m_islandFlag=!0,(u=a.other).m_islandFlag||(n.push(u),u.m_islandFlag=!0))}}for(var m=i.m_jointList;m;m=m.next){var u;1!=m.joint.m_islandFlag&&0!=(u=m.other).isActive()&&(this.addJoint(m.joint),m.joint.m_islandFlag=!0,u.m_islandFlag||(n.push(u),u.m_islandFlag=!0))}}this.solveIsland(t);for(var _=0;_<this.m_bodies.length;++_)(i=this.m_bodies[_]).isStatic()&&(i.m_islandFlag=!1)}},t.prototype.solveIsland=function(t){for(var e=this.m_world,i=e.m_gravity,s=e.m_allowSleep,o=t.dt,n=0;n<this.m_bodies.length;++n){var r=this.m_bodies[n];ut(pi,r.m_sweep.c);var a=r.m_sweep.a;ut(yi,r.m_linearVelocity);var h=r.m_angularVelocity;ut(r.m_sweep.c0,r.m_sweep.c),r.m_sweep.a0=r.m_sweep.a,r.isDynamic()&&(xt(yi,o*r.m_gravityScale,i),xt(yi,o*r.m_invMass,r.m_force),h+=o*r.m_invI*r.m_torque,vt(yi,1/(1+o*r.m_linearDamping),yi),h*=1/(1+o*r.m_angularDamping)),ut(r.c_position.c,pi),r.c_position.a=a,ut(r.c_velocity.v,yi),r.c_velocity.w=h}for(n=0;n<this.m_contacts.length;++n)this.m_contacts[n].initConstraint(t);for(n=0;n<this.m_contacts.length;++n)this.m_contacts[n].initVelocityConstraint(t);if(t.warmStarting)for(n=0;n<this.m_contacts.length;++n)this.m_contacts[n].warmStartConstraint(t);for(n=0;n<this.m_joints.length;++n)this.m_joints[n].initVelocityConstraints(t);for(n=0;n<t.velocityIterations;++n){for(var c=0;c<this.m_joints.length;++c)this.m_joints[c].solveVelocityConstraints(t);for(c=0;c<this.m_contacts.length;++c)this.m_contacts[c].solveVelocityConstraint(t)}for(n=0;n<this.m_contacts.length;++n)this.m_contacts[n].storeConstraintImpulses(t);for(n=0;n<this.m_bodies.length;++n){r=this.m_bodies[n],ut(pi,r.c_position.c),a=r.c_position.a,ut(yi,r.c_velocity.v),h=r.c_velocity.w,vt(fi,o,yi);var l=Vt(fi);if(l>G.maxTranslationSquared){var m=G.maxTranslation/mi(l);gt(yi,m)}var u=o*h;u*u>G.maxRotationSquared&&(h*=m=G.maxRotation/li(u)),xt(pi,o,yi),a+=o*h,ut(r.c_position.c,pi),r.c_position.a=a,ut(r.c_velocity.v,yi),r.c_velocity.w=h}var _=!1;for(n=0;n<t.positionIterations;++n){var d=0;for(c=0;c<this.m_contacts.length;++c){var p=this.m_contacts[c].solvePositionConstraint(t);d=ui(d,p)}var y=d>=-3*G.linearSlop,f=!0;for(c=0;c<this.m_joints.length;++c){var g=this.m_joints[c].solvePositionConstraints(t);f=f&&g}if(y&&f){_=!0;break}}for(n=0;n<this.m_bodies.length;++n)ut((r=this.m_bodies[n]).m_sweep.c,r.c_position.c),r.m_sweep.a=r.c_position.a,ut(r.m_linearVelocity,r.c_velocity.v),r.m_angularVelocity=r.c_velocity.w,r.synchronizeTransform();if(this.postSolveIsland(),s){var v=1/0,x=G.linearSleepToleranceSqr,b=G.angularSleepToleranceSqr;for(n=0;n<this.m_bodies.length;++n)(r=this.m_bodies[n]).isStatic()||(0==r.m_autoSleepFlag||r.m_angularVelocity*r.m_angularVelocity>b||Vt(r.m_linearVelocity)>x?(r.m_sleepTime=0,v=0):(r.m_sleepTime+=o,v=ui(v,r.m_sleepTime)));if(v>=G.timeToSleep&&_)for(n=0;n<this.m_bodies.length;++n)(r=this.m_bodies[n]).setAwake(!1)}},t.prototype.solveWorldTOI=function(t){var e=this.m_world;if(e.m_stepComplete){for(var i=e.m_bodyList;i;i=i.m_next)i.m_islandFlag=!1,i.m_sweep.alpha0=0;for(var s=e.m_contactList;s;s=s.m_next)s.m_toiFlag=!1,s.m_islandFlag=!1,s.m_toiCount=0,s.m_toi=1}for(;;){for(var o=null,n=1,r=e.m_contactList;r;r=r.m_next)if(0!=r.isEnabled()&&!(r.m_toiCount>G.maxSubSteps)){var a=1;if(r.m_toiFlag)a=r.m_toi;else{var h=r.getFixtureA(),c=r.getFixtureB();if(h.isSensor()||c.isSensor())continue;var l=h.getBody(),m=c.getBody(),u=l.isAwake()&&!l.isStatic(),_=m.isAwake()&&!m.isStatic();if(0==u&&0==_)continue;var d=l.isBullet()||!l.isDynamic(),p=m.isBullet()||!m.isDynamic();if(0==d&&0==p)continue;var y=l.m_sweep.alpha0;l.m_sweep.alpha0<m.m_sweep.alpha0?(y=m.m_sweep.alpha0,l.m_sweep.advance(y)):m.m_sweep.alpha0<l.m_sweep.alpha0&&(y=l.m_sweep.alpha0,m.m_sweep.advance(y));var f=r.getChildIndexA(),g=r.getChildIndexB();gi.proxyA.set(h.getShape(),f),gi.proxyB.set(c.getShape(),g),gi.sweepA.set(l.m_sweep),gi.sweepB.set(m.m_sweep),gi.tMax=1,hi(vi,gi);var v=vi.t;a=vi.state==Oe.e_touching?ui(y+(1-y)*v,1):1,r.m_toi=a,r.m_toiFlag=!0}a<n&&(o=r,n=a)}if(null==o||1-1e-8<n){e.m_stepComplete=!0;break}var x=o.getFixtureA(),b=o.getFixtureB(),A=x.getBody(),w=b.getBody();if(bi.set(A.m_sweep),Ai.set(w.m_sweep),A.advance(n),w.advance(n),o.update(e),o.m_toiFlag=!1,++o.m_toiCount,0!=o.isEnabled()&&0!=o.isTouching()){A.setAwake(!0),w.setAwake(!0),this.clear(),this.addBody(A),this.addBody(w),this.addContact(o),A.m_islandFlag=!0,w.m_islandFlag=!0,o.m_islandFlag=!0;for(var B=[A,w],C=0;C<B.length;++C)if((z=B[C]).isDynamic())for(var S=z.m_contactList;S;S=S.next){var M=S.contact;if(!M.m_islandFlag){var P=S.other;if(!P.isDynamic()||z.isBullet()||P.isBullet()){var V=M.m_fixtureA.m_isSensor,I=M.m_fixtureB.m_isSensor;V||I||(xi.set(P.m_sweep),0==P.m_islandFlag&&P.advance(n),M.update(e),0!=M.isEnabled()&&0!=M.isTouching()?(M.m_islandFlag=!0,this.addContact(M),P.m_islandFlag||(P.m_islandFlag=!0,P.isStatic()||P.setAwake(!0),this.addBody(P))):(P.m_sweep.set(xi),P.synchronizeTransform()))}}}for(di.reset((1-n)*t.dt),di.dtRatio=1,di.positionIterations=20,di.velocityIterations=t.velocityIterations,di.warmStarting=!1,this.solveIslandTOI(di,A,w),C=0;C<this.m_bodies.length;++C){var z;if((z=this.m_bodies[C]).m_islandFlag=!1,z.isDynamic())for(z.synchronizeFixtures(),S=z.m_contactList;S;S=S.next)S.contact.m_toiFlag=!1,S.contact.m_islandFlag=!1}if(e.findNewContacts(),e.m_subStepping){e.m_stepComplete=!1;break}}else o.setEnabled(!1),A.m_sweep.set(bi),w.m_sweep.set(Ai),A.synchronizeTransform(),w.synchronizeTransform()}},t.prototype.solveIslandTOI=function(t,e,i){for(var s=0;s<this.m_bodies.length;++s)ut((h=this.m_bodies[s]).c_position.c,h.m_sweep.c),h.c_position.a=h.m_sweep.a,ut(h.c_velocity.v,h.m_linearVelocity),h.c_velocity.w=h.m_angularVelocity;for(s=0;s<this.m_contacts.length;++s)this.m_contacts[s].initConstraint(t);for(s=0;s<t.positionIterations;++s){for(var o=0,n=0;n<this.m_contacts.length;++n){var r=this.m_contacts[n].solvePositionConstraintTOI(t,e,i);o=ui(o,r)}if(o>=-1.5*G.linearSlop)break}for(ut(e.m_sweep.c0,e.c_position.c),e.m_sweep.a0=e.c_position.a,ut(i.m_sweep.c0,i.c_position.c),i.m_sweep.a0=i.c_position.a,s=0;s<this.m_contacts.length;++s)this.m_contacts[s].initVelocityConstraint(t);for(s=0;s<t.velocityIterations;++s)for(n=0;n<this.m_contacts.length;++n)this.m_contacts[n].solveVelocityConstraint(t);var a=t.dt;for(s=0;s<this.m_bodies.length;++s){var h=this.m_bodies[s];ut(pi,h.c_position.c);var c=h.c_position.a;ut(yi,h.c_velocity.v);var l=h.c_velocity.w;vt(fi,a,yi);var m=Vt(fi);if(m>G.maxTranslationSquared){var u=G.maxTranslation/mi(m);gt(yi,u)}var _=a*l;_*_>G.maxRotationSquared&&(l*=u=G.maxRotation/li(_)),xt(pi,a,yi),c+=a*l,ut(h.c_position.c,pi),h.c_position.a=c,ut(h.c_velocity.v,yi),h.c_velocity.w=l,ut(h.m_sweep.c,pi),h.m_sweep.a=c,ut(h.m_linearVelocity,yi),h.m_angularVelocity=l,h.synchronizeTransform()}this.postSolveIsland()},t.prototype.postSolveIsland=function(){for(var t=0;t<this.m_contacts.length;++t){var e=this.m_contacts[t];this.m_world.postSolve(e,e.m_impulse)}},t}();Bi.TimeStep=_i;var Ci,Si,Mi,Pi,Vi,Ii,zi=function(){function t(t,e,i,s){"object"==typeof t&&null!==t?(this.ex=Y.clone(t),this.ey=Y.clone(e)):"number"==typeof t?(this.ex=Y.neo(t,i),this.ey=Y.neo(e,s)):(this.ex=Y.zero(),this.ey=Y.zero())}return t.prototype.toString=function(){return JSON.stringify(this)},t.isValid=function(t){return null!=t&&Y.isValid(t.ex)&&Y.isValid(t.ey)},t.assert=function(t){},t.prototype.set=function(t,e,i,s){"number"==typeof t&&"number"==typeof e&&"number"==typeof i&&"number"==typeof s?(this.ex.setNum(t,i),this.ey.setNum(e,s)):"object"==typeof t&&"object"==typeof e?(this.ex.setVec2(t),this.ey.setVec2(e)):"object"==typeof t&&(this.ex.setVec2(t.ex),this.ey.setVec2(t.ey))},t.prototype.setIdentity=function(){this.ex.x=1,this.ey.x=0,this.ex.y=0,this.ey.y=1},t.prototype.setZero=function(){this.ex.x=0,this.ey.x=0,this.ex.y=0,this.ey.y=0},t.prototype.getInverse=function(){var e=this.ex.x,i=this.ey.x,s=this.ex.y,o=this.ey.y,n=e*o-i*s;0!==n&&(n=1/n);var r=new t;return r.ex.x=n*o,r.ey.x=-n*i,r.ex.y=-n*s,r.ey.y=n*e,r},t.prototype.solve=function(t){var e=this.ex.x,i=this.ey.x,s=this.ex.y,o=this.ey.y,n=e*o-i*s;0!==n&&(n=1/n);var r=Y.zero();return r.x=n*(o*t.x-i*t.y),r.y=n*(e*t.y-s*t.x),r},t.mul=function(e,i){if(i&&"x"in i&&"y"in i){var s=e.ex.x*i.x+e.ey.x*i.y,o=e.ex.y*i.x+e.ey.y*i.y;return Y.neo(s,o)}if(i&&"ex"in i&&"ey"in i)return new t(e.ex.x*i.ex.x+e.ey.x*i.ex.y,e.ex.x*i.ey.x+e.ey.x*i.ey.y,e.ex.y*i.ex.x+e.ey.y*i.ex.y,e.ex.y*i.ey.x+e.ey.y*i.ey.y)},t.mulVec2=function(t,e){var i=t.ex.x*e.x+t.ey.x*e.y,s=t.ex.y*e.x+t.ey.y*e.y;return Y.neo(i,s)},t.mulMat22=function(e,i){return new t(e.ex.x*i.ex.x+e.ey.x*i.ex.y,e.ex.x*i.ey.x+e.ey.x*i.ey.y,e.ex.y*i.ex.x+e.ey.y*i.ex.y,e.ex.y*i.ey.x+e.ey.y*i.ey.y)},t.mulT=function(e,i){return i&&"x"in i&&"y"in i?Y.neo(Y.dot(i,e.ex),Y.dot(i,e.ey)):i&&"ex"in i&&"ey"in i?new t(Y.neo(Y.dot(e.ex,i.ex),Y.dot(e.ey,i.ex)),Y.neo(Y.dot(e.ex,i.ey),Y.dot(e.ey,i.ey))):void 0},t.mulTVec2=function(t,e){return Y.neo(Y.dot(e,t.ex),Y.dot(e,t.ey))},t.mulTMat22=function(e,i){return new t(Y.neo(Y.dot(e.ex,i.ex),Y.dot(e.ey,i.ex)),Y.neo(Y.dot(e.ex,i.ey),Y.dot(e.ey,i.ey)))},t.abs=function(e){return new t(Y.abs(e.ex),Y.abs(e.ey))},t.add=function(e,i){return new t(Y.add(e.ex,i.ex),Y.add(e.ey,i.ey))},t}(),Ti=Math.sqrt,Li=lt(0,0),Fi=lt(0,0),ki=lt(0,0),qi=lt(0,0),Ni=lt(0,0),ji=lt(0,0),Ri=lt(0,0),Ei=lt(0,0);(Si=Ci||(Ci={}))[Si.e_unset=-1]="e_unset",Si[Si.e_circles=0]="e_circles",Si[Si.e_faceA=1]="e_faceA",Si[Si.e_faceB=2]="e_faceB",(Pi=Mi||(Mi={}))[Pi.e_unset=-1]="e_unset",Pi[Pi.e_vertex=0]="e_vertex",Pi[Pi.e_face=1]="e_face",(Ii=Vi||(Vi={}))[Ii.nullState=0]="nullState",Ii[Ii.addState=1]="addState",Ii[Ii.persistState=2]="persistState",Ii[Ii.removeState=3]="removeState";var Oi=function(){function t(){this.v=lt(0,0),this.id=new Yi}return t.prototype.set=function(t){ut(this.v,t.v),this.id.set(t.id)},t.prototype.recycle=function(){_t(this.v),this.id.recycle()},t}(),Di=function(){function t(){this.localNormal=lt(0,0),this.localPoint=lt(0,0),this.points=[new Hi,new Hi],this.pointCount=0}return t.prototype.set=function(t){this.type=t.type,ut(this.localNormal,t.localNormal),ut(this.localPoint,t.localPoint),this.pointCount=t.pointCount,this.points[0].set(t.points[0]),this.points[1].set(t.points[1])},t.prototype.recycle=function(){this.type=Ci.e_unset,_t(this.localNormal),_t(this.localPoint),this.pointCount=0,this.points[0].recycle(),this.points[1].recycle()},t.prototype.getWorldManifold=function(t,e,i,s,o){if(0==this.pointCount)return t;(t=t||new Wi).pointCount=this.pointCount;var n=t.normal,r=t.points,a=t.separations;switch(this.type){case Ci.e_circles:mt(n,1,0);var h=this.points[0];qt(Li,e,this.localPoint),qt(Fi,s,h.localPoint),ft(ji,Fi,Li);var c=Vt(ji);c>1e-18&&vt(n,1/Ti(c),ji),At(qi,1,Li,i,n),At(Ni,1,Fi,-o,n),At(r[0],.5,qi,.5,Ni),a[0]=Pt(ft(ki,Ni,qi),n);break;case Ci.e_faceA:Tt(n,e.q,this.localNormal),qt(Ri,e,this.localPoint);for(var l=0;l<this.pointCount;++l)h=this.points[l],qt(Ei,s,h.localPoint),At(qi,1,Ei,i-Pt(ft(ki,Ei,Ri),n),n),At(Ni,1,Ei,-o,n),At(r[l],.5,qi,.5,Ni),a[l]=Pt(ft(ki,Ni,qi),n);break;case Ci.e_faceB:for(Tt(n,s.q,this.localNormal),qt(Ri,s,this.localPoint),l=0;l<this.pointCount;++l)h=this.points[l],qt(Ei,e,h.localPoint),At(Ni,1,Ei,o-Pt(ft(ki,Ei,Ri),n),n),At(qi,1,Ei,-i,n),At(r[l],.5,qi,.5,Ni),a[l]=Pt(ft(ki,qi,Ni),n);dt(n)}return t},t.clipSegmentToLine=Xi,t.ClipVertex=Oi,t.getPointStates=Ui,t.PointState=Vi,t}(),Hi=function(){function t(){this.localPoint=lt(0,0),this.normalImpulse=0,this.tangentImpulse=0,this.id=new Yi}return t.prototype.set=function(t){ut(this.localPoint,t.localPoint),this.normalImpulse=t.normalImpulse,this.tangentImpulse=t.tangentImpulse,this.id.set(t.id)},t.prototype.recycle=function(){_t(this.localPoint),this.normalImpulse=0,this.tangentImpulse=0,this.id.recycle()},t}(),Yi=function(){function t(){this.key=-1,this.indexA=-1,this.indexB=-1,this.typeA=Mi.e_unset,this.typeB=Mi.e_unset}return t.prototype.setFeatures=function(t,e,i,s){this.indexA=t,this.indexB=i,this.typeA=e,this.typeB=s,this.key=this.indexA+4*this.indexB+16*this.typeA+64*this.typeB},t.prototype.set=function(t){this.indexA=t.indexA,this.indexB=t.indexB,this.typeA=t.typeA,this.typeB=t.typeB,this.key=this.indexA+4*this.indexB+16*this.typeA+64*this.typeB},t.prototype.swapFeatures=function(){var t=this.indexA,e=this.indexB,i=this.typeA,s=this.typeB;this.indexA=e,this.indexB=t,this.typeA=s,this.typeB=i,this.key=this.indexA+4*this.indexB+16*this.typeA+64*this.typeB},t.prototype.recycle=function(){this.indexA=0,this.indexB=0,this.typeA=Mi.e_unset,this.typeB=Mi.e_unset,this.key=-1},t}(),Wi=function(){function t(){this.normal=lt(0,0),this.points=[lt(0,0),lt(0,0)],this.separations=[0,0],this.pointCount=0}return t.prototype.recycle=function(){_t(this.normal),_t(this.points[0]),_t(this.points[1]),this.separations[0]=0,this.separations[1]=0,this.pointCount=0},t}();function Ui(t,e,i,s){for(var o=0;o<i.pointCount;++o){var n=i.points[o].id;t[o]=Vi.removeState;for(var r=0;r<s.pointCount;++r)if(s.points[r].id.key===n.key){t[o]=Vi.persistState;break}}for(o=0;o<s.pointCount;++o)for(n=s.points[o].id,e[o]=Vi.addState,r=0;r<i.pointCount;++r)if(i.points[r].id.key===n.key){e[o]=Vi.persistState;break}}function Xi(t,e,i,s,o){var n=0,r=Pt(i,e[0].v)-s,a=Pt(i,e[1].v)-s;if(r<=0&&t[n++].set(e[0]),a<=0&&t[n++].set(e[1]),r*a<0){var h=r/(r-a);At(t[n].v,1-h,e[0].v,h,e[1].v),t[n].id.setFeatures(o,Mi.e_vertex,e[0].id.indexB,Mi.e_face),++n}return n}var Ji=Math.sqrt,$i=Math.max,Gi=Math.min,Ki=new K({create:function(){return new Ls},release:function(t){t.recycle()}}),Zi=new Di,Qi=new Wi,ts=function(){function t(t){this.prev=null,this.next=null,this.other=null,this.contact=t}return t.prototype.recycle=function(){this.prev=null,this.next=null,this.other=null},t}();function es(t,e){return Ji(t*e)}function is(t,e){return t>e?t:e}var ss,os,ns=[],rs=function(){function t(){this.rA=lt(0,0),this.rB=lt(0,0),this.normalImpulse=0,this.tangentImpulse=0,this.normalMass=0,this.tangentMass=0,this.velocityBias=0}return t.prototype.recycle=function(){_t(this.rA),_t(this.rB),this.normalImpulse=0,this.tangentImpulse=0,this.normalMass=0,this.tangentMass=0,this.velocityBias=0},t}(),as=lt(0,0),hs=lt(0,0),cs=lt(0,0),ls=lt(0,0),ms=lt(0,0),us=Ft(0,0,0),_s=Ft(0,0,0),ds=lt(0,0),ps=lt(0,0),ys=lt(0,0),fs=lt(0,0),gs=lt(0,0),vs=lt(0,0),xs=lt(0,0),bs=lt(0,0),As=lt(0,0),ws=lt(0,0),Bs=lt(0,0),Cs=lt(0,0),Ss=lt(0,0),Ms=lt(0,0),Ps=lt(0,0),Vs=lt(0,0),Is=lt(0,0),zs=lt(0,0),Ts=lt(0,0),Ls=function(){function t(){this.m_nodeA=new ts(this),this.m_nodeB=new ts(this),this.m_fixtureA=null,this.m_fixtureB=null,this.m_indexA=-1,this.m_indexB=-1,this.m_evaluateFcn=null,this.m_manifold=new Di,this.m_prev=null,this.m_next=null,this.m_toi=1,this.m_toiCount=0,this.m_toiFlag=!1,this.m_friction=0,this.m_restitution=0,this.m_tangentSpeed=0,this.m_enabledFlag=!0,this.m_islandFlag=!1,this.m_touchingFlag=!1,this.m_filterFlag=!1,this.m_bulletHitFlag=!1,this.m_impulse=new wi(this),this.v_points=[new rs,new rs],this.v_normal=lt(0,0),this.v_normalMass=new zi,this.v_K=new zi,this.v_pointCount=0,this.v_tangentSpeed=0,this.v_friction=0,this.v_restitution=0,this.v_invMassA=0,this.v_invMassB=0,this.v_invIA=0,this.v_invIB=0,this.p_localPoints=[lt(0,0),lt(0,0)],this.p_localNormal=lt(0,0),this.p_localPoint=lt(0,0),this.p_localCenterA=lt(0,0),this.p_localCenterB=lt(0,0),this.p_type=Ci.e_unset,this.p_radiusA=0,this.p_radiusB=0,this.p_pointCount=0,this.p_invMassA=0,this.p_invMassB=0,this.p_invIA=0,this.p_invIB=0}return t.prototype.initialize=function(t,e,i,s,o){this.m_fixtureA=t,this.m_fixtureB=i,this.m_indexA=e,this.m_indexB=s,this.m_evaluateFcn=o,this.m_friction=es(this.m_fixtureA.m_friction,this.m_fixtureB.m_friction),this.m_restitution=is(this.m_fixtureA.m_restitution,this.m_fixtureB.m_restitution)},t.prototype.recycle=function(){this.m_nodeA.recycle(),this.m_nodeB.recycle(),this.m_fixtureA=null,this.m_fixtureB=null,this.m_indexA=-1,this.m_indexB=-1,this.m_evaluateFcn=null,this.m_manifold.recycle(),this.m_prev=null,this.m_next=null,this.m_toi=1,this.m_toiCount=0,this.m_toiFlag=!1,this.m_friction=0,this.m_restitution=0,this.m_tangentSpeed=0,this.m_enabledFlag=!0,this.m_islandFlag=!1,this.m_touchingFlag=!1,this.m_filterFlag=!1,this.m_bulletHitFlag=!1,this.m_impulse.recycle();for(var t=0,e=this.v_points;t<e.length;t++)e[t].recycle();_t(this.v_normal),this.v_normalMass.setZero(),this.v_K.setZero(),this.v_pointCount=0,this.v_tangentSpeed=0,this.v_friction=0,this.v_restitution=0,this.v_invMassA=0,this.v_invMassB=0,this.v_invIA=0,this.v_invIB=0;for(var i=0,s=this.p_localPoints;i<s.length;i++)_t(s[i]);_t(this.p_localNormal),_t(this.p_localPoint),_t(this.p_localCenterA),_t(this.p_localCenterB),this.p_type=Ci.e_unset,this.p_radiusA=0,this.p_radiusB=0,this.p_pointCount=0,this.p_invMassA=0,this.p_invMassB=0,this.p_invIA=0,this.p_invIB=0},t.prototype.initConstraint=function(t){var e=this.m_fixtureA,i=this.m_fixtureB;if(null!==e&&null!==i){var s=e.m_body,o=i.m_body;if(null!==s&&null!==o){var n=e.m_shape,r=i.m_shape;if(null!==n&&null!==r){var a=this.m_manifold,h=a.pointCount;this.v_invMassA=s.m_invMass,this.v_invMassB=o.m_invMass,this.v_invIA=s.m_invI,this.v_invIB=o.m_invI,this.v_friction=this.m_friction,this.v_restitution=this.m_restitution,this.v_tangentSpeed=this.m_tangentSpeed,this.v_pointCount=h,this.v_K.setZero(),this.v_normalMass.setZero(),this.p_invMassA=s.m_invMass,this.p_invMassB=o.m_invMass,this.p_invIA=s.m_invI,this.p_invIB=o.m_invI,ut(this.p_localCenterA,s.m_sweep.localCenter),ut(this.p_localCenterB,o.m_sweep.localCenter),this.p_radiusA=n.m_radius,this.p_radiusB=r.m_radius,this.p_type=a.type,ut(this.p_localNormal,a.localNormal),ut(this.p_localPoint,a.localPoint),this.p_pointCount=h;for(var c=0;c<G.maxManifoldPoints;++c)this.v_points[c].recycle(),_t(this.p_localPoints[c]);for(c=0;c<h;++c){var l=a.points[c],m=this.v_points[c];t.warmStarting&&(m.normalImpulse=t.dtRatio*l.normalImpulse,m.tangentImpulse=t.dtRatio*l.tangentImpulse),ut(this.p_localPoints[c],l.localPoint)}}}}},t.prototype.getManifold=function(){return this.m_manifold},t.prototype.getWorldManifold=function(t){var e=this.m_fixtureA,i=this.m_fixtureB;if(null!==e&&null!==i){var s=e.m_body,o=i.m_body;if(null!==s&&null!==o){var n=e.m_shape,r=i.m_shape;if(null!==n&&null!==r)return this.m_manifold.getWorldManifold(t,s.getTransform(),n.m_radius,o.getTransform(),r.m_radius)}}},t.prototype.setEnabled=function(t){this.m_enabledFlag=!!t},t.prototype.isEnabled=function(){return this.m_enabledFlag},t.prototype.isTouching=function(){return this.m_touchingFlag},t.prototype.getNext=function(){return this.m_next},t.prototype.getFixtureA=function(){return this.m_fixtureA},t.prototype.getFixtureB=function(){return this.m_fixtureB},t.prototype.getChildIndexA=function(){return this.m_indexA},t.prototype.getChildIndexB=function(){return this.m_indexB},t.prototype.flagForFiltering=function(){this.m_filterFlag=!0},t.prototype.setFriction=function(t){this.m_friction=t},t.prototype.getFriction=function(){return this.m_friction},t.prototype.resetFriction=function(){var t=this.m_fixtureA,e=this.m_fixtureB;null!==t&&null!==e&&(this.m_friction=es(t.m_friction,e.m_friction))},t.prototype.setRestitution=function(t){this.m_restitution=t},t.prototype.getRestitution=function(){return this.m_restitution},t.prototype.resetRestitution=function(){var t=this.m_fixtureA,e=this.m_fixtureB;null!==t&&null!==e&&(this.m_restitution=is(t.m_restitution,e.m_restitution))},t.prototype.setTangentSpeed=function(t){this.m_tangentSpeed=t},t.prototype.getTangentSpeed=function(){return this.m_tangentSpeed},t.prototype.evaluate=function(t,e,i){var s=this.m_fixtureA,o=this.m_fixtureB;null!==s&&null!==o&&this.m_evaluateFcn(t,e,s,this.m_indexA,i,o,this.m_indexB)},t.prototype.update=function(t){var e=this.m_fixtureA,i=this.m_fixtureB;if(null!==e&&null!==i){var s=e.m_body,o=i.m_body;if(null!==s&&null!==o){var n=e.m_shape,r=i.m_shape;if(null!==n&&null!==r){this.m_enabledFlag=!0;var a=!1,h=this.m_touchingFlag,c=e.m_isSensor,l=i.m_isSensor,m=c||l,u=s.m_xf,_=o.m_xf;if(m)a=Ee(n,this.m_indexA,r,this.m_indexB,u,_),this.m_manifold.pointCount=0;else{Zi.recycle(),Zi.set(this.m_manifold),this.m_manifold.recycle(),this.evaluate(this.m_manifold,u,_),a=this.m_manifold.pointCount>0;for(var d=0;d<this.m_manifold.pointCount;++d){var p=this.m_manifold.points[d];p.normalImpulse=0,p.tangentImpulse=0;for(var y=0;y<Zi.pointCount;++y){var f=Zi.points[y];if(f.id.key===p.id.key){p.normalImpulse=f.normalImpulse,p.tangentImpulse=f.tangentImpulse;break}}}a!==h&&(s.setAwake(!0),o.setAwake(!0))}this.m_touchingFlag=a;var g="object"==typeof t&&null!==t;!h&&a&&g&&t.beginContact(this),h&&!a&&g&&t.endContact(this),!m&&a&&g&&Zi&&t.preSolve(this,Zi)}}}},t.prototype.solvePositionConstraint=function(t){return this._solvePositionConstraint(t,null,null)},t.prototype.solvePositionConstraintTOI=function(t,e,i){return this._solvePositionConstraint(t,e,i)},t.prototype._solvePositionConstraint=function(t,e,i){var s=null!==e&&null!==i,o=0,n=this.m_fixtureA,r=this.m_fixtureB;if(null===n||null===r)return o;var a=n.m_body,h=r.m_body;if(null===a||null===h)return o;var c=a.c_position,l=h.c_position,m=this.p_localCenterA,u=this.p_localCenterB,_=0,d=0;s&&a!==e&&a!==i||(_=this.p_invMassA,d=this.p_invIA);var p=0,y=0;s&&h!==e&&h!==i||(p=this.p_invMassB,y=this.p_invIB),ut(as,c.c);var f=c.a;ut(cs,l.c);for(var g=l.a,v=0;v<this.p_pointCount;++v){Qt(us,m,as,f),Qt(_s,u,cs,g);var x=void 0;switch(this.p_type){case Ci.e_circles:qt(ds,us,this.p_localPoint),qt(ps,_s,this.p_localPoints[0]),ft(bs,ps,ds),Bt(bs),At(As,.5,ds,.5,ps),x=Pt(ps,bs)-Pt(ds,bs)-this.p_radiusA-this.p_radiusB;break;case Ci.e_faceA:Tt(bs,us.q,this.p_localNormal),qt(fs,us,this.p_localPoint),qt(ys,_s,this.p_localPoints[v]),x=Pt(ys,bs)-Pt(fs,bs)-this.p_radiusA-this.p_radiusB,ut(As,ys);break;case Ci.e_faceB:Tt(bs,_s.q,this.p_localNormal),qt(fs,_s,this.p_localPoint),qt(ys,us,this.p_localPoints[v]),x=Pt(ys,bs)-Pt(fs,bs)-this.p_radiusA-this.p_radiusB,ut(As,ys),dt(bs);break;default:return o}ft(gs,As,as),ft(vs,As,cs),o=Gi(o,x);var b=j((s?G.toiBaugarte:G.baumgarte)*(x+G.linearSlop),-G.maxLinearCorrection,0),A=Mt(gs,bs),w=Mt(vs,bs),B=_+p+d*A*A+y*w*w;vt(xs,B>0?-b/B:0,bs),bt(as,_,xs),f-=d*Mt(gs,xs),xt(cs,p,xs),g+=y*Mt(vs,xs)}return ut(c.c,as),c.a=f,ut(l.c,cs),l.a=g,o},t.prototype.initVelocityConstraint=function(t){var e=this.m_fixtureA,i=this.m_fixtureB;if(null!==e&&null!==i){var s=e.m_body,o=i.m_body;if(null!==s&&null!==o){var n=s.c_velocity,r=o.c_velocity,a=s.c_position,h=o.c_position,c=this.p_radiusA,l=this.p_radiusB,m=this.m_manifold,u=this.v_invMassA,_=this.v_invMassB,d=this.v_invIA,p=this.v_invIB,y=this.p_localCenterA,f=this.p_localCenterB;ut(as,a.c);var g=a.a;ut(hs,n.v);var v=n.w;ut(cs,h.c);var x=h.a;ut(ls,r.v);var b=r.w;Qt(us,y,as,g),Qt(_s,f,cs,x),Qi.recycle(),m.getWorldManifold(Qi,us,c,_s,l),ut(this.v_normal,Qi.normal);for(var A=0;A<this.v_pointCount;++A){var w=this.v_points[A],B=Qi.points[A];ft(w.rA,B,as),ft(w.rB,B,cs);var C=Mt(w.rA,this.v_normal),S=Mt(w.rB,this.v_normal),M=u+_+d*C*C+p*S*S;w.normalMass=M>0?1/M:0,Ct(ms,this.v_normal,1);var P=Mt(w.rA,ms),V=Mt(w.rB,ms),I=u+_+d*P*P+p*V*V;w.tangentMass=I>0?1/I:0,w.velocityBias=0;var z=0;z+=Pt(this.v_normal,ls),z+=Pt(this.v_normal,St(Ts,b,w.rB)),z-=Pt(this.v_normal,hs),(z-=Pt(this.v_normal,St(Ts,v,w.rA)))<-G.velocityThreshold&&(w.velocityBias=-this.v_restitution*z)}if(2==this.v_pointCount&&t.blockSolve){var T=this.v_points[0],L=this.v_points[1],F=Mt(T.rA,this.v_normal),k=Mt(T.rB,this.v_normal),q=Mt(L.rA,this.v_normal),N=Mt(L.rB,this.v_normal),j=u+_+d*F*F+p*k*k,R=u+_+d*q*q+p*N*N,E=u+_+d*F*q+p*k*N;if(j*j<1e3*(j*R-E*E)){this.v_K.ex.setNum(j,E),this.v_K.ey.setNum(E,R);var O=this.v_K.ex.x,D=this.v_K.ey.x,H=this.v_K.ex.y,Y=this.v_K.ey.y,W=O*Y-D*H;0!==W&&(W=1/W),this.v_normalMass.ex.x=W*Y,this.v_normalMass.ey.x=-W*D,this.v_normalMass.ex.y=-W*H,this.v_normalMass.ey.y=W*O}else this.v_pointCount=1}ut(a.c,as),a.a=g,ut(n.v,hs),n.w=v,ut(h.c,cs),h.a=x,ut(r.v,ls),r.w=b}}},t.prototype.warmStartConstraint=function(t){var e=this.m_fixtureA,i=this.m_fixtureB;if(null!==e&&null!==i){var s=e.m_body,o=i.m_body;if(null!==s&&null!==o){var n=s.c_velocity,r=o.c_velocity,a=this.v_invMassA,h=this.v_invIA,c=this.v_invMassB,l=this.v_invIB;ut(hs,n.v);var m=n.w;ut(ls,r.v);var u=r.w;ut(bs,this.v_normal),Ct(ms,bs,1);for(var _=0;_<this.v_pointCount;++_){var d=this.v_points[_];At(xs,d.normalImpulse,bs,d.tangentImpulse,ms),m-=h*Mt(d.rA,xs),bt(hs,a,xs),u+=l*Mt(d.rB,xs),xt(ls,c,xs)}ut(n.v,hs),n.w=m,ut(r.v,ls),r.w=u}}},t.prototype.storeConstraintImpulses=function(t){for(var e=this.m_manifold,i=0;i<this.v_pointCount;++i)e.points[i].normalImpulse=this.v_points[i].normalImpulse,e.points[i].tangentImpulse=this.v_points[i].tangentImpulse},t.prototype.solveVelocityConstraint=function(t){var e=this.m_fixtureA,i=this.m_fixtureB;if(null!==e&&null!==i){var s=e.m_body,o=i.m_body;if(null!==s&&null!==o){var n=s.c_velocity,r=o.c_velocity,a=this.v_invMassA,h=this.v_invIA,c=this.v_invMassB,l=this.v_invIB;ut(hs,n.v);var m=n.w;ut(ls,r.v);var u=r.w;ut(bs,this.v_normal),Ct(ms,bs,1);for(var _=this.v_friction,d=0;d<this.v_pointCount;++d){var p=this.v_points[d];_t(ws),pt(ws,ls),pt(ws,St(Ts,u,p.rB)),yt(ws,hs),yt(ws,St(Ts,m,p.rA));var y=Pt(ws,ms)-this.v_tangentSpeed,f=p.tangentMass*-y,g=_*p.normalImpulse;f=(x=j(p.tangentImpulse+f,-g,g))-p.tangentImpulse,p.tangentImpulse=x,vt(xs,f,ms),bt(hs,a,xs),m-=h*Mt(p.rA,xs),xt(ls,c,xs),u+=l*Mt(p.rB,xs)}if(1==this.v_pointCount||0==t.blockSolve)for(var v=0;v<this.v_pointCount;++v){p=this.v_points[v],_t(ws),pt(ws,ls),pt(ws,St(Ts,u,p.rB)),yt(ws,hs),yt(ws,St(Ts,m,p.rA));var x,b=Pt(ws,bs);f=-p.normalMass*(b-p.velocityBias),f=(x=$i(p.normalImpulse+f,0))-p.normalImpulse,p.normalImpulse=x,vt(xs,f,bs),bt(hs,a,xs),m-=h*Mt(p.rA,xs),xt(ls,c,xs),u+=l*Mt(p.rB,xs)}else{var A=this.v_points[0],w=this.v_points[1];mt(Ms,A.normalImpulse,w.normalImpulse),_t(Bs),pt(Bs,ls),pt(Bs,St(Ts,u,A.rB)),yt(Bs,hs),yt(Bs,St(Ts,m,A.rA)),_t(Cs),pt(Cs,ls),pt(Cs,St(Ts,u,w.rB)),yt(Cs,hs),yt(Cs,St(Ts,m,w.rA));var B=Pt(Bs,bs),C=Pt(Cs,bs);for(mt(Ss,B-A.velocityBias,C-w.velocityBias),Ss.x-=this.v_K.ex.x*Ms.x+this.v_K.ey.x*Ms.y,Ss.y-=this.v_K.ex.y*Ms.x+this.v_K.ey.y*Ms.y;;){if(_t(Ps),Ps.x=-(this.v_normalMass.ex.x*Ss.x+this.v_normalMass.ey.x*Ss.y),Ps.y=-(this.v_normalMass.ex.y*Ss.x+this.v_normalMass.ey.y*Ss.y),Ps.x>=0&&Ps.y>=0){ft(Vs,Ps,Ms),vt(Is,Vs.x,bs),vt(zs,Vs.y,bs),wt(hs,-a,Is,-a,zs,1,hs),m-=h*(Mt(A.rA,Is)+Mt(w.rA,zs)),wt(ls,c,Is,c,zs,1,ls),u+=l*(Mt(A.rB,Is)+Mt(w.rB,zs)),A.normalImpulse=Ps.x,w.normalImpulse=Ps.y;break}if(Ps.x=-A.normalMass*Ss.x,Ps.y=0,B=0,C=this.v_K.ex.y*Ps.x+Ss.y,Ps.x>=0&&C>=0){ft(Vs,Ps,Ms),vt(Is,Vs.x,bs),vt(zs,Vs.y,bs),wt(hs,-a,Is,-a,zs,1,hs),m-=h*(Mt(A.rA,Is)+Mt(w.rA,zs)),wt(ls,c,Is,c,zs,1,ls),u+=l*(Mt(A.rB,Is)+Mt(w.rB,zs)),A.normalImpulse=Ps.x,w.normalImpulse=Ps.y;break}if(Ps.x=0,Ps.y=-w.normalMass*Ss.y,B=this.v_K.ey.x*Ps.y+Ss.x,C=0,Ps.y>=0&&B>=0){ft(Vs,Ps,Ms),vt(Is,Vs.x,bs),vt(zs,Vs.y,bs),wt(hs,-a,Is,-a,zs,1,hs),m-=h*(Mt(A.rA,Is)+Mt(w.rA,zs)),wt(ls,c,Is,c,zs,1,ls),u+=l*(Mt(A.rB,Is)+Mt(w.rB,zs)),A.normalImpulse=Ps.x,w.normalImpulse=Ps.y;break}if(Ps.x=0,Ps.y=0,B=Ss.x,C=Ss.y,B>=0&&C>=0){ft(Vs,Ps,Ms),vt(Is,Vs.x,bs),vt(zs,Vs.y,bs),wt(hs,-a,Is,-a,zs,1,hs),m-=h*(Mt(A.rA,Is)+Mt(w.rA,zs)),wt(ls,c,Is,c,zs,1,ls),u+=l*(Mt(A.rB,Is)+Mt(w.rB,zs)),A.normalImpulse=Ps.x,w.normalImpulse=Ps.y;break}break}}ut(n.v,hs),n.w=m,ut(r.v,ls),r.w=u}}},t.addType=function(t,e,i){ns[t]=ns[t]||{},ns[t][e]=i},t.create=function(t,e,i,s){var o,n=t.m_shape.m_type,r=i.m_shape.m_type,a=Ki.allocate();if(o=ns[n]&&ns[n][r])a.initialize(t,e,i,s,o);else{if(!(o=ns[r]&&ns[r][n]))return null;a.initialize(i,s,t,e,o)}t=a.m_fixtureA,i=a.m_fixtureB,e=a.getChildIndexA(),s=a.getChildIndexB();var h=t.m_body,c=i.m_body;return a.m_nodeA.contact=a,a.m_nodeA.other=c,a.m_nodeA.prev=null,a.m_nodeA.next=h.m_contactList,null!=h.m_contactList&&(h.m_contactList.prev=a.m_nodeA),h.m_contactList=a.m_nodeA,a.m_nodeB.contact=a,a.m_nodeB.other=h,a.m_nodeB.prev=null,a.m_nodeB.next=c.m_contactList,null!=c.m_contactList&&(c.m_contactList.prev=a.m_nodeB),c.m_contactList=a.m_nodeB,0==t.isSensor()&&0==i.isSensor()&&(h.setAwake(!0),c.setAwake(!0)),a},t.destroy=function(t,e){var i=t.m_fixtureA,s=t.m_fixtureB;if(null!==i&&null!==s){var o=i.m_body,n=s.m_body;null!==o&&null!==n&&(t.isTouching()&&e.endContact(t),t.m_nodeA.prev&&(t.m_nodeA.prev.next=t.m_nodeA.next),t.m_nodeA.next&&(t.m_nodeA.next.prev=t.m_nodeA.prev),t.m_nodeA==o.m_contactList&&(o.m_contactList=t.m_nodeA.next),t.m_nodeB.prev&&(t.m_nodeB.prev.next=t.m_nodeB.next),t.m_nodeB.next&&(t.m_nodeB.next.prev=t.m_nodeB.prev),t.m_nodeB==n.m_contactList&&(n.m_contactList=t.m_nodeB.next),t.m_manifold.pointCount>0&&!i.m_isSensor&&!s.m_isSensor&&(o.setAwake(!0),n.setAwake(!0)),Ki.release(t))}},t}(),Fs={gravity:Y.zero(),allowSleep:!0,warmStarting:!0,continuousPhysics:!0,subStepping:!1,blockSolve:!0,velocityIterations:8,positionIterations:3},ks=function(){function t(e){if(!(this instanceof t))return new t(e);this.s_step=new _i,e?Y.isValid(e)&&(e={gravity:e}):e={},e=L(e,Fs),this.m_solver=new Bi(this),this.m_broadPhase=new rt,this.m_contactList=null,this.m_contactCount=0,this.m_bodyList=null,this.m_bodyCount=0,this.m_jointList=null,this.m_jointCount=0,this.m_stepComplete=!0,this.m_allowSleep=e.allowSleep,this.m_gravity=Y.clone(e.gravity),this.m_clearForces=!0,this.m_newFixture=!1,this.m_locked=!1,this.m_warmStarting=e.warmStarting,this.m_continuousPhysics=e.continuousPhysics,this.m_subStepping=e.subStepping,this.m_blockSolve=e.blockSolve,this.m_velocityIterations=e.velocityIterations,this.m_positionIterations=e.positionIterations,this.m_t=0,this.m_step_callback=[]}return t.prototype._serialize=function(){for(var t=[],e=[],i=this.getBodyList();i;i=i.getNext())t.push(i);for(var s=this.getJointList();s;s=s.getNext())"function"==typeof s._serialize&&e.push(s);return{gravity:this.m_gravity,bodies:t,joints:e}},t._deserialize=function(e,i,s){if(!e)return new t;var o=new t(e.gravity);if(e.bodies)for(var n=e.bodies.length-1;n>=0;n-=1)o._addBody(s(ye,e.bodies[n],o));if(e.joints)for(n=e.joints.length-1;n>=0;n--)o.createJoint(s(ge,e.joints[n],o));return o},t.prototype.getBodyList=function(){return this.m_bodyList},t.prototype.getJointList=function(){return this.m_jointList},t.prototype.getContactList=function(){return this.m_contactList},t.prototype.getBodyCount=function(){return this.m_bodyCount},t.prototype.getJointCount=function(){return this.m_jointCount},t.prototype.getContactCount=function(){return this.m_contactCount},t.prototype.setGravity=function(t){this.m_gravity.set(t)},t.prototype.getGravity=function(){return this.m_gravity},t.prototype.isLocked=function(){return this.m_locked},t.prototype.setAllowSleeping=function(t){if(t!=this.m_allowSleep&&(this.m_allowSleep=t,0==this.m_allowSleep))for(var e=this.m_bodyList;e;e=e.m_next)e.setAwake(!0)},t.prototype.getAllowSleeping=function(){return this.m_allowSleep},t.prototype.setWarmStarting=function(t){this.m_warmStarting=t},t.prototype.getWarmStarting=function(){return this.m_warmStarting},t.prototype.setContinuousPhysics=function(t){this.m_continuousPhysics=t},t.prototype.getContinuousPhysics=function(){return this.m_continuousPhysics},t.prototype.setSubStepping=function(t){this.m_subStepping=t},t.prototype.getSubStepping=function(){return this.m_subStepping},t.prototype.setAutoClearForces=function(t){this.m_clearForces=t},t.prototype.getAutoClearForces=function(){return this.m_clearForces},t.prototype.clearForces=function(){for(var t=this.m_bodyList;t;t=t.getNext())t.m_force.setZero(),t.m_torque=0},t.prototype.queryAABB=function(t,e){var i=this.m_broadPhase;this.m_broadPhase.query(t,function(t){var s=i.getUserData(t);return e(s.fixture)})},t.prototype.rayCast=function(t,e,i){var s=this.m_broadPhase;this.m_broadPhase.rayCast({maxFraction:1,p1:t,p2:e},function(t,e){var o=s.getUserData(e),n=o.fixture,r=o.childIndex,a={};if(n.rayCast(a,t,r)){var h=a.fraction,c=Y.add(Y.mulNumVec2(1-h,t.p1),Y.mulNumVec2(h,t.p2));return i(n,c,a.normal,h)}return t.maxFraction})},t.prototype.getProxyCount=function(){return this.m_broadPhase.getProxyCount()},t.prototype.getTreeHeight=function(){return this.m_broadPhase.getTreeHeight()},t.prototype.getTreeBalance=function(){return this.m_broadPhase.getTreeBalance()},t.prototype.getTreeQuality=function(){return this.m_broadPhase.getTreeQuality()},t.prototype.shiftOrigin=function(t){if(!this.isLocked()){for(var e=this.m_bodyList;e;e=e.m_next)e.m_xf.p.sub(t),e.m_sweep.c0.sub(t),e.m_sweep.c.sub(t);for(var i=this.m_jointList;i;i=i.m_next)i.shiftOrigin(t);this.m_broadPhase.shiftOrigin(t)}},t.prototype._addBody=function(t){this.isLocked()||(t.m_prev=null,t.m_next=this.m_bodyList,this.m_bodyList&&(this.m_bodyList.m_prev=t),this.m_bodyList=t,++this.m_bodyCount)},t.prototype.createBody=function(t,e){if(this.isLocked())return null;var i={};t&&(Y.isValid(t)?i={position:t,angle:e}:"object"==typeof t&&(i=t));var s=new ye(this,i);return this._addBody(s),s},t.prototype.createDynamicBody=function(t,e){var i={};return t&&(Y.isValid(t)?i={position:t,angle:e}:"object"==typeof t&&(i=t)),i.type="dynamic",this.createBody(i)},t.prototype.createKinematicBody=function(t,e){var i={};return t&&(Y.isValid(t)?i={position:t,angle:e}:"object"==typeof t&&(i=t)),i.type="kinematic",this.createBody(i)},t.prototype.destroyBody=function(t){if(!this.isLocked()){if(t.m_destroyed)return!1;for(var e=t.m_jointList;e;){var i=e;e=e.next,this.publish("remove-joint",i.joint),this.destroyJoint(i.joint),t.m_jointList=e}t.m_jointList=null;for(var s=t.m_contactList;s;){var o=s;s=s.next,this.destroyContact(o.contact),t.m_contactList=s}t.m_contactList=null;for(var n=t.m_fixtureList;n;){var r=n;n=n.m_next,this.publish("remove-fixture",r),r.destroyProxies(this.m_broadPhase),t.m_fixtureList=n}return t.m_fixtureList=null,t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),t==this.m_bodyList&&(this.m_bodyList=t.m_next),t.m_destroyed=!0,--this.m_bodyCount,this.publish("remove-body",t),!0}},t.prototype.createJoint=function(t){if(this.isLocked())return null;if(t.m_prev=null,t.m_next=this.m_jointList,this.m_jointList&&(this.m_jointList.m_prev=t),this.m_jointList=t,++this.m_jointCount,t.m_edgeA.joint=t,t.m_edgeA.other=t.m_bodyB,t.m_edgeA.prev=null,t.m_edgeA.next=t.m_bodyA.m_jointList,t.m_bodyA.m_jointList&&(t.m_bodyA.m_jointList.prev=t.m_edgeA),t.m_bodyA.m_jointList=t.m_edgeA,t.m_edgeB.joint=t,t.m_edgeB.other=t.m_bodyA,t.m_edgeB.prev=null,t.m_edgeB.next=t.m_bodyB.m_jointList,t.m_bodyB.m_jointList&&(t.m_bodyB.m_jointList.prev=t.m_edgeB),t.m_bodyB.m_jointList=t.m_edgeB,0==t.m_collideConnected)for(var e=t.m_bodyB.getContactList();e;e=e.next)e.other==t.m_bodyA&&e.contact.flagForFiltering();return t},t.prototype.destroyJoint=function(t){if(!this.isLocked()){t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),t==this.m_jointList&&(this.m_jointList=t.m_next);var e=t.m_bodyA,i=t.m_bodyB;if(e.setAwake(!0),i.setAwake(!0),t.m_edgeA.prev&&(t.m_edgeA.prev.next=t.m_edgeA.next),t.m_edgeA.next&&(t.m_edgeA.next.prev=t.m_edgeA.prev),t.m_edgeA==e.m_jointList&&(e.m_jointList=t.m_edgeA.next),t.m_edgeA.prev=null,t.m_edgeA.next=null,t.m_edgeB.prev&&(t.m_edgeB.prev.next=t.m_edgeB.next),t.m_edgeB.next&&(t.m_edgeB.next.prev=t.m_edgeB.prev),t.m_edgeB==i.m_jointList&&(i.m_jointList=t.m_edgeB.next),t.m_edgeB.prev=null,t.m_edgeB.next=null,--this.m_jointCount,0==t.m_collideConnected)for(var s=i.getContactList();s;)s.other==e&&s.contact.flagForFiltering(),s=s.next;this.publish("remove-joint",t)}},t.prototype.step=function(t,e,i){if(this.publish("pre-step",t),(0|e)!==e&&(e=0),e=e||this.m_velocityIterations,i=i||this.m_positionIterations,this.m_newFixture&&(this.findNewContacts(),this.m_newFixture=!1),this.m_locked=!0,this.s_step.reset(t),this.s_step.velocityIterations=e,this.s_step.positionIterations=i,this.s_step.warmStarting=this.m_warmStarting,this.s_step.blockSolve=this.m_blockSolve,this.updateContacts(),this.m_stepComplete&&t>0){this.m_solver.solveWorld(this.s_step);for(var s=this.m_bodyList;s;s=s.getNext())0!=s.m_islandFlag&&(s.isStatic()||s.synchronizeFixtures());this.findNewContacts()}var o;for(this.m_continuousPhysics&&t>0&&this.m_solver.solveWorldTOI(this.s_step),this.m_clearForces&&this.clearForces(),this.m_locked=!1;o=this.m_step_callback.shift();)o(this);this.publish("post-step",t)},t.prototype.queueUpdate=function(t){this.isLocked()?this.m_step_callback.push(t):t(this)},t.prototype.findNewContacts=function(){var t=this;this.m_broadPhase.updatePairs(function(e,i){return t.createContact(e,i)})},t.prototype.createContact=function(t,e){var i=t.fixture,s=e.fixture,o=t.childIndex,n=e.childIndex,r=i.getBody(),a=s.getBody();if(r!=a){for(var h=a.getContactList();h;){if(h.other==r){var c=h.contact.getFixtureA(),l=h.contact.getFixtureB(),m=h.contact.getChildIndexA(),u=h.contact.getChildIndexB();if(c==i&&l==s&&m==o&&u==n)return;if(c==s&&l==i&&m==n&&u==o)return}h=h.next}if(0!=a.shouldCollide(r)&&0!=s.shouldCollide(i)){var _=Ls.create(i,o,s,n);null!=_&&(_.m_prev=null,null!=this.m_contactList&&(_.m_next=this.m_contactList,this.m_contactList.m_prev=_),this.m_contactList=_,++this.m_contactCount)}}},t.prototype.updateContacts=function(){for(var t,e=this.m_contactList;t=e;){e=t.getNext();var i=t.getFixtureA(),s=t.getFixtureB(),o=t.getChildIndexA(),n=t.getChildIndexB(),r=i.getBody(),a=s.getBody();if(t.m_filterFlag){if(0==a.shouldCollide(r)){this.destroyContact(t);continue}if(0==s.shouldCollide(i)){this.destroyContact(t);continue}t.m_filterFlag=!1}var h=r.isAwake()&&!r.isStatic(),c=a.isAwake()&&!a.isStatic();if(0!=h||0!=c){var l=i.m_proxies[o].proxyId,m=s.m_proxies[n].proxyId;0!=this.m_broadPhase.testOverlap(l,m)?t.update(this):this.destroyContact(t)}}},t.prototype.destroyContact=function(t){t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),t==this.m_contactList&&(this.m_contactList=t.m_next),Ls.destroy(t,this),--this.m_contactCount},t.prototype.on=function(t,e){return"string"!=typeof t||"function"!=typeof e||(this._listeners||(this._listeners={}),this._listeners[t]||(this._listeners[t]=[]),this._listeners[t].push(e)),this},t.prototype.off=function(t,e){if("string"!=typeof t||"function"!=typeof e)return this;var i=this._listeners&&this._listeners[t];if(!i||!i.length)return this;var s=i.indexOf(e);return s>=0&&i.splice(s,1),this},t.prototype.publish=function(t,e,i,s){var o=this._listeners&&this._listeners[t];if(!o||!o.length)return 0;for(var n=0;n<o.length;n++)o[n].call(this,e,i,s);return o.length},t.prototype.beginContact=function(t){this.publish("begin-contact",t)},t.prototype.endContact=function(t){this.publish("end-contact",t)},t.prototype.preSolve=function(t,e){this.publish("pre-solve",t,e)},t.prototype.postSolve=function(t,e){this.publish("post-solve",t,e)},t}(),qs=function(){function t(e,i,s){if(!(this instanceof t))return new t(e,i,s);void 0===e?(this.x=0,this.y=0,this.z=0):"object"==typeof e?(this.x=e.x,this.y=e.y,this.z=e.z):(this.x=e,this.y=i,this.z=s)}return t.prototype._serialize=function(){return{x:this.x,y:this.y,z:this.z}},t._deserialize=function(e){var i=Object.create(t.prototype);return i.x=e.x,i.y=e.y,i.z=e.z,i},t.neo=function(e,i,s){var o=Object.create(t.prototype);return o.x=e,o.y=i,o.z=s,o},t.zero=function(){var e=Object.create(t.prototype);return e.x=0,e.y=0,e.z=0,e},t.clone=function(e){return t.neo(e.x,e.y,e.z)},t.prototype.toString=function(){return JSON.stringify(this)},t.isValid=function(t){return null!=t&&Number.isFinite(t.x)&&Number.isFinite(t.y)&&Number.isFinite(t.z)},t.assert=function(t){},t.prototype.setZero=function(){return this.x=0,this.y=0,this.z=0,this},t.prototype.set=function(t,e,i){return this.x=t,this.y=e,this.z=i,this},t.prototype.add=function(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this},t.prototype.sub=function(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this},t.prototype.mul=function(t){return this.x*=t,this.y*=t,this.z*=t,this},t.areEqual=function(t,e){return t===e||"object"==typeof t&&null!==t&&"object"==typeof e&&null!==e&&t.x===e.x&&t.y===e.y&&t.z===e.z},t.dot=function(t,e){return t.x*e.x+t.y*e.y+t.z*e.z},t.cross=function(e,i){return new t(e.y*i.z-e.z*i.y,e.z*i.x-e.x*i.z,e.x*i.y-e.y*i.x)},t.add=function(e,i){return new t(e.x+i.x,e.y+i.y,e.z+i.z)},t.sub=function(e,i){return new t(e.x-i.x,e.y-i.y,e.z-i.z)},t.mul=function(e,i){return new t(i*e.x,i*e.y,i*e.z)},t.prototype.neg=function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this},t.neg=function(e){return new t(-e.x,-e.y,-e.z)},t}(),Ns=lt(0,0),js=lt(0,0),Rs=function(t){function e(i,s){var o=this;return o instanceof e?((o=t.call(this)||this).m_type=e.TYPE,o.m_radius=G.polygonRadius,o.m_vertex1=i?Y.clone(i):Y.zero(),o.m_vertex2=s?Y.clone(s):Y.zero(),o.m_vertex0=Y.zero(),o.m_vertex3=Y.zero(),o.m_hasVertex0=!1,o.m_hasVertex3=!1,o):new e(i,s)}return z(e,t),e.prototype._serialize=function(){return{type:this.m_type,vertex1:this.m_vertex1,vertex2:this.m_vertex2,vertex0:this.m_vertex0,vertex3:this.m_vertex3,hasVertex0:this.m_hasVertex0,hasVertex3:this.m_hasVertex3}},e._deserialize=function(t){var i=new e(t.vertex1,t.vertex2);return i.m_hasVertex0&&i.setPrevVertex(t.vertex0),i.m_hasVertex3&&i.setNextVertex(t.vertex3),i},e.prototype._reset=function(){},e.prototype.getRadius=function(){return this.m_radius},e.prototype.getType=function(){return this.m_type},e.prototype.setNext=function(t){return this.setNextVertex(t)},e.prototype.setNextVertex=function(t){return t?(this.m_vertex3.setVec2(t),this.m_hasVertex3=!0):(this.m_vertex3.setZero(),this.m_hasVertex3=!1),this},e.prototype.getNextVertex=function(){return this.m_vertex3},e.prototype.setPrev=function(t){return this.setPrevVertex(t)},e.prototype.setPrevVertex=function(t){return t?(this.m_vertex0.setVec2(t),this.m_hasVertex0=!0):(this.m_vertex0.setZero(),this.m_hasVertex0=!1),this},e.prototype.getPrevVertex=function(){return this.m_vertex0},e.prototype._set=function(t,e){return this.m_vertex1.setVec2(t),this.m_vertex2.setVec2(e),this.m_hasVertex0=!1,this.m_hasVertex3=!1,this},e.prototype._clone=function(){var t=new e;return t.m_type=this.m_type,t.m_radius=this.m_radius,t.m_vertex1.setVec2(this.m_vertex1),t.m_vertex2.setVec2(this.m_vertex2),t.m_vertex0.setVec2(this.m_vertex0),t.m_vertex3.setVec2(this.m_vertex3),t.m_hasVertex0=this.m_hasVertex0,t.m_hasVertex3=this.m_hasVertex3,t},e.prototype.getChildCount=function(){return 1},e.prototype.testPoint=function(t,e){return!1},e.prototype.rayCast=function(t,e,i,s){var o=Ht.mulTVec2(i.q,Y.sub(e.p1,i.p)),n=Ht.mulTVec2(i.q,Y.sub(e.p2,i.p)),r=Y.sub(n,o),a=this.m_vertex1,h=this.m_vertex2,c=Y.sub(h,a),l=Y.neo(c.y,-c.x);l.normalize();var m=Y.dot(l,Y.sub(a,o)),u=Y.dot(l,r);if(0==u)return!1;var _=m/u;if(_<0||e.maxFraction<_)return!1;var d=Y.add(o,Y.mulNumVec2(_,r)),p=Y.sub(h,a),y=Y.dot(p,p);if(0==y)return!1;var f=Y.dot(Y.sub(d,a),p)/y;return!(f<0||1<f||(t.fraction=_,t.normal=m>0?Ht.mulVec2(i.q,l).neg():Ht.mulVec2(i.q,l),0))},e.prototype.computeAABB=function(t,e,i){qt(Ns,e,this.m_vertex1),qt(js,e,this.m_vertex2),X.combinePoints(t,Ns,js),X.extend(t,this.m_radius)},e.prototype.computeMass=function(t,e){t.mass=0,At(t.center,.5,this.m_vertex1,.5,this.m_vertex2),t.I=0},e.prototype.computeDistanceProxy=function(t){t.m_vertices[0]=this.m_vertex1,t.m_vertices[1]=this.m_vertex2,t.m_vertices.length=2,t.m_count=2,t.m_radius=this.m_radius},e.TYPE="edge",e}(te),Es=lt(0,0),Os=lt(0,0),Ds=function(t){function e(i,s){var o=this;return o instanceof e?((o=t.call(this)||this).m_type=e.TYPE,o.m_radius=G.polygonRadius,o.m_vertices=[],o.m_count=0,o.m_prevVertex=null,o.m_nextVertex=null,o.m_hasPrevVertex=!1,o.m_hasNextVertex=!1,o.m_isLoop=!!s,i&&i.length&&(s?o._createLoop(i):o._createChain(i)),o):new e(i,s)}return z(e,t),e.prototype._serialize=function(){var t={type:this.m_type,vertices:this.m_isLoop?this.m_vertices.slice(0,this.m_vertices.length-1):this.m_vertices,isLoop:this.m_isLoop,hasPrevVertex:this.m_hasPrevVertex,hasNextVertex:this.m_hasNextVertex,prevVertex:null,nextVertex:null};return this.m_prevVertex&&(t.prevVertex=this.m_prevVertex),this.m_nextVertex&&(t.nextVertex=this.m_nextVertex),t},e._deserialize=function(t,i,s){var o=[];if(t.vertices)for(var n=0;n<t.vertices.length;n++)o.push(s(Y,t.vertices[n]));var r=new e(o,t.isLoop);return t.prevVertex&&r.setPrevVertex(t.prevVertex),t.nextVertex&&r.setNextVertex(t.nextVertex),r},e.prototype.getType=function(){return this.m_type},e.prototype.getRadius=function(){return this.m_radius},e.prototype._createLoop=function(t){if(!(t.length<3)){this.m_vertices=[],this.m_count=t.length+1;for(var e=0;e<t.length;++e)this.m_vertices[e]=Y.clone(t[e]);return this.m_vertices[t.length]=Y.clone(t[0]),this.m_prevVertex=this.m_vertices[this.m_count-2],this.m_nextVertex=this.m_vertices[1],this.m_hasPrevVertex=!0,this.m_hasNextVertex=!0,this}},e.prototype._createChain=function(t){this.m_vertices=[],this.m_count=t.length;for(var e=0;e<t.length;++e)this.m_vertices[e]=Y.clone(t[e]);return this.m_prevVertex=null,this.m_nextVertex=null,this.m_hasPrevVertex=!1,this.m_hasNextVertex=!1,this},e.prototype._reset=function(){this.m_isLoop?this._createLoop(this.m_vertices.slice(0,this.m_vertices.length-1)):this._createChain(this.m_vertices)},e.prototype.setPrevVertex=function(t){this.m_prevVertex=t,this.m_hasPrevVertex=!0},e.prototype.getPrevVertex=function(){return this.m_prevVertex},e.prototype.setNextVertex=function(t){this.m_nextVertex=t,this.m_hasNextVertex=!0},e.prototype.getNextVertex=function(){return this.m_nextVertex},e.prototype._clone=function(){var t=new e;return t._createChain(this.m_vertices),t.m_type=this.m_type,t.m_radius=this.m_radius,t.m_prevVertex=this.m_prevVertex,t.m_nextVertex=this.m_nextVertex,t.m_hasPrevVertex=this.m_hasPrevVertex,t.m_hasNextVertex=this.m_hasNextVertex,t},e.prototype.getChildCount=function(){return this.m_count-1},e.prototype.getChildEdge=function(t,e){t.m_type=Rs.TYPE,t.m_radius=this.m_radius,t.m_vertex1=this.m_vertices[e],t.m_vertex2=this.m_vertices[e+1],e>0?(t.m_vertex0=this.m_vertices[e-1],t.m_hasVertex0=!0):(t.m_vertex0=this.m_prevVertex,t.m_hasVertex0=this.m_hasPrevVertex),e<this.m_count-2?(t.m_vertex3=this.m_vertices[e+2],t.m_hasVertex3=!0):(t.m_vertex3=this.m_nextVertex,t.m_hasVertex3=this.m_hasNextVertex)},e.prototype.getVertex=function(t){return t<this.m_count?this.m_vertices[t]:this.m_vertices[0]},e.prototype.isLoop=function(){return this.m_isLoop},e.prototype.testPoint=function(t,e){return!1},e.prototype.rayCast=function(t,e,i,s){return new Rs(this.getVertex(s),this.getVertex(s+1)).rayCast(t,e,i,0)},e.prototype.computeAABB=function(t,e,i){qt(Es,e,this.getVertex(i)),qt(Os,e,this.getVertex(i+1)),X.combinePoints(t,Es,Os)},e.prototype.computeMass=function(t,e){t.mass=0,_t(t.center),t.I=0},e.prototype.computeDistanceProxy=function(t,e){t.m_vertices[0]=this.getVertex(e),t.m_vertices[1]=this.getVertex(e+1),t.m_count=2,t.m_radius=this.m_radius},e.TYPE="chain",e}(te),Hs=Math.max,Ys=Math.min,Ws=lt(0,0),Us=lt(0,0),Xs=lt(0,0),Js=lt(0,0),$s=lt(0,0),Gs=lt(0,0),Ks=function(t){function e(i){var s=this;return s instanceof e?((s=t.call(this)||this).m_type=e.TYPE,s.m_radius=G.polygonRadius,s.m_centroid=Y.zero(),s.m_vertices=[],s.m_normals=[],s.m_count=0,i&&i.length&&s._set(i),s):new e(i)}return z(e,t),e.prototype._serialize=function(){return{type:this.m_type,vertices:this.m_vertices}},e._deserialize=function(t,i,s){var o=[];if(t.vertices)for(var n=0;n<t.vertices.length;n++)o.push(s(Y,t.vertices[n]));return new e(o)},e.prototype.getType=function(){return this.m_type},e.prototype.getRadius=function(){return this.m_radius},e.prototype._clone=function(){var t=new e;t.m_type=this.m_type,t.m_radius=this.m_radius,t.m_count=this.m_count,t.m_centroid.setVec2(this.m_centroid);for(var i=0;i<this.m_count;i++)t.m_vertices.push(this.m_vertices[i].clone());for(i=0;i<this.m_normals.length;i++)t.m_normals.push(this.m_normals[i].clone());return t},e.prototype.getChildCount=function(){return 1},e.prototype._reset=function(){this._set(this.m_vertices)},e.prototype._set=function(t){if(t.length<3)this._setAsBox(1,1);else{for(var e=Ys(t.length,G.maxPolygonVertices),i=[],s=0;s<e;++s){for(var o=t[s],n=!0,r=0;r<i.length;++r)if(Y.distanceSquared(o,i[r])<.25*G.linearSlopSquared){n=!1;break}n&&i.push(Y.clone(o))}if((e=i.length)<3)this._setAsBox(1,1);else{var a=0,h=i[0].x;for(s=1;s<e;++s){var c=i[s].x;(c>h||c===h&&i[s].y<i[a].y)&&(a=s,h=c)}for(var l=[],m=0,u=a;;){l[m]=u;var _=0;for(r=1;r<e;++r)if(_!==u){var d=Y.sub(i[_],i[l[m]]),p=(o=Y.sub(i[r],i[l[m]]),Y.crossVec2Vec2(d,o));p<0&&(_=r),0===p&&o.lengthSquared()>d.lengthSquared()&&(_=r)}else _=r;if(++m,u=_,_===a)break}if(m<3)this._setAsBox(1,1);else{for(this.m_count=m,this.m_vertices=[],s=0;s<m;++s)this.m_vertices[s]=i[l[s]];for(s=0;s<m;++s){var y=s,f=s+1<m?s+1:0,g=Y.sub(this.m_vertices[f],this.m_vertices[y]);this.m_normals[s]=Y.crossVec2Num(g,1),this.m_normals[s].normalize()}this.m_centroid=function(t,e){for(var i=Y.zero(),s=0,o=Y.zero(),n=1/3,r=0;r<e;++r){var a=o,h=t[r],c=r+1<e?t[r+1]:t[0],l=Y.sub(h,a),m=Y.sub(c,a),u=.5*Y.crossVec2Vec2(l,m);s+=u,wt(Ws,1,a,1,h,1,c),xt(i,u*n,Ws)}return i.mul(1/s),i}(this.m_vertices,m)}}}},e.prototype._setAsBox=function(t,e,i,s){if(this.m_vertices[0]=Y.neo(t,-e),this.m_vertices[1]=Y.neo(t,e),this.m_vertices[2]=Y.neo(-t,e),this.m_vertices[3]=Y.neo(-t,-e),this.m_normals[0]=Y.neo(1,0),this.m_normals[1]=Y.neo(0,1),this.m_normals[2]=Y.neo(-1,0),this.m_normals[3]=Y.neo(0,-1),this.m_count=4,i&&Y.isValid(i)){s=s||0,ut(this.m_centroid,i);var o=Jt.identity();o.p.setVec2(i),o.q.setAngle(s);for(var n=0;n<this.m_count;++n)this.m_vertices[n]=Jt.mulVec2(o,this.m_vertices[n]),this.m_normals[n]=Ht.mulVec2(o.q,this.m_normals[n])}},e.prototype.testPoint=function(t,e){for(var i=Nt(Ws,t,e),s=0;s<this.m_count;++s)if(Pt(this.m_normals[s],i)-Pt(this.m_normals[s],this.m_vertices[s])>0)return!1;return!0},e.prototype.rayCast=function(t,e,i,s){for(var o=Ht.mulTVec2(i.q,Y.sub(e.p1,i.p)),n=Ht.mulTVec2(i.q,Y.sub(e.p2,i.p)),r=Y.sub(n,o),a=0,h=e.maxFraction,c=-1,l=0;l<this.m_count;++l){var m=Y.dot(this.m_normals[l],Y.sub(this.m_vertices[l],o)),u=Y.dot(this.m_normals[l],r);if(0==u){if(m<0)return!1}else u<0&&m<a*u?(a=m/u,c=l):u>0&&m<h*u&&(h=m/u);if(h<a)return!1}return c>=0&&(t.fraction=a,t.normal=Ht.mulVec2(i.q,this.m_normals[c]),!0)},e.prototype.computeAABB=function(t,e,i){for(var s=1/0,o=1/0,n=-1/0,r=-1/0,a=0;a<this.m_count;++a){var h=qt(Ws,e,this.m_vertices[a]);s=Ys(s,h.x),n=Hs(n,h.x),o=Ys(o,h.y),r=Hs(r,h.y)}mt(t.lowerBound,s-this.m_radius,o-this.m_radius),mt(t.upperBound,n+this.m_radius,r+this.m_radius)},e.prototype.computeMass=function(t,e){_t($s);var i=0,s=0;_t(Gs);for(var o=0;o<this.m_count;++o)pt(Gs,this.m_vertices[o]);vt(Gs,1/this.m_count,Gs);var n,r,a,h=1/3;for(o=0;o<this.m_count;++o){ft(Xs,this.m_vertices[o],Gs),o+1<this.m_count?ft(Js,this.m_vertices[o+1],Gs):ft(Js,this.m_vertices[0],Gs);var c=Mt(Xs,Js),l=.5*c;i+=l,At(Ws,l*h,Xs,l*h,Js),pt($s,Ws);var m=Xs.x,u=Xs.y,_=Js.x,d=Js.y;s+=.25*h*c*(m*m+_*m+_*_+(u*u+d*u+d*d))}t.mass=e*i,vt($s,1/i,$s),n=t.center,r=$s,a=Gs,n.x=r.x+a.x,n.y=r.x+a.y,t.I=e*s,t.I+=t.mass*(Pt(t.center,t.center)-Pt($s,$s))},e.prototype.validate=function(){for(var t=0;t<this.m_count;++t){var e=t,i=t<this.m_count-1?e+1:0,s=this.m_vertices[e];ft(Us,this.m_vertices[i],s);for(var o=0;o<this.m_count;++o)if(o!=e&&o!=i&&Mt(Us,ft(Ws,this.m_vertices[o],s))<0)return!1}return!0},e.prototype.computeDistanceProxy=function(t){for(var e=0;e<this.m_count;++e)t.m_vertices[e]=this.m_vertices[e];t.m_vertices.length=this.m_count,t.m_count=this.m_count,t.m_radius=this.m_radius},e.TYPE="polygon",e}(te),Zs=Math.sqrt,Qs=Math.PI,to=lt(0,0),eo=function(t){function e(i,s){var o=this;return o instanceof e?((o=t.call(this)||this).m_type=e.TYPE,o.m_p=Y.zero(),o.m_radius=1,"object"==typeof i&&Y.isValid(i)?(o.m_p.setVec2(i),"number"==typeof s&&(o.m_radius=s)):"number"==typeof i&&(o.m_radius=i),o):new e(i,s)}return z(e,t),e.prototype._serialize=function(){return{type:this.m_type,p:this.m_p,radius:this.m_radius}},e._deserialize=function(t){return new e(t.p,t.radius)},e.prototype._reset=function(){},e.prototype.getType=function(){return this.m_type},e.prototype.getRadius=function(){return this.m_radius},e.prototype.getCenter=function(){return this.m_p},e.prototype._clone=function(){var t=new e;return t.m_type=this.m_type,t.m_radius=this.m_radius,t.m_p=this.m_p.clone(),t},e.prototype.getChildCount=function(){return 1},e.prototype.testPoint=function(t,e){return zt(e,qt(to,t,this.m_p))<=this.m_radius*this.m_radius},e.prototype.rayCast=function(t,e,i,s){var o=Y.add(i.p,Ht.mulVec2(i.q,this.m_p)),n=Y.sub(e.p1,o),r=Y.dot(n,n)-this.m_radius*this.m_radius,a=Y.sub(e.p2,e.p1),h=Y.dot(n,a),c=Y.dot(a,a),l=h*h-c*r;if(l<0||c<k)return!1;var m=-(h+Zs(l));return 0<=m&&m<=e.maxFraction*c&&(m/=c,t.fraction=m,t.normal=Y.add(n,Y.mulNumVec2(m,a)),t.normal.normalize(),!0)},e.prototype.computeAABB=function(t,e,i){var s=qt(to,e,this.m_p);mt(t.lowerBound,s.x-this.m_radius,s.y-this.m_radius),mt(t.upperBound,s.x+this.m_radius,s.y+this.m_radius)},e.prototype.computeMass=function(t,e){t.mass=e*Qs*this.m_radius*this.m_radius,ut(t.center,this.m_p),t.I=t.mass*(.5*this.m_radius*this.m_radius+Vt(this.m_p))},e.prototype.computeDistanceProxy=function(t){t.m_vertices[0]=this.m_p,t.m_vertices.length=1,t.m_count=1,t.m_radius=this.m_radius},e.TYPE="circle",e}(te),io=Math.abs,so=Math.PI,oo={frequencyHz:0,dampingRatio:0},no=function(t){function e(i,s,o,n,r){var a=this;if(!(a instanceof e))return new e(i,s,o,n,r);if(o&&n&&"m_type"in n&&"x"in o&&"y"in o){var h=o;o=n,n=h}return i=L(i,oo),s=(a=t.call(this,i,s,o)||this).m_bodyA,o=a.m_bodyB,a.m_type=e.TYPE,a.m_localAnchorA=Y.clone(n?s.getLocalPoint(n):i.localAnchorA||Y.zero()),a.m_localAnchorB=Y.clone(r?o.getLocalPoint(r):i.localAnchorB||Y.zero()),a.m_length=Number.isFinite(i.length)?i.length:Y.distance(s.getWorldPoint(a.m_localAnchorA),o.getWorldPoint(a.m_localAnchorB)),a.m_frequencyHz=i.frequencyHz,a.m_dampingRatio=i.dampingRatio,a.m_impulse=0,a.m_gamma=0,a.m_bias=0,a}return z(e,t),e.prototype._serialize=function(){return{type:this.m_type,bodyA:this.m_bodyA,bodyB:this.m_bodyB,collideConnected:this.m_collideConnected,frequencyHz:this.m_frequencyHz,dampingRatio:this.m_dampingRatio,localAnchorA:this.m_localAnchorA,localAnchorB:this.m_localAnchorB,length:this.m_length,impulse:this.m_impulse,gamma:this.m_gamma,bias:this.m_bias}},e._deserialize=function(t,i,s){return(t=T({},t)).bodyA=s(ye,t.bodyA,i),t.bodyB=s(ye,t.bodyB,i),new e(t)},e.prototype._reset=function(t){t.anchorA?this.m_localAnchorA.setVec2(this.m_bodyA.getLocalPoint(t.anchorA)):t.localAnchorA&&this.m_localAnchorA.setVec2(t.localAnchorA),t.anchorB?this.m_localAnchorB.setVec2(this.m_bodyB.getLocalPoint(t.anchorB)):t.localAnchorB&&this.m_localAnchorB.setVec2(t.localAnchorB),t.length>0?this.m_length=+t.length:t.length<0||(t.anchorA||t.anchorA||t.anchorA||t.anchorA)&&(this.m_length=Y.distance(this.m_bodyA.getWorldPoint(this.m_localAnchorA),this.m_bodyB.getWorldPoint(this.m_localAnchorB))),Number.isFinite(t.frequencyHz)&&(this.m_frequencyHz=t.frequencyHz),Number.isFinite(t.dampingRatio)&&(this.m_dampingRatio=t.dampingRatio)},e.prototype.getLocalAnchorA=function(){return this.m_localAnchorA},e.prototype.getLocalAnchorB=function(){return this.m_localAnchorB},e.prototype.setLength=function(t){this.m_length=t},e.prototype.getLength=function(){return this.m_length},e.prototype.setFrequency=function(t){this.m_frequencyHz=t},e.prototype.getFrequency=function(){return this.m_frequencyHz},e.prototype.setDampingRatio=function(t){this.m_dampingRatio=t},e.prototype.getDampingRatio=function(){return this.m_dampingRatio},e.prototype.getAnchorA=function(){return this.m_bodyA.getWorldPoint(this.m_localAnchorA)},e.prototype.getAnchorB=function(){return this.m_bodyB.getWorldPoint(this.m_localAnchorB)},e.prototype.getReactionForce=function(t){return Y.mulNumVec2(this.m_impulse,this.m_u).mul(t)},e.prototype.getReactionTorque=function(t){return 0},e.prototype.initVelocityConstraints=function(t){this.m_localCenterA=this.m_bodyA.m_sweep.localCenter,this.m_localCenterB=this.m_bodyB.m_sweep.localCenter,this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;var e=this.m_bodyA.c_position.c,i=this.m_bodyA.c_position.a,s=this.m_bodyA.c_velocity.v,o=this.m_bodyA.c_velocity.w,n=this.m_bodyB.c_position.c,r=this.m_bodyB.c_position.a,a=this.m_bodyB.c_velocity.v,h=this.m_bodyB.c_velocity.w,c=Ht.neo(i),l=Ht.neo(r);this.m_rA=Ht.mulVec2(c,Y.sub(this.m_localAnchorA,this.m_localCenterA)),this.m_rB=Ht.mulVec2(l,Y.sub(this.m_localAnchorB,this.m_localCenterB)),this.m_u=Y.sub(Y.add(n,this.m_rB),Y.add(e,this.m_rA));var m=this.m_u.length();m>G.linearSlop?this.m_u.mul(1/m):this.m_u.setNum(0,0);var u=Y.crossVec2Vec2(this.m_rA,this.m_u),_=Y.crossVec2Vec2(this.m_rB,this.m_u),d=this.m_invMassA+this.m_invIA*u*u+this.m_invMassB+this.m_invIB*_*_;if(this.m_mass=0!=d?1/d:0,this.m_frequencyHz>0){var p=m-this.m_length,y=2*so*this.m_frequencyHz,f=2*this.m_mass*this.m_dampingRatio*y,g=this.m_mass*y*y,v=t.dt;this.m_gamma=v*(f+v*g),this.m_gamma=0!=this.m_gamma?1/this.m_gamma:0,this.m_bias=p*v*g*this.m_gamma,d+=this.m_gamma,this.m_mass=0!=d?1/d:0}else this.m_gamma=0,this.m_bias=0;if(t.warmStarting){this.m_impulse*=t.dtRatio;var x=Y.mulNumVec2(this.m_impulse,this.m_u);s.subMul(this.m_invMassA,x),o-=this.m_invIA*Y.crossVec2Vec2(this.m_rA,x),a.addMul(this.m_invMassB,x),h+=this.m_invIB*Y.crossVec2Vec2(this.m_rB,x)}else this.m_impulse=0;this.m_bodyA.c_velocity.v.setVec2(s),this.m_bodyA.c_velocity.w=o,this.m_bodyB.c_velocity.v.setVec2(a),this.m_bodyB.c_velocity.w=h},e.prototype.solveVelocityConstraints=function(t){var e=this.m_bodyA.c_velocity.v,i=this.m_bodyA.c_velocity.w,s=this.m_bodyB.c_velocity.v,o=this.m_bodyB.c_velocity.w,n=Y.add(e,Y.crossNumVec2(i,this.m_rA)),r=Y.add(s,Y.crossNumVec2(o,this.m_rB)),a=Y.dot(this.m_u,r)-Y.dot(this.m_u,n),h=-this.m_mass*(a+this.m_bias+this.m_gamma*this.m_impulse);this.m_impulse+=h;var c=Y.mulNumVec2(h,this.m_u);e.subMul(this.m_invMassA,c),i-=this.m_invIA*Y.crossVec2Vec2(this.m_rA,c),s.addMul(this.m_invMassB,c),o+=this.m_invIB*Y.crossVec2Vec2(this.m_rB,c),this.m_bodyA.c_velocity.v.setVec2(e),this.m_bodyA.c_velocity.w=i,this.m_bodyB.c_velocity.v.setVec2(s),this.m_bodyB.c_velocity.w=o},e.prototype.solvePositionConstraints=function(t){if(this.m_frequencyHz>0)return!0;var e=this.m_bodyA.c_position.c,i=this.m_bodyA.c_position.a,s=this.m_bodyB.c_position.c,o=this.m_bodyB.c_position.a,n=Ht.neo(i),r=Ht.neo(o),a=Ht.mulSub(n,this.m_localAnchorA,this.m_localCenterA),h=Ht.mulSub(r,this.m_localAnchorB,this.m_localCenterB),c=Y.sub(Y.add(s,h),Y.add(e,a)),l=j(c.normalize()-this.m_length,-G.maxLinearCorrection,G.maxLinearCorrection),m=-this.m_mass*l,u=Y.mulNumVec2(m,c);return e.subMul(this.m_invMassA,u),i-=this.m_invIA*Y.crossVec2Vec2(a,u),s.addMul(this.m_invMassB,u),o+=this.m_invIB*Y.crossVec2Vec2(h,u),this.m_bodyA.c_position.c.setVec2(e),this.m_bodyA.c_position.a=i,this.m_bodyB.c_position.c.setVec2(s),this.m_bodyB.c_position.a=o,io(l)<G.linearSlop},e.TYPE="distance-joint",e}(ge),ro={maxForce:0,maxTorque:0},ao=function(t){function e(i,s,o,n){var r=this;return r instanceof e?(i=L(i,ro),s=(r=t.call(this,i,s,o)||this).m_bodyA,o=r.m_bodyB,r.m_type=e.TYPE,r.m_localAnchorA=Y.clone(n?s.getLocalPoint(n):i.localAnchorA||Y.zero()),r.m_localAnchorB=Y.clone(n?o.getLocalPoint(n):i.localAnchorB||Y.zero()),r.m_linearImpulse=Y.zero(),r.m_angularImpulse=0,r.m_maxForce=i.maxForce,r.m_maxTorque=i.maxTorque,r):new e(i,s,o,n)}return z(e,t),e.prototype._serialize=function(){return{type:this.m_type,bodyA:this.m_bodyA,bodyB:this.m_bodyB,collideConnected:this.m_collideConnected,maxForce:this.m_maxForce,maxTorque:this.m_maxTorque,localAnchorA:this.m_localAnchorA,localAnchorB:this.m_localAnchorB}},e._deserialize=function(t,i,s){return(t=T({},t)).bodyA=s(ye,t.bodyA,i),t.bodyB=s(ye,t.bodyB,i),new e(t)},e.prototype._reset=function(t){t.anchorA?this.m_localAnchorA.setVec2(this.m_bodyA.getLocalPoint(t.anchorA)):t.localAnchorA&&this.m_localAnchorA.setVec2(t.localAnchorA),t.anchorB?this.m_localAnchorB.setVec2(this.m_bodyB.getLocalPoint(t.anchorB)):t.localAnchorB&&this.m_localAnchorB.setVec2(t.localAnchorB),Number.isFinite(t.maxForce)&&(this.m_maxForce=t.maxForce),Number.isFinite(t.maxTorque)&&(this.m_maxTorque=t.maxTorque)},e.prototype.getLocalAnchorA=function(){return this.m_localAnchorA},e.prototype.getLocalAnchorB=function(){return this.m_localAnchorB},e.prototype.setMaxForce=function(t){this.m_maxForce=t},e.prototype.getMaxForce=function(){return this.m_maxForce},e.prototype.setMaxTorque=function(t){this.m_maxTorque=t},e.prototype.getMaxTorque=function(){return this.m_maxTorque},e.prototype.getAnchorA=function(){return this.m_bodyA.getWorldPoint(this.m_localAnchorA)},e.prototype.getAnchorB=function(){return this.m_bodyB.getWorldPoint(this.m_localAnchorB)},e.prototype.getReactionForce=function(t){return Y.mulNumVec2(t,this.m_linearImpulse)},e.prototype.getReactionTorque=function(t){return t*this.m_angularImpulse},e.prototype.initVelocityConstraints=function(t){this.m_localCenterA=this.m_bodyA.m_sweep.localCenter,this.m_localCenterB=this.m_bodyB.m_sweep.localCenter,this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;var e=this.m_bodyA.c_position.a,i=this.m_bodyA.c_velocity.v,s=this.m_bodyA.c_velocity.w,o=this.m_bodyB.c_position.a,n=this.m_bodyB.c_velocity.v,r=this.m_bodyB.c_velocity.w,a=Ht.neo(e),h=Ht.neo(o);this.m_rA=Ht.mulVec2(a,Y.sub(this.m_localAnchorA,this.m_localCenterA)),this.m_rB=Ht.mulVec2(h,Y.sub(this.m_localAnchorB,this.m_localCenterB));var c=this.m_invMassA,l=this.m_invMassB,m=this.m_invIA,u=this.m_invIB,_=new zi;if(_.ex.x=c+l+m*this.m_rA.y*this.m_rA.y+u*this.m_rB.y*this.m_rB.y,_.ex.y=-m*this.m_rA.x*this.m_rA.y-u*this.m_rB.x*this.m_rB.y,_.ey.x=_.ex.y,_.ey.y=c+l+m*this.m_rA.x*this.m_rA.x+u*this.m_rB.x*this.m_rB.x,this.m_linearMass=_.getInverse(),this.m_angularMass=m+u,this.m_angularMass>0&&(this.m_angularMass=1/this.m_angularMass),t.warmStarting){this.m_linearImpulse.mul(t.dtRatio),this.m_angularImpulse*=t.dtRatio;var d=Y.neo(this.m_linearImpulse.x,this.m_linearImpulse.y);i.subMul(c,d),s-=m*(Y.crossVec2Vec2(this.m_rA,d)+this.m_angularImpulse),n.addMul(l,d),r+=u*(Y.crossVec2Vec2(this.m_rB,d)+this.m_angularImpulse)}else this.m_linearImpulse.setZero(),this.m_angularImpulse=0;this.m_bodyA.c_velocity.v=i,this.m_bodyA.c_velocity.w=s,this.m_bodyB.c_velocity.v=n,this.m_bodyB.c_velocity.w=r},e.prototype.solveVelocityConstraints=function(t){var e=this.m_bodyA.c_velocity.v,i=this.m_bodyA.c_velocity.w,s=this.m_bodyB.c_velocity.v,o=this.m_bodyB.c_velocity.w,n=this.m_invMassA,r=this.m_invMassB,a=this.m_invIA,h=this.m_invIB,c=t.dt,l=o-i,m=-this.m_angularMass*l,u=this.m_angularImpulse,_=c*this.m_maxTorque;this.m_angularImpulse=j(this.m_angularImpulse+m,-_,_),i-=a*(m=this.m_angularImpulse-u),o+=h*m,l=Y.sub(Y.add(s,Y.crossNumVec2(o,this.m_rB)),Y.add(e,Y.crossNumVec2(i,this.m_rA))),m=Y.neg(zi.mulVec2(this.m_linearMass,l)),u=this.m_linearImpulse,this.m_linearImpulse.add(m),_=c*this.m_maxForce,this.m_linearImpulse.lengthSquared()>_*_&&(this.m_linearImpulse.normalize(),this.m_linearImpulse.mul(_)),m=Y.sub(this.m_linearImpulse,u),e.subMul(n,m),i-=a*Y.crossVec2Vec2(this.m_rA,m),s.addMul(r,m),o+=h*Y.crossVec2Vec2(this.m_rB,m),this.m_bodyA.c_velocity.v=e,this.m_bodyA.c_velocity.w=i,this.m_bodyB.c_velocity.v=s,this.m_bodyB.c_velocity.w=o},e.prototype.solvePositionConstraints=function(t){return!0},e.TYPE="friction-joint",e}(ge),ho=function(){function t(t,e,i){"object"==typeof t&&null!==t?(this.ex=qs.clone(t),this.ey=qs.clone(e),this.ez=qs.clone(i)):(this.ex=qs.zero(),this.ey=qs.zero(),this.ez=qs.zero())}return t.prototype.toString=function(){return JSON.stringify(this)},t.isValid=function(t){return null!=t&&qs.isValid(t.ex)&&qs.isValid(t.ey)&&qs.isValid(t.ez)},t.assert=function(t){},t.prototype.setZero=function(){return this.ex.setZero(),this.ey.setZero(),this.ez.setZero(),this},t.prototype.solve33=function(t){var e=this.ey.y*this.ez.z-this.ey.z*this.ez.y,i=this.ey.z*this.ez.x-this.ey.x*this.ez.z,s=this.ey.x*this.ez.y-this.ey.y*this.ez.x,o=this.ex.x*e+this.ex.y*i+this.ex.z*s;0!==o&&(o=1/o);var n=new qs;return e=this.ey.y*this.ez.z-this.ey.z*this.ez.y,i=this.ey.z*this.ez.x-this.ey.x*this.ez.z,s=this.ey.x*this.ez.y-this.ey.y*this.ez.x,n.x=o*(t.x*e+t.y*i+t.z*s),e=t.y*this.ez.z-t.z*this.ez.y,i=t.z*this.ez.x-t.x*this.ez.z,s=t.x*this.ez.y-t.y*this.ez.x,n.y=o*(this.ex.x*e+this.ex.y*i+this.ex.z*s),e=this.ey.y*t.z-this.ey.z*t.y,i=this.ey.z*t.x-this.ey.x*t.z,s=this.ey.x*t.y-this.ey.y*t.x,n.z=o*(this.ex.x*e+this.ex.y*i+this.ex.z*s),n},t.prototype.solve22=function(t){var e=this.ex.x,i=this.ey.x,s=this.ex.y,o=this.ey.y,n=e*o-i*s;0!==n&&(n=1/n);var r=Y.zero();return r.x=n*(o*t.x-i*t.y),r.y=n*(e*t.y-s*t.x),r},t.prototype.getInverse22=function(t){var e=this.ex.x,i=this.ey.x,s=this.ex.y,o=this.ey.y,n=e*o-i*s;0!==n&&(n=1/n),t.ex.x=n*o,t.ey.x=-n*i,t.ex.z=0,t.ex.y=-n*s,t.ey.y=n*e,t.ey.z=0,t.ez.x=0,t.ez.y=0,t.ez.z=0},t.prototype.getSymInverse33=function(t){var e=qs.dot(this.ex,qs.cross(this.ey,this.ez));0!==e&&(e=1/e);var i=this.ex.x,s=this.ey.x,o=this.ez.x,n=this.ey.y,r=this.ez.y,a=this.ez.z;t.ex.x=e*(n*a-r*r),t.ex.y=e*(o*r-s*a),t.ex.z=e*(s*r-o*n),t.ey.x=t.ex.y,t.ey.y=e*(i*a-o*o),t.ey.z=e*(o*s-i*r),t.ez.x=t.ex.z,t.ez.y=t.ey.z,t.ez.z=e*(i*n-s*s)},t.mul=function(t,e){if(e&&"z"in e&&"y"in e&&"x"in e){var i=t.ex.x*e.x+t.ey.x*e.y+t.ez.x*e.z,s=t.ex.y*e.x+t.ey.y*e.y+t.ez.y*e.z,o=t.ex.z*e.x+t.ey.z*e.y+t.ez.z*e.z;return new qs(i,s,o)}if(e&&"y"in e&&"x"in e)return i=t.ex.x*e.x+t.ey.x*e.y,s=t.ex.y*e.x+t.ey.y*e.y,Y.neo(i,s)},t.mulVec3=function(t,e){var i=t.ex.x*e.x+t.ey.x*e.y+t.ez.x*e.z,s=t.ex.y*e.x+t.ey.y*e.y+t.ez.y*e.z,o=t.ex.z*e.x+t.ey.z*e.y+t.ez.z*e.z;return new qs(i,s,o)},t.mulVec2=function(t,e){var i=t.ex.x*e.x+t.ey.x*e.y,s=t.ex.y*e.x+t.ey.y*e.y;return Y.neo(i,s)},t.add=function(e,i){return new t(qs.add(e.ex,i.ex),qs.add(e.ey,i.ey),qs.add(e.ez,i.ez))},t}(),co=Math.abs;(os=ss||(ss={}))[os.inactiveLimit=0]="inactiveLimit",os[os.atLowerLimit=1]="atLowerLimit",os[os.atUpperLimit=2]="atUpperLimit",os[os.equalLimits=3]="equalLimits";var lo,mo=function(t){function e(i,s,o,n){var r,a,h,c,l,m,u=this;return u instanceof e?(i=null!=i?i:{},s=(u=t.call(this,i,s,o)||this).m_bodyA,o=u.m_bodyB,u.m_mass=new ho,u.m_limitState=ss.inactiveLimit,u.m_type=e.TYPE,Y.isValid(n)?u.m_localAnchorA=s.getLocalPoint(n):Y.isValid(i.localAnchorA)?u.m_localAnchorA=Y.clone(i.localAnchorA):u.m_localAnchorA=Y.zero(),Y.isValid(n)?u.m_localAnchorB=o.getLocalPoint(n):Y.isValid(i.localAnchorB)?u.m_localAnchorB=Y.clone(i.localAnchorB):u.m_localAnchorB=Y.zero(),Number.isFinite(i.referenceAngle)?u.m_referenceAngle=i.referenceAngle:u.m_referenceAngle=o.getAngle()-s.getAngle(),u.m_impulse=new qs,u.m_motorImpulse=0,u.m_lowerAngle=null!==(r=i.lowerAngle)&&void 0!==r?r:0,u.m_upperAngle=null!==(a=i.upperAngle)&&void 0!==a?a:0,u.m_maxMotorTorque=null!==(h=i.maxMotorTorque)&&void 0!==h?h:0,u.m_motorSpeed=null!==(c=i.motorSpeed)&&void 0!==c?c:0,u.m_enableLimit=null!==(l=i.enableLimit)&&void 0!==l&&l,u.m_enableMotor=null!==(m=i.enableMotor)&&void 0!==m&&m,u):new e(i,s,o,n)}return z(e,t),e.prototype._serialize=function(){return{type:this.m_type,bodyA:this.m_bodyA,bodyB:this.m_bodyB,collideConnected:this.m_collideConnected,lowerAngle:this.m_lowerAngle,upperAngle:this.m_upperAngle,maxMotorTorque:this.m_maxMotorTorque,motorSpeed:this.m_motorSpeed,enableLimit:this.m_enableLimit,enableMotor:this.m_enableMotor,localAnchorA:this.m_localAnchorA,localAnchorB:this.m_localAnchorB,referenceAngle:this.m_referenceAngle}},e._deserialize=function(t,i,s){return(t=T({},t)).bodyA=s(ye,t.bodyA,i),t.bodyB=s(ye,t.bodyB,i),new e(t)},e.prototype._reset=function(t){t.anchorA?this.m_localAnchorA.setVec2(this.m_bodyA.getLocalPoint(t.anchorA)):t.localAnchorA&&this.m_localAnchorA.setVec2(t.localAnchorA),t.anchorB?this.m_localAnchorB.setVec2(this.m_bodyB.getLocalPoint(t.anchorB)):t.localAnchorB&&this.m_localAnchorB.setVec2(t.localAnchorB),Number.isFinite(t.referenceAngle)&&(this.m_referenceAngle=t.referenceAngle),void 0!==t.enableLimit&&(this.m_enableLimit=t.enableLimit),Number.isFinite(t.lowerAngle)&&(this.m_lowerAngle=t.lowerAngle),Number.isFinite(t.upperAngle)&&(this.m_upperAngle=t.upperAngle),Number.isFinite(t.maxMotorTorque)&&(this.m_maxMotorTorque=t.maxMotorTorque),Number.isFinite(t.motorSpeed)&&(this.m_motorSpeed=t.motorSpeed),void 0!==t.enableMotor&&(this.m_enableMotor=t.enableMotor)},e.prototype.getLocalAnchorA=function(){return this.m_localAnchorA},e.prototype.getLocalAnchorB=function(){return this.m_localAnchorB},e.prototype.getReferenceAngle=function(){return this.m_referenceAngle},e.prototype.getJointAngle=function(){var t=this.m_bodyA;return this.m_bodyB.m_sweep.a-t.m_sweep.a-this.m_referenceAngle},e.prototype.getJointSpeed=function(){var t=this.m_bodyA;return this.m_bodyB.m_angularVelocity-t.m_angularVelocity},e.prototype.isMotorEnabled=function(){return this.m_enableMotor},e.prototype.enableMotor=function(t){t!=this.m_enableMotor&&(this.m_bodyA.setAwake(!0),this.m_bodyB.setAwake(!0),this.m_enableMotor=t)},e.prototype.getMotorTorque=function(t){return t*this.m_motorImpulse},e.prototype.setMotorSpeed=function(t){t!=this.m_motorSpeed&&(this.m_bodyA.setAwake(!0),this.m_bodyB.setAwake(!0),this.m_motorSpeed=t)},e.prototype.getMotorSpeed=function(){return this.m_motorSpeed},e.prototype.setMaxMotorTorque=function(t){t!=this.m_maxMotorTorque&&(this.m_bodyA.setAwake(!0),this.m_bodyB.setAwake(!0),this.m_maxMotorTorque=t)},e.prototype.getMaxMotorTorque=function(){return this.m_maxMotorTorque},e.prototype.isLimitEnabled=function(){return this.m_enableLimit},e.prototype.enableLimit=function(t){t!=this.m_enableLimit&&(this.m_bodyA.setAwake(!0),this.m_bodyB.setAwake(!0),this.m_enableLimit=t,this.m_impulse.z=0)},e.prototype.getLowerLimit=function(){return this.m_lowerAngle},e.prototype.getUpperLimit=function(){return this.m_upperAngle},e.prototype.setLimits=function(t,e){t==this.m_lowerAngle&&e==this.m_upperAngle||(this.m_bodyA.setAwake(!0),this.m_bodyB.setAwake(!0),this.m_impulse.z=0,this.m_lowerAngle=t,this.m_upperAngle=e)},e.prototype.getAnchorA=function(){return this.m_bodyA.getWorldPoint(this.m_localAnchorA)},e.prototype.getAnchorB=function(){return this.m_bodyB.getWorldPoint(this.m_localAnchorB)},e.prototype.getReactionForce=function(t){return Y.neo(this.m_impulse.x,this.m_impulse.y).mul(t)},e.prototype.getReactionTorque=function(t){return t*this.m_impulse.z},e.prototype.initVelocityConstraints=function(t){this.m_localCenterA=this.m_bodyA.m_sweep.localCenter,this.m_localCenterB=this.m_bodyB.m_sweep.localCenter,this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;var e=this.m_bodyA.c_position.a,i=this.m_bodyA.c_velocity.v,s=this.m_bodyA.c_velocity.w,o=this.m_bodyB.c_position.a,n=this.m_bodyB.c_velocity.v,r=this.m_bodyB.c_velocity.w,a=Ht.neo(e),h=Ht.neo(o);this.m_rA=Ht.mulVec2(a,Y.sub(this.m_localAnchorA,this.m_localCenterA)),this.m_rB=Ht.mulVec2(h,Y.sub(this.m_localAnchorB,this.m_localCenterB));var c=this.m_invMassA,l=this.m_invMassB,m=this.m_invIA,u=this.m_invIB,_=m+u===0;if(this.m_mass.ex.x=c+l+this.m_rA.y*this.m_rA.y*m+this.m_rB.y*this.m_rB.y*u,this.m_mass.ey.x=-this.m_rA.y*this.m_rA.x*m-this.m_rB.y*this.m_rB.x*u,this.m_mass.ez.x=-this.m_rA.y*m-this.m_rB.y*u,this.m_mass.ex.y=this.m_mass.ey.x,this.m_mass.ey.y=c+l+this.m_rA.x*this.m_rA.x*m+this.m_rB.x*this.m_rB.x*u,this.m_mass.ez.y=this.m_rA.x*m+this.m_rB.x*u,this.m_mass.ex.z=this.m_mass.ez.x,this.m_mass.ey.z=this.m_mass.ez.y,this.m_mass.ez.z=m+u,this.m_motorMass=m+u,this.m_motorMass>0&&(this.m_motorMass=1/this.m_motorMass),(0==this.m_enableMotor||_)&&(this.m_motorImpulse=0),this.m_enableLimit&&0==_){var d=o-e-this.m_referenceAngle;co(this.m_upperAngle-this.m_lowerAngle)<2*G.angularSlop?this.m_limitState=ss.equalLimits:d<=this.m_lowerAngle?(this.m_limitState!=ss.atLowerLimit&&(this.m_impulse.z=0),this.m_limitState=ss.atLowerLimit):d>=this.m_upperAngle?(this.m_limitState!=ss.atUpperLimit&&(this.m_impulse.z=0),this.m_limitState=ss.atUpperLimit):(this.m_limitState=ss.inactiveLimit,this.m_impulse.z=0)}else this.m_limitState=ss.inactiveLimit;if(t.warmStarting){this.m_impulse.mul(t.dtRatio),this.m_motorImpulse*=t.dtRatio;var p=Y.neo(this.m_impulse.x,this.m_impulse.y);i.subMul(c,p),s-=m*(Y.crossVec2Vec2(this.m_rA,p)+this.m_motorImpulse+this.m_impulse.z),n.addMul(l,p),r+=u*(Y.crossVec2Vec2(this.m_rB,p)+this.m_motorImpulse+this.m_impulse.z)}else this.m_impulse.setZero(),this.m_motorImpulse=0;this.m_bodyA.c_velocity.v=i,this.m_bodyA.c_velocity.w=s,this.m_bodyB.c_velocity.v=n,this.m_bodyB.c_velocity.w=r},e.prototype.solveVelocityConstraints=function(t){var e=this.m_bodyA.c_velocity.v,i=this.m_bodyA.c_velocity.w,s=this.m_bodyB.c_velocity.v,o=this.m_bodyB.c_velocity.w,n=this.m_invMassA,r=this.m_invMassB,a=this.m_invIA,h=this.m_invIB,c=a+h===0;if(this.m_enableMotor&&this.m_limitState!=ss.equalLimits&&0==c){var l=o-i-this.m_motorSpeed,m=-this.m_motorMass*l,u=this.m_motorImpulse,_=t.dt*this.m_maxMotorTorque;this.m_motorImpulse=j(this.m_motorImpulse+m,-_,_),i-=a*(m=this.m_motorImpulse-u),o+=h*m}if(this.m_enableLimit&&this.m_limitState!=ss.inactiveLimit&&0==c){var d=Y.zero();d.addCombine(1,s,1,Y.crossNumVec2(o,this.m_rB)),d.subCombine(1,e,1,Y.crossNumVec2(i,this.m_rA));var p=o-i;if(l=new qs(d.x,d.y,p),m=qs.neg(this.m_mass.solve33(l)),this.m_limitState==ss.equalLimits)this.m_impulse.add(m);else if(this.m_limitState==ss.atLowerLimit)if(this.m_impulse.z+m.z<0){var y=Y.combine(-1,d,this.m_impulse.z,Y.neo(this.m_mass.ez.x,this.m_mass.ez.y)),f=this.m_mass.solve22(y);m.x=f.x,m.y=f.y,m.z=-this.m_impulse.z,this.m_impulse.x+=f.x,this.m_impulse.y+=f.y,this.m_impulse.z=0}else this.m_impulse.add(m);else this.m_limitState==ss.atUpperLimit&&(this.m_impulse.z+m.z>0?(y=Y.combine(-1,d,this.m_impulse.z,Y.neo(this.m_mass.ez.x,this.m_mass.ez.y)),f=this.m_mass.solve22(y),m.x=f.x,m.y=f.y,m.z=-this.m_impulse.z,this.m_impulse.x+=f.x,this.m_impulse.y+=f.y,this.m_impulse.z=0):this.m_impulse.add(m));var g=Y.neo(m.x,m.y);e.subMul(n,g),i-=a*(Y.crossVec2Vec2(this.m_rA,g)+m.z),s.addMul(r,g),o+=h*(Y.crossVec2Vec2(this.m_rB,g)+m.z)}else(l=Y.zero()).addCombine(1,s,1,Y.crossNumVec2(o,this.m_rB)),l.subCombine(1,e,1,Y.crossNumVec2(i,this.m_rA)),m=this.m_mass.solve22(Y.neg(l)),this.m_impulse.x+=m.x,this.m_impulse.y+=m.y,e.subMul(n,m),i-=a*Y.crossVec2Vec2(this.m_rA,m),s.addMul(r,m),o+=h*Y.crossVec2Vec2(this.m_rB,m);this.m_bodyA.c_velocity.v=e,this.m_bodyA.c_velocity.w=i,this.m_bodyB.c_velocity.v=s,this.m_bodyB.c_velocity.w=o},e.prototype.solvePositionConstraints=function(t){var e,i=this.m_bodyA.c_position.c,s=this.m_bodyA.c_position.a,o=this.m_bodyB.c_position.c,n=this.m_bodyB.c_position.a,r=Ht.neo(s),a=Ht.neo(n),h=0,c=this.m_invIA+this.m_invIB==0;if(this.m_enableLimit&&this.m_limitState!=ss.inactiveLimit&&0==c){var l=n-s-this.m_referenceAngle,m=0;if(this.m_limitState==ss.equalLimits){var u=j(l-this.m_lowerAngle,-G.maxAngularCorrection,G.maxAngularCorrection);m=-this.m_motorMass*u,h=co(u)}else this.m_limitState==ss.atLowerLimit?(h=-(u=l-this.m_lowerAngle),u=j(u+G.angularSlop,-G.maxAngularCorrection,0),m=-this.m_motorMass*u):this.m_limitState==ss.atUpperLimit&&(h=u=l-this.m_upperAngle,u=j(u-G.angularSlop,0,G.maxAngularCorrection),m=-this.m_motorMass*u);s-=this.m_invIA*m,n+=this.m_invIB*m}r.setAngle(s),a.setAngle(n);var _=Ht.mulVec2(r,Y.sub(this.m_localAnchorA,this.m_localCenterA)),d=Ht.mulVec2(a,Y.sub(this.m_localAnchorB,this.m_localCenterB));(u=Y.zero()).addCombine(1,o,1,d),u.subCombine(1,i,1,_),e=u.length();var p=this.m_invMassA,y=this.m_invMassB,f=this.m_invIA,g=this.m_invIB,v=new zi;v.ex.x=p+y+f*_.y*_.y+g*d.y*d.y,v.ex.y=-f*_.x*_.y-g*d.x*d.y,v.ey.x=v.ex.y,v.ey.y=p+y+f*_.x*_.x+g*d.x*d.x;var x=Y.neg(v.solve(u));return i.subMul(p,x),s-=f*Y.crossVec2Vec2(_,x),o.addMul(y,x),n+=g*Y.crossVec2Vec2(d,x),this.m_bodyA.c_position.c.setVec2(i),this.m_bodyA.c_position.a=s,this.m_bodyB.c_position.c.setVec2(o),this.m_bodyB.c_position.a=n,e<=G.linearSlop&&h<=G.angularSlop},e.TYPE="revolute-joint",e}(ge),uo=Math.abs,_o=Math.max,po=Math.min;!function(t){t[t.inactiveLimit=0]="inactiveLimit",t[t.atLowerLimit=1]="atLowerLimit",t[t.atUpperLimit=2]="atUpperLimit",t[t.equalLimits=3]="equalLimits"}(lo||(lo={}));var yo,fo={enableLimit:!1,lowerTranslation:0,upperTranslation:0,enableMotor:!1,maxMotorForce:0,motorSpeed:0},go=function(t){function e(i,s,o,n,r){var a=this;return a instanceof e?(i=L(i,fo),s=(a=t.call(this,i,s,o)||this).m_bodyA,o=a.m_bodyB,a.m_type=e.TYPE,a.m_localAnchorA=Y.clone(n?s.getLocalPoint(n):i.localAnchorA||Y.zero()),a.m_localAnchorB=Y.clone(n?o.getLocalPoint(n):i.localAnchorB||Y.zero()),a.m_localXAxisA=Y.clone(r?s.getLocalVector(r):i.localAxisA||Y.neo(1,0)),a.m_localXAxisA.normalize(),a.m_localYAxisA=Y.crossNumVec2(1,a.m_localXAxisA),a.m_referenceAngle=Number.isFinite(i.referenceAngle)?i.referenceAngle:o.getAngle()-s.getAngle(),a.m_impulse=new qs,a.m_motorMass=0,a.m_motorImpulse=0,a.m_lowerTranslation=i.lowerTranslation,a.m_upperTranslation=i.upperTranslation,a.m_maxMotorForce=i.maxMotorForce,a.m_motorSpeed=i.motorSpeed,a.m_enableLimit=i.enableLimit,a.m_enableMotor=i.enableMotor,a.m_limitState=lo.inactiveLimit,a.m_axis=Y.zero(),a.m_perp=Y.zero(),a.m_K=new ho,a):new e(i,s,o,n,r)}return z(e,t),e.prototype._serialize=function(){return{type:this.m_type,bodyA:this.m_bodyA,bodyB:this.m_bodyB,collideConnected:this.m_collideConnected,lowerTranslation:this.m_lowerTranslation,upperTranslation:this.m_upperTranslation,maxMotorForce:this.m_maxMotorForce,motorSpeed:this.m_motorSpeed,enableLimit:this.m_enableLimit,enableMotor:this.m_enableMotor,localAnchorA:this.m_localAnchorA,localAnchorB:this.m_localAnchorB,localAxisA:this.m_localXAxisA,referenceAngle:this.m_referenceAngle}},e._deserialize=function(t,i,s){return(t=T({},t)).bodyA=s(ye,t.bodyA,i),t.bodyB=s(ye,t.bodyB,i),t.localAxisA=Y.clone(t.localAxisA),new e(t)},e.prototype._reset=function(t){t.anchorA?this.m_localAnchorA.setVec2(this.m_bodyA.getLocalPoint(t.anchorA)):t.localAnchorA&&this.m_localAnchorA.setVec2(t.localAnchorA),t.anchorB?this.m_localAnchorB.setVec2(this.m_bodyB.getLocalPoint(t.anchorB)):t.localAnchorB&&this.m_localAnchorB.setVec2(t.localAnchorB),t.localAxisA&&(this.m_localXAxisA.setVec2(t.localAxisA),this.m_localYAxisA.setVec2(Y.crossNumVec2(1,t.localAxisA))),Number.isFinite(t.referenceAngle)&&(this.m_referenceAngle=t.referenceAngle),void 0!==t.enableLimit&&(this.m_enableLimit=!!t.enableLimit),Number.isFinite(t.lowerTranslation)&&(this.m_lowerTranslation=t.lowerTranslation),Number.isFinite(t.upperTranslation)&&(this.m_upperTranslation=t.upperTranslation),void 0!==t.enableMotor&&(this.m_enableMotor=!!t.enableMotor),Number.isFinite(t.maxMotorForce)&&(this.m_maxMotorForce=t.maxMotorForce),Number.isFinite(t.motorSpeed)&&(this.m_motorSpeed=t.motorSpeed)},e.prototype.getLocalAnchorA=function(){return this.m_localAnchorA},e.prototype.getLocalAnchorB=function(){return this.m_localAnchorB},e.prototype.getLocalAxisA=function(){return this.m_localXAxisA},e.prototype.getReferenceAngle=function(){return this.m_referenceAngle},e.prototype.getJointTranslation=function(){var t=this.m_bodyA.getWorldPoint(this.m_localAnchorA),e=this.m_bodyB.getWorldPoint(this.m_localAnchorB),i=Y.sub(e,t),s=this.m_bodyA.getWorldVector(this.m_localXAxisA);return Y.dot(i,s)},e.prototype.getJointSpeed=function(){var t=this.m_bodyA,e=this.m_bodyB,i=Ht.mulVec2(t.m_xf.q,Y.sub(this.m_localAnchorA,t.m_sweep.localCenter)),s=Ht.mulVec2(e.m_xf.q,Y.sub(this.m_localAnchorB,e.m_sweep.localCenter)),o=Y.add(t.m_sweep.c,i),n=Y.add(e.m_sweep.c,s),r=Y.sub(n,o),a=Ht.mulVec2(t.m_xf.q,this.m_localXAxisA),h=t.m_linearVelocity,c=e.m_linearVelocity,l=t.m_angularVelocity,m=e.m_angularVelocity;return Y.dot(r,Y.crossNumVec2(l,a))+Y.dot(a,Y.sub(Y.addCrossNumVec2(c,m,s),Y.addCrossNumVec2(h,l,i)))},e.prototype.isLimitEnabled=function(){return this.m_enableLimit},e.prototype.enableLimit=function(t){t!=this.m_enableLimit&&(this.m_bodyA.setAwake(!0),this.m_bodyB.setAwake(!0),this.m_enableLimit=t,this.m_impulse.z=0)},e.prototype.getLowerLimit=function(){return this.m_lowerTranslation},e.prototype.getUpperLimit=function(){return this.m_upperTranslation},e.prototype.setLimits=function(t,e){t==this.m_lowerTranslation&&e==this.m_upperTranslation||(this.m_bodyA.setAwake(!0),this.m_bodyB.setAwake(!0),this.m_lowerTranslation=t,this.m_upperTranslation=e,this.m_impulse.z=0)},e.prototype.isMotorEnabled=function(){return this.m_enableMotor},e.prototype.enableMotor=function(t){t!=this.m_enableMotor&&(this.m_bodyA.setAwake(!0),this.m_bodyB.setAwake(!0),this.m_enableMotor=t)},e.prototype.setMotorSpeed=function(t){t!=this.m_motorSpeed&&(this.m_bodyA.setAwake(!0),this.m_bodyB.setAwake(!0),this.m_motorSpeed=t)},e.prototype.setMaxMotorForce=function(t){t!=this.m_maxMotorForce&&(this.m_bodyA.setAwake(!0),this.m_bodyB.setAwake(!0),this.m_maxMotorForce=t)},e.prototype.getMaxMotorForce=function(){return this.m_maxMotorForce},e.prototype.getMotorSpeed=function(){return this.m_motorSpeed},e.prototype.getMotorForce=function(t){return t*this.m_motorImpulse},e.prototype.getAnchorA=function(){return this.m_bodyA.getWorldPoint(this.m_localAnchorA)},e.prototype.getAnchorB=function(){return this.m_bodyB.getWorldPoint(this.m_localAnchorB)},e.prototype.getReactionForce=function(t){return Y.combine(this.m_impulse.x,this.m_perp,this.m_motorImpulse+this.m_impulse.z,this.m_axis).mul(t)},e.prototype.getReactionTorque=function(t){return t*this.m_impulse.y},e.prototype.initVelocityConstraints=function(t){this.m_localCenterA=this.m_bodyA.m_sweep.localCenter,this.m_localCenterB=this.m_bodyB.m_sweep.localCenter,this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;var e=this.m_bodyA.c_position.c,i=this.m_bodyA.c_position.a,s=this.m_bodyA.c_velocity.v,o=this.m_bodyA.c_velocity.w,n=this.m_bodyB.c_position.c,r=this.m_bodyB.c_position.a,a=this.m_bodyB.c_velocity.v,h=this.m_bodyB.c_velocity.w,c=Ht.neo(i),l=Ht.neo(r),m=Ht.mulVec2(c,Y.sub(this.m_localAnchorA,this.m_localCenterA)),u=Ht.mulVec2(l,Y.sub(this.m_localAnchorB,this.m_localCenterB)),_=Y.zero();_.addCombine(1,n,1,u),_.subCombine(1,e,1,m);var d=this.m_invMassA,p=this.m_invMassB,y=this.m_invIA,f=this.m_invIB;this.m_axis=Ht.mulVec2(c,this.m_localXAxisA),this.m_a1=Y.crossVec2Vec2(Y.add(_,m),this.m_axis),this.m_a2=Y.crossVec2Vec2(u,this.m_axis),this.m_motorMass=d+p+y*this.m_a1*this.m_a1+f*this.m_a2*this.m_a2,this.m_motorMass>0&&(this.m_motorMass=1/this.m_motorMass),this.m_perp=Ht.mulVec2(c,this.m_localYAxisA),this.m_s1=Y.crossVec2Vec2(Y.add(_,m),this.m_perp),this.m_s2=Y.crossVec2Vec2(u,this.m_perp),Y.crossVec2Vec2(m,this.m_perp);var g=d+p+y*this.m_s1*this.m_s1+f*this.m_s2*this.m_s2,v=y*this.m_s1+f*this.m_s2,x=y*this.m_s1*this.m_a1+f*this.m_s2*this.m_a2,b=y+f;0==b&&(b=1);var A=y*this.m_a1+f*this.m_a2,w=d+p+y*this.m_a1*this.m_a1+f*this.m_a2*this.m_a2;if(this.m_K.ex.set(g,v,x),this.m_K.ey.set(v,b,A),this.m_K.ez.set(x,A,w),this.m_enableLimit){var B=Y.dot(this.m_axis,_);uo(this.m_upperTranslation-this.m_lowerTranslation)<2*G.linearSlop?this.m_limitState=lo.equalLimits:B<=this.m_lowerTranslation?this.m_limitState!=lo.atLowerLimit&&(this.m_limitState=lo.atLowerLimit,this.m_impulse.z=0):B>=this.m_upperTranslation?this.m_limitState!=lo.atUpperLimit&&(this.m_limitState=lo.atUpperLimit,this.m_impulse.z=0):(this.m_limitState=lo.inactiveLimit,this.m_impulse.z=0)}else this.m_limitState=lo.inactiveLimit,this.m_impulse.z=0;if(0==this.m_enableMotor&&(this.m_motorImpulse=0),t.warmStarting){this.m_impulse.mul(t.dtRatio),this.m_motorImpulse*=t.dtRatio;var C=Y.combine(this.m_impulse.x,this.m_perp,this.m_motorImpulse+this.m_impulse.z,this.m_axis),S=this.m_impulse.x*this.m_s1+this.m_impulse.y+(this.m_motorImpulse+this.m_impulse.z)*this.m_a1,M=this.m_impulse.x*this.m_s2+this.m_impulse.y+(this.m_motorImpulse+this.m_impulse.z)*this.m_a2;s.subMul(d,C),o-=y*S,a.addMul(p,C),h+=f*M}else this.m_impulse.setZero(),this.m_motorImpulse=0;this.m_bodyA.c_velocity.v.setVec2(s),this.m_bodyA.c_velocity.w=o,this.m_bodyB.c_velocity.v.setVec2(a),this.m_bodyB.c_velocity.w=h},e.prototype.solveVelocityConstraints=function(t){var e=this.m_bodyA.c_velocity.v,i=this.m_bodyA.c_velocity.w,s=this.m_bodyB.c_velocity.v,o=this.m_bodyB.c_velocity.w,n=this.m_invMassA,r=this.m_invMassB,a=this.m_invIA,h=this.m_invIB;if(this.m_enableMotor&&this.m_limitState!=lo.equalLimits){var c=Y.dot(this.m_axis,Y.sub(s,e))+this.m_a2*o-this.m_a1*i,l=this.m_motorMass*(this.m_motorSpeed-c),m=this.m_motorImpulse,u=t.dt*this.m_maxMotorForce;this.m_motorImpulse=j(this.m_motorImpulse+l,-u,u),l=this.m_motorImpulse-m;var _=Y.mulNumVec2(l,this.m_axis),d=l*this.m_a1,p=l*this.m_a2;e.subMul(n,_),i-=a*d,s.addMul(r,_),o+=h*p}var y=Y.zero();if(y.x+=Y.dot(this.m_perp,s)+this.m_s2*o,y.x-=Y.dot(this.m_perp,e)+this.m_s1*i,y.y=o-i,this.m_enableLimit&&this.m_limitState!=lo.inactiveLimit){var f=0;f+=Y.dot(this.m_axis,s)+this.m_a2*o,f-=Y.dot(this.m_axis,e)+this.m_a1*i,c=new qs(y.x,y.y,f);var g=qs.clone(this.m_impulse),v=this.m_K.solve33(qs.neg(c));this.m_impulse.add(v),this.m_limitState==lo.atLowerLimit?this.m_impulse.z=_o(this.m_impulse.z,0):this.m_limitState==lo.atUpperLimit&&(this.m_impulse.z=po(this.m_impulse.z,0));var x=Y.combine(-1,y,-(this.m_impulse.z-g.z),Y.neo(this.m_K.ez.x,this.m_K.ez.y)),b=Y.add(this.m_K.solve22(x),Y.neo(g.x,g.y));this.m_impulse.x=b.x,this.m_impulse.y=b.y,v=qs.sub(this.m_impulse,g),_=Y.combine(v.x,this.m_perp,v.z,this.m_axis),d=v.x*this.m_s1+v.y+v.z*this.m_a1,p=v.x*this.m_s2+v.y+v.z*this.m_a2,e.subMul(n,_),i-=a*d,s.addMul(r,_),o+=h*p}else v=this.m_K.solve22(Y.neg(y)),this.m_impulse.x+=v.x,this.m_impulse.y+=v.y,_=Y.mulNumVec2(v.x,this.m_perp),d=v.x*this.m_s1+v.y,p=v.x*this.m_s2+v.y,e.subMul(n,_),i-=a*d,s.addMul(r,_),o+=h*p;this.m_bodyA.c_velocity.v=e,this.m_bodyA.c_velocity.w=i,this.m_bodyB.c_velocity.v=s,this.m_bodyB.c_velocity.w=o},e.prototype.solvePositionConstraints=function(t){var e=this.m_bodyA.c_position.c,i=this.m_bodyA.c_position.a,s=this.m_bodyB.c_position.c,o=this.m_bodyB.c_position.a,n=Ht.neo(i),r=Ht.neo(o),a=this.m_invMassA,h=this.m_invMassB,c=this.m_invIA,l=this.m_invIB,m=Ht.mulVec2(n,Y.sub(this.m_localAnchorA,this.m_localCenterA)),u=Ht.mulVec2(r,Y.sub(this.m_localAnchorB,this.m_localCenterB)),_=Y.sub(Y.add(s,u),Y.add(e,m)),d=Ht.mulVec2(n,this.m_localXAxisA),p=Y.crossVec2Vec2(Y.add(_,m),d),y=Y.crossVec2Vec2(u,d),f=Ht.mulVec2(n,this.m_localYAxisA),g=Y.crossVec2Vec2(Y.add(_,m),f),v=Y.crossVec2Vec2(u,f),x=new qs,b=Y.zero();b.x=Y.dot(f,_),b.y=o-i-this.m_referenceAngle;var A=uo(b.x),w=uo(b.y),B=G.linearSlop,C=G.maxLinearCorrection,S=!1,M=0;if(this.m_enableLimit){var P=Y.dot(d,_);uo(this.m_upperTranslation-this.m_lowerTranslation)<2*B?(M=j(P,-C,C),A=_o(A,uo(P)),S=!0):P<=this.m_lowerTranslation?(M=j(P-this.m_lowerTranslation+B,-C,0),A=Math.max(A,this.m_lowerTranslation-P),S=!0):P>=this.m_upperTranslation&&(M=j(P-this.m_upperTranslation-B,0,C),A=Math.max(A,P-this.m_upperTranslation),S=!0)}if(S){var V=a+h+c*g*g+l*v*v,I=c*g+l*v,z=c*g*p+l*v*y;0==(k=c+l)&&(k=1);var T=c*p+l*y,L=a+h+c*p*p+l*y*y;(q=new ho).ex.set(V,I,z),q.ey.set(I,k,T),q.ez.set(z,T,L);var F=new qs;F.x=b.x,F.y=b.y,F.z=M,x=q.solve33(qs.neg(F))}else{var k,q;V=a+h+c*g*g+l*v*v,I=c*g+l*v,0==(k=c+l)&&(k=1),(q=new zi).ex.setNum(V,I),q.ey.setNum(I,k);var N=q.solve(Y.neg(b));x.x=N.x,x.y=N.y,x.z=0}var R=Y.combine(x.x,f,x.z,d),E=x.x*g+x.y+x.z*p,O=x.x*v+x.y+x.z*y;return e.subMul(a,R),i-=c*E,s.addMul(h,R),o+=l*O,this.m_bodyA.c_position.c=e,this.m_bodyA.c_position.a=i,this.m_bodyB.c_position.c=s,this.m_bodyB.c_position.a=o,A<=G.linearSlop&&w<=G.angularSlop},e.TYPE="prismatic-joint",e}(ge),vo={ratio:1},xo=function(t){function e(i,s,o,n,r,a){var h,c,l=this;if(!(l instanceof e))return new e(i,s,o,n,r,a);i=L(i,vo),s=(l=t.call(this,i,s,o)||this).m_bodyA,o=l.m_bodyB,l.m_type=e.TYPE,l.m_joint1=n||i.joint1,l.m_joint2=r||i.joint2,l.m_ratio=Number.isFinite(a)?a:i.ratio,l.m_type1=l.m_joint1.getType(),l.m_type2=l.m_joint2.getType(),l.m_bodyC=l.m_joint1.getBodyA(),l.m_bodyA=l.m_joint1.getBodyB();var m=l.m_bodyA.m_xf,u=l.m_bodyA.m_sweep.a,_=l.m_bodyC.m_xf,d=l.m_bodyC.m_sweep.a;if(l.m_type1===mo.TYPE){var p=l.m_joint1;l.m_localAnchorC=p.m_localAnchorA,l.m_localAnchorA=p.m_localAnchorB,l.m_referenceAngleA=p.m_referenceAngle,l.m_localAxisC=Y.zero(),h=u-d-l.m_referenceAngleA}else{var y=l.m_joint1;l.m_localAnchorC=y.m_localAnchorA,l.m_localAnchorA=y.m_localAnchorB,l.m_referenceAngleA=y.m_referenceAngle,l.m_localAxisC=y.m_localXAxisA;var f=l.m_localAnchorC,g=Ht.mulTVec2(_.q,Y.add(Ht.mulVec2(m.q,l.m_localAnchorA),Y.sub(m.p,_.p)));h=Y.dot(g,l.m_localAxisC)-Y.dot(f,l.m_localAxisC)}l.m_bodyD=l.m_joint2.getBodyA(),l.m_bodyB=l.m_joint2.getBodyB();var v=l.m_bodyB.m_xf,x=l.m_bodyB.m_sweep.a,b=l.m_bodyD.m_xf,A=l.m_bodyD.m_sweep.a;if(l.m_type2===mo.TYPE)p=l.m_joint2,l.m_localAnchorD=p.m_localAnchorA,l.m_localAnchorB=p.m_localAnchorB,l.m_referenceAngleB=p.m_referenceAngle,l.m_localAxisD=Y.zero(),c=x-A-l.m_referenceAngleB;else{y=l.m_joint2,l.m_localAnchorD=y.m_localAnchorA,l.m_localAnchorB=y.m_localAnchorB,l.m_referenceAngleB=y.m_referenceAngle,l.m_localAxisD=y.m_localXAxisA;var w=l.m_localAnchorD,B=Ht.mulTVec2(b.q,Y.add(Ht.mulVec2(v.q,l.m_localAnchorB),Y.sub(v.p,b.p)));c=Y.dot(B,l.m_localAxisD)-Y.dot(w,l.m_localAxisD)}return l.m_constant=h+l.m_ratio*c,l.m_impulse=0,l}return z(e,t),e.prototype._serialize=function(){return{type:this.m_type,bodyA:this.m_bodyA,bodyB:this.m_bodyB,collideConnected:this.m_collideConnected,joint1:this.m_joint1,joint2:this.m_joint2,ratio:this.m_ratio}},e._deserialize=function(t,i,s){return(t=T({},t)).bodyA=s(ye,t.bodyA,i),t.bodyB=s(ye,t.bodyB,i),t.joint1=s(ge,t.joint1,i),t.joint2=s(ge,t.joint2,i),new e(t)},e.prototype._reset=function(t){Number.isFinite(t.ratio)&&(this.m_ratio=t.ratio)},e.prototype.getJoint1=function(){return this.m_joint1},e.prototype.getJoint2=function(){return this.m_joint2},e.prototype.setRatio=function(t){this.m_ratio=t},e.prototype.getRatio=function(){return this.m_ratio},e.prototype.getAnchorA=function(){return this.m_bodyA.getWorldPoint(this.m_localAnchorA)},e.prototype.getAnchorB=function(){return this.m_bodyB.getWorldPoint(this.m_localAnchorB)},e.prototype.getReactionForce=function(t){return Y.mulNumVec2(this.m_impulse,this.m_JvAC).mul(t)},e.prototype.getReactionTorque=function(t){return t*(this.m_impulse*this.m_JwA)},e.prototype.initVelocityConstraints=function(t){this.m_lcA=this.m_bodyA.m_sweep.localCenter,this.m_lcB=this.m_bodyB.m_sweep.localCenter,this.m_lcC=this.m_bodyC.m_sweep.localCenter,this.m_lcD=this.m_bodyD.m_sweep.localCenter,this.m_mA=this.m_bodyA.m_invMass,this.m_mB=this.m_bodyB.m_invMass,this.m_mC=this.m_bodyC.m_invMass,this.m_mD=this.m_bodyD.m_invMass,this.m_iA=this.m_bodyA.m_invI,this.m_iB=this.m_bodyB.m_invI,this.m_iC=this.m_bodyC.m_invI,this.m_iD=this.m_bodyD.m_invI;var e=this.m_bodyA.c_position.a,i=this.m_bodyA.c_velocity.v,s=this.m_bodyA.c_velocity.w,o=this.m_bodyB.c_position.a,n=this.m_bodyB.c_velocity.v,r=this.m_bodyB.c_velocity.w,a=this.m_bodyC.c_position.a,h=this.m_bodyC.c_velocity.v,c=this.m_bodyC.c_velocity.w,l=this.m_bodyD.c_position.a,m=this.m_bodyD.c_velocity.v,u=this.m_bodyD.c_velocity.w,_=Ht.neo(e),d=Ht.neo(o),p=Ht.neo(a),y=Ht.neo(l);if(this.m_mass=0,this.m_type1==mo.TYPE)this.m_JvAC=Y.zero(),this.m_JwA=1,this.m_JwC=1,this.m_mass+=this.m_iA+this.m_iC;else{var f=Ht.mulVec2(p,this.m_localAxisC),g=Ht.mulSub(p,this.m_localAnchorC,this.m_lcC),v=Ht.mulSub(_,this.m_localAnchorA,this.m_lcA);this.m_JvAC=f,this.m_JwC=Y.crossVec2Vec2(g,f),this.m_JwA=Y.crossVec2Vec2(v,f),this.m_mass+=this.m_mC+this.m_mA+this.m_iC*this.m_JwC*this.m_JwC+this.m_iA*this.m_JwA*this.m_JwA}if(this.m_type2==mo.TYPE)this.m_JvBD=Y.zero(),this.m_JwB=this.m_ratio,this.m_JwD=this.m_ratio,this.m_mass+=this.m_ratio*this.m_ratio*(this.m_iB+this.m_iD);else{f=Ht.mulVec2(y,this.m_localAxisD);var x=Ht.mulSub(y,this.m_localAnchorD,this.m_lcD),b=Ht.mulSub(d,this.m_localAnchorB,this.m_lcB);this.m_JvBD=Y.mulNumVec2(this.m_ratio,f),this.m_JwD=this.m_ratio*Y.crossVec2Vec2(x,f),this.m_JwB=this.m_ratio*Y.crossVec2Vec2(b,f),this.m_mass+=this.m_ratio*this.m_ratio*(this.m_mD+this.m_mB)+this.m_iD*this.m_JwD*this.m_JwD+this.m_iB*this.m_JwB*this.m_JwB}this.m_mass=this.m_mass>0?1/this.m_mass:0,t.warmStarting?(i.addMul(this.m_mA*this.m_impulse,this.m_JvAC),s+=this.m_iA*this.m_impulse*this.m_JwA,n.addMul(this.m_mB*this.m_impulse,this.m_JvBD),r+=this.m_iB*this.m_impulse*this.m_JwB,h.subMul(this.m_mC*this.m_impulse,this.m_JvAC),c-=this.m_iC*this.m_impulse*this.m_JwC,m.subMul(this.m_mD*this.m_impulse,this.m_JvBD),u-=this.m_iD*this.m_impulse*this.m_JwD):this.m_impulse=0,this.m_bodyA.c_velocity.v.setVec2(i),this.m_bodyA.c_velocity.w=s,this.m_bodyB.c_velocity.v.setVec2(n),this.m_bodyB.c_velocity.w=r,this.m_bodyC.c_velocity.v.setVec2(h),this.m_bodyC.c_velocity.w=c,this.m_bodyD.c_velocity.v.setVec2(m),this.m_bodyD.c_velocity.w=u},e.prototype.solveVelocityConstraints=function(t){var e=this.m_bodyA.c_velocity.v,i=this.m_bodyA.c_velocity.w,s=this.m_bodyB.c_velocity.v,o=this.m_bodyB.c_velocity.w,n=this.m_bodyC.c_velocity.v,r=this.m_bodyC.c_velocity.w,a=this.m_bodyD.c_velocity.v,h=this.m_bodyD.c_velocity.w,c=Y.dot(this.m_JvAC,e)-Y.dot(this.m_JvAC,n)+Y.dot(this.m_JvBD,s)-Y.dot(this.m_JvBD,a);c+=this.m_JwA*i-this.m_JwC*r+(this.m_JwB*o-this.m_JwD*h);var l=-this.m_mass*c;this.m_impulse+=l,e.addMul(this.m_mA*l,this.m_JvAC),i+=this.m_iA*l*this.m_JwA,s.addMul(this.m_mB*l,this.m_JvBD),o+=this.m_iB*l*this.m_JwB,n.subMul(this.m_mC*l,this.m_JvAC),r-=this.m_iC*l*this.m_JwC,a.subMul(this.m_mD*l,this.m_JvBD),h-=this.m_iD*l*this.m_JwD,this.m_bodyA.c_velocity.v.setVec2(e),this.m_bodyA.c_velocity.w=i,this.m_bodyB.c_velocity.v.setVec2(s),this.m_bodyB.c_velocity.w=o,this.m_bodyC.c_velocity.v.setVec2(n),this.m_bodyC.c_velocity.w=r,this.m_bodyD.c_velocity.v.setVec2(a),this.m_bodyD.c_velocity.w=h},e.prototype.solvePositionConstraints=function(t){var e,i,s,o,n,r,a,h,c=this.m_bodyA.c_position.c,l=this.m_bodyA.c_position.a,m=this.m_bodyB.c_position.c,u=this.m_bodyB.c_position.a,_=this.m_bodyC.c_position.c,d=this.m_bodyC.c_position.a,p=this.m_bodyD.c_position.c,y=this.m_bodyD.c_position.a,f=Ht.neo(l),g=Ht.neo(u),v=Ht.neo(d),x=Ht.neo(y),b=0;if(this.m_type1==mo.TYPE)s=Y.zero(),n=1,a=1,b+=this.m_iA+this.m_iC,e=l-d-this.m_referenceAngleA;else{var A=Ht.mulVec2(v,this.m_localAxisC),w=Ht.mulSub(v,this.m_localAnchorC,this.m_lcC),B=Ht.mulSub(f,this.m_localAnchorA,this.m_lcA);s=A,a=Y.crossVec2Vec2(w,A),n=Y.crossVec2Vec2(B,A),b+=this.m_mC+this.m_mA+this.m_iC*a*a+this.m_iA*n*n;var C=Y.sub(this.m_localAnchorC,this.m_lcC),S=Ht.mulTVec2(v,Y.add(B,Y.sub(c,_)));e=Y.dot(Y.sub(S,C),this.m_localAxisC)}if(this.m_type2==mo.TYPE)o=Y.zero(),r=this.m_ratio,h=this.m_ratio,b+=this.m_ratio*this.m_ratio*(this.m_iB+this.m_iD),i=u-y-this.m_referenceAngleB;else{A=Ht.mulVec2(x,this.m_localAxisD);var M=Ht.mulSub(x,this.m_localAnchorD,this.m_lcD),P=Ht.mulSub(g,this.m_localAnchorB,this.m_lcB);o=Y.mulNumVec2(this.m_ratio,A),h=this.m_ratio*Y.crossVec2Vec2(M,A),r=this.m_ratio*Y.crossVec2Vec2(P,A),b+=this.m_ratio*this.m_ratio*(this.m_mD+this.m_mB)+this.m_iD*h*h+this.m_iB*r*r;var V=Y.sub(this.m_localAnchorD,this.m_lcD),I=Ht.mulTVec2(x,Y.add(P,Y.sub(m,p)));i=Y.dot(I,this.m_localAxisD)-Y.dot(V,this.m_localAxisD)}var z=e+this.m_ratio*i-this.m_constant,T=0;return b>0&&(T=-z/b),c.addMul(this.m_mA*T,s),l+=this.m_iA*T*n,m.addMul(this.m_mB*T,o),u+=this.m_iB*T*r,_.subMul(this.m_mC*T,s),d-=this.m_iC*T*a,p.subMul(this.m_mD*T,o),y-=this.m_iD*T*h,this.m_bodyA.c_position.c.setVec2(c),this.m_bodyA.c_position.a=l,this.m_bodyB.c_position.c.setVec2(m),this.m_bodyB.c_position.a=u,this.m_bodyC.c_position.c.setVec2(_),this.m_bodyC.c_position.a=d,this.m_bodyD.c_position.c.setVec2(p),this.m_bodyD.c_position.a=y,0<G.linearSlop},e.TYPE="gear-joint",e}(ge),bo={maxForce:1,maxTorque:1,correctionFactor:.3},Ao=function(t){function e(i,s,o){var n=this;return n instanceof e?(i=L(i,bo),s=(n=t.call(this,i,s,o)||this).m_bodyA,o=n.m_bodyB,n.m_type=e.TYPE,n.m_linearOffset=Y.isValid(i.linearOffset)?Y.clone(i.linearOffset):s.getLocalPoint(o.getPosition()),n.m_angularOffset=Number.isFinite(i.angularOffset)?i.angularOffset:o.getAngle()-s.getAngle(),n.m_linearImpulse=Y.zero(),n.m_angularImpulse=0,n.m_maxForce=i.maxForce,n.m_maxTorque=i.maxTorque,n.m_correctionFactor=i.correctionFactor,n):new e(i,s,o)}return z(e,t),e.prototype._serialize=function(){return{type:this.m_type,bodyA:this.m_bodyA,bodyB:this.m_bodyB,collideConnected:this.m_collideConnected,maxForce:this.m_maxForce,maxTorque:this.m_maxTorque,correctionFactor:this.m_correctionFactor,linearOffset:this.m_linearOffset,angularOffset:this.m_angularOffset}},e._deserialize=function(t,i,s){return(t=T({},t)).bodyA=s(ye,t.bodyA,i),t.bodyB=s(ye,t.bodyB,i),new e(t)},e.prototype._reset=function(t){Number.isFinite(t.angularOffset)&&(this.m_angularOffset=t.angularOffset),Number.isFinite(t.maxForce)&&(this.m_maxForce=t.maxForce),Number.isFinite(t.maxTorque)&&(this.m_maxTorque=t.maxTorque),Number.isFinite(t.correctionFactor)&&(this.m_correctionFactor=t.correctionFactor),Y.isValid(t.linearOffset)&&this.m_linearOffset.set(t.linearOffset)},e.prototype.setMaxForce=function(t){this.m_maxForce=t},e.prototype.getMaxForce=function(){return this.m_maxForce},e.prototype.setMaxTorque=function(t){this.m_maxTorque=t},e.prototype.getMaxTorque=function(){return this.m_maxTorque},e.prototype.setCorrectionFactor=function(t){this.m_correctionFactor=t},e.prototype.getCorrectionFactor=function(){return this.m_correctionFactor},e.prototype.setLinearOffset=function(t){t.x==this.m_linearOffset.x&&t.y==this.m_linearOffset.y||(this.m_bodyA.setAwake(!0),this.m_bodyB.setAwake(!0),this.m_linearOffset.set(t))},e.prototype.getLinearOffset=function(){return this.m_linearOffset},e.prototype.setAngularOffset=function(t){t!=this.m_angularOffset&&(this.m_bodyA.setAwake(!0),this.m_bodyB.setAwake(!0),this.m_angularOffset=t)},e.prototype.getAngularOffset=function(){return this.m_angularOffset},e.prototype.getAnchorA=function(){return this.m_bodyA.getPosition()},e.prototype.getAnchorB=function(){return this.m_bodyB.getPosition()},e.prototype.getReactionForce=function(t){return Y.mulNumVec2(t,this.m_linearImpulse)},e.prototype.getReactionTorque=function(t){return t*this.m_angularImpulse},e.prototype.initVelocityConstraints=function(t){this.m_localCenterA=this.m_bodyA.m_sweep.localCenter,this.m_localCenterB=this.m_bodyB.m_sweep.localCenter,this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;var e=this.m_bodyA.c_position.c,i=this.m_bodyA.c_position.a,s=this.m_bodyA.c_velocity.v,o=this.m_bodyA.c_velocity.w,n=this.m_bodyB.c_position.c,r=this.m_bodyB.c_position.a,a=this.m_bodyB.c_velocity.v,h=this.m_bodyB.c_velocity.w,c=Ht.neo(i),l=Ht.neo(r);this.m_rA=Ht.mulVec2(c,Y.sub(this.m_linearOffset,this.m_localCenterA)),this.m_rB=Ht.mulVec2(l,Y.neg(this.m_localCenterB));var m=this.m_invMassA,u=this.m_invMassB,_=this.m_invIA,d=this.m_invIB,p=new zi;if(p.ex.x=m+u+_*this.m_rA.y*this.m_rA.y+d*this.m_rB.y*this.m_rB.y,p.ex.y=-_*this.m_rA.x*this.m_rA.y-d*this.m_rB.x*this.m_rB.y,p.ey.x=p.ex.y,p.ey.y=m+u+_*this.m_rA.x*this.m_rA.x+d*this.m_rB.x*this.m_rB.x,this.m_linearMass=p.getInverse(),this.m_angularMass=_+d,this.m_angularMass>0&&(this.m_angularMass=1/this.m_angularMass),this.m_linearError=Y.zero(),this.m_linearError.addCombine(1,n,1,this.m_rB),this.m_linearError.subCombine(1,e,1,this.m_rA),this.m_angularError=r-i-this.m_angularOffset,t.warmStarting){this.m_linearImpulse.mul(t.dtRatio),this.m_angularImpulse*=t.dtRatio;var y=Y.neo(this.m_linearImpulse.x,this.m_linearImpulse.y);s.subMul(m,y),o-=_*(Y.crossVec2Vec2(this.m_rA,y)+this.m_angularImpulse),a.addMul(u,y),h+=d*(Y.crossVec2Vec2(this.m_rB,y)+this.m_angularImpulse)}else this.m_linearImpulse.setZero(),this.m_angularImpulse=0;this.m_bodyA.c_velocity.v=s,this.m_bodyA.c_velocity.w=o,this.m_bodyB.c_velocity.v=a,this.m_bodyB.c_velocity.w=h},e.prototype.solveVelocityConstraints=function(t){var e=this.m_bodyA.c_velocity.v,i=this.m_bodyA.c_velocity.w,s=this.m_bodyB.c_velocity.v,o=this.m_bodyB.c_velocity.w,n=this.m_invMassA,r=this.m_invMassB,a=this.m_invIA,h=this.m_invIB,c=t.dt,l=t.inv_dt,m=o-i+l*this.m_correctionFactor*this.m_angularError,u=-this.m_angularMass*m,_=this.m_angularImpulse,d=c*this.m_maxTorque;this.m_angularImpulse=j(this.m_angularImpulse+u,-d,d),i-=a*(u=this.m_angularImpulse-_),o+=h*u,(m=Y.zero()).addCombine(1,s,1,Y.crossNumVec2(o,this.m_rB)),m.subCombine(1,e,1,Y.crossNumVec2(i,this.m_rA)),m.addMul(l*this.m_correctionFactor,this.m_linearError),u=Y.neg(zi.mulVec2(this.m_linearMass,m)),_=Y.clone(this.m_linearImpulse),this.m_linearImpulse.add(u),d=c*this.m_maxForce,this.m_linearImpulse.clamp(d),u=Y.sub(this.m_linearImpulse,_),e.subMul(n,u),i-=a*Y.crossVec2Vec2(this.m_rA,u),s.addMul(r,u),o+=h*Y.crossVec2Vec2(this.m_rB,u),this.m_bodyA.c_velocity.v=e,this.m_bodyA.c_velocity.w=i,this.m_bodyB.c_velocity.v=s,this.m_bodyB.c_velocity.w=o},e.prototype.solvePositionConstraints=function(t){return!0},e.TYPE="motor-joint",e}(ge),wo=Math.PI,Bo={maxForce:0,frequencyHz:5,dampingRatio:.7},Co=function(t){function e(i,s,o,n){var r=this;return r instanceof e?(i=L(i,Bo),s=(r=t.call(this,i,s,o)||this).m_bodyA,o=r.m_bodyB,r.m_type=e.TYPE,Y.isValid(n)?r.m_targetA=Y.clone(n):Y.isValid(i.target)?r.m_targetA=Y.clone(i.target):r.m_targetA=Y.zero(),r.m_localAnchorB=Jt.mulTVec2(o.getTransform(),r.m_targetA),r.m_maxForce=i.maxForce,r.m_impulse=Y.zero(),r.m_frequencyHz=i.frequencyHz,r.m_dampingRatio=i.dampingRatio,r.m_beta=0,r.m_gamma=0,r.m_rB=Y.zero(),r.m_localCenterB=Y.zero(),r.m_invMassB=0,r.m_invIB=0,r.m_mass=new zi,r.m_C=Y.zero(),r):new e(i,s,o,n)}return z(e,t),e.prototype._serialize=function(){return{type:this.m_type,bodyA:this.m_bodyA,bodyB:this.m_bodyB,collideConnected:this.m_collideConnected,target:this.m_targetA,maxForce:this.m_maxForce,frequencyHz:this.m_frequencyHz,dampingRatio:this.m_dampingRatio,_localAnchorB:this.m_localAnchorB}},e._deserialize=function(t,i,s){(t=T({},t)).bodyA=s(ye,t.bodyA,i),t.bodyB=s(ye,t.bodyB,i),t.target=Y.clone(t.target);var o=new e(t);return t._localAnchorB&&(o.m_localAnchorB=t._localAnchorB),o},e.prototype._reset=function(t){Number.isFinite(t.maxForce)&&(this.m_maxForce=t.maxForce),Number.isFinite(t.frequencyHz)&&(this.m_frequencyHz=t.frequencyHz),Number.isFinite(t.dampingRatio)&&(this.m_dampingRatio=t.dampingRatio)},e.prototype.setTarget=function(t){Y.areEqual(t,this.m_targetA)||(this.m_bodyB.setAwake(!0),this.m_targetA.set(t))},e.prototype.getTarget=function(){return this.m_targetA},e.prototype.setMaxForce=function(t){this.m_maxForce=t},e.prototype.getMaxForce=function(){return this.m_maxForce},e.prototype.setFrequency=function(t){this.m_frequencyHz=t},e.prototype.getFrequency=function(){return this.m_frequencyHz},e.prototype.setDampingRatio=function(t){this.m_dampingRatio=t},e.prototype.getDampingRatio=function(){return this.m_dampingRatio},e.prototype.getAnchorA=function(){return Y.clone(this.m_targetA)},e.prototype.getAnchorB=function(){return this.m_bodyB.getWorldPoint(this.m_localAnchorB)},e.prototype.getReactionForce=function(t){return Y.mulNumVec2(t,this.m_impulse)},e.prototype.getReactionTorque=function(t){return 0*t},e.prototype.shiftOrigin=function(t){this.m_targetA.sub(t)},e.prototype.initVelocityConstraints=function(t){this.m_localCenterB=this.m_bodyB.m_sweep.localCenter,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIB=this.m_bodyB.m_invI;var e=this.m_bodyB.c_position,i=this.m_bodyB.c_velocity,s=e.c,o=e.a,n=i.v,r=i.w,a=Ht.neo(o),h=this.m_bodyB.getMass(),c=2*wo*this.m_frequencyHz,l=2*h*this.m_dampingRatio*c,m=h*(c*c),u=t.dt;this.m_gamma=u*(l+u*m),0!=this.m_gamma&&(this.m_gamma=1/this.m_gamma),this.m_beta=u*m*this.m_gamma,this.m_rB=Ht.mulVec2(a,Y.sub(this.m_localAnchorB,this.m_localCenterB));var _=new zi;_.ex.x=this.m_invMassB+this.m_invIB*this.m_rB.y*this.m_rB.y+this.m_gamma,_.ex.y=-this.m_invIB*this.m_rB.x*this.m_rB.y,_.ey.x=_.ex.y,_.ey.y=this.m_invMassB+this.m_invIB*this.m_rB.x*this.m_rB.x+this.m_gamma,this.m_mass=_.getInverse(),this.m_C.setVec2(s),this.m_C.addCombine(1,this.m_rB,-1,this.m_targetA),this.m_C.mul(this.m_beta),r*=.98,t.warmStarting?(this.m_impulse.mul(t.dtRatio),n.addMul(this.m_invMassB,this.m_impulse),r+=this.m_invIB*Y.crossVec2Vec2(this.m_rB,this.m_impulse)):this.m_impulse.setZero(),i.v.setVec2(n),i.w=r},e.prototype.solveVelocityConstraints=function(t){var e=this.m_bodyB.c_velocity,i=Y.clone(e.v),s=e.w,o=Y.crossNumVec2(s,this.m_rB);o.add(i),o.addCombine(1,this.m_C,this.m_gamma,this.m_impulse),o.neg();var n=zi.mulVec2(this.m_mass,o),r=Y.clone(this.m_impulse);this.m_impulse.add(n);var a=t.dt*this.m_maxForce;this.m_impulse.clamp(a),n=Y.sub(this.m_impulse,r),i.addMul(this.m_invMassB,n),s+=this.m_invIB*Y.crossVec2Vec2(this.m_rB,n),e.v.setVec2(i),e.w=s},e.prototype.solvePositionConstraints=function(t){return!0},e.TYPE="mouse-joint",e}(ge),So=Math.abs,Mo={collideConnected:!0},Po=function(t){function e(i,s,o,n,r,a,h,c){var l=this;return l instanceof e?(i=L(i,Mo),s=(l=t.call(this,i,s,o)||this).m_bodyA,o=l.m_bodyB,l.m_type=e.TYPE,l.m_groundAnchorA=Y.clone(n||i.groundAnchorA||Y.neo(-1,1)),l.m_groundAnchorB=Y.clone(r||i.groundAnchorB||Y.neo(1,1)),l.m_localAnchorA=Y.clone(a?s.getLocalPoint(a):i.localAnchorA||Y.neo(-1,0)),l.m_localAnchorB=Y.clone(h?o.getLocalPoint(h):i.localAnchorB||Y.neo(1,0)),l.m_lengthA=Number.isFinite(i.lengthA)?i.lengthA:Y.distance(a,n),l.m_lengthB=Number.isFinite(i.lengthB)?i.lengthB:Y.distance(h,r),l.m_ratio=Number.isFinite(c)?c:i.ratio,l.m_constant=l.m_lengthA+l.m_ratio*l.m_lengthB,l.m_impulse=0,l):new e(i,s,o,n,r,a,h,c)}return z(e,t),e.prototype._serialize=function(){return{type:this.m_type,bodyA:this.m_bodyA,bodyB:this.m_bodyB,collideConnected:this.m_collideConnected,groundAnchorA:this.m_groundAnchorA,groundAnchorB:this.m_groundAnchorB,localAnchorA:this.m_localAnchorA,localAnchorB:this.m_localAnchorB,lengthA:this.m_lengthA,lengthB:this.m_lengthB,ratio:this.m_ratio}},e._deserialize=function(t,i,s){return(t=T({},t)).bodyA=s(ye,t.bodyA,i),t.bodyB=s(ye,t.bodyB,i),new e(t)},e.prototype._reset=function(t){Y.isValid(t.groundAnchorA)&&this.m_groundAnchorA.set(t.groundAnchorA),Y.isValid(t.groundAnchorB)&&this.m_groundAnchorB.set(t.groundAnchorB),Y.isValid(t.localAnchorA)?this.m_localAnchorA.set(t.localAnchorA):Y.isValid(t.anchorA)&&this.m_localAnchorA.set(this.m_bodyA.getLocalPoint(t.anchorA)),Y.isValid(t.localAnchorB)?this.m_localAnchorB.set(t.localAnchorB):Y.isValid(t.anchorB)&&this.m_localAnchorB.set(this.m_bodyB.getLocalPoint(t.anchorB)),Number.isFinite(t.lengthA)&&(this.m_lengthA=t.lengthA),Number.isFinite(t.lengthB)&&(this.m_lengthB=t.lengthB),Number.isFinite(t.ratio)&&(this.m_ratio=t.ratio)},e.prototype.getGroundAnchorA=function(){return this.m_groundAnchorA},e.prototype.getGroundAnchorB=function(){return this.m_groundAnchorB},e.prototype.getLengthA=function(){return this.m_lengthA},e.prototype.getLengthB=function(){return this.m_lengthB},e.prototype.getRatio=function(){return this.m_ratio},e.prototype.getCurrentLengthA=function(){var t=this.m_bodyA.getWorldPoint(this.m_localAnchorA),e=this.m_groundAnchorA;return Y.distance(t,e)},e.prototype.getCurrentLengthB=function(){var t=this.m_bodyB.getWorldPoint(this.m_localAnchorB),e=this.m_groundAnchorB;return Y.distance(t,e)},e.prototype.shiftOrigin=function(t){this.m_groundAnchorA.sub(t),this.m_groundAnchorB.sub(t)},e.prototype.getAnchorA=function(){return this.m_bodyA.getWorldPoint(this.m_localAnchorA)},e.prototype.getAnchorB=function(){return this.m_bodyB.getWorldPoint(this.m_localAnchorB)},e.prototype.getReactionForce=function(t){return Y.mulNumVec2(this.m_impulse,this.m_uB).mul(t)},e.prototype.getReactionTorque=function(t){return 0},e.prototype.initVelocityConstraints=function(t){this.m_localCenterA=this.m_bodyA.m_sweep.localCenter,this.m_localCenterB=this.m_bodyB.m_sweep.localCenter,this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;var e=this.m_bodyA.c_position.c,i=this.m_bodyA.c_position.a,s=this.m_bodyA.c_velocity.v,o=this.m_bodyA.c_velocity.w,n=this.m_bodyB.c_position.c,r=this.m_bodyB.c_position.a,a=this.m_bodyB.c_velocity.v,h=this.m_bodyB.c_velocity.w,c=Ht.neo(i),l=Ht.neo(r);this.m_rA=Ht.mulVec2(c,Y.sub(this.m_localAnchorA,this.m_localCenterA)),this.m_rB=Ht.mulVec2(l,Y.sub(this.m_localAnchorB,this.m_localCenterB)),this.m_uA=Y.sub(Y.add(e,this.m_rA),this.m_groundAnchorA),this.m_uB=Y.sub(Y.add(n,this.m_rB),this.m_groundAnchorB);var m=this.m_uA.length(),u=this.m_uB.length();m>10*G.linearSlop?this.m_uA.mul(1/m):this.m_uA.setZero(),u>10*G.linearSlop?this.m_uB.mul(1/u):this.m_uB.setZero();var _=Y.crossVec2Vec2(this.m_rA,this.m_uA),d=Y.crossVec2Vec2(this.m_rB,this.m_uB),p=this.m_invMassA+this.m_invIA*_*_,y=this.m_invMassB+this.m_invIB*d*d;if(this.m_mass=p+this.m_ratio*this.m_ratio*y,this.m_mass>0&&(this.m_mass=1/this.m_mass),t.warmStarting){this.m_impulse*=t.dtRatio;var f=Y.mulNumVec2(-this.m_impulse,this.m_uA),g=Y.mulNumVec2(-this.m_ratio*this.m_impulse,this.m_uB);s.addMul(this.m_invMassA,f),o+=this.m_invIA*Y.crossVec2Vec2(this.m_rA,f),a.addMul(this.m_invMassB,g),h+=this.m_invIB*Y.crossVec2Vec2(this.m_rB,g)}else this.m_impulse=0;this.m_bodyA.c_velocity.v=s,this.m_bodyA.c_velocity.w=o,this.m_bodyB.c_velocity.v=a,this.m_bodyB.c_velocity.w=h},e.prototype.solveVelocityConstraints=function(t){var e=this.m_bodyA.c_velocity.v,i=this.m_bodyA.c_velocity.w,s=this.m_bodyB.c_velocity.v,o=this.m_bodyB.c_velocity.w,n=Y.add(e,Y.crossNumVec2(i,this.m_rA)),r=Y.add(s,Y.crossNumVec2(o,this.m_rB)),a=-Y.dot(this.m_uA,n)-this.m_ratio*Y.dot(this.m_uB,r),h=-this.m_mass*a;this.m_impulse+=h;var c=Y.mulNumVec2(-h,this.m_uA),l=Y.mulNumVec2(-this.m_ratio*h,this.m_uB);e.addMul(this.m_invMassA,c),i+=this.m_invIA*Y.crossVec2Vec2(this.m_rA,c),s.addMul(this.m_invMassB,l),o+=this.m_invIB*Y.crossVec2Vec2(this.m_rB,l),this.m_bodyA.c_velocity.v=e,this.m_bodyA.c_velocity.w=i,this.m_bodyB.c_velocity.v=s,this.m_bodyB.c_velocity.w=o},e.prototype.solvePositionConstraints=function(t){var e=this.m_bodyA.c_position.c,i=this.m_bodyA.c_position.a,s=this.m_bodyB.c_position.c,o=this.m_bodyB.c_position.a,n=Ht.neo(i),r=Ht.neo(o),a=Ht.mulVec2(n,Y.sub(this.m_localAnchorA,this.m_localCenterA)),h=Ht.mulVec2(r,Y.sub(this.m_localAnchorB,this.m_localCenterB)),c=Y.sub(Y.add(e,this.m_rA),this.m_groundAnchorA),l=Y.sub(Y.add(s,this.m_rB),this.m_groundAnchorB),m=c.length(),u=l.length();m>10*G.linearSlop?c.mul(1/m):c.setZero(),u>10*G.linearSlop?l.mul(1/u):l.setZero();var _=Y.crossVec2Vec2(a,c),d=Y.crossVec2Vec2(h,l),p=this.m_invMassA+this.m_invIA*_*_,y=this.m_invMassB+this.m_invIB*d*d,f=p+this.m_ratio*this.m_ratio*y;f>0&&(f=1/f);var g=this.m_constant-m-this.m_ratio*u,v=So(g),x=-f*g,b=Y.mulNumVec2(-x,c),A=Y.mulNumVec2(-this.m_ratio*x,l);return e.addMul(this.m_invMassA,b),i+=this.m_invIA*Y.crossVec2Vec2(a,b),s.addMul(this.m_invMassB,A),o+=this.m_invIB*Y.crossVec2Vec2(h,A),this.m_bodyA.c_position.c=e,this.m_bodyA.c_position.a=i,this.m_bodyB.c_position.c=s,this.m_bodyB.c_position.a=o,v<G.linearSlop},e.TYPE="pulley-joint",e}(ge),Vo=Math.min;!function(t){t[t.inactiveLimit=0]="inactiveLimit",t[t.atLowerLimit=1]="atLowerLimit",t[t.atUpperLimit=2]="atUpperLimit",t[t.equalLimits=3]="equalLimits"}(yo||(yo={}));var Io,zo={maxLength:0},To=function(t){function e(i,s,o,n){var r=this;return r instanceof e?(i=L(i,zo),s=(r=t.call(this,i,s,o)||this).m_bodyA,o=r.m_bodyB,r.m_type=e.TYPE,r.m_localAnchorA=Y.clone(n?s.getLocalPoint(n):i.localAnchorA||Y.neo(-1,0)),r.m_localAnchorB=Y.clone(n?o.getLocalPoint(n):i.localAnchorB||Y.neo(1,0)),r.m_maxLength=i.maxLength,r.m_mass=0,r.m_impulse=0,r.m_length=0,r.m_state=yo.inactiveLimit,r):new e(i,s,o,n)}return z(e,t),e.prototype._serialize=function(){return{type:this.m_type,bodyA:this.m_bodyA,bodyB:this.m_bodyB,collideConnected:this.m_collideConnected,localAnchorA:this.m_localAnchorA,localAnchorB:this.m_localAnchorB,maxLength:this.m_maxLength}},e._deserialize=function(t,i,s){return(t=T({},t)).bodyA=s(ye,t.bodyA,i),t.bodyB=s(ye,t.bodyB,i),new e(t)},e.prototype._reset=function(t){Number.isFinite(t.maxLength)&&(this.m_maxLength=t.maxLength)},e.prototype.getLocalAnchorA=function(){return this.m_localAnchorA},e.prototype.getLocalAnchorB=function(){return this.m_localAnchorB},e.prototype.setMaxLength=function(t){this.m_maxLength=t},e.prototype.getMaxLength=function(){return this.m_maxLength},e.prototype.getLimitState=function(){return this.m_state},e.prototype.getAnchorA=function(){return this.m_bodyA.getWorldPoint(this.m_localAnchorA)},e.prototype.getAnchorB=function(){return this.m_bodyB.getWorldPoint(this.m_localAnchorB)},e.prototype.getReactionForce=function(t){return Y.mulNumVec2(this.m_impulse,this.m_u).mul(t)},e.prototype.getReactionTorque=function(t){return 0},e.prototype.initVelocityConstraints=function(t){this.m_localCenterA=this.m_bodyA.m_sweep.localCenter,this.m_localCenterB=this.m_bodyB.m_sweep.localCenter,this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;var e=this.m_bodyA.c_position.c,i=this.m_bodyA.c_position.a,s=this.m_bodyA.c_velocity.v,o=this.m_bodyA.c_velocity.w,n=this.m_bodyB.c_position.c,r=this.m_bodyB.c_position.a,a=this.m_bodyB.c_velocity.v,h=this.m_bodyB.c_velocity.w,c=Ht.neo(i),l=Ht.neo(r);this.m_rA=Ht.mulSub(c,this.m_localAnchorA,this.m_localCenterA),this.m_rB=Ht.mulSub(l,this.m_localAnchorB,this.m_localCenterB),this.m_u=Y.zero(),this.m_u.addCombine(1,n,1,this.m_rB),this.m_u.subCombine(1,e,1,this.m_rA),this.m_length=this.m_u.length();var m=this.m_length-this.m_maxLength;if(this.m_state=m>0?yo.atUpperLimit:yo.inactiveLimit,!(this.m_length>G.linearSlop))return this.m_u.setZero(),this.m_mass=0,void(this.m_impulse=0);this.m_u.mul(1/this.m_length);var u=Y.crossVec2Vec2(this.m_rA,this.m_u),_=Y.crossVec2Vec2(this.m_rB,this.m_u),d=this.m_invMassA+this.m_invIA*u*u+this.m_invMassB+this.m_invIB*_*_;if(this.m_mass=0!=d?1/d:0,t.warmStarting){this.m_impulse*=t.dtRatio;var p=Y.mulNumVec2(this.m_impulse,this.m_u);s.subMul(this.m_invMassA,p),o-=this.m_invIA*Y.crossVec2Vec2(this.m_rA,p),a.addMul(this.m_invMassB,p),h+=this.m_invIB*Y.crossVec2Vec2(this.m_rB,p)}else this.m_impulse=0;this.m_bodyA.c_velocity.v.setVec2(s),this.m_bodyA.c_velocity.w=o,this.m_bodyB.c_velocity.v.setVec2(a),this.m_bodyB.c_velocity.w=h},e.prototype.solveVelocityConstraints=function(t){var e=this.m_bodyA.c_velocity.v,i=this.m_bodyA.c_velocity.w,s=this.m_bodyB.c_velocity.v,o=this.m_bodyB.c_velocity.w,n=Y.addCrossNumVec2(e,i,this.m_rA),r=Y.addCrossNumVec2(s,o,this.m_rB),a=this.m_length-this.m_maxLength,h=Y.dot(this.m_u,Y.sub(r,n));a<0&&(h+=t.inv_dt*a);var c=-this.m_mass*h,l=this.m_impulse;this.m_impulse=Vo(0,this.m_impulse+c),c=this.m_impulse-l;var m=Y.mulNumVec2(c,this.m_u);e.subMul(this.m_invMassA,m),i-=this.m_invIA*Y.crossVec2Vec2(this.m_rA,m),s.addMul(this.m_invMassB,m),o+=this.m_invIB*Y.crossVec2Vec2(this.m_rB,m),this.m_bodyA.c_velocity.v=e,this.m_bodyA.c_velocity.w=i,this.m_bodyB.c_velocity.v=s,this.m_bodyB.c_velocity.w=o},e.prototype.solvePositionConstraints=function(t){var e=this.m_bodyA.c_position.c,i=this.m_bodyA.c_position.a,s=this.m_bodyB.c_position.c,o=this.m_bodyB.c_position.a,n=Ht.neo(i),r=Ht.neo(o),a=Ht.mulSub(n,this.m_localAnchorA,this.m_localCenterA),h=Ht.mulSub(r,this.m_localAnchorB,this.m_localCenterB),c=Y.zero();c.addCombine(1,s,1,h),c.subCombine(1,e,1,a);var l=c.normalize(),m=l-this.m_maxLength;m=j(m,0,G.maxLinearCorrection);var u=-this.m_mass*m,_=Y.mulNumVec2(u,c);return e.subMul(this.m_invMassA,_),i-=this.m_invIA*Y.crossVec2Vec2(a,_),s.addMul(this.m_invMassB,_),o+=this.m_invIB*Y.crossVec2Vec2(h,_),this.m_bodyA.c_position.c.setVec2(e),this.m_bodyA.c_position.a=i,this.m_bodyB.c_position.c.setVec2(s),this.m_bodyB.c_position.a=o,l-this.m_maxLength<G.linearSlop},e.TYPE="rope-joint",e}(ge),Lo=Math.abs,Fo=Math.PI,ko={frequencyHz:0,dampingRatio:0},qo=function(t){function e(i,s,o,n){var r=this;return r instanceof e?(i=L(i,ko),s=(r=t.call(this,i,s,o)||this).m_bodyA,o=r.m_bodyB,r.m_type=e.TYPE,r.m_localAnchorA=Y.clone(n?s.getLocalPoint(n):i.localAnchorA||Y.zero()),r.m_localAnchorB=Y.clone(n?o.getLocalPoint(n):i.localAnchorB||Y.zero()),r.m_referenceAngle=Number.isFinite(i.referenceAngle)?i.referenceAngle:o.getAngle()-s.getAngle(),r.m_frequencyHz=i.frequencyHz,r.m_dampingRatio=i.dampingRatio,r.m_impulse=new qs,r.m_bias=0,r.m_gamma=0,r.m_mass=new ho,r):new e(i,s,o,n)}return z(e,t),e.prototype._serialize=function(){return{type:this.m_type,bodyA:this.m_bodyA,bodyB:this.m_bodyB,collideConnected:this.m_collideConnected,frequencyHz:this.m_frequencyHz,dampingRatio:this.m_dampingRatio,localAnchorA:this.m_localAnchorA,localAnchorB:this.m_localAnchorB,referenceAngle:this.m_referenceAngle}},e._deserialize=function(t,i,s){return(t=T({},t)).bodyA=s(ye,t.bodyA,i),t.bodyB=s(ye,t.bodyB,i),new e(t)},e.prototype._reset=function(t){t.anchorA?this.m_localAnchorA.setVec2(this.m_bodyA.getLocalPoint(t.anchorA)):t.localAnchorA&&this.m_localAnchorA.setVec2(t.localAnchorA),t.anchorB?this.m_localAnchorB.setVec2(this.m_bodyB.getLocalPoint(t.anchorB)):t.localAnchorB&&this.m_localAnchorB.setVec2(t.localAnchorB),Number.isFinite(t.frequencyHz)&&(this.m_frequencyHz=t.frequencyHz),Number.isFinite(t.dampingRatio)&&(this.m_dampingRatio=t.dampingRatio)},e.prototype.getLocalAnchorA=function(){return this.m_localAnchorA},e.prototype.getLocalAnchorB=function(){return this.m_localAnchorB},e.prototype.getReferenceAngle=function(){return this.m_referenceAngle},e.prototype.setFrequency=function(t){this.m_frequencyHz=t},e.prototype.getFrequency=function(){return this.m_frequencyHz},e.prototype.setDampingRatio=function(t){this.m_dampingRatio=t},e.prototype.getDampingRatio=function(){return this.m_dampingRatio},e.prototype.getAnchorA=function(){return this.m_bodyA.getWorldPoint(this.m_localAnchorA)},e.prototype.getAnchorB=function(){return this.m_bodyB.getWorldPoint(this.m_localAnchorB)},e.prototype.getReactionForce=function(t){return Y.neo(this.m_impulse.x,this.m_impulse.y).mul(t)},e.prototype.getReactionTorque=function(t){return t*this.m_impulse.z},e.prototype.initVelocityConstraints=function(t){this.m_localCenterA=this.m_bodyA.m_sweep.localCenter,this.m_localCenterB=this.m_bodyB.m_sweep.localCenter,this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;var e=this.m_bodyA.c_position.a,i=this.m_bodyA.c_velocity.v,s=this.m_bodyA.c_velocity.w,o=this.m_bodyB.c_position.a,n=this.m_bodyB.c_velocity.v,r=this.m_bodyB.c_velocity.w,a=Ht.neo(e),h=Ht.neo(o);this.m_rA=Ht.mulVec2(a,Y.sub(this.m_localAnchorA,this.m_localCenterA)),this.m_rB=Ht.mulVec2(h,Y.sub(this.m_localAnchorB,this.m_localCenterB));var c=this.m_invMassA,l=this.m_invMassB,m=this.m_invIA,u=this.m_invIB,_=new ho;if(_.ex.x=c+l+this.m_rA.y*this.m_rA.y*m+this.m_rB.y*this.m_rB.y*u,_.ey.x=-this.m_rA.y*this.m_rA.x*m-this.m_rB.y*this.m_rB.x*u,_.ez.x=-this.m_rA.y*m-this.m_rB.y*u,_.ex.y=_.ey.x,_.ey.y=c+l+this.m_rA.x*this.m_rA.x*m+this.m_rB.x*this.m_rB.x*u,_.ez.y=this.m_rA.x*m+this.m_rB.x*u,_.ex.z=_.ez.x,_.ey.z=_.ez.y,_.ez.z=m+u,this.m_frequencyHz>0){_.getInverse22(this.m_mass);var d=m+u,p=d>0?1/d:0,y=o-e-this.m_referenceAngle,f=2*Fo*this.m_frequencyHz,g=2*p*this.m_dampingRatio*f,v=p*f*f,x=t.dt;this.m_gamma=x*(g+x*v),this.m_gamma=0!=this.m_gamma?1/this.m_gamma:0,this.m_bias=y*x*v*this.m_gamma,d+=this.m_gamma,this.m_mass.ez.z=0!=d?1/d:0}else 0==_.ez.z?(_.getInverse22(this.m_mass),this.m_gamma=0,this.m_bias=0):(_.getSymInverse33(this.m_mass),this.m_gamma=0,this.m_bias=0);if(t.warmStarting){this.m_impulse.mul(t.dtRatio);var b=Y.neo(this.m_impulse.x,this.m_impulse.y);i.subMul(c,b),s-=m*(Y.crossVec2Vec2(this.m_rA,b)+this.m_impulse.z),n.addMul(l,b),r+=u*(Y.crossVec2Vec2(this.m_rB,b)+this.m_impulse.z)}else this.m_impulse.setZero();this.m_bodyA.c_velocity.v=i,this.m_bodyA.c_velocity.w=s,this.m_bodyB.c_velocity.v=n,this.m_bodyB.c_velocity.w=r},e.prototype.solveVelocityConstraints=function(t){var e=this.m_bodyA.c_velocity.v,i=this.m_bodyA.c_velocity.w,s=this.m_bodyB.c_velocity.v,o=this.m_bodyB.c_velocity.w,n=this.m_invMassA,r=this.m_invMassB,a=this.m_invIA,h=this.m_invIB;if(this.m_frequencyHz>0){var c=o-i,l=-this.m_mass.ez.z*(c+this.m_bias+this.m_gamma*this.m_impulse.z);this.m_impulse.z+=l,i-=a*l,o+=h*l,(_=Y.zero()).addCombine(1,s,1,Y.crossNumVec2(o,this.m_rB)),_.subCombine(1,e,1,Y.crossNumVec2(i,this.m_rA));var m=Y.neg(ho.mulVec2(this.m_mass,_));this.m_impulse.x+=m.x,this.m_impulse.y+=m.y;var u=Y.clone(m);e.subMul(n,u),i-=a*Y.crossVec2Vec2(this.m_rA,u),s.addMul(r,u),o+=h*Y.crossVec2Vec2(this.m_rB,u)}else{var _;(_=Y.zero()).addCombine(1,s,1,Y.crossNumVec2(o,this.m_rB)),_.subCombine(1,e,1,Y.crossNumVec2(i,this.m_rA)),c=o-i;var d=new qs(_.x,_.y,c),p=qs.neg(ho.mulVec3(this.m_mass,d));this.m_impulse.add(p),u=Y.neo(p.x,p.y),e.subMul(n,u),i-=a*(Y.crossVec2Vec2(this.m_rA,u)+p.z),s.addMul(r,u),o+=h*(Y.crossVec2Vec2(this.m_rB,u)+p.z)}this.m_bodyA.c_velocity.v=e,this.m_bodyA.c_velocity.w=i,this.m_bodyB.c_velocity.v=s,this.m_bodyB.c_velocity.w=o},e.prototype.solvePositionConstraints=function(t){var e,i,s=this.m_bodyA.c_position.c,o=this.m_bodyA.c_position.a,n=this.m_bodyB.c_position.c,r=this.m_bodyB.c_position.a,a=Ht.neo(o),h=Ht.neo(r),c=this.m_invMassA,l=this.m_invMassB,m=this.m_invIA,u=this.m_invIB,_=Ht.mulVec2(a,Y.sub(this.m_localAnchorA,this.m_localCenterA)),d=Ht.mulVec2(h,Y.sub(this.m_localAnchorB,this.m_localCenterB)),p=new ho;if(p.ex.x=c+l+_.y*_.y*m+d.y*d.y*u,p.ey.x=-_.y*_.x*m-d.y*d.x*u,p.ez.x=-_.y*m-d.y*u,p.ex.y=p.ey.x,p.ey.y=c+l+_.x*_.x*m+d.x*d.x*u,p.ez.y=_.x*m+d.x*u,p.ex.z=p.ez.x,p.ey.z=p.ez.y,p.ez.z=m+u,this.m_frequencyHz>0){(f=Y.zero()).addCombine(1,n,1,d),f.subCombine(1,s,1,_),e=f.length(),i=0;var y=Y.neg(p.solve22(f));s.subMul(c,y),o-=m*Y.crossVec2Vec2(_,y),n.addMul(l,y),r+=u*Y.crossVec2Vec2(d,y)}else{var f;(f=Y.zero()).addCombine(1,n,1,d),f.subCombine(1,s,1,_);var g=r-o-this.m_referenceAngle;e=f.length(),i=Lo(g);var v=new qs(f.x,f.y,g),x=new qs;if(p.ez.z>0)x=qs.neg(p.solve33(v));else{var b=Y.neg(p.solve22(f));x.set(b.x,b.y,0)}y=Y.neo(x.x,x.y),s.subMul(c,y),o-=m*(Y.crossVec2Vec2(_,y)+x.z),n.addMul(l,y),r+=u*(Y.crossVec2Vec2(d,y)+x.z)}return this.m_bodyA.c_position.c=s,this.m_bodyA.c_position.a=o,this.m_bodyB.c_position.c=n,this.m_bodyB.c_position.a=r,e<=G.linearSlop&&i<=G.angularSlop},e.TYPE="weld-joint",e}(ge),No=Math.abs,jo=Math.PI,Ro={enableMotor:!1,maxMotorTorque:0,motorSpeed:0,frequencyHz:2,dampingRatio:.7},Eo=function(t){function e(i,s,o,n,r){var a=this;return a instanceof e?(i=L(i,Ro),s=(a=t.call(this,i,s,o)||this).m_bodyA,o=a.m_bodyB,a.m_ax=Y.zero(),a.m_ay=Y.zero(),a.m_type=e.TYPE,a.m_localAnchorA=Y.clone(n?s.getLocalPoint(n):i.localAnchorA||Y.zero()),a.m_localAnchorB=Y.clone(n?o.getLocalPoint(n):i.localAnchorB||Y.zero()),Y.isValid(r)?a.m_localXAxisA=s.getLocalVector(r):Y.isValid(i.localAxisA)?a.m_localXAxisA=Y.clone(i.localAxisA):Y.isValid(i.localAxis)?a.m_localXAxisA=Y.clone(i.localAxis):a.m_localXAxisA=Y.neo(1,0),a.m_localYAxisA=Y.crossNumVec2(1,a.m_localXAxisA),a.m_mass=0,a.m_impulse=0,a.m_motorMass=0,a.m_motorImpulse=0,a.m_springMass=0,a.m_springImpulse=0,a.m_maxMotorTorque=i.maxMotorTorque,a.m_motorSpeed=i.motorSpeed,a.m_enableMotor=i.enableMotor,a.m_frequencyHz=i.frequencyHz,a.m_dampingRatio=i.dampingRatio,a.m_bias=0,a.m_gamma=0,a):new e(i,s,o,n,r)}return z(e,t),e.prototype._serialize=function(){return{type:this.m_type,bodyA:this.m_bodyA,bodyB:this.m_bodyB,collideConnected:this.m_collideConnected,enableMotor:this.m_enableMotor,maxMotorTorque:this.m_maxMotorTorque,motorSpeed:this.m_motorSpeed,frequencyHz:this.m_frequencyHz,dampingRatio:this.m_dampingRatio,localAnchorA:this.m_localAnchorA,localAnchorB:this.m_localAnchorB,localAxisA:this.m_localXAxisA}},e._deserialize=function(t,i,s){return(t=T({},t)).bodyA=s(ye,t.bodyA,i),t.bodyB=s(ye,t.bodyB,i),new e(t)},e.prototype._reset=function(t){t.anchorA?this.m_localAnchorA.setVec2(this.m_bodyA.getLocalPoint(t.anchorA)):t.localAnchorA&&this.m_localAnchorA.setVec2(t.localAnchorA),t.anchorB?this.m_localAnchorB.setVec2(this.m_bodyB.getLocalPoint(t.anchorB)):t.localAnchorB&&this.m_localAnchorB.setVec2(t.localAnchorB),t.localAxisA&&(this.m_localXAxisA.setVec2(t.localAxisA),this.m_localYAxisA.setVec2(Y.crossNumVec2(1,t.localAxisA))),void 0!==t.enableMotor&&(this.m_enableMotor=t.enableMotor),Number.isFinite(t.maxMotorTorque)&&(this.m_maxMotorTorque=t.maxMotorTorque),Number.isFinite(t.motorSpeed)&&(this.m_motorSpeed=t.motorSpeed),Number.isFinite(t.frequencyHz)&&(this.m_frequencyHz=t.frequencyHz),Number.isFinite(t.dampingRatio)&&(this.m_dampingRatio=t.dampingRatio)},e.prototype.getLocalAnchorA=function(){return this.m_localAnchorA},e.prototype.getLocalAnchorB=function(){return this.m_localAnchorB},e.prototype.getLocalAxisA=function(){return this.m_localXAxisA},e.prototype.getJointTranslation=function(){var t=this.m_bodyA,e=this.m_bodyB,i=t.getWorldPoint(this.m_localAnchorA),s=e.getWorldPoint(this.m_localAnchorB),o=Y.sub(s,i),n=t.getWorldVector(this.m_localXAxisA);return Y.dot(o,n)},e.prototype.getJointSpeed=function(){var t=this.m_bodyA.m_angularVelocity;return this.m_bodyB.m_angularVelocity-t},e.prototype.isMotorEnabled=function(){return this.m_enableMotor},e.prototype.enableMotor=function(t){t!=this.m_enableMotor&&(this.m_bodyA.setAwake(!0),this.m_bodyB.setAwake(!0),this.m_enableMotor=t)},e.prototype.setMotorSpeed=function(t){t!=this.m_motorSpeed&&(this.m_bodyA.setAwake(!0),this.m_bodyB.setAwake(!0),this.m_motorSpeed=t)},e.prototype.getMotorSpeed=function(){return this.m_motorSpeed},e.prototype.setMaxMotorTorque=function(t){t!=this.m_maxMotorTorque&&(this.m_bodyA.setAwake(!0),this.m_bodyB.setAwake(!0),this.m_maxMotorTorque=t)},e.prototype.getMaxMotorTorque=function(){return this.m_maxMotorTorque},e.prototype.getMotorTorque=function(t){return t*this.m_motorImpulse},e.prototype.setSpringFrequencyHz=function(t){this.m_frequencyHz=t},e.prototype.getSpringFrequencyHz=function(){return this.m_frequencyHz},e.prototype.setSpringDampingRatio=function(t){this.m_dampingRatio=t},e.prototype.getSpringDampingRatio=function(){return this.m_dampingRatio},e.prototype.getAnchorA=function(){return this.m_bodyA.getWorldPoint(this.m_localAnchorA)},e.prototype.getAnchorB=function(){return this.m_bodyB.getWorldPoint(this.m_localAnchorB)},e.prototype.getReactionForce=function(t){return Y.combine(this.m_impulse,this.m_ay,this.m_springImpulse,this.m_ax).mul(t)},e.prototype.getReactionTorque=function(t){return t*this.m_motorImpulse},e.prototype.initVelocityConstraints=function(t){this.m_localCenterA=this.m_bodyA.m_sweep.localCenter,this.m_localCenterB=this.m_bodyB.m_sweep.localCenter,this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;var e=this.m_invMassA,i=this.m_invMassB,s=this.m_invIA,o=this.m_invIB,n=this.m_bodyA.c_position.c,r=this.m_bodyA.c_position.a,a=this.m_bodyA.c_velocity.v,h=this.m_bodyA.c_velocity.w,c=this.m_bodyB.c_position.c,l=this.m_bodyB.c_position.a,m=this.m_bodyB.c_velocity.v,u=this.m_bodyB.c_velocity.w,_=Ht.neo(r),d=Ht.neo(l),p=Ht.mulVec2(_,Y.sub(this.m_localAnchorA,this.m_localCenterA)),y=Ht.mulVec2(d,Y.sub(this.m_localAnchorB,this.m_localCenterB)),f=Y.zero();if(f.addCombine(1,c,1,y),f.subCombine(1,n,1,p),this.m_ay=Ht.mulVec2(_,this.m_localYAxisA),this.m_sAy=Y.crossVec2Vec2(Y.add(f,p),this.m_ay),this.m_sBy=Y.crossVec2Vec2(y,this.m_ay),this.m_mass=e+i+s*this.m_sAy*this.m_sAy+o*this.m_sBy*this.m_sBy,this.m_mass>0&&(this.m_mass=1/this.m_mass),this.m_springMass=0,this.m_bias=0,this.m_gamma=0,this.m_frequencyHz>0){this.m_ax=Ht.mulVec2(_,this.m_localXAxisA),this.m_sAx=Y.crossVec2Vec2(Y.add(f,p),this.m_ax),this.m_sBx=Y.crossVec2Vec2(y,this.m_ax);var g=e+i+s*this.m_sAx*this.m_sAx+o*this.m_sBx*this.m_sBx;if(g>0){this.m_springMass=1/g;var v=Y.dot(f,this.m_ax),x=2*jo*this.m_frequencyHz,b=2*this.m_springMass*this.m_dampingRatio*x,A=this.m_springMass*x*x,w=t.dt;this.m_gamma=w*(b+w*A),this.m_gamma>0&&(this.m_gamma=1/this.m_gamma),this.m_bias=v*w*A*this.m_gamma,this.m_springMass=g+this.m_gamma,this.m_springMass>0&&(this.m_springMass=1/this.m_springMass)}}else this.m_springImpulse=0;if(this.m_enableMotor?(this.m_motorMass=s+o,this.m_motorMass>0&&(this.m_motorMass=1/this.m_motorMass)):(this.m_motorMass=0,this.m_motorImpulse=0),t.warmStarting){this.m_impulse*=t.dtRatio,this.m_springImpulse*=t.dtRatio,this.m_motorImpulse*=t.dtRatio;var B=Y.combine(this.m_impulse,this.m_ay,this.m_springImpulse,this.m_ax),C=this.m_impulse*this.m_sAy+this.m_springImpulse*this.m_sAx+this.m_motorImpulse,S=this.m_impulse*this.m_sBy+this.m_springImpulse*this.m_sBx+this.m_motorImpulse;a.subMul(this.m_invMassA,B),h-=this.m_invIA*C,m.addMul(this.m_invMassB,B),u+=this.m_invIB*S}else this.m_impulse=0,this.m_springImpulse=0,this.m_motorImpulse=0;this.m_bodyA.c_velocity.v.setVec2(a),this.m_bodyA.c_velocity.w=h,this.m_bodyB.c_velocity.v.setVec2(m),this.m_bodyB.c_velocity.w=u},e.prototype.solveVelocityConstraints=function(t){var e=this.m_invMassA,i=this.m_invMassB,s=this.m_invIA,o=this.m_invIB,n=this.m_bodyA.c_velocity.v,r=this.m_bodyA.c_velocity.w,a=this.m_bodyB.c_velocity.v,h=this.m_bodyB.c_velocity.w,c=Y.dot(this.m_ax,a)-Y.dot(this.m_ax,n)+this.m_sBx*h-this.m_sAx*r,l=-this.m_springMass*(c+this.m_bias+this.m_gamma*this.m_springImpulse);this.m_springImpulse+=l;var m=Y.mulNumVec2(l,this.m_ax),u=l*this.m_sAx,_=l*this.m_sBx;n.subMul(e,m),r-=s*u,a.addMul(i,m),c=(h+=o*_)-r-this.m_motorSpeed,l=-this.m_motorMass*c;var d=this.m_motorImpulse,p=t.dt*this.m_maxMotorTorque;this.m_motorImpulse=j(this.m_motorImpulse+l,-p,p),r-=s*(l=this.m_motorImpulse-d),h+=o*l,c=Y.dot(this.m_ay,a)-Y.dot(this.m_ay,n)+this.m_sBy*h-this.m_sAy*r,l=-this.m_mass*c,this.m_impulse+=l,m=Y.mulNumVec2(l,this.m_ay),u=l*this.m_sAy,_=l*this.m_sBy,n.subMul(e,m),r-=s*u,a.addMul(i,m),h+=o*_,this.m_bodyA.c_velocity.v.setVec2(n),this.m_bodyA.c_velocity.w=r,this.m_bodyB.c_velocity.v.setVec2(a),this.m_bodyB.c_velocity.w=h},e.prototype.solvePositionConstraints=function(t){var e=this.m_bodyA.c_position.c,i=this.m_bodyA.c_position.a,s=this.m_bodyB.c_position.c,o=this.m_bodyB.c_position.a,n=Ht.neo(i),r=Ht.neo(o),a=Ht.mulVec2(n,Y.sub(this.m_localAnchorA,this.m_localCenterA)),h=Ht.mulVec2(r,Y.sub(this.m_localAnchorB,this.m_localCenterB)),c=Y.zero();c.addCombine(1,s,1,h),c.subCombine(1,e,1,a);var l=Ht.mulVec2(n,this.m_localYAxisA),m=Y.crossVec2Vec2(Y.add(c,a),l),u=Y.crossVec2Vec2(h,l),_=Y.dot(c,l),d=this.m_invMassA+this.m_invMassB+this.m_invIA*this.m_sAy*this.m_sAy+this.m_invIB*this.m_sBy*this.m_sBy,p=0!=d?-_/d:0,y=Y.mulNumVec2(p,l),f=p*m,g=p*u;return e.subMul(this.m_invMassA,y),i-=this.m_invIA*f,s.addMul(this.m_invMassB,y),o+=this.m_invIB*g,this.m_bodyA.c_position.c.setVec2(e),this.m_bodyA.c_position.a=i,this.m_bodyB.c_position.c.setVec2(s),this.m_bodyB.c_position.a=o,No(_)<=G.linearSlop},e.TYPE="wheel-joint",e}(ge),Oo=0,Do={World:ks,Body:ye,Joint:ge,Fixture:re,Shape:te},Ho={Vec2:Y,Vec3:qs,World:ks,Body:ye,Joint:ge,Fixture:re,Shape:te},Yo=((Io={})[ye.STATIC]=ye,Io[ye.DYNAMIC]=ye,Io[ye.KINEMATIC]=ye,Io[Ds.TYPE]=Ds,Io[Ks.TYPE]=Ks,Io[Rs.TYPE]=Rs,Io[eo.TYPE]=eo,Io[no.TYPE]=no,Io[ao.TYPE]=ao,Io[xo.TYPE]=xo,Io[Ao.TYPE]=Ao,Io[Co.TYPE]=Co,Io[go.TYPE]=go,Io[Po.TYPE]=Po,Io[mo.TYPE]=mo,Io[To.TYPE]=To,Io[qo.TYPE]=qo,Io[Eo.TYPE]=Eo,Io),Wo={rootClass:ks,preSerialize:function(t){return t},postSerialize:function(t,e){return t},preDeserialize:function(t){return t},postDeserialize:function(t,e){return t}},Uo=function(){return function(t){var e=this;this.toJson=function(t){var i=e.options.preSerialize,s=e.options.postSerialize,o=[],n=[t],r={};function a(t,e){if(t.__sid=t.__sid||++Oo,!r[t.__sid]){n.push(t);var i={refIndex:o.length+n.length,refType:e};r[t.__sid]=i}return r[t.__sid]}function h(t,e){if(void 0===e&&(e=!1),"object"!=typeof t||null===t)return t;if("function"==typeof t._serialize){if(!e)for(var o in Do)if(t instanceof Do[o])return a(t,o);r=(n=i(n=t))._serialize(),t=s(r,n)}var n,r;if(Array.isArray(t)){for(var c=[],l=0;l<t.length;l++)c[l]=h(t[l]);t=c}else{for(var l in c={},t)t.hasOwnProperty(l)&&(c[l]=h(t[l]));t=c}return t}for(;n.length;){var c=h(n.shift(),!0);o.push(c)}return o},this.fromJson=function(t){var i=e.options.preDeserialize,s=e.options.postDeserialize,o=e.options.rootClass,n={};function r(t,e,o){if(t&&t._deserialize||(t=Yo[e.type]),t&&t._deserialize){e=i(e);var n=(0,t._deserialize)(e,o,a);return s(n,e)}}function a(e,i,s){if(!i.refIndex||!i.refType)return r(e,i,s);var o=i;Ho[o.refType]&&(e=Ho[o.refType]);var a=o.refIndex;if(!n[a]){var h=r(e,t[a],s);n[a]=h}return n[a]}return r(o,t[0],null)},this.options=T(T({},Wo),t)}}(),Xo=new Uo({rootClass:ks});Uo.fromJson=Xo.fromJson,Uo.toJson=Xo.toJson;(function(){function t(){}t.mount=function(t){throw new Error("Not implemented")},t.start=function(e){var i=t.mount();return i.start(e),i}})(),function(t){function e(i,s,o,n){var r=this;return r instanceof e?((r=t.call(this)||this)._setAsBox(i,s,o,n),r):new e(i,s,o,n)}z(e,t),e.TYPE="polygon"}(Ks);Ls.addType(eo.TYPE,eo.TYPE,function(t,e,i,s,o,n,r){Go(t,i.getShape(),e,n.getShape(),o)});var Jo=lt(0,0),$o=lt(0,0),Go=function(t,e,i,s,o){t.pointCount=0,qt(Jo,i,e.m_p),qt($o,o,s.m_p);var n=zt($o,Jo),r=e.m_radius+s.m_radius;n>r*r||(t.type=Ci.e_circles,ut(t.localPoint,e.m_p),_t(t.localNormal),t.pointCount=1,ut(t.points[0].localPoint,s.m_p),t.points[0].id.setFeatures(0,Mi.e_vertex,0,Mi.e_vertex))};Ls.addType(Rs.TYPE,eo.TYPE,function(t,e,i,s,o,n,r){var a=i.getShape(),h=n.getShape();on(t,a,e,h,o)}),Ls.addType(Ds.TYPE,eo.TYPE,function(t,e,i,s,o,n,r){var a=i.getShape(),h=new Rs;a.getChildEdge(h,s);var c=h,l=n.getShape();on(t,c,e,l,o)});var Ko=lt(0,0),Zo=lt(0,0),Qo=lt(0,0),tn=lt(0,0),en=lt(0,0),sn=lt(0,0),on=function(t,e,i,s,o){t.pointCount=0,jt(tn,o,i,s.m_p);var n=e.m_vertex1,r=e.m_vertex2;ft(Ko,r,n);var a=Pt(Ko,r)-Pt(Ko,tn),h=Pt(Ko,tn)-Pt(Ko,n),c=e.m_radius+s.m_radius;if(h<=0){if(ut(en,n),zt(tn,n)>c*c)return;if(e.m_hasVertex0){var l=e.m_vertex0,m=n;if(ft(Zo,m,l),Pt(Zo,m)-Pt(Zo,tn)>0)return}return t.type=Ci.e_circles,_t(t.localNormal),ut(t.localPoint,en),t.pointCount=1,ut(t.points[0].localPoint,s.m_p),void t.points[0].id.setFeatures(0,Mi.e_vertex,0,Mi.e_vertex)}if(a<=0){if(ut(en,r),zt(tn,en)>c*c)return;if(e.m_hasVertex3){var u=e.m_vertex3,_=r;if(ft(Qo,u,_),Pt(Qo,tn)-Pt(Qo,_)>0)return}return t.type=Ci.e_circles,_t(t.localNormal),ut(t.localPoint,en),t.pointCount=1,ut(t.points[0].localPoint,s.m_p),void t.points[0].id.setFeatures(1,Mi.e_vertex,0,Mi.e_vertex)}var d=Vt(Ko);At(en,a/d,n,h/d,r),zt(tn,en)>c*c||(St(sn,1,Ko),Pt(sn,tn)-Pt(sn,n)<0&&dt(sn),Bt(sn),t.type=Ci.e_faceA,ut(t.localNormal,sn),ut(t.localPoint,n),t.pointCount=1,ut(t.points[0].localPoint,s.m_p),t.points[0].id.setFeatures(0,Mi.e_face,0,Mi.e_vertex))},nn=[new Oi,new Oi],rn=[new Oi,new Oi],an=[new Oi,new Oi],hn=lt(0,0),cn=lt(0,0),ln=lt(0,0),mn=Ft(0,0,0),un=lt(0,0),_n=lt(0,0),dn=lt(0,0),pn=lt(0,0),yn=lt(0,0),fn=lt(0,0),gn=lt(0,0),vn=lt(0,0);function xn(t,e,i,s,o){var n=t.m_count,r=i.m_count,a=t.m_normals,h=t.m_vertices,c=i.m_vertices;Rt(mn,s,e);for(var l=0,m=-1/0,u=0;u<n;++u){Tt(ln,mn.q,a[u]),qt(cn,mn,h[u]);for(var _=1/0,d=0;d<r;++d){var p=Pt(ln,c[d])-Pt(ln,cn);p<_&&(_=p)}_>m&&(m=_,l=u)}o.maxSeparation=m,o.bestIndex=l}Ls.addType(Ks.TYPE,Ks.TYPE,function(t,e,i,s,o,n,r){An(t,i.getShape(),e,n.getShape(),o)});var bn={maxSeparation:0,bestIndex:0},An=function(t,e,i,s,o){t.pointCount=0;var n=e.m_radius+s.m_radius;xn(e,i,s,o,bn);var r=bn.bestIndex,a=bn.maxSeparation;if(!(a>n)){xn(s,o,e,i,bn);var h=bn.bestIndex,c=bn.maxSeparation;if(!(c>n)){var l,m,u,_,d,p;c>a+.1*G.linearSlop?(l=s,m=e,u=o,_=i,d=h,t.type=Ci.e_faceB,p=!0):(l=e,m=s,u=i,_=o,d=r,t.type=Ci.e_faceA,p=!1),nn[0].recycle(),nn[1].recycle(),function(t,e,i,s,o,n){var r,a,h,c,l,m,u,_,d=e.m_normals,p=o.m_count,y=o.m_vertices,f=o.m_normals;r=vn,a=n.q,h=i.q,c=d[s],l=a.c*c.x+a.s*c.y,m=-a.s*c.x+a.c*c.y,u=h.c*l-h.s*m,_=h.s*l+h.c*m,r.x=u,r.y=_;for(var g=0,v=1/0,x=0;x<p;++x){var b=Pt(vn,f[x]);b<v&&(v=b,g=x)}var A=g,w=A+1<p?A+1:0;qt(t[0].v,n,y[A]),t[0].id.setFeatures(s,Mi.e_face,A,Mi.e_vertex),qt(t[1].v,n,y[w]),t[1].id.setFeatures(s,Mi.e_face,w,Mi.e_vertex)}(nn,l,u,d,m,_);var y=l.m_count,f=l.m_vertices,g=d,v=d+1<y?d+1:0;ut(un,f[g]),ut(_n,f[v]),ft(dn,_n,un),Bt(dn),Ct(pn,dn,1),At(yn,.5,un,.5,_n),Tt(fn,u.q,dn),Ct(gn,fn,1),qt(un,u,un),qt(_n,u,_n);var x=Pt(gn,un),b=-Pt(fn,un)+n,A=Pt(fn,_n)+n;if(!(rn[0].recycle(),rn[1].recycle(),an[0].recycle(),an[1].recycle(),mt(hn,-fn.x,-fn.y),Xi(rn,nn,hn,b,g)<2||(mt(hn,fn.x,fn.y),Xi(an,rn,hn,A,v)<2))){ut(t.localNormal,pn),ut(t.localPoint,yn);for(var w=0,B=0;B<an.length;++B)if(Pt(gn,an[B].v)-x<=n){var C=t.points[w];Nt(C.localPoint,_,an[B].v),C.id.set(an[B].id),p&&C.id.swapFeatures(),++w}t.pointCount=w}}}};Ls.addType(Ks.TYPE,eo.TYPE,function(t,e,i,s,o,n,r){Cn(t,i.getShape(),e,n.getShape(),o)});var wn=lt(0,0),Bn=lt(0,0),Cn=function(t,e,i,s,o){t.pointCount=0,jt(wn,o,i,s.m_p);for(var n=0,r=-1/0,a=e.m_radius+s.m_radius,h=e.m_count,c=e.m_vertices,l=e.m_normals,m=0;m<h;++m){var u=Pt(l[m],wn)-Pt(l[m],c[m]);if(u>a)return;u>r&&(r=u,n=m)}var _=n,d=_+1<h?_+1:0,p=c[_],y=c[d];if(r<k)return t.pointCount=1,t.type=Ci.e_faceA,ut(t.localNormal,l[n]),At(t.localPoint,.5,p,.5,y),ut(t.points[0].localPoint,s.m_p),void t.points[0].id.setFeatures(0,Mi.e_vertex,0,Mi.e_vertex);var f=Pt(wn,y)-Pt(wn,p)-Pt(p,y)+Pt(p,p),g=Pt(wn,p)-Pt(wn,y)-Pt(y,p)+Pt(y,y);if(f<=0){if(zt(wn,p)>a*a)return;t.pointCount=1,t.type=Ci.e_faceA,ft(t.localNormal,wn,p),Bt(t.localNormal),ut(t.localPoint,p),ut(t.points[0].localPoint,s.m_p),t.points[0].id.setFeatures(0,Mi.e_vertex,0,Mi.e_vertex)}else if(g<=0){if(zt(wn,y)>a*a)return;t.pointCount=1,t.type=Ci.e_faceA,ft(t.localNormal,wn,y),Bt(t.localNormal),ut(t.localPoint,y),ut(t.points[0].localPoint,s.m_p),t.points[0].id.setFeatures(0,Mi.e_vertex,0,Mi.e_vertex)}else{if(At(Bn,.5,p,.5,y),Pt(wn,l[_])-Pt(Bn,l[_])>a)return;t.pointCount=1,t.type=Ci.e_faceA,ut(t.localNormal,l[_]),ut(t.localPoint,Bn),ut(t.points[0].localPoint,s.m_p),t.points[0].id.setFeatures(0,Mi.e_vertex,0,Mi.e_vertex)}},Sn=Math.min;Ls.addType(Rs.TYPE,Ks.TYPE,function(t,e,i,s,o,n,r){er(t,i.getShape(),e,n.getShape(),o)}),Ls.addType(Ds.TYPE,Ks.TYPE,function(t,e,i,s,o,n,r){i.getShape().getChildEdge(zn,s),er(t,zn,e,n.getShape(),o)});var Mn,Pn,Vn,In,zn=new Rs;(Pn=Mn||(Mn={}))[Pn.e_unknown=-1]="e_unknown",Pn[Pn.e_edgeA=1]="e_edgeA",Pn[Pn.e_edgeB=2]="e_edgeB",(In=Vn||(Vn={}))[In.e_isolated=0]="e_isolated",In[In.e_concave=1]="e_concave",In[In.e_convex=2]="e_convex";var Tn=function(){return function(){}}(),Ln=function(){return function(){this.vertices=[],this.normals=[],this.count=0;for(var t=0;t<G.maxPolygonVertices;t++)this.vertices.push(lt(0,0)),this.normals.push(lt(0,0))}}(),Fn=function(){function t(){this.v1=lt(0,0),this.v2=lt(0,0),this.normal=lt(0,0),this.sideNormal1=lt(0,0),this.sideNormal2=lt(0,0)}return t.prototype.recycle=function(){_t(this.v1),_t(this.v2),_t(this.normal),_t(this.sideNormal1),_t(this.sideNormal2)},t}(),kn=[new Oi,new Oi],qn=[new Oi,new Oi],Nn=[new Oi,new Oi],jn=new Tn,Rn=new Tn,En=new Ln,On=new Fn,Dn=lt(0,0),Hn=lt(0,0),Yn=lt(0,0),Wn=lt(0,0),Un=Ft(0,0,0),Xn=lt(0,0),Jn=lt(0,0),$n=lt(0,0),Gn=lt(0,0),Kn=lt(0,0),Zn=lt(0,0),Qn=lt(0,0),tr=lt(0,0),er=function(t,e,i,s,o){Rt(Un,i,o),qt(Dn,Un,s.m_centroid);var n=e.m_vertex0,r=e.m_vertex1,a=e.m_vertex2,h=e.m_vertex3,c=e.m_hasVertex0,l=e.m_hasVertex3;ft(Yn,a,r),Bt(Yn),mt($n,Yn.y,-Yn.x);var m,u=Pt($n,Dn)-Pt($n,r),_=0,d=0,p=!1,y=!1;_t(Jn),_t(Gn),c&&(ft(Hn,r,n),Bt(Hn),mt(Jn,Hn.y,-Hn.x),p=Mt(Hn,Yn)>=0,_=Y.dot(Jn,Dn)-Y.dot(Jn,n)),l&&(ft(Wn,h,a),Bt(Wn),mt(Gn,Wn.y,-Wn.x),y=Y.crossVec2Vec2(Yn,Wn)>0,d=Y.dot(Gn,Dn)-Y.dot(Gn,a)),_t(Xn),_t(Kn),_t(Zn),c&&l?p&&y?(m=_>=0||u>=0||d>=0)?(ut(Xn,$n),ut(Kn,Jn),ut(Zn,Gn)):(vt(Xn,-1,$n),vt(Kn,-1,$n),vt(Zn,-1,$n)):p?(m=_>=0||u>=0&&d>=0)?(ut(Xn,$n),ut(Kn,Jn),ut(Zn,$n)):(vt(Xn,-1,$n),vt(Kn,-1,Gn),vt(Zn,-1,$n)):y?(m=d>=0||_>=0&&u>=0)?(ut(Xn,$n),ut(Kn,$n),ut(Zn,Gn)):(vt(Xn,-1,$n),vt(Kn,-1,$n),vt(Zn,-1,Jn)):(m=_>=0&&u>=0&&d>=0)?(ut(Xn,$n),ut(Kn,$n),ut(Zn,$n)):(vt(Xn,-1,$n),vt(Kn,-1,Gn),vt(Zn,-1,Jn)):c?p?(m=_>=0||u>=0)?(ut(Xn,$n),ut(Kn,Jn),vt(Zn,-1,$n)):(vt(Xn,-1,$n),ut(Kn,$n),vt(Zn,-1,$n)):(m=_>=0&&u>=0)?(ut(Xn,$n),ut(Kn,$n),vt(Zn,-1,$n)):(vt(Xn,-1,$n),ut(Kn,$n),vt(Zn,-1,Jn)):l?y?(m=u>=0||d>=0)?(ut(Xn,$n),vt(Kn,-1,$n),ut(Zn,Gn)):(vt(Xn,-1,$n),vt(Kn,-1,$n),ut(Zn,$n)):(m=u>=0&&d>=0)?(ut(Xn,$n),vt(Kn,-1,$n),ut(Zn,$n)):(vt(Xn,-1,$n),vt(Kn,-1,Gn),ut(Zn,$n)):(m=u>=0)?(ut(Xn,$n),vt(Kn,-1,$n),vt(Zn,-1,$n)):(vt(Xn,-1,$n),ut(Kn,$n),ut(Zn,$n)),En.count=s.m_count;for(var f=0;f<s.m_count;++f)qt(En.vertices[f],Un,s.m_vertices[f]),Tt(En.normals[f],Un.q,s.m_normals[f]);var g=s.m_radius+e.m_radius;for(t.pointCount=0,jn.type=Mn.e_edgeA,jn.index=m?0:1,jn.separation=1/0,f=0;f<En.count;++f){var v=En.vertices[f];(x=Pt(Xn,v)-Pt(Xn,r))<jn.separation&&(jn.separation=x)}if(jn.type!=Mn.e_unknown&&!(jn.separation>g)){for(Rn.type=Mn.e_unknown,Rn.index=-1,Rn.separation=-1/0,mt(Qn,-Xn.y,Xn.x),f=0;f<En.count;++f){vt(tr,-1,En.normals[f]);var x,b=Pt(tr,En.vertices[f])-Pt(tr,r),A=Pt(tr,En.vertices[f])-Pt(tr,a);if((x=Sn(b,A))>g){Rn.type=Mn.e_edgeB,Rn.index=f,Rn.separation=x;break}if(Pt(tr,Qn)>=0){if(Pt(tr,Xn)-Pt(Zn,Xn)<-G.angularSlop)continue}else if(Pt(tr,Xn)-Pt(Kn,Xn)<-G.angularSlop)continue;x>Rn.separation&&(Rn.type=Mn.e_edgeB,Rn.index=f,Rn.separation=x)}if(!(Rn.type!=Mn.e_unknown&&Rn.separation>g)){var w;if(w=Rn.type==Mn.e_unknown?jn:Rn.separation>.98*jn.separation+.001?Rn:jn,Nn[0].recycle(),Nn[1].recycle(),w.type==Mn.e_edgeA){t.type=Ci.e_faceA;var B=0,C=Pt(Xn,En.normals[0]);for(f=1;f<En.count;++f){var S=Pt(Xn,En.normals[f]);S<C&&(C=S,B=f)}var M=B,P=M+1<En.count?M+1:0;ut(Nn[0].v,En.vertices[M]),Nn[0].id.setFeatures(0,Mi.e_face,M,Mi.e_vertex),ut(Nn[1].v,En.vertices[P]),Nn[1].id.setFeatures(0,Mi.e_face,P,Mi.e_vertex),m?(On.i1=0,On.i2=1,ut(On.v1,r),ut(On.v2,a),ut(On.normal,$n)):(On.i1=1,On.i2=0,ut(On.v1,a),ut(On.v2,r),vt(On.normal,-1,$n))}else t.type=Ci.e_faceB,ut(Nn[0].v,r),Nn[0].id.setFeatures(0,Mi.e_vertex,w.index,Mi.e_face),ut(Nn[1].v,a),Nn[1].id.setFeatures(0,Mi.e_vertex,w.index,Mi.e_face),On.i1=w.index,On.i2=On.i1+1<En.count?On.i1+1:0,ut(On.v1,En.vertices[On.i1]),ut(On.v2,En.vertices[On.i2]),ut(On.normal,En.normals[On.i1]);if(!(mt(On.sideNormal1,On.normal.y,-On.normal.x),mt(On.sideNormal2,-On.sideNormal1.x,-On.sideNormal1.y),On.sideOffset1=Pt(On.sideNormal1,On.v1),On.sideOffset2=Pt(On.sideNormal2,On.v2),kn[0].recycle(),kn[1].recycle(),qn[0].recycle(),qn[1].recycle(),Xi(kn,Nn,On.sideNormal1,On.sideOffset1,On.i1)<G.maxManifoldPoints||Xi(qn,kn,On.sideNormal2,On.sideOffset2,On.i2)<G.maxManifoldPoints)){w.type==Mn.e_edgeA?(ut(t.localNormal,On.normal),ut(t.localPoint,On.v1)):(ut(t.localNormal,s.m_normals[On.i1]),ut(t.localPoint,s.m_vertices[On.i1]));var V=0;for(f=0;f<G.maxManifoldPoints;++f)if(Pt(On.normal,qn[f].v)-Pt(On.normal,On.v1)<=g){var I=t.points[V];w.type==Mn.e_edgeA?(Nt(I.localPoint,Un,qn[f].v),I.id.set(qn[f].id)):(ut(I.localPoint,qn[f].v),I.id.set(qn[f].id),I.id.swapFeatures()),++V}t.pointCount=V}}}};!function(){function t(t,e){this._refMap={},this._map={},this._xmap={},this._data=[],this._entered=[],this._exited=[],this._key=t,this._listener=e}t.prototype.update=function(t){if(!Array.isArray(t))throw"Invalid data: "+t;this._entered.length=0,this._exited.length=0,this._data.length=t.length;for(var e=0;e<t.length;e++)if("object"==typeof t[e]&&null!==t[e]){var i=t[e],s=this._key(i);this._map[s]?delete this._map[s]:this._entered.push(i),this._data[e]=i,this._xmap[s]=i}for(var s in this._map)this._exited.push(this._map[s]),delete this._map[s];var o=this._map;for(this._map=this._xmap,this._xmap=o,e=0;e<this._exited.length;e++){i=this._exited[e];var n=this._key(i),r=this._refMap[n];this._listener.exit(i,r),delete this._refMap[n]}for(e=0;e<this._entered.length;e++)i=this._entered[e],n=this._key(i),(r=this._listener.enter(i))&&(this._refMap[n]=r);for(e=0;e<this._data.length;e++)"object"==typeof t[e]&&null!==t[e]&&(i=this._data[e],n=this._key(i),r=this._refMap[n],this._listener.update(i,r));this._entered.length=0,this._exited.length=0,this._data.length=0},t.prototype.ref=function(t){return this._refMap[this._key(t)]}}();Symbol.toStringTag;class ir{constructor(){this.tagToBit=new Map,this.bitToTag=new Map,this.nextBit=1,this.register("default")}register(t){if(!this.tagToBit.has(t)){if(this.nextBit>32768)throw new Error("Maximum collision tags reached (16 tags)");this.tagToBit.set(t,this.nextBit),this.bitToTag.set(this.nextBit,t),this.nextBit<<=1}}getBit(t){return this.tagToBit.has(t)||this.register(t),this.tagToBit.get(t)}getTag(t){return this.bitToTag.get(t)}tagsToBits(t){return t&&0!==t.length?t.reduce((t,e)=>t|this.getBit(e),0):this.getBit("default")}bitsToTags(t){const e=[];for(const[i,s]of this.bitToTag)t&i&&e.push(s);return e}}function sr(t){return null!==t&&"object"==typeof t&&"options"in t&&"object"==typeof t.options}class or{constructor(t,e){this.callbacks=new Map,this.world=t,this.registry=e,this.setupListeners()}setupListeners(){this.world.world.on("begin-contact",t=>{this.handleBeginContact(t)}),this.world.world.on("end-contact",t=>{this.handleEndContact(t)})}onCollision(t,e,i){const s=this.makeKey(t,e);this.callbacks.has(s)||this.callbacks.set(s,new Set),this.callbacks.get(s).add(i)}offCollision(t,e,i){const s=this.makeKey(t,e);this.callbacks.get(s)?.delete(i)}makeKey(t,e){return t<e?`${t}:${e}`:`${e}:${t}`}handleBeginContact(t){const e=t.getFixtureA().getBody().getUserData(),i=t.getFixtureB().getBody().getUserData();sr(e)&&sr(i)&&(e.onCollisionBegin?.(i,t),i.onCollisionBegin?.(e,t),this.triggerTagCallbacks(e,i,t))}handleEndContact(t){const e=t.getFixtureA().getBody().getUserData(),i=t.getFixtureB().getBody().getUserData();sr(e)&&sr(i)&&(e.onCollisionEnd?.(i,t),i.onCollisionEnd?.(e,t))}triggerTagCallbacks(t,i,s){const o=t.options.collisionTags||[],n=i.options.collisionTags||[];for(const r of o)for(const o of n){const n=this.makeKey(r,o),a=this.callbacks.get(n);if(a){const o={bodyA:t,bodyB:i,contact:s,normal:new e.Point(0,0),impulse:0};a.forEach(t=>t(o))}}}}class nr extends S{constructor(t,e={}){super(),this.name="PhysicsDebugRenderer",this.isVisible=!0,this.world=t,this.options={showShapes:e.showShapes??!0,showVelocities:e.showVelocities??!1,showAABBs:e.showAABBs??!1,showCenterOfMass:e.showCenterOfMass??!1,showContactPoints:e.showContactPoints??!1,showJoints:e.showJoints??!1,colorStatic:e.colorStatic??65280,colorDynamic:e.colorDynamic??16711680,colorKinematic:e.colorKinematic??255,colorSleeping:e.colorSleeping??11184810,colorSensor:e.colorSensor??16776960,alpha:e.alpha??.5,lineWidth:e.lineWidth??2}}init(t,e){this.graphics=t}update(t,e){if(this.isVisible){if(this.graphics.clear(),this.options.showShapes)for(let t=this.world.world.getBodyList();t;t=t.getNext())this.drawBody(t);this.options.showContactPoints&&this.drawContacts()}else this.graphics.clear()}drawBody(t){const e=t.getTransform();let i;i=!t.isAwake()&&t.isDynamic()?this.options.colorSleeping:t.isStatic()?this.options.colorStatic:t.isKinematic()?this.options.colorKinematic:this.options.colorDynamic;for(let s=t.getFixtureList();s;s=s.getNext()){const t=s.getShape(),o=s.isSensor()?this.options.colorSensor:i,n=s.isSensor()?.5*this.options.alpha:this.options.alpha;this.drawShape(t,e,o,n)}this.options.showVelocities&&t.isDynamic()&&this.drawVelocity(t),this.options.showAABBs&&this.drawAABB(t),this.options.showCenterOfMass&&this.drawCenterOfMass(t)}drawShape(t,e,i,s){this.graphics.stroke({width:this.options.lineWidth,color:i,alpha:s});const o=t.getType();if("circle"===o){const i=t,s=Y.add(e.p,Ht.mulVec2(e.q,i.getCenter())),o=i.getRadius(),n=this.world.toPixelsPoint(s),r=this.world.toPixels(o);this.graphics.circle(n.x,n.y,r),this.graphics.stroke();const a=e.q.getAngle(),h=n.x+Math.cos(a)*r,c=n.y+Math.sin(a)*r;this.graphics.moveTo(n.x,n.y),this.graphics.lineTo(h,c),this.graphics.stroke()}else if("polygon"===o){const i=t.m_vertices;if(i&&i.length>0){const t=Y.add(e.p,Ht.mulVec2(e.q,i[0])),s=this.world.toPixelsPoint(t);this.graphics.moveTo(s.x,s.y);for(let t=1;t<i.length;t++){const s=Y.add(e.p,Ht.mulVec2(e.q,i[t])),o=this.world.toPixelsPoint(s);this.graphics.lineTo(o.x,o.y)}this.graphics.lineTo(s.x,s.y),this.graphics.stroke()}}else if("edge"===o){const i=t,s=Y.add(e.p,Ht.mulVec2(e.q,i.m_vertex1)),o=Y.add(e.p,Ht.mulVec2(e.q,i.m_vertex2)),n=this.world.toPixelsPoint(s),r=this.world.toPixelsPoint(o);this.graphics.moveTo(n.x,n.y),this.graphics.lineTo(r.x,r.y),this.graphics.stroke()}else if("chain"===o){const i=t.m_vertices;if(i&&i.length>0){const t=Y.add(e.p,Ht.mulVec2(e.q,i[0])),s=this.world.toPixelsPoint(t);this.graphics.moveTo(s.x,s.y);for(let t=1;t<i.length;t++){const s=Y.add(e.p,Ht.mulVec2(e.q,i[t])),o=this.world.toPixelsPoint(s);this.graphics.lineTo(o.x,o.y)}this.graphics.stroke()}}}drawVelocity(t){const e=t.getPosition(),i=t.getLinearVelocity(),s=Y.add(e,Y.mul(i,.5)),o=this.world.toPixelsPoint(e),n=this.world.toPixelsPoint(s);this.graphics.stroke({width:2,color:65535,alpha:.8}),this.graphics.moveTo(o.x,o.y),this.graphics.lineTo(n.x,n.y),this.graphics.stroke();const r=Math.atan2(n.y-o.y,n.x-o.x),a=r+.8*Math.PI,h=r-.8*Math.PI;this.graphics.moveTo(n.x,n.y),this.graphics.lineTo(n.x+5*Math.cos(a),n.y+5*Math.sin(a)),this.graphics.moveTo(n.x,n.y),this.graphics.lineTo(n.x+5*Math.cos(h),n.y+5*Math.sin(h)),this.graphics.stroke()}drawAABB(t){for(let e=t.getFixtureList();e;e=e.getNext()){const t=e.getAABB(0),i=this.world.toPixelsPoint(t.lowerBound),s=this.world.toPixelsPoint(t.upperBound);this.graphics.stroke({width:1,color:16711935,alpha:.3}),this.graphics.rect(i.x,i.y,s.x-i.x,s.y-i.y),this.graphics.stroke()}}drawCenterOfMass(t){const e=t.getWorldCenter(),i=this.world.toPixelsPoint(e);this.graphics.stroke({width:1,color:16777215,alpha:1}),this.graphics.moveTo(i.x-5,i.y),this.graphics.lineTo(i.x+5,i.y),this.graphics.moveTo(i.x,i.y-5),this.graphics.lineTo(i.x,i.y+5),this.graphics.stroke()}drawContacts(){for(let t=this.world.world.getContactList();t;t=t.getNext()){if(!t.isTouching())continue;const e=t.getManifold();if(!e)continue;const i=t.getWorldManifold(null);if(i)for(let t=0;t<e.pointCount;t++){const e=i.points[t];if(!e)continue;const s=this.world.toPixelsPoint(Y(e.x,e.y));this.graphics.circle(s.x,s.y,3),this.graphics.fill({color:16711680,alpha:.8})}}}setVisible(t){this.isVisible=t,t||this.graphics.clear()}toggle(){this.setVisible(!this.isVisible)}getVisible(){return this.isVisible}}function rr(t,e){t.__physicsShape__=e}class ar{constructor(t={}){this.pixelsPerMeter=30,this.timestep=1/60,this.velocityIterations=8,this.positionIterations=3,this.accumulator=0,this.bodies=new Map,function(){const t=e.Graphics.prototype.rect,i=e.Graphics.prototype.circle,s=e.Graphics.prototype.poly;e.Graphics.prototype.rect=function(e,i,s,o){return rr(this,{type:"rectangle",width:s,height:o}),t.call(this,e,i,s,o)},e.Graphics.prototype.circle=function(t,e,s){return rr(this,{type:"circle",radius:s}),i.call(this,t,e,s)},e.Graphics.prototype.poly=function(t){return rr(this,{type:"polygon",vertices:Array.isArray(t[0])?t.flat():t}),s.call(this,t)}}();const{gravity:i={x:0,y:9.8},pixelsPerMeter:s=30,velocityIterations:o=8,positionIterations:n=3,enableSleeping:r=!0,timestep:a=1/60}=t;this.pixelsPerMeter=s,this.velocityIterations=o,this.positionIterations=n,this.timestep=a,this.world=ks({gravity:Y(i.x,i.y)}),this.world.setAllowSleeping(r),this.collisionRegistry=new ir,this.collisionManager=new or(this,this.collisionRegistry)}step(t){for(this.accumulator+=t;this.accumulator>=this.timestep;)this.world.step(this.timestep,this.velocityIterations,this.positionIterations),this.accumulator-=this.timestep}createBody(t){return this.world.createBody(t)}destroyBody(t){this.bodies.delete(t),this.world.destroyBody(t)}registerBody(t,e){this.bodies.set(t,e)}getBodyLogic(t){return this.bodies.get(t)}raycast(t,i,s){const o=this.toPhysicsPoint(t),n=this.toPhysicsPoint(i);this.world.rayCast(o,n,(t,i,o,n)=>{const r=this.toPixelsPoint(i),a=new e.Point(o.x,o.y);return s(t,r,a,n)})}queryAABB(t,i){const s=this.toPhysicsPoint(new e.Point(t.x,t.y)),o=this.toPhysicsPoint(new e.Point(t.x+t.width,t.y+t.height));this.world.queryAABB(X(s,o),t=>i(t.getBody()))}queryPoint(t,e){const i=this.toPhysicsPoint(t);this.world.queryAABB(X(Y(i.x-.001,i.y-.001),Y(i.x+.001,i.y+.001)),t=>!t.testPoint(i)||e(t))}toPhysics(t){return t/this.pixelsPerMeter}toPixels(t){return t*this.pixelsPerMeter}toPhysicsPoint(t){return Y(this.toPhysics(t.x),this.toPhysics(t.y))}toPixelsPoint(t){return new e.Point(this.toPixels(t.x),this.toPixels(t.y))}enableDebugRenderer(t,i={}){this.debugRenderer&&this.disableDebugRenderer(),this.debugGraphics=new e.Graphics,this.debugRenderer=new nr(this,i);const s=function(t,e={}){const i=t;return i.isInteractive=()=>!1,i.moxiEntity=new M(i,e),t}(this.debugGraphics);return s.moxiEntity.addLogic(this.debugRenderer),s.zIndex=1e4,t.sortableChildren=!0,t.addChild(s),console.log('Physics debug renderer enabled. Press "P" to toggle visibility.'),this.debugRenderer}disableDebugRenderer(){this.debugRenderer&&this.debugGraphics&&(this.debugGraphics.parent&&this.debugGraphics.parent.removeChild(this.debugGraphics),this.debugGraphics.destroy(),this.debugGraphics=void 0,this.debugRenderer=void 0)}getDebugRenderer(){return this.debugRenderer}getBodies(){const t=[];for(let e=this.world.getBodyList();e;e=e.getNext())t.push(e);return t}destroy(){this.getBodies().forEach(t=>this.world.destroyBody(t)),this.bodies.clear(),this.debugRenderer=void 0}}const hr=[15784625,14916268,12869023,6507389,6578626,2861492,9688245,15791848];class cr{constructor(t={}){this.particles=[],this.container=null,this.nextSpawn=0,this.time=0,this.squareSize=t.squareSize??20,this.maxParticles=t.maxParticles??30,this.palette=t.palette??hr,this.spawnInterval=t.spawnInterval??.5}init(t){this.container=t}update(t){if(!this.container)return;this.time=t.time;const{width:e,height:i,textElement:s}=t;this.spawnParticle(e,i,s),this.particles=this.particles.filter(t=>{const e=(this.time-t.spawnTime)/t.duration;return e<0||e>1?(t.sprite.destroy(),!1):(t.sprite.x=t.startX,t.sprite.y=t.startY+(t.endY-t.startY)*e,t.sprite.rotation=this.time*t.spinRate*Math.PI*2,t.sprite.alpha=e<.1?e/.1:e>.85?(1-e)/.15:1,!0)})}spawnParticle(t,i,s){if(!this.container)return;if(this.particles.length>=this.maxParticles||this.time<this.nextSpawn)return;const o=this.squareSize*(.7+.6*Math.random()),n=new e.Graphics;n.rect(0,0,o,o),n.fill({color:this.palette[Math.floor(Math.random()*this.palette.length)]}),n.pivot.set(o/2,o/2),this.container.addChild(n);const r=s.y,a=s.width||200,h=t/2;this.particles.push({sprite:n,spawnTime:this.time,duration:1+2.5*Math.random(),spinRate:(.05+1.075*Math.random())*(Math.random()<.5?1:-1),startX:h-a/2+Math.random()*a-4,startY:r-100,endY:r-40}),this.nextSpawn=this.time+Math.random()*this.spawnInterval}reset(){this.time=0,this.nextSpawn=0,this.particles.forEach(t=>t.sprite.destroy()),this.particles=[]}destroy(){this.particles.forEach(t=>t.sprite.destroy()),this.particles=[],this.container=null}}class lr extends e.Container{constructor(t={}){super(),this.renderer=null,this.time=0;const{backgroundColor:i=1710618,text:o="LOADING...",textStyle:n={},animation:r,fallingSquaresOptions:a}=t;this.backgroundColor=i,this.animation=r??new cr(a),this.background=new e.Graphics,this.addChild(this.background),this.animationContainer=new e.Container,this.addChild(this.animationContainer),this.text=new e.Text({text:o,style:{fontFamily:"Courier New, monospace",fontSize:16,fill:16777215,fontWeight:"bold",...n}}),this.text.anchor.set(.5),this.addChild(this.text),this.animation.init(this.animationContainer),this.ticker=new(s().Ticker),this.ticker.autoStart=!1,this.ticker.add(()=>{if(this.visible&&this.renderer){const t=this.ticker.deltaTime/60;this.time+=t,this.update(this.renderer.width,this.renderer.height,t),this.renderer.render(this)}})}update(t,e,i){this.background.clear(),this.background.rect(0,0,t,e),this.background.fill({color:this.backgroundColor}),this.text.x=t/2-4,this.text.y=e/2+60,this.animation.update({time:this.time,deltaTime:i,width:t,height:e,textElement:this.text})}init(t){this.renderer=t}show(){this.visible=!0,this.time=0,this.animation.reset(),this.ticker.started||this.ticker.start()}hide(){this.visible=!1,this.ticker.started&&this.ticker.stop()}destroy(){this.ticker.started&&this.ticker.stop(),this.ticker.destroy(),this.animation.destroy(),super.destroy()}}const mr={width:1280,height:720,backgroundColor:1087931,resolution:window.devicePixelRatio||1,autoDensity:!0,antialias:!0};i(767);class ur{constructor(){this.focusableComponents=[],this.currentFocusIndex=-1,this.keydownHandler=null,this.setupKeyboardListeners(),ur.instance=this}static getInstance(){return ur.instance}setupKeyboardListeners(){"undefined"!=typeof window&&(this.keydownHandler&&window.removeEventListener("keydown",this.keydownHandler),this.keydownHandler=t=>{"Tab"===t.key&&(t.preventDefault(),t.shiftKey?this.focusPrevious():this.focusNext())},window.addEventListener("keydown",this.keydownHandler))}register(t){this.focusableComponents.includes(t)||(this.focusableComponents.push(t),this.sortByTabIndex())}registerContainer(t){this.discoverFocusableComponents(t),this.sortByTabIndex()}discoverFocusableComponents(t){this.isFocusableComponent(t)&&this.register(t),"children"in t&&Array.isArray(t.children)&&t.children.forEach(t=>this.discoverFocusableComponents(t))}isFocusableComponent(t){return"number"==typeof t.tabIndex&&t.tabIndex>=0&&"function"==typeof t.canFocus&&"function"==typeof t.onFocus&&"function"==typeof t.onBlur&&"function"==typeof t.isFocused}unregister(t){const e=this.focusableComponents.indexOf(t);-1!==e&&(e===this.currentFocusIndex&&this.blur(),this.focusableComponents.splice(e,1),this.currentFocusIndex>e&&this.currentFocusIndex--)}sortByTabIndex(){this.focusableComponents.sort((t,e)=>t.tabIndex-e.tabIndex)}focus(t){if(!t.canFocus())return;const e=this.focusableComponents.indexOf(t);if(-1!==e){if(-1!==this.currentFocusIndex&&this.currentFocusIndex!==e){const t=this.focusableComponents[this.currentFocusIndex];t&&t.onBlur()}this.currentFocusIndex=e,t.onFocus()}}requestFocus(t){this.focus(t)}blur(){if(-1!==this.currentFocusIndex){const t=this.focusableComponents[this.currentFocusIndex];t&&t.onBlur(),this.currentFocusIndex=-1}}focusNext(){if(0===this.focusableComponents.length)return;let t=this.currentFocusIndex+1,e=0;for(;e<this.focusableComponents.length;){t>=this.focusableComponents.length&&(t=0);const i=this.focusableComponents[t];if(i&&i.canFocus())return void this.focus(i);t++,e++}}focusPrevious(){if(0===this.focusableComponents.length)return;let t=this.currentFocusIndex-1,e=0;for(;e<this.focusableComponents.length;){t<0&&(t=this.focusableComponents.length-1);const i=this.focusableComponents[t];if(i&&i.canFocus())return void this.focus(i);t--,e++}}focusFirst(){if(0!==this.focusableComponents.length)for(const t of this.focusableComponents)if(t.canFocus())return void this.focus(t)}focusLast(){if(0!==this.focusableComponents.length)for(let t=this.focusableComponents.length-1;t>=0;t--){const e=this.focusableComponents[t];if(e.canFocus())return void this.focus(e)}}getCurrentFocus(){return-1===this.currentFocusIndex?null:this.focusableComponents[this.currentFocusIndex]||null}getFocusableComponents(){return[...this.focusableComponents]}clear(){this.blur(),this.focusableComponents=[],this.currentFocusIndex=-1}destroy(){"undefined"!=typeof window&&this.keydownHandler&&window.removeEventListener("keydown",this.keydownHandler),this.clear()}}var _r,dr,pr,yr,fr;ur.instance=null,function(t){t.Row="row",t.RowReverse="row-reverse",t.Column="column",t.ColumnReverse="column-reverse"}(_r||(_r={})),function(t){t.Start="start",t.End="end",t.Center="center",t.SpaceBetween="space-between",t.SpaceAround="space-around",t.SpaceEvenly="space-evenly"}(dr||(dr={})),function(t){t.Start="start",t.End="end",t.Center="center",t.Stretch="stretch"}(pr||(pr={})),function(t){t.Normal="normal",t.Hover="hover",t.Pressed="pressed",t.Disabled="disabled"}(yr||(yr={})),function(t){t.None="none",t.ScaleUI="scaleUI",t.LockRatio="lockRatio"}(fr||(fr={})),e.Container,EventTarget;class gr{constructor(t={}){this.unit=t.unit??1,this.scale=t.scale??4,this.border=t.border??1,this.padding=t.padding??1,this.gap=t.gap??1,this.margin=t.margin??5,this.fontScale=t.fontScale??this.scale/16}px(t){return t*this.unit*this.scale}units(t){return Math.round(t/(this.unit*this.scale))}}const vr=(()=>{const t="undefined"!=typeof localStorage?localStorage.getItem("temp-grid-scale"):null;if(t){const e=parseInt(t,10);if(!isNaN(e)&&e>=1&&e<=4)return new gr({scale:e})}return new gr})(),xr=t=>vr.px(t),br={unit:vr.unit,scale:vr.scale,border:vr.border,padding:vr.padding,gap:vr.gap,margin:vr.margin,fontScale:vr.fontScale},Ar=1,wr=1,Br=3;e.Container,e.Container;const Cr=JSON.parse('{"paletteName":"CC-29","classic":[{"name":"Dark","description":"Classic dark theme","backgroundRoot":"0x212123","backgroundSurface":"0x212123","backgroundRaised":"0x646365","backgroundOverlay":"0x45444f","borderStrong":"0x000000","borderSubtle":"0x868188","accentPrimary":"0x4b80ca","accentSecondary":"0x68c2d3","textPrimary":"0xf2f0e5","textSecondary":"0xb8b5b9"},{"name":"Light","description":"Clean light theme","backgroundRoot":"0x868188","backgroundSurface":"0xf2f0e5","backgroundRaised":"0xf2f0e5","backgroundOverlay":"0xdad8ce","borderStrong":"0x646365","borderSubtle":"0xb8b5b9","accentPrimary":"0x4b80ca","accentSecondary":"0x43436a","textPrimary":"0x212123","textSecondary":"0x646365"}],"seasonal":[{"name":"Spring","description":"Fresh greens and soft pastels","backgroundRoot":"0xb2b47e","backgroundSurface":"0xa2dcc7","backgroundRaised":"0xc2d368","backgroundOverlay":"0x8ab060","borderStrong":"0x4e584a","borderSubtle":"0xc2d368","accentPrimary":"0xedc8c4","accentSecondary":"0xcf8acb","textPrimary":"0x212123","textSecondary":"0x4e584a"},{"name":"Summer","description":"Bright blues and warm sunshine","backgroundRoot":"0xa2dcc7","backgroundSurface":"0x68c2d3","backgroundRaised":"0xede19e","backgroundOverlay":"0x4b80ca","borderStrong":"0x80493a","borderSubtle":"0xede19e","accentPrimary":"0xd3a068","accentSecondary":"0x80493a","textPrimary":"0x212123","textSecondary":"0x3a3858"},{"name":"Autumn","description":"Warm oranges, browns, and deep reds","backgroundRoot":"0x7b7243","backgroundSurface":"0xa77b5b","backgroundRaised":"0xd3a068","backgroundOverlay":"0x80493a","borderStrong":"0x80493a","borderSubtle":"0xd3a068","accentPrimary":"0xb45252","accentSecondary":"0x80493a","textPrimary":"0xf2f0e5","textSecondary":"0xe5ceb4"},{"name":"Winter","description":"Cool blues, purples, and icy whites","backgroundRoot":"0x212123","backgroundSurface":"0x43436a","backgroundRaised":"0x68c2d3","backgroundOverlay":"0x4b4158","borderStrong":"0x3a3858","borderSubtle":"0xcf8acb","accentPrimary":"0xcf8acb","accentSecondary":"0xedc8c4","textPrimary":"0xf2f0e5","textSecondary":"0xb8b5b9"}]}');function Sr(t){const e=t=>parseInt(t,16);return{backgroundRoot:e(t.backgroundRoot),backgroundSurface:e(t.backgroundSurface),backgroundRaised:e(t.backgroundRaised),backgroundOverlay:e(t.backgroundOverlay),borderStrong:e(t.borderStrong),borderSubtle:e(t.borderSubtle),accentPrimary:e(t.accentPrimary),accentSecondary:e(t.accentSecondary),textPrimary:e(t.textPrimary),textSecondary:e(t.textSecondary)}}const Mr=Cr,Pr=Sr(Mr.classic[0]);Sr(Mr.classic[1]),Sr(Mr.seasonal[0]),Sr(Mr.seasonal[1]),Sr(Mr.seasonal[2]),Sr(Mr.seasonal[3]);const Vr=[function(t){const e=t.paletteName,i=t.classic.map(t=>({name:t.name,theme:Sr(t),category:"classic",palette:e})),s=t.seasonal.map(t=>({name:t.name,theme:Sr(t),category:"seasonal",palette:e}));return{paletteName:e,classic:i,seasonal:s}}(Cr)];let Ir=Pr,zr={name:"Dark",theme:Pr,category:"classic",palette:"CC-29"};function Tr(){return Ir}const Lr={get cardBg(){return Tr().backgroundSurface},get cardBorder(){return Tr().borderStrong},get middleBorder(){return Tr().borderSubtle},get text(){return Tr().textPrimary},get titleBar(){return Tr().backgroundOverlay},get selected(){return Tr().accentPrimary},get buttonBg(){return Tr().backgroundRaised}};class Fr{constructor(t){this.isDragging=!1,this.dragStartX=0,this.dragStartY=0,this.cardStartX=0,this.cardStartY=0,this.isResizing=!1,this.resizeStartX=0,this.resizeStartY=0,this.resizeStartWidth=0,this.resizeStartHeight=0,this.resizeDirection=null,this.capturedPointerId=null,this.scaleIndicator=null,this.pairedCard=null,this.onFocus=null,this.onStateChange=null,this.contentMask=null,this.options=t,this.pairedCard=t.pairedCard??null,this.onFocus=t.onFocus??null,this.container=new e.Container,this.container.position.set(t.x??0,t.y??0),this.contentContainer=new e.Container,this.state={contentWidth:t.contentWidth,contentHeight:t.contentHeight};const i=64*br.fontScale,s=xr(2*br.padding);this.titleBarHeightPx=Math.ceil(i+s),this.setupEventListeners(),this.redraw()}setupEventListeners(){const t=this.options.renderer,e=e=>{if(this.isDragging){const i=t.canvas,s=i.getBoundingClientRect(),o=i.width/s.width,n=i.height/s.height,r=(e.clientX-this.dragStartX)*o,a=(e.clientY-this.dragStartY)*n;this.container.x=this.cardStartX+r,this.container.y=this.cardStartY+a}else if(this.isResizing&&this.resizeDirection){const i=t.canvas,s=i.getBoundingClientRect(),o=i.width/s.width,n=i.height/s.height,r=(e.clientX-this.resizeStartX)*o,a=(e.clientY-this.resizeStartY)*n,h=Math.round(r/xr(1)),c=Math.round(a/xr(1)),l=this.state.minContentWidth??10,m=this.state.minContentHeight??10;if(this.resizeDirection.includes("e"))this.state.contentWidth=Math.max(l,this.resizeStartWidth+h);else if(this.resizeDirection.includes("w")){const t=Math.max(l,this.resizeStartWidth-h),e=t-this.resizeStartWidth,i=Math.max(0,this.cardStartX-xr(e));this.container.x=i,this.state.contentWidth=t}if(this.resizeDirection.includes("s"))this.state.contentHeight=Math.max(m,this.resizeStartHeight+c);else if(this.resizeDirection.includes("n")){const t=Math.max(m,this.resizeStartHeight-c),e=t-this.resizeStartHeight,i=Math.max(0,this.cardStartY-xr(e));this.container.y=i,this.state.contentHeight=t}this.redraw(),this.showScaleIndicator(e.clientX,e.clientY),this.options.onResize&&this.options.onResize(this.state.contentWidth,this.state.contentHeight)}},i=()=>{const e=this.isDragging,i=this.isResizing;if(this.isDragging=!1,this.isResizing=!1,this.resizeDirection=null,null!==this.capturedPointerId){const e=t.canvas;if(e)try{e.releasePointerCapture(this.capturedPointerId)}catch(t){}this.capturedPointerId=null}this.hideScaleIndicator(),(e||i)&&this.onStateChange&&this.onStateChange()};"undefined"!=typeof window&&(window.addEventListener("pointermove",e),window.addEventListener("pointerup",i),this.container.on("destroyed",()=>{window.removeEventListener("pointermove",e),window.removeEventListener("pointerup",i)}))}redraw(){this.container.removeChildren();const t=2*Br+2*br.padding+this.state.contentWidth,i=xr(2*Br)+this.titleBarHeightPx+xr(2*br.padding)+xr(this.state.contentHeight),s=new e.Graphics;s.roundPixels=!0;const o=xr(1);s.rect(o,o,xr(t),i),s.fill({color:0,alpha:.3}),s.rect(0,0,xr(t),i),s.fill({color:0}),s.rect(xr(Ar),xr(Ar),xr(t-2*Ar),i-xr(2*Ar)),s.fill({color:Lr.middleBorder}),s.rect(xr(Ar+wr),xr(Ar+wr),xr(t-2*(Ar+wr)),i-xr(2*(Ar+wr))),s.fill({color:0}),s.rect(xr(Br),xr(Br),xr(t-2*Br),i-xr(2*Br)),s.fill({color:this.options.backgroundColor??Lr.cardBg}),this.container.addChild(s);const n=new e.Graphics;n.roundPixels=!0,n.eventMode="static",n.cursor="move",n.rect(xr(Br),xr(Br),xr(t-2*Br),this.titleBarHeightPx),n.fill({color:Lr.titleBar}),n.on("pointerdown",t=>{this.onFocus&&this.onFocus(),this.isDragging=!0,this.cardStartX=this.container.x,this.cardStartY=this.container.y;const e=this.options.renderer.canvas;e.getBoundingClientRect(),this.dragStartX=t.client.x,this.dragStartY=t.client.y,e&&void 0!==t.pointerId&&(e.setPointerCapture(t.pointerId),this.capturedPointerId=t.pointerId),t.stopPropagation()}),this.container.addChild(n);const r=Tr(),a=new e.BitmapText({text:this.options.title,style:{fontFamily:"PixelOperator8Bitmap",fontSize:64,fill:r.textPrimary}});a.roundPixels=!0,a.scale.set(br.fontScale);const h=a.height,c=xr(Br)+(this.titleBarHeightPx-h)/2;if(a.position.set(xr(Br)+2,Math.floor(c)),this.container.addChild(a),"PIKCELL"===this.options.title){const t=new e.BitmapText({text:"ALPHA!",style:{fontFamily:"KennyBlocksBitmap",fontSize:64,fill:2731519}});t.roundPixels=!0,t.anchor.set(.5),t.scale.set(1.2*br.fontScale),t.angle=-8;const i=a.x+a.width+xr(2)+xr(8)+xr(2),s=c-xr(2)+xr(4)-xr(1);t.position.set(i,s),this.container.addChild(t)}this.contentContainer.position.set(xr(Br+br.padding),xr(Br)+this.titleBarHeightPx+xr(br.padding)),this.options.clipContent?(this.contentMask||(this.contentMask=new e.Graphics),this.contentMask.clear(),this.contentMask.rect(xr(Br+br.padding),xr(Br)+this.titleBarHeightPx+xr(br.padding),xr(this.state.contentWidth),xr(this.state.contentHeight)),this.contentMask.fill({color:16777215}),this.container.addChild(this.contentMask),this.contentContainer.mask=this.contentMask):this.contentContainer.mask=null,this.container.addChild(this.contentContainer),this.addResizeHandles(t,i)}addResizeHandles(t,i){const s=xr(1),o=xr(2),n=(t,i,s,o,n,r)=>{const a=new e.Graphics;a.roundPixels=!0,a.eventMode="static",a.cursor=n,a.rect(0,0,s,o),a.fill({color:0,alpha:.01}),a.position.set(t,i),a.on("pointerdown",t=>{this.isResizing=!0,this.resizeDirection=r,this.resizeStartX=t.client.x,this.resizeStartY=t.client.y,this.resizeStartWidth=this.state.contentWidth,this.resizeStartHeight=this.state.contentHeight,this.cardStartX=this.container.x,this.cardStartY=this.container.y;const e=this.options.renderer.canvas;e&&void 0!==t.pointerId&&(e.setPointerCapture(t.pointerId),this.capturedPointerId=t.pointerId),t.stopPropagation()}),this.container.addChild(a)};n(0,0,o,o,"nwse-resize","nw"),n(xr(t)-o,0,o,o,"nesw-resize","ne"),n(0,i-o,o,o,"nesw-resize","sw"),n(xr(t)-o,i-o,o,o,"nwse-resize","se"),n(o,0,xr(t)-2*o,s,"ns-resize","n"),n(o,i-s,xr(t)-2*o,s,"ns-resize","s"),n(0,o,s,i-2*o,"ew-resize","w"),n(xr(t)-s,o,s,i-2*o,"ew-resize","e")}getContentContainer(){return this.contentContainer}getContentSize(){return{width:this.state.contentWidth,height:this.state.contentHeight}}setContentSize(t,e){this.state.contentWidth=t,this.state.contentHeight=e,this.redraw(),this.options.onResize&&this.options.onResize(t,e)}getPixelWidth(){const t=this.state.contentWidth+2*Br+2*br.padding;return xr(t)}getPixelHeight(){return xr(this.state.contentHeight)+xr(2*Br)+this.titleBarHeightPx+xr(2*br.padding)}refresh(){this.redraw(),this.options.onRefresh&&this.options.onRefresh()}setTitle(t){this.options.title=t,this.redraw()}setTitleContent(t,i){this.options.title="",this.container.children.filter(t=>t instanceof e.BitmapText).forEach(t=>this.container.removeChild(t));const s=Tr(),o=xr(Br)+(this.titleBarHeightPx-64*br.fontScale)/2,n=new e.BitmapText({text:t,style:{fontFamily:"PixelOperator8Bitmap",fontSize:64,fill:s.textPrimary}});n.roundPixels=!0,n.scale.set(br.fontScale),n.position.set(xr(Br)+2,Math.floor(o)),this.container.addChild(n);const r=new e.BitmapText({text:i,style:{fontFamily:"PixelOperator8Bitmap",fontSize:64,fill:s.textPrimary}});r.roundPixels=!0,r.scale.set(br.fontScale);const a=this.state.contentWidth+2*Br+2*br.padding,h=xr(a-Br)-r.width-2;r.position.set(h,Math.floor(o)),this.container.addChild(r)}setPairedCard(t){this.pairedCard=t}getPairedCard(){return this.pairedCard}onStateChanged(t){this.onStateChange=t}exportState(t){return{id:t,x:this.container.x,y:this.container.y,contentWidth:this.state.contentWidth,contentHeight:this.state.contentHeight,visible:this.container.visible}}importState(t){this.container.position.set(t.x,t.y),this.container.visible=t.visible,t.contentWidth===this.state.contentWidth&&t.contentHeight===this.state.contentHeight||this.setContentSize(t.contentWidth,t.contentHeight)}updateMinContentSize(){if(!this.options.minContentSize)return;const t=this.contentContainer.getLocalBounds(),e=Math.ceil((t.x+t.width)/xr(1)),i=Math.ceil((t.y+t.height)/xr(1));this.state.minContentWidth=e,this.state.minContentHeight=i,(this.state.contentWidth<e||this.state.contentHeight<i)&&(this.state.contentWidth=Math.max(this.state.contentWidth,e),this.state.contentHeight=Math.max(this.state.contentHeight,i),this.redraw())}showScaleIndicator(t,i){const s=this.options.renderer.canvas,o=s.getBoundingClientRect(),n=s.width/o.width,r=s.height/o.height,a=(t-o.left)*n,h=(i-o.top)*r;this.scaleIndicator||(this.scaleIndicator=new e.Container),this.scaleIndicator.removeChildren();const c=`${this.state.contentWidth}x${this.state.contentHeight}`,l=Tr(),m=new e.BitmapText({text:c,style:{fontFamily:"PixelOperator8Bitmap",fontSize:64,fill:l.textPrimary}});m.roundPixels=!0,m.scale.set(br.fontScale);const u=xr(2),_=xr(Ar),d=xr(1),p=m.width+2*u+2*_,y=m.height+2*u+2*_,f=new e.Graphics;f.roundPixels=!0,f.rect(d,d,p,y),f.fill({color:Lr.titleBar}),f.rect(0,0,p,y),f.fill({color:16777215}),f.rect(_,_,p-2*_,y-2*_),f.fill({color:0}),this.scaleIndicator.addChild(f),m.position.set(_+u,_+u),this.scaleIndicator.addChild(m),this.scaleIndicator.position.set(a+10,h-y-10),this.container.parent&&this.container.parent.addChild(this.scaleIndicator)}hideScaleIndicator(){this.scaleIndicator&&this.scaleIndicator.parent&&(this.scaleIndicator.parent.removeChild(this.scaleIndicator),this.scaleIndicator.destroy(),this.scaleIndicator=null)}}function kr(t){const{size:i,width:s,height:o,selected:n=!1,label:r,icon:a,backgroundColor:h=Lr.buttonBg,onClick:c,selectionMode:l="press",actionMode:m="click",tooltip:u}=t;let _=s??i??10;const d=o??i??10;if(r&&!s&&!i){const t=new e.BitmapText({text:r,style:{fontFamily:"PixelOperator8Bitmap",fontSize:64,fill:16777215}});t.scale.set(br.fontScale),_=Math.ceil(t.width/xr(1))+4*br.border+2,t.destroy()}const p=new e.Graphics;if(p.roundPixels=!0,p.eventMode=c||u?"static":"auto",p.cursor=c?"pointer":"default",u){let t=null;const i=()=>{const t=new e.Container,i=new e.BitmapText({text:u,style:{fontFamily:"PixelOperator8Bitmap",fontSize:64,fill:16777215}});i.roundPixels=!0,i.scale.set(br.fontScale);const s=xr(2),o=xr(br.border),n=i.width+2*s+2*o,r=i.height+2*s+2*o,a=new e.Graphics;a.roundPixels=!0;const h=xr(1);return a.rect(h,h,n,r),a.fill({color:6841441}),a.rect(0,0,n,r),a.fill({color:16777215}),a.rect(o,o,n-2*o,r-2*o),a.fill({color:0}),t.addChild(a),i.position.set(o+s,o+s),t.addChild(i),t};p.on("pointerover",e=>{if(t)return;t=i();const s=e.getLocalPosition(p);t.position.set(s.x,s.y-t.height-2),p.addChild(t)}),p.on("pointermove",e=>{if(t){const i=e.getLocalPosition(p);t.position.set(i.x,i.y-t.height-2)}}),p.on("pointerout",()=>{t&&(p.removeChild(t),t.destroy(),t=null)})}const y=Tr();if("highlight"===l?n?(p.rect(0,0,xr(_),xr(d)),p.fill({color:y.accentPrimary}),p.rect(xr(br.border),xr(br.border),xr(_-2*br.border),xr(d-2*br.border)),p.fill({color:y.borderStrong}),p.rect(xr(2*br.border),xr(2*br.border),xr(_-4*br.border),xr(d-4*br.border)),p.fill({color:h})):(p.rect(0,0,xr(_),xr(d)),p.fill({color:y.borderStrong}),p.rect(xr(br.border),xr(br.border),xr(_-2*br.border),xr(d-2*br.border)),p.fill({color:h})):n?(p.rect(0,xr(1),xr(_),xr(d)-xr(1)),p.fill({color:y.borderStrong}),p.rect(xr(br.border),xr(br.border+1),xr(_-2*br.border),xr(d-2*br.border-1)),p.fill({color:y.borderSubtle}),p.rect(xr(2*br.border),xr(2*br.border+1),xr(_-4*br.border),xr(d-4*br.border-1)),p.fill({color:h})):(p.rect(0,0,xr(_),xr(d)),p.fill({color:y.borderStrong}),p.rect(xr(br.border),xr(d-2*br.border),xr(_-2*br.border),xr(br.border)),p.fill({color:y.backgroundOverlay}),p.rect(xr(br.border),xr(br.border),xr(_-2*br.border),xr(d-3*br.border)),p.fill({color:y.borderSubtle}),p.rect(xr(2*br.border),xr(2*br.border),xr(_-4*br.border),xr(d-5*br.border)),p.fill({color:h})),a){const t="press"===l&&n?xr(1):0;a.position.set(xr(_)/2-a.width/2,xr(d)/2-a.height/2+t),p.addChild(a)}else if(r){const t=0,i=new e.BitmapText({text:r,style:{fontFamily:"PixelOperator8Bitmap",fontSize:64,fill:y.textPrimary}});i.roundPixels=!0,i.scale.set(br.fontScale),i.anchor.set(.5),i.position.set(xr(_)/2,xr(d)/2+t),p.addChild(i)}return c&&p.on("pointerdown",t=>{c(),t.stopPropagation()}),p}function qr(t){const{title:i,message:s,buttons:o,checkboxes:n=[],renderer:r}=t,a=new e.Container,h=new e.Graphics;h.rect(0,0,r.width,r.height),h.fill({color:0,alpha:.5}),h.eventMode="static",a.addChild(h);const c={};n.forEach(t=>{c[t.name]=t.defaultValue??!1});const l=xr(2),m=(xr(4),Tr()),u=new e.BitmapText({text:s,style:{fontFamily:"PixelOperator8Bitmap",fontSize:64,fill:m.textPrimary}});u.roundPixels=!0,u.scale.set(br.fontScale);const _=Math.ceil(u.width/xr(1)),d=30*o.length+(o.length-1)*(l/xr(1)),p=Math.max(_,d)+4,y=Math.ceil(u.height/xr(1)),f=n.length>0?8*n.length+2:0,g=new Fr({title:i,x:0,y:0,contentWidth:p,contentHeight:y+f+4+12+4,renderer:r,minContentSize:!0}),v=g.getContentContainer(),x=xr(2);u.position.set(xr(2),x),v.addChild(u);let b=x+u.height+xr(4);n.forEach(t=>{const i=function(t){const{label:i,checked:s=!1,onChange:o}=t,n=new e.Container;let r=s;const a=new e.BitmapText({text:i,style:{fontFamily:"PixelOperator8Bitmap",fontSize:64,fill:0}});a.roundPixels=!0,a.scale.set(br.fontScale),a.position.set(xr(8),0),n.addChild(a);const h=xr(6),c=(a.height-h)/2,l=kr({size:6,selected:r,selectionMode:"highlight",actionMode:"toggle",backgroundColor:16777215,onClick:()=>{r=!r,o&&o(r)}});return l.position.set(0,c),n.addChild(l),n}({label:t.label,checked:c[t.name],onChange:e=>{c[t.name]=e}});i.position.set(xr(2),b),v.addChild(i),b+=i.height+xr(1)});const A=xr(y+f+4+2);let w=xr((p-d)/2);o.forEach((t,e)=>{const i=kr({width:30,height:12,label:t.label,selectionMode:"press",actionMode:"click",onClick:()=>{t.onClick(c),a.destroy()}});i.position.set(w,A),v.addChild(i),w+=xr(30)+l});const B=g.container.getBounds();return g.container.position.set((r.width-B.width)/2,(r.height-B.height)/2),a.addChild(g.container),a}class Nr{constructor(t){this.scale=1,this.texture=null,this.sprite=null,this.isPanning=!1,this.panStartX=0,this.panStartY=0,this.spriteStartX=0,this.spriteStartY=0,this.cellOverlay=null,this.selectedCellX=-1,this.selectedCellY=-1,this.hoveredCellX=-1,this.hoveredCellY=-1,this.interactionSetup=!1,this.isDragging=!1,this.dragStartX=0,this.dragStartY=0,this.clickThreshold=5,this.wheelHandler=null,this.mouseDownHandler=null,this.mouseMoveHandler=null,this.mouseUpHandler=null,this.animationFrameId=null,this.config=t.config,this.renderer=t.renderer,this.showGrid=t.showGrid??!1,this.onScaleChange=t.onScaleChange,this.onCellHover=t.onCellHover,this.onCellClick=t.onCellClick;const e=.5*this.renderer.height;this.scale=Math.max(1,Math.floor(e/this.config.height)),this.pixels=[];for(let t=0;t<this.config.height;t++){this.pixels[t]=[];for(let e=0;e<this.config.width;e++)this.pixels[t][e]=0}this.setupMouseWheelZoom(),this.setupMiddleMousePan()}setupMouseWheelZoom(){"undefined"!=typeof window&&(this.wheelHandler=t=>{if(!this.sprite)return;const e=this.renderer.canvas,i=e.getBoundingClientRect(),s=e.width/i.width,o=e.height/i.height,n=(t.clientX-i.left)*s,r=(t.clientY-i.top)*o,a=this.sprite.getBounds();if(n>=a.x&&n<=a.x+a.width&&r>=a.y&&r<=a.y+a.height){t.preventDefault();const e=this.sprite.parent.getBounds(),i=e.x+this.sprite.x,s=e.y+this.sprite.y,o=this.sprite.scale.x,a=(n-i)/o,h=(r-s)/o,c=t.deltaY>0?-.5:.5,l=Math.max(1,Math.min(16,this.scale+c));l!==this.scale&&(this.sprite.x=n-e.x-a*l,this.sprite.y=r-e.y-h*l,this.setScale(l))}},window.addEventListener("wheel",this.wheelHandler,{passive:!1}))}setupMiddleMousePan(){"undefined"!=typeof window&&(this.mouseDownHandler=t=>{if(1!==t.button||!this.sprite)return;const e=this.renderer.canvas,i=e.getBoundingClientRect(),s=e.width/i.width,o=e.height/i.height,n=(t.clientX-i.left)*s,r=(t.clientY-i.top)*o,a=this.sprite.getBounds();n>=a.x&&n<=a.x+a.width&&r>=a.y&&r<=a.y+a.height&&(t.preventDefault(),this.isPanning=!0,this.panStartX=t.clientX,this.panStartY=t.clientY,this.spriteStartX=this.sprite.x,this.spriteStartY=this.sprite.y)},this.mouseMoveHandler=t=>{if(!this.isPanning||!this.sprite)return;t.preventDefault();const e=this.renderer.canvas,i=e.getBoundingClientRect(),s=e.width/i.width,o=e.height/i.height,n=(t.clientX-this.panStartX)*s,r=(t.clientY-this.panStartY)*o;this.sprite.x=this.spriteStartX+n,this.sprite.y=this.spriteStartY+r},this.mouseUpHandler=t=>{1===t.button&&(this.isPanning=!1)},window.addEventListener("mousedown",this.mouseDownHandler),window.addEventListener("mousemove",this.mouseMoveHandler),window.addEventListener("mouseup",this.mouseUpHandler))}getScale(){return this.scale}setScale(t){const e=Math.max(1,Math.min(16,t));e!==this.scale&&(this.scale=e,this.onScaleChange&&this.onScaleChange(this.scale))}getConfig(){return this.config}getScaledDimensions(){return{width:this.config.width*this.scale,height:this.config.height*this.scale}}getPixel(t,e){return t<0||t>=this.config.width||e<0||e>=this.config.height?0:this.pixels[e][t]}setPixel(t,e,i){t<0||t>=this.config.width||e<0||e>=this.config.height||i<0||i>=this.config.palette.length||(this.pixels[e][t]=i)}updateTexture(){const t=document.createElement("canvas");t.width=this.config.width,t.height=this.config.height;const i=t.getContext("2d");if(i){for(let t=0;t<this.config.height;t++)for(let e=0;e<this.config.width;e++){const s=this.pixels[t][e],o=this.config.palette[s],n=o>>16&255,r=o>>8&255,a=255&o;i.fillStyle=`rgb(${n}, ${r}, ${a})`,i.fillRect(e,t,1,1)}if(this.showGrid){const t=8;i.strokeStyle="rgba(128, 128, 128, 0.3)",i.lineWidth=1;for(let e=t;e<this.config.width;e+=t)i.beginPath(),i.moveTo(e,0),i.lineTo(e,this.config.height),i.stroke();for(let e=t;e<this.config.height;e+=t)i.beginPath(),i.moveTo(0,e),i.lineTo(this.config.width,e),i.stroke()}this.texture&&this.texture.destroy(!0),this.texture=e.Texture.from(t),this.texture.source.scaleMode="nearest"}}drawCellOverlay(){if(!this.cellOverlay||!this.sprite)return;this.cellOverlay.clear();const t=8*this.scale,e=this.sprite.x-this.config.width*this.scale/2,i=this.sprite.y-this.config.height*this.scale/2;this.selectedCellX>=0&&this.selectedCellY>=0&&(this.cellOverlay.rect(e+this.selectedCellX*t,i+this.selectedCellY*t,t,t),this.cellOverlay.stroke({color:16772135,width:2})),this.hoveredCellX>=0&&this.hoveredCellY>=0&&(this.cellOverlay.rect(e+this.hoveredCellX*t,i+this.hoveredCellY*t,t,t),this.cellOverlay.stroke({color:16777215,width:1,alpha:.5}))}setupCellInteraction(t){if((this.onCellHover||this.onCellClick)&&!this.interactionSetup&&(this.interactionSetup=!0,t.eventMode="static",t.cursor="pointer",t.on("pointermove",t=>{if(!this.sprite)return;const e=t.getLocalPosition(this.sprite),i=e.x+this.config.width/2,s=e.y+this.config.height/2,o=Math.floor(i/8),n=Math.floor(s/8),r=Math.floor(this.config.width/8)-1,a=Math.floor(this.config.height/8)-1;o>=0&&o<=r&&n>=0&&n<=a?o===this.hoveredCellX&&n===this.hoveredCellY||(this.hoveredCellX=o,this.hoveredCellY=n,this.drawCellOverlay(),this.onCellHover&&this.onCellHover(o,n)):-1===this.hoveredCellX&&-1===this.hoveredCellY||(this.hoveredCellX=-1,this.hoveredCellY=-1,this.drawCellOverlay())}),t.on("pointerout",()=>{this.hoveredCellX=-1,this.hoveredCellY=-1,this.drawCellOverlay()}),t.on("pointerdown",t=>{this.sprite&&(this.isDragging=!1,this.dragStartX=t.global.x,this.dragStartY=t.global.y,this.spriteStartX=this.sprite.x,this.spriteStartY=this.sprite.y)}),t.on("globalpointermove",t=>{if(!this.sprite)return;const e=t.global.x-this.dragStartX,i=t.global.y-this.dragStartY;Math.sqrt(e*e+i*i)>this.clickThreshold&&(0!==this.dragStartX||0!==this.dragStartY)&&(this.isDragging=!0,this.sprite.x=this.spriteStartX+e,this.sprite.y=this.spriteStartY+i)}),t.on("pointerup",()=>{!this.isDragging&&this.onCellClick&&this.hoveredCellX>=0&&this.hoveredCellY>=0&&(this.selectedCellX=this.hoveredCellX,this.selectedCellY=this.hoveredCellY,this.drawCellOverlay(),this.onCellClick(this.selectedCellX,this.selectedCellY)),this.isDragging=!1,this.dragStartX=0,this.dragStartY=0}),t.on("pointerupoutside",()=>{this.isDragging=!1,this.dragStartX=0,this.dragStartY=0}),"undefined"!=typeof window)){const t=()=>{this.drawCellOverlay(),this.animationFrameId=requestAnimationFrame(t)};this.animationFrameId=requestAnimationFrame(t)}}render(t){const i=this.sprite?.x,s=this.sprite?.y;this.sprite&&t.removeChild(this.sprite),this.cellOverlay&&t.removeChild(this.cellOverlay),this.updateTexture(),this.texture&&(this.sprite=new e.Sprite(this.texture),this.sprite.anchor.set(.5,.5),this.sprite.scale.set(this.scale),void 0!==i&&void 0!==s?(this.sprite.x=i,this.sprite.y=s):(this.sprite.x=this.config.width*this.scale/2,this.sprite.y=this.config.height*this.scale/2),t.addChild(this.sprite),this.cellOverlay=new e.Graphics,this.cellOverlay.roundPixels=!0,t.addChild(this.cellOverlay),(this.onCellHover||this.onCellClick)&&this.setupCellInteraction(t),this.drawCellOverlay())}selectCell(t,e){this.selectedCellX=t,this.selectedCellY=e,this.drawCellOverlay(),this.onCellClick&&this.onCellClick(t,e)}clear(t=0){for(let e=0;e<this.config.height;e++)for(let i=0;i<this.config.width;i++)this.pixels[e][i]=t}screenToPixel(t,e){const i=Math.floor(t/this.scale),s=Math.floor(e/this.scale);return i<0||i>=this.config.width||s<0||s>=this.config.height?null:{x:i,y:s}}getPixelData(){return this.pixels.map(t=>[...t])}setPixelData(t){t.length===this.config.height?t[0]?.length===this.config.width?this.pixels=t.map(t=>[...t]):console.error("Pixel data width mismatch"):console.error("Pixel data height mismatch")}getSelectedCell(){return{x:this.selectedCellX,y:this.selectedCellY}}positionCell00AtTopLeft(){this.sprite&&(this.sprite.x=this.config.width*this.scale/2,this.sprite.y=this.config.height*this.scale/2,this.drawCellOverlay())}centerCell(t,e,i,s){if(!this.sprite)return;const o=8*t+4,n=8*e+4,r=i/2,a=s/2,h=this.config.width/2,c=this.config.height/2;this.sprite.x=r-(o-h)*this.scale,this.sprite.y=a-(n-c)*this.scale,this.drawCellOverlay()}destroy(){"undefined"!=typeof window&&(this.wheelHandler&&(window.removeEventListener("wheel",this.wheelHandler),this.wheelHandler=null),this.mouseDownHandler&&(window.removeEventListener("mousedown",this.mouseDownHandler),this.mouseDownHandler=null),this.mouseMoveHandler&&(window.removeEventListener("mousemove",this.mouseMoveHandler),this.mouseMoveHandler=null),this.mouseUpHandler&&(window.removeEventListener("mouseup",this.mouseUpHandler),this.mouseUpHandler=null),null!==this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null)),this.texture&&(this.texture.destroy(!0),this.texture=null),this.cellOverlay&&(this.cellOverlay.destroy(),this.cellOverlay=null),this.sprite&&(this.sprite.destroy(),this.sprite=null)}}const jr={"PICO-8":{type:"PICO-8",width:128,height:128,palette:[0,1911635,8267091,34641,11227702,6248271,12764103,16773608,16711757,16753408,16772135,58422,2731519,8615580,16742312,16764074]},"TIC-80":{type:"TIC-80",width:256,height:256,palette:[1313820,4465716,3159149,5130830,8735792,3433764,13649480,7696737,5864910,13794604,8754593,7186988,13806233,7193290,14341214,14610134]}};class Rr{constructor(t){this.sprite=null,this.texture=null,this.spriteSheetController=t.spriteSheetController,this.cellX=t.cellX,this.cellY=t.cellY,this.scale=t.scale??8}getCell(){return{x:this.cellX,y:this.cellY}}setCell(t,e){this.cellX=t,this.cellY=e}getScale(){return this.scale}setScale(t){this.scale=Math.max(1,Math.min(64,t))}getPixel(t,e){const i=8*this.cellX+t,s=8*this.cellY+e;return this.spriteSheetController.getPixel(i,s)}setPixel(t,e,i){const s=8*this.cellX+t,o=8*this.cellY+e;this.spriteSheetController.setPixel(s,o,i)}render(t){this.sprite&&t.removeChild(this.sprite);const i=this.spriteSheetController.getConfig(),s=document.createElement("canvas");s.width=8,s.height=8;const o=s.getContext("2d");if(o){for(let t=0;t<8;t++)for(let e=0;e<8;e++){const s=this.getPixel(e,t),n=i.palette[s],r=n>>16&255,a=n>>8&255,h=255&n;o.fillStyle=`rgb(${r}, ${a}, ${h})`,o.fillRect(e,t,1,1)}this.texture&&this.texture.destroy(!0),this.texture=e.Texture.from(s),this.texture.source.scaleMode="nearest",this.sprite=new e.Sprite(this.texture),this.sprite.scale.set(this.scale),this.sprite.position.set(0,0),t.addChild(this.sprite)}}screenToPixel(t,e){const i=Math.floor(t/this.scale),s=Math.floor(e/this.scale);return i<0||i>=8||s<0||s>=8?null:{x:i,y:s}}getScaledDimensions(){return{width:8*this.scale,height:8*this.scale}}getSpriteSheetController(){return this.spriteSheetController}}class Er{static saveState(t,e,i){const s={version:Er.VERSION,timestamp:Date.now(),canvasWidth:e,canvasHeight:i,cards:Array.from(t.values())};try{localStorage.setItem(Er.STORAGE_KEY,JSON.stringify(s)),console.log(" UI state saved:",t.size,"cards")}catch(t){console.error("Failed to save UI state:",t)}}static loadState(){try{const t=localStorage.getItem(Er.STORAGE_KEY);if(!t)return null;const e=JSON.parse(t);return e.version!==Er.VERSION?(console.warn("UI state version mismatch, ignoring"),null):(console.log(" UI state loaded:",e.cards.length,"cards"),e)}catch(t){return console.error("Failed to load UI state:",t),null}}static clearState(){localStorage.removeItem(Er.STORAGE_KEY),console.log(" UI state cleared")}static hasState(){return null!==localStorage.getItem(Er.STORAGE_KEY)}static adjustForCanvasSize(t,e,i){const s=e/t.canvasWidth,o=i/t.canvasHeight;return{...t,canvasWidth:e,canvasHeight:i,cards:t.cards.map(t=>({...t,x:Math.round(t.x*s),y:Math.round(t.y*o)}))}}}Er.VERSION="1.0.0",Er.STORAGE_KEY="sprite-editor-ui-state";const Or="sprite-editor-project";class Dr{static createEmptyProject(){return{version:this.CURRENT_VERSION,createdAt:Date.now(),modifiedAt:Date.now(),spriteSheets:[],activeSpriteSheetId:null,selectedColorIndex:0}}static saveProject(t){try{t.modifiedAt=Date.now();const e=JSON.stringify(t);return localStorage.setItem(Or,e),console.log(" Project saved to localStorage"),{success:!0}}catch(t){const e=t instanceof Error?t.message:"Unknown error";return console.error("Failed to save project state:",t),{success:!1,error:`Failed to save project: ${e}`}}}static loadProject(){try{const t=localStorage.getItem(Or);if(!t)return{success:!0,data:null};const e=JSON.parse(t);return e.version!==this.CURRENT_VERSION?(console.warn("Project version mismatch, migrating..."),{success:!0,data:this.migrateProject(e)}):(console.log(" Project loaded from localStorage"),{success:!0,data:e})}catch(t){const e=t instanceof Error?t.message:"Unknown error";return console.error("Failed to load project state:",t),{success:!1,error:`Failed to load project: ${e}`}}}static clearProject(){try{return localStorage.removeItem(Or),console.log(" Project cleared"),{success:!0}}catch(t){const e=t instanceof Error?t.message:"Unknown error";return console.error("Failed to clear project state:",t),{success:!1,error:`Failed to clear project: ${e}`}}}static hasProject(){return null!==localStorage.getItem(Or)}static migrateProject(t){return{...t,version:this.CURRENT_VERSION}}static exportProjectJSON(t){return JSON.stringify(t,null,2)}static importProjectJSON(t){try{const e=JSON.parse(t);return e.spriteSheets&&Array.isArray(e.spriteSheets)?e.version!==this.CURRENT_VERSION?{success:!0,data:this.migrateProject(e)}:{success:!0,data:e}:{success:!1,error:"Invalid project file: missing sprite sheet data"}}catch(t){const e=t instanceof Error?t.message:"Unknown error";return console.error("Failed to import project:",t),{success:!1,error:`Failed to import project: ${e}`}}}static getProjectMetadata(){const t=this.loadProject();return t.success&&t.data?{createdAt:t.data.createdAt,modifiedAt:t.data.modifiedAt,sheetCount:t.data.spriteSheets.length}:null}static downloadProject(t,e){const i=this.exportProjectJSON(t),s=new Blob([i],{type:"application/json"}),o=URL.createObjectURL(s),n=document.createElement("a");n.href=o,n.download=e??`pikcell-project-${Date.now()}.pikcell`,document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(o),console.log(" Pikcell project downloaded")}static async loadProjectFromFile(){return new Promise(t=>{const e=document.createElement("input");e.type="file",e.accept=".pikcell,application/json",e.onchange=async e=>{const i=e.target.files?.[0];if(i)try{const e=await i.text(),s=this.importProjectJSON(e);s.success&&s.data&&console.log(" Pikcell project loaded from file"),t(s.success?{success:!0,data:s.data}:s)}catch(e){const i=e instanceof Error?e.message:"Unknown error";console.error("Failed to load pikcell project file:",e),t({success:!1,error:`Failed to read file: ${i}`})}else t({success:!0,data:null})},e.click()})}}Dr.CURRENT_VERSION=1;const Hr="pikcell-layout-slot-";class Yr{static saveLayoutSlot(t,e){const i=`${Hr}${t}`;localStorage.setItem(i,JSON.stringify(e))}static loadLayoutSlot(t){const e=`${Hr}${t}`,i=localStorage.getItem(e);if(!i)return null;try{return JSON.parse(i)}catch(e){return console.error(`Failed to parse layout slot ${t}:`,e),null}}static hasLayoutSlot(t){const e=`${Hr}${t}`;return null!==localStorage.getItem(e)}static clearLayoutSlot(t){const e=`${Hr}${t}`;localStorage.removeItem(e)}}const Wr=[0,1911635,8267091,34641,11227702,6248271,12764103,16773608,16711757,16753408,16772135,58422,2731519,8615580,16742312,16764074];function Ur(t,e,i){return s=>{const o=t.canvas,n=o.getBoundingClientRect(),r=o.width/n.width,a=o.height/n.height,h=(s.clientX-n.left)*r,c=(s.clientY-n.top)*a,l=e.container.getBounds();if(h>=l.x&&h<=l.x+l.width&&c>=l.y&&c<=l.y+l.height){s.preventDefault();const t=s.deltaY>0?-1:1;i(t,s)}}}const Xr=".moxiproject",Jr=".png";class $r{constructor(){this.instances=new Map,this.activeId=null,this.eventHandlers=new Map}create(t,e,i){const s=e||this.generateId(),o={id:s,spriteCard:null,spriteController:null};return this.instances.set(s,o),this.emit("created",s),o}get(t){return this.instances.get(t)}getActive(){return this.activeId&&this.instances.get(this.activeId)||null}setActive(t){if(!this.instances.has(t))throw new Error(`Cannot set active sprite sheet: ID "${t}" not found`);this.activeId!==t&&(this.activeId=t,this.emit("activeChanged",t))}getAll(){return Array.from(this.instances.values())}remove(t){if(this.instances.get(t)){if(this.activeId===t){this.activeId=null;const e=Array.from(this.instances.keys()).filter(e=>e!==t);e.length>0&&(this.activeId=e[0])}this.instances.delete(t),this.emit("removed",t)}}validate(t){if(this.instances.size>=10)return{valid:!1,message:"Maximum 10 sprite sheets per project"};if(this.instances.size>0){const e=Array.from(this.instances.values())[0],i=e.sheetCard?.controller.getConfig().type;if(i&&i!==t)return{valid:!1,message:`Project already contains a ${i} sprite sheet. Create a new project to use ${t}.`}}return{valid:!0}}has(t){return this.instances.has(t)}count(){return this.instances.size}on(t,e){this.eventHandlers.has(t)||this.eventHandlers.set(t,new Set),this.eventHandlers.get(t).add(e)}off(t,e){const i=this.eventHandlers.get(t);i&&i.delete(e)}clear(){Array.from(this.instances.keys()).forEach(t=>this.remove(t))}getProjectSpriteSheetType(){if(0===this.instances.size)return null;const t=Array.from(this.instances.values())[0];return t.sheetCard?.controller.getConfig().type||null}generateId(){return`sheet-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}emit(t,e){const i=this.eventHandlers.get(t);i&&i.forEach(t=>t(e))}getStats(){return{total:this.instances.size,activeId:this.activeId,type:this.getProjectSpriteSheetType()}}}class Gr{constructor(t){this.cards=new Map,this.focusedCardId=null,this.cardCallbacks=new Map,this.scene=t}registerCard(t,e){if(this.cards.has(t))console.warn(`Card with ID "${t}" is already registered`);else if(this.cards.set(t,e),this.scene.children.includes(e.container)||this.scene.addChild(e.container),e.onStateChanged){const i=e.onStateChanged.bind(e);this.cardCallbacks.set(t,i);const s=()=>{this.setFocusedCard(t),i()};e.onStateChanged=s}}unregisterCard(t){const e=this.cards.get(t);if(!e)return;const i=this.cardCallbacks.get(t);i&&e.onStateChanged&&(e.onStateChanged=i),this.cardCallbacks.delete(t),this.scene.children.includes(e.container)&&this.scene.removeChild(e.container),this.focusedCardId===t&&(this.focusedCardId=null),this.cards.delete(t)}getCard(t){return this.cards.get(t)}getAllCards(){return new Map(this.cards)}bringToFront(t){const e=this.cards.get(t);if(!e)return;this.scene.removeChild(e.container),this.scene.addChild(e.container);const i=e.getPairedCard?.();if(i&&i!==e)for(const[t,s]of this.cards.entries())if(s===i){this.scene.removeChild(i.container),this.scene.addChild(i.container),this.scene.removeChild(e.container),this.scene.addChild(e.container);break}}exportAllStates(){const t=new Map;return this.cards.forEach((e,i)=>{t.set(i,e.exportState(i))}),t}importStates(t){t.forEach((t,e)=>{const i=this.cards.get(e);i&&i.importState(t)})}hasCard(t){return this.cards.has(t)}getFocusedCard(){return this.focusedCardId}setFocusedCard(t){t!==this.focusedCardId&&(this.focusedCardId=t,t&&this.bringToFront(t))}getCardCount(){return this.cards.size}clear(){Array.from(this.cards.keys()).forEach(t=>this.unregisterCard(t))}findCards(t){const e=[];return this.cards.forEach((i,s)=>{t(i,s)&&e.push([s,i])}),e}getCardIdsByPattern(t){const e="string"==typeof t?new RegExp(t):t;return Array.from(this.cards.keys()).filter(t=>e.test(t))}bringGroupToFront(t){t.forEach(t=>{const e=this.cards.get(t);e&&this.scene.children.includes(e.container)&&this.scene.removeChild(e.container)}),t.forEach(t=>{const e=this.cards.get(t);e&&this.scene.addChild(e.container)})}}class Kr{constructor(t){this.layouts=new Map,this.currentLayout=null,this.renderer=t,this.registerDefaultLayouts()}applyLayout(t,e){const i=this.layouts.get(t);i?(Object.entries(i.positions).forEach(([t,i])=>{const s=e.get(t);s&&this.positionCard(s,i)}),this.currentLayout=t):console.warn(`Layout "${t}" not found`)}applyDefaultLayout(t){const e=this.calculateTitleBarHeight(),i=xr(12)+xr(2*Br)+e+xr(2*br.gap),s=t.get("commander");s&&s.container.position.set(0,0);const o=t.get("palette");o&&o.container.position.set(0,i);const n=t.get("info");if(n){const t=8,e=this.calculateCardHeightFromContent(t),i=this.renderer.height-e;n.container.position.set(0,i)}this.currentLayout="default"}positionCard(t,e){t.container.position.set(e.x,e.y),void 0!==e.width&&void 0!==e.height&&t.setContentSize(e.width,e.height)}getLayout(t){return this.layouts.get(t)}registerLayout(t){this.layouts.set(t.id,t)}getAllLayouts(){return Array.from(this.layouts.values())}calculateCardDimensions(t,e){return this.calculateTitleBarHeight(),{width:this.calculateCardWidth(t),height:this.calculateCardHeight(e)}}onViewportResize(t,e){console.log(`Viewport resized to ${t}x${e}`)}calculateTitleBarHeight(){const t=64*br.fontScale,e=xr(2*br.padding);return Math.ceil(t+e)}calculateCardWidth(t){return xr(t+2*Br+2*br.padding)}calculateCardHeight(t){const e=this.calculateTitleBarHeight();return xr(t)+xr(2*Br)+e+xr(2*br.padding)}calculateCardHeightFromContent(t){return this.calculateCardHeight(t)}calculateFullWidthContentSize(t){return Math.floor(t/xr(1))-2*Br-2*br.padding}registerDefaultLayouts(){this.registerLayout({id:"default",name:"Default Layout",positions:{commander:{x:0,y:0},palette:{x:0,y:100},info:{x:0,y:700}}}),this.registerLayout({id:"compact",name:"Compact Layout",positions:{commander:{x:0,y:0},palette:{x:0,y:80},tool:{x:300,y:80},info:{x:0,y:700}}}),this.registerLayout({id:"fullscreen",name:"Fullscreen Layout",positions:{commander:{x:0,y:0},info:{x:0,y:700}}})}getCurrentLayoutId(){return this.currentLayout}centerCard(t){const e=t.getPixelWidth(),i=t.getPixelHeight(),s=(this.renderer.width-e)/2,o=(this.renderer.height-i)/2;t.container.position.set(s,o)}alignCardToEdge(t,e,i=0){const s=t.getPixelWidth(),o=t.getPixelHeight(),n=t.container.position;switch(e){case"top":t.container.position.set(n.x,i);break;case"right":t.container.position.set(this.renderer.width-s-i,n.y);break;case"bottom":t.container.position.set(n.x,this.renderer.height-o-i);break;case"left":t.container.position.set(i,n.y)}}positionRelativeTo(t,e,i,s=8){const o=e.container.position,n=e.getPixelWidth(),r=e.getPixelHeight(),a=t.getPixelWidth(),h=t.getPixelHeight();switch(i){case"above":t.container.position.set(o.x,o.y-h-s);break;case"below":t.container.position.set(o.x,o.y+r+s);break;case"left":t.container.position.set(o.x-a-s,o.y);break;case"right":t.container.position.set(o.x+n+s,o.y)}}}class Zr{constructor(){this.lastSavedFileName=null}async saveProject(t){if(!this.supportsFileOperations())throw new Error("File operations not supported in this browser");const e=JSON.stringify(t,null,2),i=new Blob([e],{type:"application/json"}),s=`untitled-project-${(new Date).toISOString().split("T")[0]}${Xr}`;this.downloadBlob(i,s),this.lastSavedFileName=s}async loadProject(){if(!this.supportsFileOperations())throw new Error("File operations not supported in this browser");return new Promise(t=>{const e=document.createElement("input");e.type="file",e.accept=Xr,e.onchange=async e=>{const i=e.target,s=i.files?.[0];if(s)try{const e=await s.text(),i=JSON.parse(e);if(!i.version||!i.spriteSheets)return console.error("Invalid project file format"),void t(null);this.lastSavedFileName=s.name,t(i)}catch(e){console.error("Failed to load project file:",e),t(null)}else t(null)},e.oncancel=()=>{t(null)},e.click()})}async exportPNG(t,e){if(!this.supportsFileOperations())throw new Error("File operations not supported in this browser");const i=t.getConfig(),s=t.getPixelData(),o=document.createElement("canvas");o.width=i.width,o.height=i.height;const n=o.getContext("2d");if(!n)throw new Error("Failed to get 2D context from canvas");for(let t=0;t<i.height;t++)for(let e=0;e<i.width;e++){const o=s[t][e],r=i.palette[o],a=r>>16&255,h=r>>8&255,c=255&r;n.fillStyle=`rgb(${a}, ${h}, ${c})`,n.fillRect(e,t,1,1)}const r=await this.canvasToBlob(o),a=(new Date).toISOString().split("T")[0],h=e||`spritesheet-${i.type.toLowerCase()}-${a}${Jr}`;this.downloadBlob(r,h)}async exportSpritePNG(t,e){if(!this.supportsFileOperations())throw new Error("File operations not supported in this browser");const{x:i,y:s}=t.getCell(),o=t.getSpriteSheetController().getConfig(),n=document.createElement("canvas");n.width=8,n.height=8;const r=n.getContext("2d");if(!r)throw new Error("Failed to get 2D context from canvas");for(let e=0;e<8;e++)for(let i=0;i<8;i++){const s=t.getPixel(i,e),n=o.palette[s],a=n>>16&255,h=n>>8&255,c=255&n;r.fillStyle=`rgb(${a}, ${h}, ${c})`,r.fillRect(i,e,1,1)}const a=await this.canvasToBlob(n),h=e||`sprite-${i}-${s}${Jr}`;this.downloadBlob(a,h)}supportsFileOperations(){return"undefined"!=typeof window&&"undefined"!=typeof document}getLastSavedFileName(){return this.lastSavedFileName}downloadBlob(t,e){const i=URL.createObjectURL(t),s=document.createElement("a");s.href=i,s.download=e,s.click(),setTimeout(()=>URL.revokeObjectURL(i),100)}canvasToBlob(t){return new Promise((e,i)=>{t.toBlob(t=>{t?e(t):i(new Error("Failed to convert canvas to blob"))},"image/png")})}async exportScaledPNG(t,e,i){if(!this.supportsFileOperations())throw new Error("File operations not supported in this browser");const s=t.getConfig(),o=t.getPixelData(),n=document.createElement("canvas");n.width=s.width*e,n.height=s.height*e;const r=n.getContext("2d");if(!r)throw new Error("Failed to get 2D context from canvas");r.imageSmoothingEnabled=!1;for(let t=0;t<s.height;t++)for(let i=0;i<s.width;i++){const n=o[t][i],a=s.palette[n],h=a>>16&255,c=a>>8&255,l=255&a;r.fillStyle=`rgb(${h}, ${c}, ${l})`,r.fillRect(i*e,t*e,e,e)}const a=await this.canvasToBlob(n),h=(new Date).toISOString().split("T")[0],c=i||`spritesheet-${s.type.toLowerCase()}-${e}x-${h}${Jr}`;this.downloadBlob(a,c)}clearLastSavedFileName(){this.lastSavedFileName=null}}class Qr{constructor(t){this.currentPalette=Wr,this.selectedColorIndex=0,this.hasUnsavedChanges=!1,this.uiStateSaveTimer=null,this.projectSaveTimer=null,this.renderer=t.renderer,this.scene=t.scene,this.spriteSheetManager=new $r,this.uiManager=new Gr(this.scene),this.layoutManager=new Kr(this.renderer),this.fileOperationsManager=new Zr;const e=Dr.loadProject();e.success||console.warn("Failed to load saved project, starting fresh:",e.error),this.projectState=e.data??Dr.createEmptyProject(),this.spriteSheetManager.on("activeChanged",t=>{this.updatePaletteForActiveSheet()})}async initialize(){await this.recreateUI()}registerCard(t,e){this.uiManager.registerCard(t,e),e.onStateChanged(()=>this.saveUIState())}saveUIState(){this.uiStateSaveTimer&&clearTimeout(this.uiStateSaveTimer),this.uiStateSaveTimer=window.setTimeout(()=>{const t=this.uiManager.exportAllStates();Er.saveState(t,this.renderer.width,this.renderer.height)},500)}restoreUIState(){const t=Er.loadState();if(!t)return!1;const e=Er.adjustForCanvasSize(t,this.renderer.width,this.renderer.height);return this.uiManager.importStates(new Map(e.cards.map(t=>[t.id,t]))),console.log(" UI state restored"),!0}applyDefaultLayout(){this.layoutManager.applyDefaultLayout(this.uiManager.getAllCards());const t=this.spriteSheetManager.getAll(),e=this.uiManager.getCard("info");t.forEach((t,i)=>{if(t.sheetCard){const i=t.sheetCard.card,s=50,o=50;t.sheetCard.controller.setScale(5),t.sheetCard.controller.selectCell(0,0),t.sheetCard.controller.positionCell00AtTopLeft(),i.setContentSize(s,o),t.sheetCard.controller.render(i.getContentContainer());const n=this.renderer.width-i.getPixelWidth(),r=e?e.container.y-i.getPixelHeight()-xr(br.gap):this.renderer.height-i.getPixelHeight();i.container.position.set(n,r)}});const i=xr(12)+xr(2*Br)+24;this.uiManager.getAllCards().forEach((t,e)=>{if(e.startsWith("sprite-card-")){const e=(this.renderer.width-t.getPixelWidth())/2,s=xr(br.margin)+i+xr(2*br.gap);t.container.position.set(e,s)}}),this.saveUIState(),console.log(" Default layout applied")}updatePaletteForActiveSheet(){const t=this.spriteSheetManager.getActive();t&&this.paletteCard&&(this.currentPalette=t.sheetCard.controller.getConfig().palette,this.paletteCard.setPalette(this.currentPalette))}createNewSpriteSheet(t,i,s){if(!s){const e=this.spriteSheetManager.validate(t);if(!e.valid){const t=qr({title:"Cannot Create Sprite Sheet",message:e.message||"Validation failed",buttons:[{label:"OK",onClick:()=>{}}],renderer:this.renderer});return void this.scene.addChild(t)}}const o=this.spriteSheetManager.create(t,s?.id),n=()=>{if(this.spriteSheetManager.setActive(o.id),o.sheetCard){const t=this.spriteSheetManager.getAll().indexOf(o);this.uiManager.bringGroupToFront([`sprite-sheet-${t}`,`sprite-card-${t}`])}console.log(`Activated ${t} sprite sheet`)},r=(t,i)=>{if(o.spriteCard&&o.spriteController)return console.log(`Updating sprite card to cell: ${t}, ${i}`),o.spriteController.setCell(t,i),o.spriteCard.redraw(),o.sheetCard.controller.render(o.sheetCard.card.getContentContainer()),void n();console.log(`Creating sprite card for cell: ${t}, ${i}`),n();const s=new Rr({spriteSheetController:o.sheetCard.controller,cellX:t,cellY:i,scale:32});let r,a;if(o.spriteCard)r=o.spriteCard.card.container.x,a=o.spriteCard.card.container.y,this.scene.removeChild(o.spriteCard.card.container);else{const t=s.getScaledDimensions(),e=xr(12)+xr(2*Br)+24;r=(this.renderer.width-t.width)/2,a=xr(br.margin)+e+xr(2*br.gap)}const h=function(t){const{x:i,y:s,renderer:o,spriteController:n,onPixelClick:r,onFocus:a}=t,h=n.getScaledDimensions(),c=Math.ceil(h.width/xr(1)),l=Math.ceil(h.height/xr(1)),m=new Fr({title:`(${n.getScale()}x)`,x:i,y:s,contentWidth:c,contentHeight:l,renderer:o,minContentSize:!0,clipContent:!0,onResize:(t,e)=>{d()},onFocus:a}),u=m.getContentContainer(),_=new e.Container;function d(){_.removeChildren(),n.render(_)}if(u.addChild(_),r){_.eventMode="static",_.cursor="crosshair";let t=!1,e=-1,i=-1;_.on("pointerdown",s=>{t=!0;const o=s.getLocalPosition(_),a=n.screenToPixel(o.x,o.y);a&&(e=a.x,i=a.y,r(a.x,a.y))}),_.on("pointermove",s=>{if(t){const t=s.getLocalPosition(_),o=n.screenToPixel(t.x,t.y);!o||o.x===e&&o.y===i||(e=o.x,i=o.y,r(o.x,o.y))}}),_.on("pointerup",()=>{t=!1,e=-1,i=-1}),_.on("pointerupoutside",()=>{t=!1,e=-1,i=-1})}return d(),{card:m,controller:n,redraw:d}}({x:r,y:a,renderer:this.renderer,spriteController:s,onPixelClick:(t,e)=>{s.setPixel(t,e,this.selectedColorIndex),s.render(h.card.getContentContainer().children[0]),o.sheetCard.controller.render(o.sheetCard.card.getContentContainer()),this.saveProjectState()},onFocus:n});this.scene.addChild(h.card.container),o.spriteCard=h,o.spriteController=s;const c=this.spriteSheetManager.getAll().indexOf(o);this.registerCard(`sprite-card-${c}`,h.card),h.card.setPairedCard(o.sheetCard.card),o.sheetCard.card.setPairedCard(h.card);const l=Ur(this.renderer,h.card,t=>{const e=s.getScale(),i=2*t,o=Math.max(1,Math.min(64,e+i));if(o!==e){s.setScale(o),h.card.setTitle(`Sprite (${o}x)`);const t=s.getScaledDimensions(),e=Math.ceil(t.width/xr(1)),i=Math.ceil(t.height/xr(1));h.card.setContentSize(e,i),h.redraw()}});"undefined"!=typeof window&&(window.addEventListener("wheel",l,{passive:!1}),h.card.container.on("destroyed",()=>{window.removeEventListener("wheel",l)}))},a=function(t){const{config:i,x:s,y:o,renderer:n,showGrid:r=!1,onCellHover:a,onCellClick:h,onFocus:c}=t;let l,m,u;const _=new Nr({config:i,renderer:n,showGrid:r,onScaleChange:t=>{const e=_.getSelectedCell(),i=e?`${e.x},${e.y}`:"grid-cell";l.setTitle(`${i} | ${t.toFixed(2)}x`),_.render(m)},onCellHover:a,onCellClick:(t,e)=>{l.setTitle(`${t},${e} | ${_.getScale().toFixed(2)}x`),h&&h(t,e)}}),{width:d,height:p}=_.getScaledDimensions(),y=Math.ceil(d/xr(1)),f=Math.ceil(p/xr(1)),g=xr(2*br.padding)+xr(6),v=s??n.width-xr(y)-g-20,x=o??n.height-xr(f)-g-24-20;l=new Fr({title:`grid-cell | ${_.getScale().toFixed(2)}x`,x:v,y:x,contentWidth:y,contentHeight:f,renderer:n,clipContent:!0,onFocus:c,onResize:(t,e)=>{u&&(u.width=xr(t),u.height=xr(e))}}),m=l.getContentContainer();const b=function(t=16,i=2763322,s=3487045){const o=document.createElement("canvas");o.width=2*t,o.height=2*t;const n=o.getContext("2d");n.fillStyle=`#${i.toString(16).padStart(6,"0")}`,n.fillRect(0,0,t,t),n.fillRect(t,t,t,t),n.fillStyle=`#${s.toString(16).padStart(6,"0")}`,n.fillRect(t,0,t,t),n.fillRect(0,t,t,t);const r=e.Texture.from(o);return r.source.scaleMode="nearest",r}(16,2763322,3487045);return u=new e.TilingSprite({texture:b,width:xr(y),height:xr(f)}),u.tileScale.set(1,1),m.addChildAt(u,0),_.render(m),{card:l,controller:_}}({config:jr[t],renderer:this.renderer,showGrid:i,onCellHover:(t,e)=>{console.log(`Hovering cell: ${t}, ${e}`)},onCellClick:(t,e)=>{r(t,e),this.saveProjectState()},onFocus:n});this.scene.addChild(a.card.container),o.sheetCard=a,s&&(a.controller.setPixelData(s.pixels),s.scale&&a.controller.setScale(s.scale),a.controller.render(a.card.getContentContainer()));const h=this.spriteSheetManager.count()-1;if(this.registerCard(`sprite-sheet-${h}`,a.card),this.spriteSheetManager.setActive(o.id),!s){a.controller.setScale(4);const t=a.controller.getScaledDimensions(),e=Math.ceil(t.width/xr(1)),i=Math.ceil(t.height/xr(1));a.card.setContentSize(e,i),a.controller.render(a.card.getContentContainer())}const c=s?.selectedCellX??0,l=s?.selectedCellY??0;if(a.controller.selectCell(c,l),s){const t=a.card.getContentSize(),e=xr(t.width),i=xr(t.height);a.controller.centerCell(c,l,e,i)}if(s?.spriteCardScale&&o.spriteController&&(o.spriteController.setScale(s.spriteCardScale),o.spriteCard)){o.spriteCard.card.setTitle(`Sprite (${s.spriteCardScale}x)`);const t=o.spriteController.getScaledDimensions(),e=Math.ceil(t.width/xr(1)),i=Math.ceil(t.height/xr(1));o.spriteCard.card.setContentSize(e,i),o.spriteCard.redraw()}console.log(`Created ${t} sprite sheet`),this.saveProjectState()}updateTheme(){this.renderer.background.color=Tr().backgroundRoot,this.commanderBarCard&&this.commanderBarCard.card.refresh(),this.paletteCard&&this.paletteCard.card.refresh(),this.infoBarCard&&this.infoBarCard.card.refresh(),this.spriteSheetManager.getAll().forEach(t=>{t.sheetCard&&t.sheetCard.card.refresh(),t.spriteCard&&t.spriteCard.card.refresh()}),console.log(" Theme updated")}async recreateUI(){this.scene.removeChildren(),this.renderer.background.color=Tr().backgroundRoot,this.commanderBarCard=function(t){const{x:e,y:i,renderer:s,scene:o,width:n,callbacks:r}=t,a=s.width,h=n??Math.floor(a/xr(1))-2*Br-2*br.padding,c=new Fr({title:"PIKCELL",x:e,y:i,contentWidth:h,contentHeight:12,renderer:s,minContentSize:!0,onResize:(t,e)=>{m()},onRefresh:()=>{m()}}),l=c.getContentContainer();function m(){l.removeChildren();const t=12,e=xr(2);let i=0;const n=kr({height:t,label:"New",selectionMode:"press",actionMode:"click",onClick:()=>{r?.onNew&&r.onNew()}});n.position.set(i,0),l.addChild(n),i+=n.width+e;const a=kr({height:t,label:"Save",selectionMode:"press",actionMode:"click",onClick:()=>{r?.onSave&&r.onSave()}});a.position.set(i,0),l.addChild(a),i+=a.width+e;const c=kr({height:t,label:"Load",selectionMode:"press",actionMode:"click",onClick:()=>{r?.onLoad&&r.onLoad()}});c.position.set(i,0),l.addChild(c),i+=c.width+e;const m=kr({height:t,label:"Export",selectionMode:"press",actionMode:"click",onClick:()=>{r?.onExport&&r.onExport()}});m.position.set(i,0),l.addChild(m),i+=m.width+e;const u=xr(2),_=kr({height:t,label:"Layout",selectionMode:"press",actionMode:"click",onClick:()=>{const t=[];t.push({label:"Reset",onClick:()=>{r?.onApplyLayout&&r.onApplyLayout()}}),["A","B","C"].forEach(e=>{(r?.hasLayoutSlot?.(e)??!1)&&t.push({label:`Load ${e}`,onClick:()=>{r?.onLoadLayoutSlot&&r.onLoadLayoutSlot(e)}}),t.push({label:`Save ${e}`,onClick:()=>{r?.onSaveLayoutSlot&&r.onSaveLayoutSlot(e)}})});const e=qr({title:"Layout",message:"Choose layout:",buttons:t,renderer:s});o.addChild(e)}}),d=kr({height:t,label:"Theme",selectionMode:"press",actionMode:"click",onClick:()=>{const t=qr({title:"Choose Theme",message:"Select a theme:",buttons:Vr.flatMap(t=>[...t.classic,...t.seasonal]).map(t=>({label:t.name,onClick:()=>{var e;Ir=(e=t).theme,zr=e,r?.onThemeChange&&r.onThemeChange()}})),renderer:s});o.addChild(t)}}),p=_.width/xr(1),y=d.width/xr(1);_.position.set(xr(h-p-y)-u,0),l.addChild(_),d.position.set(xr(h-y),0),l.addChild(d)}return m(),c.updateMinContentSize(),{card:c}}({x:xr(br.margin),y:xr(br.margin),renderer:this.renderer,scene:this.scene,callbacks:{onNew:()=>this.handleNew(),onSave:()=>this.handleSave(),onLoad:()=>this.handleLoad(),onExport:()=>this.handleExport(),onApplyLayout:()=>this.applyDefaultLayout(),onSaveLayoutSlot:t=>this.handleSaveLayoutSlot(t),onLoadLayoutSlot:t=>this.handleLoadLayoutSlot(t),hasLayoutSlot:t=>Yr.hasLayoutSlot(t),onThemeChange:()=>this.updateTheme(),onScaleChange:t=>this.handleScaleChange(t)}}),this.scene.addChild(this.commanderBarCard.card.container),this.registerCard("commander",this.commanderBarCard.card);const t=xr(12)+xr(2*Br)+24,i=xr(br.margin)+t+xr(2*br.gap);this.paletteCard=function(t){const{x:e,y:i,renderer:s,palette:o,onColorSelect:n}=t;let r=t.selectedColorIndex??0,a=[...o],h=4,c=4,l=12;const m=new Fr({title:"Palette",x:e,y:i,contentWidth:h*l+(h-1)*br.gap,contentHeight:c*l+(c-1)*br.gap,renderer:s,onResize:(t,e)=>{const i=a.length;let s=2,o=1,n=i;for(let r=1;r<=i;r++){const a=Math.ceil(i/r),h=Math.floor((t-(r-1)*br.gap)/r),c=Math.floor((e-(a-1)*br.gap)/a),l=Math.min(h,c);l>s&&(s=l,o=r,n=a)}l=Math.max(2,Math.min(32,s)),h=o,c=n,_()},onRefresh:()=>{_()}}),u=m.getContentContainer();function _(){u.removeChildren();const t=h*c;for(let e=0;e<Math.min(t,a.length);e++){const t=a[e],i=e%h,s=Math.floor(e/h),o=xr(i*(l+br.gap)),c=xr(s*(l+br.gap)),m=kr({size:l,selected:e===r,backgroundColor:t,selectionMode:"highlight",actionMode:"toggle",onClick:()=>{r=e,console.log(`Selected color #${e}: #${t.toString(16).padStart(6,"0")}`),_(),n&&n(e,t)}});m.position.set(o,c),u.addChild(m)}}const d=Ur(s,m,t=>{l=Math.max(2,Math.min(32,l+t));const e=h*l+(h-1)*br.gap,i=c*l+(c-1)*br.gap;m.setContentSize(e,i),_()});return"undefined"!=typeof window&&(window.addEventListener("wheel",d,{passive:!1}),m.container.on("destroyed",()=>{window.removeEventListener("wheel",d)})),_(),m.updateMinContentSize(),{card:m,getSelectedColorIndex:()=>r,setSelectedColorIndex:t=>{r=t,_()},setPalette:t=>{a=[...t],_()}}}({x:xr(br.margin),y:i,renderer:this.renderer,palette:this.currentPalette,selectedColorIndex:this.selectedColorIndex,onColorSelect:t=>{this.selectedColorIndex=t}}),this.scene.addChild(this.paletteCard.card.container),this.registerCard("palette",this.paletteCard.card);const s=this.layoutManager.calculateCardHeightFromContent(8),o=this.renderer.height-s,n=this.layoutManager.calculateFullWidthContentSize(this.renderer.width);this.infoBarCard=function(t){const{x:i,y:s,renderer:o,width:n}=t;let r=t.sections??[{label:"Tool:",value:"Pencil"},{label:"Color:",value:"#000000"},{label:"Scale:",value:"1x"}];const a=n??20*r.length,h=new Fr({title:"Info",x:i,y:s,contentWidth:a,contentHeight:8,renderer:o,minContentSize:!0,onResize:(t,e)=>{t>=8&&l()},onRefresh:()=>{l()}}),c=h.getContentContainer();function l(){c.removeChildren();let t=xr(2);const i=xr(4);r.forEach((s,o)=>{const n=new e.BitmapText({text:s.label,style:{fontFamily:"PixelOperator8Bitmap",fontSize:64,fill:Tr().textSecondary}});n.roundPixels=!0,n.scale.set(br.fontScale),n.position.set(t,xr(2)),c.addChild(n),t+=n.width+xr(1);const r=new e.BitmapText({text:s.value,style:{fontFamily:"PixelOperator8Bitmap",fontSize:64,fill:Tr().textPrimary}});r.roundPixels=!0,r.scale.set(br.fontScale),r.position.set(t,xr(2)),c.addChild(r),t+=r.width+i})}return l(),h.updateMinContentSize(),{card:h,updateSections:t=>{r=t,l(),h.updateMinContentSize()}}}({x:0,y:o,renderer:this.renderer,width:n}),this.scene.addChild(this.infoBarCard.card.container),this.registerCard("info",this.infoBarCard.card),this.loadProjectState(),this.restoreUIState()}saveProjectState(){this.hasUnsavedChanges=!0,this.projectSaveTimer&&clearTimeout(this.projectSaveTimer),this.projectSaveTimer=window.setTimeout(()=>{this.projectState.spriteSheets=this.spriteSheetManager.getAll().map(t=>{const e=t.sheetCard.controller.getSelectedCell();return{id:t.id,type:t.sheetCard.controller.getConfig().type,showGrid:!1,pixels:t.sheetCard.controller.getPixelData(),selectedCellX:e.x,selectedCellY:e.y,scale:t.sheetCard.controller.getScale(),spriteCardScale:t.spriteController?.getScale()}});const t=this.spriteSheetManager.getActive();this.projectState.activeSpriteSheetId=t?.id??null,this.projectState.selectedColorIndex=this.selectedColorIndex;const e=Dr.saveProject(this.projectState);e.success||console.warn("Auto-save failed:",e.error)},1e3)}loadProjectState(){0!==this.projectState.spriteSheets.length?(this.selectedColorIndex=this.projectState.selectedColorIndex??0,this.projectState.spriteSheets.forEach(t=>{this.createNewSpriteSheet(t.type,t.showGrid,t)}),console.log(" Project state loaded")):console.log("No sprite sheets in project state")}async handleNew(){if(this.spriteSheetManager.count()>0){const t=qr({title:"Save Current Project?",message:"You have unsaved work. Save before creating new project?",buttons:[{label:"Save",onClick:()=>{this.handleSave(),setTimeout(()=>this.createNewProject(),100)}},{label:"Discard",onClick:()=>{this.createNewProject()}},{label:"Cancel",onClick:()=>{}}],renderer:this.renderer});this.scene.addChild(t)}else this.createNewProject()}createNewProject(){this.spriteSheetManager.getAll().forEach(t=>{t.sheetCard&&this.scene.removeChild(t.sheetCard.card.container),t.spriteCard&&this.scene.removeChild(t.spriteCard.card.container)}),this.spriteSheetManager.clear(),this.projectState=Dr.createEmptyProject(),this.hasUnsavedChanges=!1;const t=qr({title:"New Sprite Sheet",message:"Choose sprite sheet type:",checkboxes:[{name:"showGrid",label:"Show 8x8 Grid",defaultValue:!0}],buttons:[{label:"PICO-8",onClick:t=>{this.createNewSpriteSheet("PICO-8",t?.showGrid??!1)}},{label:"TIC-80",onClick:t=>{this.createNewSpriteSheet("TIC-80",t?.showGrid??!1)}}],renderer:this.renderer});this.scene.addChild(t)}handleSave(){this.projectSaveTimer&&clearTimeout(this.projectSaveTimer),this.projectState.spriteSheets=this.spriteSheetManager.getAll().map(t=>{const e=t.sheetCard.controller.getSelectedCell();return{id:t.id,type:t.sheetCard.controller.getConfig().type,showGrid:!1,pixels:t.sheetCard.controller.getPixelData(),selectedCellX:e.x,selectedCellY:e.y,scale:t.sheetCard.controller.getScale(),spriteCardScale:t.spriteController?.getScale()}});const t=this.spriteSheetManager.getActive();this.projectState.activeSpriteSheetId=t?.id??null,this.projectState.selectedColorIndex=this.selectedColorIndex,this.fileOperationsManager.saveProject(this.projectState),this.hasUnsavedChanges=!1}async handleLoad(){if(this.spriteSheetManager.count()>0&&this.hasUnsavedChanges){const t=qr({title:"Unsaved Changes",message:"Loading will replace current project. Continue?",buttons:[{label:"Continue",onClick:async()=>{await this.loadProjectFile()}},{label:"Cancel",onClick:()=>{}}],renderer:this.renderer});this.scene.addChild(t)}else await this.loadProjectFile()}async loadProjectFile(){const t=await this.fileOperationsManager.loadProject();if(!t)return void console.log("No file selected or failed to load");this.spriteSheetManager.getAll().forEach(t=>{t.sheetCard&&this.scene.removeChild(t.sheetCard.card.container),t.spriteCard&&this.scene.removeChild(t.spriteCard.card.container)}),this.spriteSheetManager.clear(),this.projectState=t,this.hasUnsavedChanges=!1;const e=Dr.saveProject(this.projectState);e.success||console.warn("Failed to save loaded project to localStorage:",e.error),this.loadProjectState()}handleExport(){const t=this.spriteSheetManager.getActive();if(!t){const t=qr({title:"No Sprite Sheet",message:"Please create a sprite sheet first.",buttons:[{label:"OK",onClick:()=>{}}],renderer:this.renderer});return void this.scene.addChild(t)}this.fileOperationsManager.exportPNG(t.sheetCard.controller)}handleSaveLayoutSlot(t){const e={cards:[]};this.uiManager.getAllCards().forEach((t,i)=>{const s=t.getContentSize();e.cards.push({id:i,x:t.container.x,y:t.container.y,width:s.width,height:s.height})}),Yr.saveLayoutSlot(t,e),console.log(`Layout saved to slot ${t}`)}handleLoadLayoutSlot(t){const e=Yr.loadLayoutSlot(t);e?(e.cards.forEach(t=>{const e=this.uiManager.getCard(t.id);e&&(e.container.position.set(t.x,t.y),e.setContentSize(t.width,t.height))}),console.log(`Layout loaded from slot ${t}`)):console.warn(`No layout found in slot ${t}`)}handleScaleChange(t){const e=qr({title:"Scale Change",message:`Changing scale to ${t}x requires reloading the page.`,buttons:[{label:"Reload",onClick:()=>{localStorage.setItem("temp-grid-scale",t.toString()),window.location.reload()}},{label:"Cancel",onClick:()=>{}}],renderer:this.renderer});this.scene.addChild(e)}destroy(){this.uiStateSaveTimer&&clearTimeout(this.uiStateSaveTimer),this.projectSaveTimer&&clearTimeout(this.projectSaveTimer),this.uiManager.clear(),this.spriteSheetManager.clear()}}new Map;const ta={PIXEL_OPERATOR8_FONT:{alias:"PixelOperator8",src:"./assets/fonts/pixel_operator/PixelOperator8.ttf"},KENNEY_BLOCKS_FONT:{alias:"Kenney Blocks",src:"./assets/fonts/kenney-blocks.ttf"}};"undefined"!=typeof document&&"9001"===window.location.port&&document.addEventListener("DOMContentLoaded",()=>{const t=document.getElementById("app");t&&async function(t){const i=t||document.getElementById("app");if(!i)throw new Error("Host element not found");const{scene:s,engine:o,renderer:n}=await async function({hostElement:t,renderOptions:e=mr,physics:i,showLoadingScene:s=!1,loadingSceneOptions:o={},pixelPerfect:n}={}){let r={...e},a=!1;if(n){const t="boolean"==typeof n?{enabled:!0,imageRendering:!0}:n;!1!==t.enabled&&(r={...r,resolution:1,antialias:!1,roundPixels:!0}),a=!1!==t.imageRendering}const{renderer:h}=await v.create(t,r);if(a){const t=h.canvas;t.style.imageRendering="pixelated",t.style.imageRendering="-moz-crisp-edges",t.style.imageRendering="crisp-edges"}const c=new b(h),l=new A(c),m=new C,{PIXIAssets:u,loadAssets:_}=m,d=new V(c,h);let p,y;return i&&(p=new ar("boolean"==typeof i?{}:i),l.addPhysicsWorld(p)),s&&(y=new lr(o),y.zIndex=1e4,y.init(h),c.addChild(y),y.hide(),m.on("loading:start",()=>{y&&y.show()}),m.on("loading:end",()=>{y&&y.hide()})),{scene:c,engine:l,PIXIAssets:u,renderer:h,loadAssets:_,camera:d,physicsWorld:p,loadingScene:y}}({hostElement:i,showLoadingScene:!1,pixelPerfect:!0,renderOptions:{width:1280,height:720,backgroundColor:Tr().backgroundRoot}});await e.Assets.load([ta.PIXEL_OPERATOR8_FONT,ta.KENNEY_BLOCKS_FONT]),e.BitmapFont.install({name:"PixelOperator8Bitmap",style:{fontFamily:"PixelOperator8",fontSize:64,fill:16777215}}),e.BitmapFont.install({name:"KennyBlocksBitmap",style:{fontFamily:"Kenney Blocks",fontSize:64,fill:16777215}});const r=new Qr({renderer:n,scene:s,maxSpriteSheets:2});return await r.initialize(),s.init(),o.start(),console.log("PIKCELL loaded"),{spriteEditor:r,scene:s,engine:o,renderer:n}}(t).catch(console.error)})})()})();
//# sourceMappingURL=bundle.js.map